<!DOCTYPE html>
<!-- saved from url=(0068)https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service -->
<html lang="en" class="light" style="color-scheme: light;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link rel="preload" href="https://deepwiki.com/_next/static/media/4cf2300e9c8272f7-s.p.woff2" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://deepwiki.com/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"><link rel="stylesheet" href="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/de70bee13400563f.css" data-precedence="next"><link rel="stylesheet" href="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/fc1993f38795cea2.css" data-precedence="next"><link rel="preload" as="script" fetchpriority="low" href="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/webpack-acbbbb548492d4a6.js.download"><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/4bd1b696-cebf68b71ed1e85d.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/1684-86c9bac32de6a2a0.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/main-app-8ab5af3d6b81086e.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/b1298b8d-549c141f97a3b262.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/378e5a93-3b0f971d3611a8a5.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/f7f68e2d-40290491c524df5c.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/5009-cf1c1739f4eccbfa.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/3377-d302682beb4206f6.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/6671-9def8ce641ff6e98.js.download" async=""></script><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/polyfills-42372ed130431b0a.js.download" nomodule=""></script><style type="text/css">[data-sonner-toaster][dir=ltr],html[dir=ltr]{--toast-icon-margin-start:-3px;--toast-icon-margin-end:4px;--toast-svg-margin-start:-1px;--toast-svg-margin-end:0px;--toast-button-margin-start:auto;--toast-button-margin-end:0;--toast-close-button-start:0;--toast-close-button-end:unset;--toast-close-button-transform:translate(-35%, -35%)}[data-sonner-toaster][dir=rtl],html[dir=rtl]{--toast-icon-margin-start:4px;--toast-icon-margin-end:-3px;--toast-svg-margin-start:0px;--toast-svg-margin-end:-1px;--toast-button-margin-start:0;--toast-button-margin-end:auto;--toast-close-button-start:unset;--toast-close-button-end:0;--toast-close-button-transform:translate(35%, -35%)}[data-sonner-toaster]{position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1:hsl(0, 0%, 99%);--gray2:hsl(0, 0%, 97.3%);--gray3:hsl(0, 0%, 95.1%);--gray4:hsl(0, 0%, 93%);--gray5:hsl(0, 0%, 90.9%);--gray6:hsl(0, 0%, 88.7%);--gray7:hsl(0, 0%, 85.8%);--gray8:hsl(0, 0%, 78%);--gray9:hsl(0, 0%, 56.1%);--gray10:hsl(0, 0%, 52.3%);--gray11:hsl(0, 0%, 43.5%);--gray12:hsl(0, 0%, 9%);--border-radius:8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:0;z-index:999999999;transition:transform .4s ease}[data-sonner-toaster][data-lifted=true]{transform:translateY(-8px)}@media (hover:none) and (pointer:coarse){[data-sonner-toaster][data-lifted=true]{transform:none}}[data-sonner-toaster][data-x-position=right]{right:var(--offset-right)}[data-sonner-toaster][data-x-position=left]{left:var(--offset-left)}[data-sonner-toaster][data-x-position=center]{left:50%;transform:translateX(-50%)}[data-sonner-toaster][data-y-position=top]{top:var(--offset-top)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--offset-bottom)}[data-sonner-toast]{--y:translateY(100%);--lift-amount:calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:0;overflow-wrap:anywhere}[data-sonner-toast][data-styled=true]{padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px rgba(0,0,0,.1);width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}[data-sonner-toast]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-y-position=top]{top:0;--y:translateY(-100%);--lift:1;--lift-amount:calc(1 * var(--gap))}[data-sonner-toast][data-y-position=bottom]{bottom:0;--y:translateY(100%);--lift:-1;--lift-amount:calc(var(--lift) * var(--gap))}[data-sonner-toast][data-styled=true] [data-description]{font-weight:400;line-height:1.4;color:#3f3f3f}[data-rich-colors=true][data-sonner-toast][data-styled=true] [data-description]{color:inherit}[data-sonner-toaster][data-sonner-theme=dark] [data-description]{color:#e8e8e8}[data-sonner-toast][data-styled=true] [data-title]{font-weight:500;line-height:1.5;color:inherit}[data-sonner-toast][data-styled=true] [data-icon]{display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}[data-sonner-toast][data-promise=true] [data-icon]>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}[data-sonner-toast][data-styled=true] [data-icon]>*{flex-shrink:0}[data-sonner-toast][data-styled=true] [data-icon] svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}[data-sonner-toast][data-styled=true] [data-content]{display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;font-weight:500;cursor:pointer;outline:0;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}[data-sonner-toast][data-styled=true] [data-button]:focus-visible{box-shadow:0 0 0 2px rgba(0,0,0,.4)}[data-sonner-toast][data-styled=true] [data-button]:first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}[data-sonner-toast][data-styled=true] [data-cancel]{color:var(--normal-text);background:rgba(0,0,0,.08)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-styled=true] [data-cancel]{background:rgba(255,255,255,.3)}[data-sonner-toast][data-styled=true] [data-close-button]{position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);background:var(--normal-bg);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast][data-styled=true] [data-close-button]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-styled=true] [data-disabled=true]{cursor:not-allowed}[data-sonner-toast][data-styled=true]:hover [data-close-button]:hover{background:var(--gray2);border-color:var(--gray5)}[data-sonner-toast][data-swiping=true]::before{content:'';position:absolute;left:-100%;right:-100%;height:100%;z-index:-1}[data-sonner-toast][data-y-position=top][data-swiping=true]::before{bottom:50%;transform:scaleY(3) translateY(50%)}[data-sonner-toast][data-y-position=bottom][data-swiping=true]::before{top:50%;transform:scaleY(3) translateY(-50%)}[data-sonner-toast][data-swiping=false][data-removed=true]::before{content:'';position:absolute;inset:0;transform:scaleY(2)}[data-sonner-toast][data-expanded=true]::after{content:'';position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}[data-sonner-toast][data-mounted=true]{--y:translateY(0);opacity:1}[data-sonner-toast][data-expanded=false][data-front=false]{--scale:var(--toasts-before) * 0.05 + 1;--y:translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}[data-sonner-toast]>*{transition:opacity .4s}[data-sonner-toast][data-x-position=right]{right:0}[data-sonner-toast][data-x-position=left]{left:0}[data-sonner-toast][data-expanded=false][data-front=false][data-styled=true]>*{opacity:0}[data-sonner-toast][data-visible=false]{opacity:0;pointer-events:none}[data-sonner-toast][data-mounted=true][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}[data-sonner-toast][data-removed=true][data-front=true][data-swipe-out=false]{--y:translateY(calc(var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=false]{--y:translateY(40%);opacity:0;transition:transform .5s,opacity .2s}[data-sonner-toast][data-removed=true][data-front=false]::before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y,0)) translateX(var(--swipe-amount-x,0));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width:600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-sonner-theme=light]{--normal-bg:#fff;--normal-border:var(--gray4);--normal-text:var(--gray12);--success-bg:hsl(143, 85%, 96%);--success-border:hsl(145, 92%, 87%);--success-text:hsl(140, 100%, 27%);--info-bg:hsl(208, 100%, 97%);--info-border:hsl(221, 91%, 93%);--info-text:hsl(210, 92%, 45%);--warning-bg:hsl(49, 100%, 97%);--warning-border:hsl(49, 91%, 84%);--warning-text:hsl(31, 92%, 45%);--error-bg:hsl(359, 100%, 97%);--error-border:hsl(359, 100%, 94%);--error-text:hsl(360, 100%, 45%)}[data-sonner-toaster][data-sonner-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg:#000;--normal-border:hsl(0, 0%, 20%);--normal-text:var(--gray1)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg:#fff;--normal-border:var(--gray3);--normal-text:var(--gray12)}[data-sonner-toaster][data-sonner-theme=dark]{--normal-bg:#000;--normal-bg-hover:hsl(0, 0%, 12%);--normal-border:hsl(0, 0%, 20%);--normal-border-hover:hsl(0, 0%, 25%);--normal-text:var(--gray1);--success-bg:hsl(150, 100%, 6%);--success-border:hsl(147, 100%, 12%);--success-text:hsl(150, 86%, 65%);--info-bg:hsl(215, 100%, 6%);--info-border:hsl(223, 43%, 17%);--info-text:hsl(216, 87%, 65%);--warning-bg:hsl(64, 100%, 6%);--warning-border:hsl(60, 100%, 9%);--warning-text:hsl(46, 87%, 65%);--error-bg:hsl(358, 76%, 10%);--error-border:hsl(357, 89%, 16%);--error-text:hsl(358, 100%, 81%)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size:16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:first-child{animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}100%{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}100%{opacity:.15}}@media (prefers-reduced-motion){.sonner-loading-bar,[data-sonner-toast],[data-sonner-toast]>*{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}</style><script id="hotjar-init-script" crossorigin="anonymous">(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:6382967,hjsv:6,hjdebug:false};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async="" src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/hotjar-6382967.js.download"></script><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="next-size-adjust" content=""><title>Wallet Service | letrogthien/e-com-chuadatten | DeepWiki</title><meta name="description" content="The Wallet Service manages digital wallets, payment processing, and bank account operations within the e-commerce platform. It handles wallet balance management, payment transactions through external "><meta property="og:title" content="Wallet Service | letrogthien/e-com-chuadatten | DeepWiki"><meta property="og:description" content="The Wallet Service manages digital wallets, payment processing, and bank account operations within the e-commerce platform. It handles wallet balance management, payment transactions through external "><meta property="og:url" content="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service"><meta property="og:site_name" content="DeepWiki"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Wallet Service | letrogthien/e-com-chuadatten | DeepWiki"><meta name="twitter:description" content="The Wallet Service manages digital wallets, payment processing, and bank account operations within the e-commerce platform. It handles wallet balance management, payment transactions through external "><link rel="icon" href="https://deepwiki.com/favicon.ico" type="image/x-icon" sizes="48x48"><link rel="icon" href="https://deepwiki.com/icon.png?66aaf51e0e68c818" type="image/png" sizes="16x16"><link rel="apple-touch-icon" href="https://deepwiki.com/apple-icon.png?a4f658907db0ab87" type="image/png" sizes="180x180"></head><body class="__variable_188709 font-geist-sans relative min-h-screen __variable_9a8899 bg-background antialiased" style="overflow: auto;"><section aria-label="Notifications alt+T" tabindex="-1" aria-live="polite" aria-relevant="additions text" aria-atomic="false"></section><script>((e,t,r,n,a,o,i,s)=>{let u=document.documentElement,l=["light","dark"];function c(t){var r;(Array.isArray(e)?e:[e]).forEach(e=>{let r="class"===e,n=r&&o?a.map(e=>o[e]||e):a;r?(u.classList.remove(...n),u.classList.add(o&&o[t]?o[t]:t)):u.setAttribute(e,t)}),r=t,s&&l.includes(r)&&(u.style.colorScheme=r)}if(n)c(n);else try{let e=localStorage.getItem(t)||r,n=i&&"system"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;c(n)}catch(e){}})("class","theme","light",null,["light","dark"],null,true,true)</script><!--$--><div class="flex min-h-screen w-full flex-col text-white" id="codebase-wiki-repo-page"><div class="bg-background border-b-border sticky top-0 z-30 border-b border-dashed"><div class="font-geist-mono relative flex h-8 items-center justify-center text-xs font-medium sm:hidden"><div class="powered-by-devin-gradient absolute inset-0 z-[-1] h-8 w-full"></div><a class="flex items-center gap-2" href="https://deepwiki.com/private-repo"><svg class="size-3 [&amp;_path]:stroke-0 [&amp;_path]:animate-[custom-pulse_1.8s_infinite_var(--delay,0s)]" xmlns="http://www.w3.org/2000/svg" viewBox="110 110 460 500"><path style="fill:#21c19a" class="[--delay:0.6s]" d="M418.73,332.37c9.84-5.68,22.07-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.58,1.06.19.06.37.11.55.16.87.21,1.76.34,2.65.35.04,0,.08.02.13.02.1,0,.19-.03.29-.04.83-.02,1.64-.13,2.45-.32.14-.03.28-.05.42-.09.87-.24,1.7-.59,2.5-1.03.08-.04.17-.06.25-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.06,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.57-1.06-.19-.06-.37-.11-.56-.16-.88-.21-1.76-.34-2.65-.34-.13,0-.26.02-.4.02-.84.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.24.1.8.44,1.64.79,2.5,1.03.14.04.28.06.42.09.81.19,1.62.3,2.45.32.1,0,.19.04.29.04.04,0,.08-.02.13-.02.89,0,1.77-.13,2.65-.35.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.58-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-.08-.04-.16-.06-.24-.1-.8-.44-1.64-.8-2.51-1.04-.13-.04-.26-.05-.39-.09-.82-.2-1.65-.31-2.49-.33-.13,0-.25-.02-.38-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.75.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.07,5.68-31.9,0-9.84-5.68-15.95-16.27-15.95-27.63s6.11-21.95,15.95-27.63Z"></path><path style="fill:#3969ca" d="M141.09,317.65l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c.08-.04.13-.11.2-.16.78-.48,1.51-1.02,2.15-1.66.1-.1.18-.21.28-.31.57-.6,1.08-1.26,1.51-1.97.07-.12.15-.22.22-.34.44-.77.77-1.6,1.03-2.47.05-.19.1-.37.14-.56.22-.89.37-1.81.37-2.76v-29.43c0-11.36,6.11-21.95,15.96-27.63s22.06-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.57,1.06.19.06.37.11.56.16.87.21,1.76.34,2.64.35.04,0,.09.02.13.02.1,0,.19-.04.29-.04.83-.02,1.65-.13,2.45-.32.14-.03.28-.05.41-.09.87-.24,1.71-.6,2.51-1.04.08-.04.16-.06.24-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.07,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.58-1.06-.19-.06-.37-.11-.55-.16-.88-.21-1.76-.34-2.65-.35-.13,0-.26.02-.4.02-.83.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22Z"></path><path style="fill:#0294de" class="[--delay:1.2s]" d="M396.88,484.35l-50.97-29.43c-.08-.04-.17-.06-.24-.1-.8-.44-1.64-.79-2.51-1.03-.14-.04-.27-.06-.41-.09-.81-.19-1.64-.3-2.47-.32-.13,0-.26-.02-.39-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.76.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.06,5.68-31.9,0-9.84-5.68-15.96-16.27-15.96-27.63v-29.43c0-.95-.15-1.87-.37-2.76-.05-.19-.09-.37-.14-.56-.25-.86-.59-1.69-1.03-2.47-.07-.12-.15-.22-.22-.34-.43-.71-.94-1.37-1.51-1.97-.1-.1-.18-.21-.28-.31-.65-.63-1.37-1.18-2.15-1.66-.07-.04-.13-.11-.2-.16l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.25.1.8.44,1.63.79,2.5,1.03.14.04.29.06.43.09.8.19,1.61.3,2.43.32.1,0,.2.04.3.04.04,0,.09-.02.13-.02.88,0,1.77-.13,2.64-.34.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.57-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22Z"></path></svg>Get free private DeepWikis in Devin</a></div><div class="container-wrapper"><div class="container mx-auto flex w-full flex-row items-center gap-2 py-4 md:py-6"><a class="flex items-center gap-3" href="https://deepwiki.com/"><span class="text-base font-medium leading-none md:text-lg hidden sm:block">DeepWiki</span></a><div class="flex-1"><div class="flex flex-row items-center gap-2"><a class="block text-xs font-medium leading-none text-white sm:hidden md:text-lg" href="https://deepwiki.com/">DeepWiki</a><p class="text-sm font-normal leading-none md:text-lg"><a href="https://github.com/letrogthien/e-com-chuadatten" target="_blank" rel="noopener noreferrer" class="text-muted-foreground hover:text-muted-foreground/80 transition-colors">letrogthien/e-com-chuadatten</a></p></div></div><div class="flex items-center gap-4"><a class="group hidden items-center gap-1.5 md:flex" href="https://deepwiki.com/private-repo"><div class="relative"><span class="text-foreground/70 group-hover:text-foreground text-xs font-light transition-colors">Get free private DeepWikis with</span><div class="absolute bottom-0 left-0 h-[1px] w-0 bg-black/30 transition-all duration-300 group-hover:w-full"></div></div><div class="flex items-center gap-1 transition-transform duration-300 group-hover:translate-x-0.5"><svg class="size-4 transform transition-transform duration-700 group-hover:rotate-180 [&amp;_path]:stroke-0" xmlns="http://www.w3.org/2000/svg" viewBox="110 110 460 500"><path style="fill:#21c19a" class="" d="M418.73,332.37c9.84-5.68,22.07-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.58,1.06.19.06.37.11.55.16.87.21,1.76.34,2.65.35.04,0,.08.02.13.02.1,0,.19-.03.29-.04.83-.02,1.64-.13,2.45-.32.14-.03.28-.05.42-.09.87-.24,1.7-.59,2.5-1.03.08-.04.17-.06.25-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.06,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.57-1.06-.19-.06-.37-.11-.56-.16-.88-.21-1.76-.34-2.65-.34-.13,0-.26.02-.4.02-.84.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.24.1.8.44,1.64.79,2.5,1.03.14.04.28.06.42.09.81.19,1.62.3,2.45.32.1,0,.19.04.29.04.04,0,.08-.02.13-.02.89,0,1.77-.13,2.65-.35.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.58-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-.08-.04-.16-.06-.24-.1-.8-.44-1.64-.8-2.51-1.04-.13-.04-.26-.05-.39-.09-.82-.2-1.65-.31-2.49-.33-.13,0-.25-.02-.38-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.75.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.07,5.68-31.9,0-9.84-5.68-15.95-16.27-15.95-27.63s6.11-21.95,15.95-27.63Z"></path><path style="fill:#3969ca" d="M141.09,317.65l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c.08-.04.13-.11.2-.16.78-.48,1.51-1.02,2.15-1.66.1-.1.18-.21.28-.31.57-.6,1.08-1.26,1.51-1.97.07-.12.15-.22.22-.34.44-.77.77-1.6,1.03-2.47.05-.19.1-.37.14-.56.22-.89.37-1.81.37-2.76v-29.43c0-11.36,6.11-21.95,15.96-27.63s22.06-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.57,1.06.19.06.37.11.56.16.87.21,1.76.34,2.64.35.04,0,.09.02.13.02.1,0,.19-.04.29-.04.83-.02,1.65-.13,2.45-.32.14-.03.28-.05.41-.09.87-.24,1.71-.6,2.51-1.04.08-.04.16-.06.24-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.07,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.58-1.06-.19-.06-.37-.11-.55-.16-.88-.21-1.76-.34-2.65-.35-.13,0-.26.02-.4.02-.83.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22Z"></path><path style="fill:#0294de" class="" d="M396.88,484.35l-50.97-29.43c-.08-.04-.17-.06-.24-.1-.8-.44-1.64-.79-2.51-1.03-.14-.04-.27-.06-.41-.09-.81-.19-1.64-.3-2.47-.32-.13,0-.26-.02-.39-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.76.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.06,5.68-31.9,0-9.84-5.68-15.96-16.27-15.96-27.63v-29.43c0-.95-.15-1.87-.37-2.76-.05-.19-.09-.37-.14-.56-.25-.86-.59-1.69-1.03-2.47-.07-.12-.15-.22-.22-.34-.43-.71-.94-1.37-1.51-1.97-.1-.1-.18-.21-.28-.31-.65-.63-1.37-1.18-2.15-1.66-.07-.04-.13-.11-.2-.16l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.25.1.8.44,1.63.79,2.5,1.03.14.04.29.06.43.09.8.19,1.61.3,2.43.32.1,0,.2.04.3.04.04,0,.09-.02.13-.02.88,0,1.77-.13,2.64-.34.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.57-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22Z"></path></svg><span class="text-sm font-medium">Devin</span></div></a><button class="flex items-center rounded-md !text-white cursor-pointer transition-all border bg-blue-500 hover:bg-blue-600 border-blue-500 hover:border-blue-600 dark:bg-blue-900 dark:hover:bg-blue-800 dark:border-blue-900 dark:hover:border-blue-800 disabled:cursor-default disabled:opacity-50 disabled:hover:bg-blue-500 disabled:hover:border-blue-500 dark:disabled:hover:bg-blue-900 dark:disabled:hover:border-blue-900 gap-1.5 px-3 py-1.5 text-sm" aria-label="Share"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg><span>Share</span></button><button class="hover:bg-surface-hover flex h-8 w-8 cursor-pointer items-center justify-center rounded-md transition-colors" aria-label="Switch to dark mode"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-5 w-5 text-gray-700"><path d="M235.54,150.21a104.84,104.84,0,0,1-37,52.91A104,104,0,0,1,32,120,103.09,103.09,0,0,1,52.88,57.48a104.84,104.84,0,0,1,52.91-37,8,8,0,0,1,10,10,88.08,88.08,0,0,0,109.8,109.8,8,8,0,0,1,10,10Z"></path></svg></button></div></div></div></div><!--$--><!--/$--><div class="w-full flex-1"><div class="container-wrapper relative mx-auto h-full px-0"><div class="container relative mx-auto flex h-full w-full flex-col gap-0 max-md:!px-0 md:flex-row md:gap-6 lg:gap-10"><div class="border-r-border hidden max-h-screen border-r border-dashed py-6 pr-4 transition-[border-radius] md:sticky md:left-0 md:top-20 md:block md:h-[calc(100vh-82px)] md:w-64 md:flex-shrink-0 md:overflow-y-auto lg:py-9 xl:w-72"><div class="flex h-full w-full max-w-full flex-shrink-0 flex-col overflow-hidden" style="scrollbar-color: var(--color-border) transparent;"><div class="flex-shrink-0 px-2"><div class="text-secondary pb-1 text-xs">Last indexed: 18 September 2025 (<a href="https://github.com/letrogthien/e-com-chuadatten/commits/35018ebc" target="_blank" rel="noopener noreferrer">35018e</a>)</div></div><ul class="flex-1 flex-shrink-0 space-y-1 overflow-y-auto py-1" style="scrollbar-width: none;"><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/1-overview">Overview</a></li><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/2-system-architecture">System Architecture</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/2.1-microservices-overview">Microservices Overview</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/2.2-event-driven-architecture">Event-Driven Architecture</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/2.3-authentication-and-security">Authentication &amp; Security</a></li><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/3-core-services">Core Services</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.1-transaction-service">Transaction Service</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.2-product-service">Product Service</a></li><li style="padding-left: 12px;"><a data-selected="true" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service">Wallet Service</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.4-user-service">User Service</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.5-notification-service">Notification Service</a></li><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/4-core-business-processes">Core Business Processes</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/4.1-payment-processing">Payment Processing</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/4.2-order-lifecycle">Order Lifecycle</a></li><li style="padding-left: 12px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/4.3-event-system">Event System</a></li><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/5-database-design">Database Design</a></li><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/6-api-reference">API Reference</a></li><li style="padding-left: 0px;"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="https://deepwiki.com/letrogthien/e-com-chuadatten/7-development-setup">Development Setup</a></li></ul></div></div><div class="flex h-full flex-1 flex-col overflow-hidden"><div class="bg-background border-b-border sticky top-0 z-10 border-b border-dashed md:hidden"><div class="flex cursor-pointer items-center gap-2 p-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="transition-transform"><path d="M184.49,136.49l-80,80a12,12,0,0,1-17-17L159,128,87.51,56.49a12,12,0,1,1,17-17l80,80A12,12,0,0,1,184.49,136.49Z"></path></svg><span class="truncate text-base font-normal">Menu</span></div></div><div class="relative flex-1 overflow-y-auto px-3 pt-3 md:rounded-md md:px-0 md:pt-0 [&amp;_::selection]:bg-purple-500/40" style="scrollbar-color: var(--color-night) transparent;"><div class="pb-30 mx-auto max-w-2xl md:pb-40 md:pt-6 lg:pt-8"><div class="prose prose-invert dark:prose-invert prose-headings:text-inherit prose-p:text-inherit max-w-none"><div><div class="prose-custom prose-custom-md prose-custom-gray !max-w-none text-neutral-300 [overflow-wrap:anywhere]"><h1 id="wallet-service" class="group" data-header="true">Wallet Service<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h1>
<details>
<summary>Relevant source files</summary>
<ul>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/db.sql" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/db.sql</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/common/Status.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/common/Status.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/entity/Payment.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/entity/Payment.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java</span></a></li>
<li><a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/resources/payment.yaml" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/resources/payment.yaml</span></a></li>
</ul>
</details>
<p>The Wallet Service manages digital wallets, payment processing, and bank account operations within the e-commerce platform. It handles wallet balance management, payment transactions through external gateways (primarily VNPAY), wallet reservations for orders, and withdrawal requests to bank accounts. The service publishes payment events to other services via Kafka and maintains comprehensive transaction logs for financial auditing.</p>
<p>For order processing workflows that interact with wallets, see <a href="https://deepwiki.com/letrogthien/e-com-chuadatten/4.2-order-lifecycle" class="text-neutral-300 hover:text-neutral-200 hover:underline">Order Lifecycle</a>. For complete payment flow documentation, see <a href="https://deepwiki.com/letrogthien/e-com-chuadatten/4.1-payment-processing" class="text-neutral-300 hover:text-neutral-200 hover:underline">Payment Processing</a>.</p>
<h2 id="core-components" class="group" data-header="true">Core Components<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>The Wallet Service is built around five main entity types that handle different aspects of financial operations:</p>
<h3 id="entity-architecture" class="group" data-header="true">Entity Architecture<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r17" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="er" role="graphics-document document" viewBox="0.0000152587890625 0.000003814697265625 1344.706298828125 1256.500244140625" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="erDiagram" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-w1eavz90qho" preserveAspectRatio="xMidYMid meet"><style>#mermaid-w1eavz90qho{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-w1eavz90qho .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-w1eavz90qho .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-w1eavz90qho .error-icon{fill:#dddddd;}#mermaid-w1eavz90qho .error-text{fill:#222222;stroke:#222222;}#mermaid-w1eavz90qho .edge-thickness-normal{stroke-width:1px;}#mermaid-w1eavz90qho .edge-thickness-thick{stroke-width:3.5px;}#mermaid-w1eavz90qho .edge-pattern-solid{stroke-dasharray:0;}#mermaid-w1eavz90qho .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-w1eavz90qho .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-w1eavz90qho .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-w1eavz90qho .marker{fill:#999;stroke:#999;}#mermaid-w1eavz90qho .marker.cross{stroke:#999;}#mermaid-w1eavz90qho svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-w1eavz90qho p{margin:0;}#mermaid-w1eavz90qho .entityBox{fill:#ffffff;stroke:#dddddd;}#mermaid-w1eavz90qho .relationshipLabelBox{fill:#dddddd;opacity:0.7;background-color:#dddddd;}#mermaid-w1eavz90qho .relationshipLabelBox rect{opacity:0.5;}#mermaid-w1eavz90qho .labelBkg{background-color:rgba(221, 221, 221, 0.5);}#mermaid-w1eavz90qho .edgeLabel .label{fill:#dddddd;font-size:14px;}#mermaid-w1eavz90qho .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-w1eavz90qho .edge-pattern-dashed{stroke-dasharray:8,8;}#mermaid-w1eavz90qho .node rect,#mermaid-w1eavz90qho .node circle,#mermaid-w1eavz90qho .node ellipse,#mermaid-w1eavz90qho .node polygon{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-w1eavz90qho .relationshipLine{stroke:#999;stroke-width:1;fill:none;}#mermaid-w1eavz90qho .marker{fill:none!important;stroke:#999!important;stroke-width:1;}#mermaid-w1eavz90qho :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerHeight="18" markerWidth="18" refY="9" refX="0" class="marker onlyOne er" id="mermaid-w1eavz90qho_er-onlyOneStart"><path d="M9,0 L9,18 M15,0 L15,18"></path></marker></defs><defs><marker orient="auto" markerHeight="18" markerWidth="18" refY="9" refX="18" class="marker onlyOne er" id="mermaid-w1eavz90qho_er-onlyOneEnd"><path d="M3,0 L3,18 M9,0 L9,18"></path></marker></defs><defs><marker orient="auto" markerHeight="18" markerWidth="30" refY="9" refX="0" class="marker zeroOrOne er" id="mermaid-w1eavz90qho_er-zeroOrOneStart"><circle r="6" cy="9" cx="21" fill="white"></circle><path d="M9,0 L9,18"></path></marker></defs><defs><marker orient="auto" markerHeight="18" markerWidth="30" refY="9" refX="30" class="marker zeroOrOne er" id="mermaid-w1eavz90qho_er-zeroOrOneEnd"><circle r="6" cy="9" cx="9" fill="white"></circle><path d="M21,0 L21,18"></path></marker></defs><defs><marker orient="auto" markerHeight="36" markerWidth="45" refY="18" refX="18" class="marker oneOrMore er" id="mermaid-w1eavz90qho_er-oneOrMoreStart"><path d="M0,18 Q 18,0 36,18 Q 18,36 0,18 M42,9 L42,27"></path></marker></defs><defs><marker orient="auto" markerHeight="36" markerWidth="45" refY="18" refX="27" class="marker oneOrMore er" id="mermaid-w1eavz90qho_er-oneOrMoreEnd"><path d="M3,9 L3,27 M9,18 Q27,0 45,18 Q27,36 9,18"></path></marker></defs><defs><marker orient="auto" markerHeight="36" markerWidth="57" refY="18" refX="18" class="marker zeroOrMore er" id="mermaid-w1eavz90qho_er-zeroOrMoreStart"><circle r="6" cy="18" cx="48" fill="white"></circle><path d="M0,18 Q18,0 36,18 Q18,36 0,18"></path></marker></defs><defs><marker orient="auto" markerHeight="36" markerWidth="57" refY="18" refX="39" class="marker zeroOrMore er" id="mermaid-w1eavz90qho_er-zeroOrMoreEnd"><circle r="6" cy="18" cx="9" fill="white"></circle><path d="M21,18 Q39,0 57,18 Q39,36 21,18"></path></marker></defs><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-w1eavz90qho_er-zeroOrMoreEnd)" marker-start="url(#mermaid-w1eavz90qho_er-onlyOneStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-wallets-0_entity-wallet_transactions-1_0" d="M591.737,407.008L517.585,436.757C443.432,466.505,295.126,526.003,220.974,567.731C146.821,609.458,146.821,633.417,146.821,645.396L146.821,657.375"></path><path marker-end="url(#mermaid-w1eavz90qho_er-zeroOrMoreEnd)" marker-start="url(#mermaid-w1eavz90qho_er-onlyOneStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-wallets-0_entity-wallet_reservations-2_1" d="M591.737,491.07L578.46,506.809C565.182,522.547,538.626,554.023,525.349,606.803C512.071,659.583,512.071,733.667,512.071,770.708L512.071,807.75"></path><path marker-end="url(#mermaid-w1eavz90qho_er-zeroOrMoreEnd)" marker-start="url(#mermaid-w1eavz90qho_er-onlyOneStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-wallets-0_entity-payments-3_2" d="M806.146,491.07L819.424,506.809C832.701,522.547,859.257,554.023,872.535,578.178C885.813,602.333,885.813,619.167,885.813,627.583L885.813,636"></path><path marker-end="url(#mermaid-w1eavz90qho_er-zeroOrMoreEnd)" marker-start="url(#mermaid-w1eavz90qho_er-onlyOneStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-payments-3_entity-payment_attempts-4_3" d="M885.813,1063.5L885.813,1071.917C885.813,1080.333,885.813,1097.167,885.813,1114C885.813,1130.833,885.813,1147.667,885.813,1156.083L885.813,1164.5"></path><path marker-end="url(#mermaid-w1eavz90qho_er-onlyOneEnd)" marker-start="url(#mermaid-w1eavz90qho_er-zeroOrMoreStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-wallets-0_entity-users-5_4" d="M806.146,423.214L855.114,450.262C904.082,477.31,1002.018,531.405,1068.252,595.494C1134.486,659.583,1169.017,733.667,1186.283,770.708L1203.548,807.75"></path><path marker-end="url(#mermaid-w1eavz90qho_er-onlyOneEnd)" marker-start="url(#mermaid-w1eavz90qho_er-zeroOrMoreStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-bank_accounts-6_entity-users-5_5" d="M1264.798,406L1264.798,435.917C1264.798,465.833,1264.798,525.667,1258.956,592.625C1253.115,659.583,1241.432,733.667,1235.59,770.708L1229.749,807.75"></path><path marker-end="url(#mermaid-w1eavz90qho_er-onlyOneEnd)" marker-start="url(#mermaid-w1eavz90qho_er-zeroOrMoreStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-withdrawal_requests-7_entity-wallets-0_6" d="M791.019,92L775.673,100.417C760.326,108.833,729.634,125.667,714.288,142.5C698.942,159.333,698.942,176.167,698.942,184.583L698.942,193"></path><path marker-end="url(#mermaid-w1eavz90qho_er-onlyOneEnd)" marker-start="url(#mermaid-w1eavz90qho_er-zeroOrMoreStart)" style="undefined;" class="edge-thickness-normal edge-pattern-solid relationshipLine" id="id_entity-withdrawal_requests-7_entity-bank_accounts-6_7" d="M959.115,71.312L1010.062,83.177C1061.009,95.042,1162.903,118.771,1213.851,160.552C1264.798,202.333,1264.798,262.167,1264.798,292.083L1264.798,322"></path></g><g class="edgeLabels"><g transform="translate(146.82083129882812, 585.500002861023)" class="edgeLabel"><g transform="translate(-49.150001525878906, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="98.30000305175781"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>logs all changes</p></span></div></foreignobject></g></g><g transform="translate(512.0708312988281, 585.500002861023)" class="edgeLabel"><g transform="translate(-35.97500228881836, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="71.95000457763672"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>holds funds</p></span></div></foreignobject></g></g><g transform="translate(885.8125, 585.500002861023)" class="edgeLabel"><g transform="translate(-40.645835876464844, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="81.29167175292969"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>processes via</p></span></div></foreignobject></g></g><g transform="translate(885.8125, 1114.0000658035278)" class="edgeLabel"><g transform="translate(-47.42500305175781, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="94.85000610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>tracks attempts</p></span></div></foreignobject></g></g><g transform="translate(1099.9541683197021, 585.500002861023)" class="edgeLabel"><g transform="translate(-30.325000762939453, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="60.650001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>owned by</p></span></div></foreignobject></g></g><g transform="translate(1264.7979183197021, 585.500002861023)" class="edgeLabel"><g transform="translate(-33.020835876464844, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="66.04167175292969"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>belongs to</p></span></div></foreignobject></g></g><g transform="translate(698.9416656494141, 142.50000095367432)" class="edgeLabel"><g transform="translate(-47.9083366394043, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="95.8166732788086"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>withdraws from</p></span></div></foreignobject></g></g><g transform="translate(1264.7979183197021, 142.50000095367432)" class="edgeLabel"><g transform="translate(-39.625003814697266, -10.500000953674316)" class="label"><foreignobject height="21.000001907348633" width="79.25000762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>withdraws to</p></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(698.9416656494141, 364.00000190734863)" id="entity-wallets-0" class="node default"><g style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 -171.00000095367432 L107.20417022705078 -171.00000095367432 L107.20417022705078 171.00000095367432 L-107.20417022705078 171.00000095367432"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -171.00000095367432 C-27.22044923144776 -171.00000095367432, 52.76327176415526 -171.00000095367432, 107.20417022705078 -171.00000095367432 M-107.20417022705078 -171.00000095367432 C-56.653937713429244 -171.00000095367432, -6.103705199807706 -171.00000095367432, 107.20417022705078 -171.00000095367432 M107.20417022705078 -171.00000095367432 C107.20417022705078 -58.21654413377112, 107.20417022705078 54.56691268613207, 107.20417022705078 171.00000095367432 M107.20417022705078 -171.00000095367432 C107.20417022705078 -80.45875752568263, 107.20417022705078 10.08248590230906, 107.20417022705078 171.00000095367432 M107.20417022705078 171.00000095367432 C39.436226480393486 171.00000095367432, -28.33171726626381 171.00000095367432, -107.20417022705078 171.00000095367432 M107.20417022705078 171.00000095367432 C30.74196342554177 171.00000095367432, -45.72024337596724 171.00000095367432, -107.20417022705078 171.00000095367432 M-107.20417022705078 171.00000095367432 C-107.20417022705078 35.71800231607526, -107.20417022705078 -99.5639963215238, -107.20417022705078 -171.00000095367432 M-107.20417022705078 171.00000095367432 C-107.20417022705078 88.4601646722788, -107.20417022705078 5.92032839088327, -107.20417022705078 -171.00000095367432"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 -42.74999523162842 L107.20417022705078 -42.74999523162842 L107.20417022705078 0.00000667572021484375 L-107.20417022705078 0.00000667572021484375"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -42.74999523162842 C-60.98941623550831 -42.74999523162842, -14.774662243965835 -42.74999523162842, 107.20417022705078 -42.74999523162842 M-107.20417022705078 -42.74999523162842 C-49.14693935877593 -42.74999523162842, 8.910291509498919 -42.74999523162842, 107.20417022705078 -42.74999523162842 M107.20417022705078 -42.74999523162842 C107.20417022705078 -27.7093917461167, 107.20417022705078 -12.66878826060498, 107.20417022705078 0.00000667572021484375 M107.20417022705078 -42.74999523162842 C107.20417022705078 -30.72784348287324, 107.20417022705078 -18.705691734118066, 107.20417022705078 0.00000667572021484375 M107.20417022705078 0.00000667572021484375 C44.88376997200123 0.00000667572021484375, -17.436630283048316 0.00000667572021484375, -107.20417022705078 0.00000667572021484375 M107.20417022705078 0.00000667572021484375 C54.98873218767845 0.00000667572021484375, 2.773294148306121 0.00000667572021484375, -107.20417022705078 0.00000667572021484375 M-107.20417022705078 0.00000667572021484375 C-107.20417022705078 -14.368977425393044, -107.20417022705078 -28.737961526506304, -107.20417022705078 -42.74999523162842 M-107.20417022705078 0.00000667572021484375 C-107.20417022705078 -15.011992199498955, -107.20417022705078 -30.023991074718126, -107.20417022705078 -42.74999523162842"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 0.00000667572021484375 L107.20417022705078 0.00000667572021484375 L107.20417022705078 42.75000858306885 L-107.20417022705078 42.75000858306885"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 0.00000667572021484375 C-32.51472629642262 0.00000667572021484375, 42.174717634205535 0.00000667572021484375, 107.20417022705078 0.00000667572021484375 M-107.20417022705078 0.00000667572021484375 C-63.93183699078419 0.00000667572021484375, -20.6595037545176 0.00000667572021484375, 107.20417022705078 0.00000667572021484375 M107.20417022705078 0.00000667572021484375 C107.20417022705078 10.368210011684951, 107.20417022705078 20.736413347649687, 107.20417022705078 42.75000858306885 M107.20417022705078 0.00000667572021484375 C107.20417022705078 16.0811491833132, 107.20417022705078 32.16229169090619, 107.20417022705078 42.75000858306885 M107.20417022705078 42.75000858306885 C22.305887670753705 42.75000858306885, -62.59239488554337 42.75000858306885, -107.20417022705078 42.75000858306885 M107.20417022705078 42.75000858306885 C47.230580873195215 42.75000858306885, -12.74300848066035 42.75000858306885, -107.20417022705078 42.75000858306885 M-107.20417022705078 42.75000858306885 C-107.20417022705078 32.01063693528618, -107.20417022705078 21.271265287503514, -107.20417022705078 0.00000667572021484375 M-107.20417022705078 42.75000858306885 C-107.20417022705078 30.950331433854227, -107.20417022705078 19.150654284639607, -107.20417022705078 0.00000667572021484375"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 42.75000858306885 L107.20417022705078 42.75000858306885 L107.20417022705078 85.50001049041748 L-107.20417022705078 85.50001049041748"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 42.75000858306885 C-40.79200856824309 42.75000858306885, 25.6201530905646 42.75000858306885, 107.20417022705078 42.75000858306885 M-107.20417022705078 42.75000858306885 C-61.97600531847837 42.75000858306885, -16.74784040990596 42.75000858306885, 107.20417022705078 42.75000858306885 M107.20417022705078 42.75000858306885 C107.20417022705078 52.59305406969591, 107.20417022705078 62.43609955632298, 107.20417022705078 85.50001049041748 M107.20417022705078 42.75000858306885 C107.20417022705078 55.23843398567775, 107.20417022705078 67.72685938828666, 107.20417022705078 85.50001049041748 M107.20417022705078 85.50001049041748 C56.11788406248923 85.50001049041748, 5.031597897927682 85.50001049041748, -107.20417022705078 85.50001049041748 M107.20417022705078 85.50001049041748 C24.560032959328353 85.50001049041748, -58.084104308394075 85.50001049041748, -107.20417022705078 85.50001049041748 M-107.20417022705078 85.50001049041748 C-107.20417022705078 71.24305706234553, -107.20417022705078 56.98610363427357, -107.20417022705078 42.75000858306885 M-107.20417022705078 85.50001049041748 C-107.20417022705078 75.92306062615138, -107.20417022705078 66.34611076188527, -107.20417022705078 42.75000858306885"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 85.50001049041748 L107.20417022705078 85.50001049041748 L107.20417022705078 128.2500123977661 L-107.20417022705078 128.2500123977661"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 85.50001049041748 C-39.401212504600664 85.50001049041748, 28.401745217849452 85.50001049041748, 107.20417022705078 85.50001049041748 M-107.20417022705078 85.50001049041748 C-23.437482846021794 85.50001049041748, 60.32920453500719 85.50001049041748, 107.20417022705078 85.50001049041748 M107.20417022705078 85.50001049041748 C107.20417022705078 101.4735206850153, 107.20417022705078 117.44703087961314, 107.20417022705078 128.2500123977661 M107.20417022705078 85.50001049041748 C107.20417022705078 94.09860564337012, 107.20417022705078 102.69720079632276, 107.20417022705078 128.2500123977661 M107.20417022705078 128.2500123977661 C46.68478711646281 128.2500123977661, -13.834595994125166 128.2500123977661, -107.20417022705078 128.2500123977661 M107.20417022705078 128.2500123977661 C28.75109773102551 128.2500123977661, -49.70197476499976 128.2500123977661, -107.20417022705078 128.2500123977661 M-107.20417022705078 128.2500123977661 C-107.20417022705078 117.62057794911418, -107.20417022705078 106.99114350046226, -107.20417022705078 85.50001049041748 M-107.20417022705078 128.2500123977661 C-107.20417022705078 114.67738294996347, -107.20417022705078 101.10475350216085, -107.20417022705078 85.50001049041748"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 128.2500123977661 L107.20417022705078 128.2500123977661 L107.20417022705078 171.00001430511475 L-107.20417022705078 171.00001430511475"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 128.2500123977661 C-23.920038425362193 128.2500123977661, 59.364093376326394 128.2500123977661, 107.20417022705078 128.2500123977661 M-107.20417022705078 128.2500123977661 C-44.19554799069906 128.2500123977661, 18.813074245652658 128.2500123977661, 107.20417022705078 128.2500123977661 M107.20417022705078 128.2500123977661 C107.20417022705078 144.69104576977725, 107.20417022705078 161.13207914178835, 107.20417022705078 171.00001430511475 M107.20417022705078 128.2500123977661 C107.20417022705078 137.69410119523863, 107.20417022705078 147.13818999271112, 107.20417022705078 171.00001430511475 M107.20417022705078 171.00001430511475 C53.48328884646513 171.00001430511475, -0.23759253412052317 171.00001430511475, -107.20417022705078 171.00001430511475 M107.20417022705078 171.00001430511475 C55.171076844372934 171.00001430511475, 3.137983461695086 171.00001430511475, -107.20417022705078 171.00001430511475 M-107.20417022705078 171.00001430511475 C-107.20417022705078 158.8682605992514, -107.20417022705078 146.73650689338805, -107.20417022705078 128.2500123977661 M-107.20417022705078 171.00001430511475 C-107.20417022705078 159.46060202898715, -107.20417022705078 147.92118975285956, -107.20417022705078 128.2500123977661"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-107.20417022705078 -128.24999904632568 L107.20417022705078 -128.24999904632568 L107.20417022705078 -85.49999713897705 L-107.20417022705078 -85.49999713897705"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -128.24999904632568 C-50.518090313553806 -128.24999904632568, 6.167989599943169 -128.24999904632568, 107.20417022705078 -128.24999904632568 M-107.20417022705078 -128.24999904632568 C-28.061773185666496 -128.24999904632568, 51.08062385571779 -128.24999904632568, 107.20417022705078 -128.24999904632568 M107.20417022705078 -128.24999904632568 C107.20417022705078 -117.3148777782639, 107.20417022705078 -106.37975651020213, 107.20417022705078 -85.49999713897705 M107.20417022705078 -128.24999904632568 C107.20417022705078 -114.70845912398309, 107.20417022705078 -101.1669192016405, 107.20417022705078 -85.49999713897705 M107.20417022705078 -85.49999713897705 C52.43762652599144 -85.49999713897705, -2.3289171750679003 -85.49999713897705, -107.20417022705078 -85.49999713897705 M107.20417022705078 -85.49999713897705 C63.26981324681319 -85.49999713897705, 19.335456266575605 -85.49999713897705, -107.20417022705078 -85.49999713897705 M-107.20417022705078 -85.49999713897705 C-107.20417022705078 -97.26877226836481, -107.20417022705078 -109.03754739775258, -107.20417022705078 -128.24999904632568 M-107.20417022705078 -85.49999713897705 C-107.20417022705078 -95.87401239625146, -107.20417022705078 -106.24802765352588, -107.20417022705078 -128.24999904632568"></path></g><g style="" transform="translate(-24.01666831970215, -161.62500095367432)" class="label name"><foreignobject height="24.000001907348633" width="48.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 153px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>wallets</p></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, -118.87499904632568)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, -118.87499904632568)" class="label attribute-name"><foreignobject height="24.000001907348633" width="13.30000114440918"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 113px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>id</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, -118.87499904632568)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="18.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 121px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PK</p></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, -118.87499904632568)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, -76.12499713897705)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, -76.12499713897705)" class="label attribute-name"><foreignobject height="24.000001907348633" width="49.716670989990234"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 154px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>user_id</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, -76.12499713897705)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="17.100000381469727"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 120px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>FK</p></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, -76.12499713897705)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, -33.37499523162842)" class="label attribute-type"><foreignobject height="24.000001907348633" width="38.775001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 142px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>char3</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, -33.37499523162842)" class="label attribute-name"><foreignobject height="24.000001907348633" width="60.125003814697266"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 163px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>currency</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, -33.37499523162842)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, -33.37499523162842)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, 9.375006675720215)" class="label attribute-type"><foreignobject height="24.000001907348633" width="41.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 141px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bigint</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, 9.375006675720215)" class="label attribute-name"><foreignobject height="24.000001907348633" width="54.375003814697266"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 158px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>balance</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, 9.375006675720215)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, 9.375006675720215)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, 52.12500858306885)" class="label attribute-type"><foreignobject height="24.000001907348633" width="41.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 141px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bigint</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, 52.12500858306885)" class="label attribute-name"><foreignobject height="24.000001907348633" width="60.10833740234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 163px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>reserved</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, 52.12500858306885)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, 52.12500858306885)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, 94.87501049041748)" class="label attribute-type"><foreignobject height="24.000001907348633" width="41.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 141px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bigint</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, 94.87501049041748)" class="label attribute-name"><foreignobject height="24.000001907348633" width="50.69166946411133"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 153px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>version</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, 94.87501049041748)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, 94.87501049041748)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-94.70417022705078, 137.6250123977661)" class="label attribute-type"><foreignobject height="24.000001907348633" width="44.45000076293945"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 146px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>tinyint</p></span></div></foreignobject></g><g style="" transform="translate(-8.670833587646484, 137.6250123977661)" class="label attribute-name"><foreignobject height="24.000001907348633" width="41.625003814697266"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 146px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>status</p></span></div></foreignobject></g><g style="" transform="translate(76.45417022705078, 137.6250123977661)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(119.70417022705078, 137.6250123977661)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -128.24999904632568 C-58.10179799999794 -128.24999904632568, -8.999425772945102 -128.24999904632568, 107.20417022705078 -128.24999904632568 M-107.20417022705078 -128.24999904632568 C-35.55261087599469 -128.24999904632568, 36.098948475061405 -128.24999904632568, 107.20417022705078 -128.24999904632568"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-21.170833587646484 -128.24999904632568 C-21.170833587646484 -41.44794810524934, -21.170833587646484 45.35410283582701, -21.170833587646484 171.00000095367432 M-21.170833587646484 -128.24999904632568 C-21.170833587646484 -45.47202122787016, -21.170833587646484 37.30595659058537, -21.170833587646484 171.00000095367432"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M63.95417022705078 -128.24999904632568 C63.95417022705078 -49.65105678337093, 63.95417022705078 28.947885479583817, 63.95417022705078 171.00000095367432 M63.95417022705078 -128.24999904632568 C63.95417022705078 -44.93083439709541, 63.95417022705078 38.388330252134864, 63.95417022705078 171.00000095367432"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -85.49999713897705 C-45.335022368606886 -85.49999713897705, 16.53412548983701 -85.49999713897705, 107.20417022705078 -85.49999713897705 M-107.20417022705078 -85.49999713897705 C-56.34959684914696 -85.49999713897705, -5.495023471243144 -85.49999713897705, 107.20417022705078 -85.49999713897705"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -42.74999523162842 C-49.50739274929418 -42.74999523162842, 8.189384728462414 -42.74999523162842, 107.20417022705078 -42.74999523162842 M-107.20417022705078 -42.74999523162842 C-58.946401429620764 -42.74999523162842, -10.688632632190746 -42.74999523162842, 107.20417022705078 -42.74999523162842"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 0.00000667572021484375 C-50.96447382641113 0.00000667572021484375, 5.275222574228522 0.00000667572021484375, 107.20417022705078 0.00000667572021484375 M-107.20417022705078 0.00000667572021484375 C-35.5704429502903 0.00000667572021484375, 36.06328432647018 0.00000667572021484375, 107.20417022705078 0.00000667572021484375"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 42.75000858306885 C-62.22805351420319 42.75000858306885, -17.251936801355598 42.75000858306885, 107.20417022705078 42.75000858306885 M-107.20417022705078 42.75000858306885 C-45.63619541904426 42.75000858306885, 15.931779388962255 42.75000858306885, 107.20417022705078 42.75000858306885"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 85.50001049041748 C-35.003492415316714 85.50001049041748, 37.19718539641735 85.50001049041748, 107.20417022705078 85.50001049041748 M-107.20417022705078 85.50001049041748 C-43.276250901413455 85.50001049041748, 20.65166842422387 85.50001049041748, 107.20417022705078 85.50001049041748"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 128.2500123977661 C-23.902565369944554 128.2500123977661, 59.39903948716167 128.2500123977661, 107.20417022705078 128.2500123977661 M-107.20417022705078 128.2500123977661 C-25.38525127024667 128.2500123977661, 56.43366768655744 128.2500123977661, 107.20417022705078 128.2500123977661"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-107.20417022705078 -128.24999904632568 C-39.238259616029524 -128.24999904632568, 28.727650994991734 -128.24999904632568, 107.20417022705078 -128.24999904632568 M-107.20417022705078 -128.24999904632568 C-23.397673097715582 -128.24999904632568, 60.408824031619616 -128.24999904632568, 107.20417022705078 -128.24999904632568"></path></g></g><g transform="translate(146.82083129882812, 849.7500343322754)" id="entity-wallet_transactions-1" class="node default"><g style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 -192.37501621246338 L138.82083892822266 -192.37501621246338 L138.82083892822266 192.37501621246338 L-138.82083892822266 192.37501621246338"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -192.37501621246338 C-37.97603330104785 -192.37501621246338, 62.86877232612696 -192.37501621246338, 138.82083892822266 -192.37501621246338 M-138.82083892822266 -192.37501621246338 C-80.16867117814323 -192.37501621246338, -21.516503428063814 -192.37501621246338, 138.82083892822266 -192.37501621246338 M138.82083892822266 -192.37501621246338 C138.82083892822266 -40.74910350156517, 138.82083892822266 110.87680920933303, 138.82083892822266 192.37501621246338 M138.82083892822266 -192.37501621246338 C138.82083892822266 -103.07703028917732, 138.82083892822266 -13.779044365891252, 138.82083892822266 192.37501621246338 M138.82083892822266 192.37501621246338 C34.451441312595634 192.37501621246338, -69.91795630303139 192.37501621246338, -138.82083892822266 192.37501621246338 M138.82083892822266 192.37501621246338 C64.64084493456723 192.37501621246338, -9.539149059088203 192.37501621246338, -138.82083892822266 192.37501621246338 M-138.82083892822266 192.37501621246338 C-138.82083892822266 43.164592716378905, -138.82083892822266 -106.04583077970557, -138.82083892822266 -192.37501621246338 M-138.82083892822266 192.37501621246338 C-138.82083892822266 79.2649635880017, -138.82083892822266 -33.84508903645997, -138.82083892822266 -192.37501621246338"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 -64.12501049041748 L138.82083892822266 -64.12501049041748 L138.82083892822266 -21.375008583068848 L-138.82083892822266 -21.375008583068848"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -64.12501049041748 C-61.87659709502266 -64.12501049041748, 15.067644738177336 -64.12501049041748, 138.82083892822266 -64.12501049041748 M-138.82083892822266 -64.12501049041748 C-56.678955735855126 -64.12501049041748, 25.462927456512404 -64.12501049041748, 138.82083892822266 -64.12501049041748 M138.82083892822266 -64.12501049041748 C138.82083892822266 -52.967552003523295, 138.82083892822266 -41.81009351662911, 138.82083892822266 -21.375008583068848 M138.82083892822266 -64.12501049041748 C138.82083892822266 -49.68708943528996, 138.82083892822266 -35.249168380162445, 138.82083892822266 -21.375008583068848 M138.82083892822266 -21.375008583068848 C79.92144391530573 -21.375008583068848, 21.022048902388818 -21.375008583068848, -138.82083892822266 -21.375008583068848 M138.82083892822266 -21.375008583068848 C78.76055014055656 -21.375008583068848, 18.700261352890465 -21.375008583068848, -138.82083892822266 -21.375008583068848 M-138.82083892822266 -21.375008583068848 C-138.82083892822266 -36.26240787814352, -138.82083892822266 -51.14980717321819, -138.82083892822266 -64.12501049041748 M-138.82083892822266 -21.375008583068848 C-138.82083892822266 -30.070737987124687, -138.82083892822266 -38.76646739118053, -138.82083892822266 -64.12501049041748"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 -21.375008583068848 L138.82083892822266 -21.375008583068848 L138.82083892822266 21.374993324279785 L-138.82083892822266 21.374993324279785"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -21.375008583068848 C-36.67095289128183 -21.375008583068848, 65.478933145659 -21.375008583068848, 138.82083892822266 -21.375008583068848 M-138.82083892822266 -21.375008583068848 C-34.46758086121508 -21.375008583068848, 69.88567720579249 -21.375008583068848, 138.82083892822266 -21.375008583068848 M138.82083892822266 -21.375008583068848 C138.82083892822266 -4.419500264720252, 138.82083892822266 12.536008053628343, 138.82083892822266 21.374993324279785 M138.82083892822266 -21.375008583068848 C138.82083892822266 -11.699465018271926, 138.82083892822266 -2.0239214534750047, 138.82083892822266 21.374993324279785 M138.82083892822266 21.374993324279785 C30.132991394628917 21.374993324279785, -78.55485613896482 21.374993324279785, -138.82083892822266 21.374993324279785 M138.82083892822266 21.374993324279785 C63.724437754428365 21.374993324279785, -11.371963419365926 21.374993324279785, -138.82083892822266 21.374993324279785 M-138.82083892822266 21.374993324279785 C-138.82083892822266 10.408473119296637, -138.82083892822266 -0.5580470856865105, -138.82083892822266 -21.375008583068848 M-138.82083892822266 21.374993324279785 C-138.82083892822266 5.274840848119524, -138.82083892822266 -10.825311628040737, -138.82083892822266 -21.375008583068848"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 21.374993324279785 L138.82083892822266 21.374993324279785 L138.82083892822266 64.12499523162842 L-138.82083892822266 64.12499523162842"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 21.374993324279785 C-73.36973745021304 21.374993324279785, -7.918635972203418 21.374993324279785, 138.82083892822266 21.374993324279785 M-138.82083892822266 21.374993324279785 C-28.483538486835855 21.374993324279785, 81.85376195455095 21.374993324279785, 138.82083892822266 21.374993324279785 M138.82083892822266 21.374993324279785 C138.82083892822266 33.01171043124615, 138.82083892822266 44.648427538212516, 138.82083892822266 64.12499523162842 M138.82083892822266 21.374993324279785 C138.82083892822266 31.093136275802884, 138.82083892822266 40.81127922732598, 138.82083892822266 64.12499523162842 M138.82083892822266 64.12499523162842 C77.45167126357714 64.12499523162842, 16.08250359893161 64.12499523162842, -138.82083892822266 64.12499523162842 M138.82083892822266 64.12499523162842 C73.21650223724156 64.12499523162842, 7.6121655462604565 64.12499523162842, -138.82083892822266 64.12499523162842 M-138.82083892822266 64.12499523162842 C-138.82083892822266 54.4647821501172, -138.82083892822266 44.80456906860599, -138.82083892822266 21.374993324279785 M-138.82083892822266 64.12499523162842 C-138.82083892822266 51.53200764205408, -138.82083892822266 38.939020052479755, -138.82083892822266 21.374993324279785"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 64.12499523162842 L138.82083892822266 64.12499523162842 L138.82083892822266 106.87499713897705 L-138.82083892822266 106.87499713897705"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 64.12499523162842 C-49.66833456718514 64.12499523162842, 39.484169793852374 64.12499523162842, 138.82083892822266 64.12499523162842 M-138.82083892822266 64.12499523162842 C-66.02726132131357 64.12499523162842, 6.766316285595508 64.12499523162842, 138.82083892822266 64.12499523162842 M138.82083892822266 64.12499523162842 C138.82083892822266 76.8535637610797, 138.82083892822266 89.58213229053098, 138.82083892822266 106.87499713897705 M138.82083892822266 64.12499523162842 C138.82083892822266 72.976979808636, 138.82083892822266 81.82896438564359, 138.82083892822266 106.87499713897705 M138.82083892822266 106.87499713897705 C67.2220609582061 106.87499713897705, -4.376717011810456 106.87499713897705, -138.82083892822266 106.87499713897705 M138.82083892822266 106.87499713897705 C36.06372647994104 106.87499713897705, -66.69338596834058 106.87499713897705, -138.82083892822266 106.87499713897705 M-138.82083892822266 106.87499713897705 C-138.82083892822266 98.23216574976557, -138.82083892822266 89.5893343605541, -138.82083892822266 64.12499523162842 M-138.82083892822266 106.87499713897705 C-138.82083892822266 94.40152169170574, -138.82083892822266 81.92804624443444, -138.82083892822266 64.12499523162842"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 106.87499713897705 L138.82083892822266 106.87499713897705 L138.82083892822266 149.62499904632568 L-138.82083892822266 149.62499904632568"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 106.87499713897705 C-43.53518702989497 106.87499713897705, 51.750464868432715 106.87499713897705, 138.82083892822266 106.87499713897705 M-138.82083892822266 106.87499713897705 C-47.68593018469713 106.87499713897705, 43.4489785588284 106.87499713897705, 138.82083892822266 106.87499713897705 M138.82083892822266 106.87499713897705 C138.82083892822266 116.32428040606207, 138.82083892822266 125.7735636731471, 138.82083892822266 149.62499904632568 M138.82083892822266 106.87499713897705 C138.82083892822266 122.21115309633225, 138.82083892822266 137.54730905368746, 138.82083892822266 149.62499904632568 M138.82083892822266 149.62499904632568 C82.1355947176196 149.62499904632568, 25.450350507016537 149.62499904632568, -138.82083892822266 149.62499904632568 M138.82083892822266 149.62499904632568 C70.52979516271277 149.62499904632568, 2.23875139720289 149.62499904632568, -138.82083892822266 149.62499904632568 M-138.82083892822266 149.62499904632568 C-138.82083892822266 136.10121404272735, -138.82083892822266 122.577429039129, -138.82083892822266 106.87499713897705 M-138.82083892822266 149.62499904632568 C-138.82083892822266 136.19222637904087, -138.82083892822266 122.75945371175608, -138.82083892822266 106.87499713897705"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 149.62499904632568 L138.82083892822266 149.62499904632568 L138.82083892822266 192.37500095367432 L-138.82083892822266 192.37500095367432"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 149.62499904632568 C-47.76914923082816 149.62499904632568, 43.28254046656633 149.62499904632568, 138.82083892822266 149.62499904632568 M-138.82083892822266 149.62499904632568 C-75.4417017180595 149.62499904632568, -12.062564507896354 149.62499904632568, 138.82083892822266 149.62499904632568 M138.82083892822266 149.62499904632568 C138.82083892822266 163.2933617244486, 138.82083892822266 176.96172440257155, 138.82083892822266 192.37500095367432 M138.82083892822266 149.62499904632568 C138.82083892822266 159.68343113869972, 138.82083892822266 169.74186323107375, 138.82083892822266 192.37500095367432 M138.82083892822266 192.37500095367432 C42.01912127685685 192.37500095367432, -54.782596374508955 192.37500095367432, -138.82083892822266 192.37500095367432 M138.82083892822266 192.37500095367432 C80.1270810333854 192.37500095367432, 21.433323138548147 192.37500095367432, -138.82083892822266 192.37500095367432 M-138.82083892822266 192.37500095367432 C-138.82083892822266 182.94444106263745, -138.82083892822266 173.51388117160056, -138.82083892822266 149.62499904632568 M-138.82083892822266 192.37500095367432 C-138.82083892822266 177.7988241355445, -138.82083892822266 163.22264731741464, -138.82083892822266 149.62499904632568"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-138.82083892822266 -149.62501430511475 L138.82083892822266 -149.62501430511475 L138.82083892822266 -106.87501239776611 L-138.82083892822266 -106.87501239776611"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -149.62501430511475 C-69.57199112242243 -149.62501430511475, -0.3231433166222075 -149.62501430511475, 138.82083892822266 -149.62501430511475 M-138.82083892822266 -149.62501430511475 C-67.84884977689946 -149.62501430511475, 3.1231393744237437 -149.62501430511475, 138.82083892822266 -149.62501430511475 M138.82083892822266 -149.62501430511475 C138.82083892822266 -138.1416472014983, 138.82083892822266 -126.65828009788186, 138.82083892822266 -106.87501239776611 M138.82083892822266 -149.62501430511475 C138.82083892822266 -134.89424971196482, 138.82083892822266 -120.16348511881489, 138.82083892822266 -106.87501239776611 M138.82083892822266 -106.87501239776611 C56.380278491915675 -106.87501239776611, -26.060281944391306 -106.87501239776611, -138.82083892822266 -106.87501239776611 M138.82083892822266 -106.87501239776611 C38.30963820339822 -106.87501239776611, -62.20156252142621 -106.87501239776611, -138.82083892822266 -106.87501239776611 M-138.82083892822266 -106.87501239776611 C-138.82083892822266 -119.74122193250753, -138.82083892822266 -132.60743146724894, -138.82083892822266 -149.62501430511475 M-138.82083892822266 -106.87501239776611 C-138.82083892822266 -116.33699550869584, -138.82083892822266 -125.79897861962556, -138.82083892822266 -149.62501430511475"></path></g><g style="" transform="translate(-66.45000457763672, -183.00001621246338)" class="label name"><foreignobject height="24.000001907348633" width="132.90000915527344"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 245px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>wallet_transactions</p></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, -140.25001430511475)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, -140.25001430511475)" class="label attribute-name"><foreignobject height="24.000001907348633" width="13.30000114440918"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 113px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>id</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, -140.25001430511475)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="18.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 121px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PK</p></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, -140.25001430511475)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, -97.50001239776611)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, -97.50001239776611)" class="label attribute-name"><foreignobject height="24.000001907348633" width="61.1833381652832"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 167px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>wallet_id</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, -97.50001239776611)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="17.100000381469727"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 120px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>FK</p></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, -97.50001239776611)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, -54.75001049041748)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, -54.75001049041748)" class="label attribute-name"><foreignobject height="24.000001907348633" width="115.62500762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 224px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>related_entity_id</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, -54.75001049041748)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, -54.75001049041748)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, -12.000008583068848)" class="label attribute-type"><foreignobject height="24.000001907348633" width="68.76667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 175px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>varchar40</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, -12.000008583068848)" class="label attribute-name"><foreignobject height="24.000001907348633" width="30.941667556762695"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 133px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>type</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, -12.000008583068848)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, -12.000008583068848)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, 30.749993324279785)" class="label attribute-type"><foreignobject height="24.000001907348633" width="41.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 141px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bigint</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, 30.749993324279785)" class="label attribute-name"><foreignobject height="24.000001907348633" width="54.833335876464844"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 156px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>amount</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, 30.749993324279785)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, 30.749993324279785)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, 73.49999523162842)" class="label attribute-type"><foreignobject height="24.000001907348633" width="44.45000076293945"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 146px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>tinyint</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, 73.49999523162842)" class="label attribute-name"><foreignobject height="24.000001907348633" width="62.35000228881836"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 164px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>direction</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, 73.49999523162842)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, 73.49999523162842)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, 116.24999713897705)" class="label attribute-type"><foreignobject height="24.000001907348633" width="41.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 141px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bigint</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, 116.24999713897705)" class="label attribute-name"><foreignobject height="24.000001907348633" width="93.51667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 202px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>balance_after</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, 116.24999713897705)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, 116.24999713897705)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-126.32083892822266, 158.99999904632568)" class="label attribute-type"><foreignobject height="24.000001907348633" width="68.76667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 175px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>varchar30</p></span></div></foreignobject></g><g style="" transform="translate(-32.554168701171875, 158.99999904632568)" class="label attribute-name"><foreignobject height="24.000001907348633" width="41.625003814697266"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 146px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>status</p></span></div></foreignobject></g><g style="" transform="translate(108.07083892822266, 158.99999904632568)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(151.32083892822266, 158.99999904632568)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -149.62501430511475 C-62.96522739084449 -149.62501430511475, 12.890384146533677 -149.62501430511475, 138.82083892822266 -149.62501430511475 M-138.82083892822266 -149.62501430511475 C-33.187683647510326 -149.62501430511475, 72.445471633202 -149.62501430511475, 138.82083892822266 -149.62501430511475"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-45.054168701171875 -149.62501430511475 C-45.054168701171875 -77.58041014598257, -45.054168701171875 -5.5358059868503915, -45.054168701171875 192.37501621246338 M-45.054168701171875 -149.62501430511475 C-45.054168701171875 -50.8916685939182, -45.054168701171875 47.84167711727835, -45.054168701171875 192.37501621246338"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M95.57083892822266 -149.62501430511475 C95.57083892822266 -62.479602574754935, 95.57083892822266 24.665809155604876, 95.57083892822266 192.37501621246338 M95.57083892822266 -149.62501430511475 C95.57083892822266 -13.154682626134814, 95.57083892822266 123.31564905284512, 95.57083892822266 192.37501621246338"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -106.87501239776611 C-70.46696404575934 -106.87501239776611, -2.1130891632960243 -106.87501239776611, 138.82083892822266 -106.87501239776611 M-138.82083892822266 -106.87501239776611 C-41.425479784274586 -106.87501239776611, 55.969879359673484 -106.87501239776611, 138.82083892822266 -106.87501239776611"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -64.12501049041748 C-55.244461177539705 -64.12501049041748, 28.331916573143246 -64.12501049041748, 138.82083892822266 -64.12501049041748 M-138.82083892822266 -64.12501049041748 C-80.28847048544398 -64.12501049041748, -21.75610204266532 -64.12501049041748, 138.82083892822266 -64.12501049041748"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -21.375008583068848 C-56.742681039403934 -21.375008583068848, 25.33547684941479 -21.375008583068848, 138.82083892822266 -21.375008583068848 M-138.82083892822266 -21.375008583068848 C-58.53006160514748 -21.375008583068848, 21.760715717927695 -21.375008583068848, 138.82083892822266 -21.375008583068848"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 21.374993324279785 C-77.92836356095546 21.374993324279785, -17.03588819368828 21.374993324279785, 138.82083892822266 21.374993324279785 M-138.82083892822266 21.374993324279785 C-76.88940109140006 21.374993324279785, -14.957963254577479 21.374993324279785, 138.82083892822266 21.374993324279785"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 64.12499523162842 C-77.29610217361947 64.12499523162842, -15.771365419016291 64.12499523162842, 138.82083892822266 64.12499523162842 M-138.82083892822266 64.12499523162842 C-67.01042705354399 64.12499523162842, 4.799984821134672 64.12499523162842, 138.82083892822266 64.12499523162842"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 106.87499713897705 C-80.99122806048075 106.87499713897705, -23.161617192738845 106.87499713897705, 138.82083892822266 106.87499713897705 M-138.82083892822266 106.87499713897705 C-29.856264000261646 106.87499713897705, 79.10831092769936 106.87499713897705, 138.82083892822266 106.87499713897705"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 149.62499904632568 C-61.17637371485925 149.62499904632568, 16.46809149850415 149.62499904632568, 138.82083892822266 149.62499904632568 M-138.82083892822266 149.62499904632568 C-38.59027593148092 149.62499904632568, 61.64028706526082 149.62499904632568, 138.82083892822266 149.62499904632568"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-138.82083892822266 -149.62501430511475 C-46.072215866808406 -149.62501430511475, 46.676407194605844 -149.62501430511475, 138.82083892822266 -149.62501430511475 M-138.82083892822266 -149.62501430511475 C-61.80342395743298 -149.62501430511475, 15.21399101335669 -149.62501430511475, 138.82083892822266 -149.62501430511475"></path></g></g><g transform="translate(512.0708312988281, 849.7500343322754)" id="entity-wallet_reservations-2" class="node default"><rect height="84.00000190734863" width="172.85833740234375" y="-42.000000953674316" x="-86.42916870117188" style="" class="basic label-container"></rect><g transform="translate(-66.42916870117188, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="132.85833740234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>wallet_reservations</p></span></div></foreignobject></g></g><g transform="translate(885.8125, 849.7500343322754)" id="entity-payments-3" class="node default"><g style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 -213.75003147125244 L147.31250381469727 -213.75003147125244 L147.31250381469727 213.75003147125244 L-147.31250381469727 213.75003147125244"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -213.75003147125244 C-66.60958459950199 -213.75003147125244, 14.093334615693294 -213.75003147125244, 147.31250381469727 -213.75003147125244 M-147.31250381469727 -213.75003147125244 C-36.13003972131605 -213.75003147125244, 75.05242437206516 -213.75003147125244, 147.31250381469727 -213.75003147125244 M147.31250381469727 -213.75003147125244 C147.31250381469727 -50.0299827881, 147.31250381469727 113.69006589505244, 147.31250381469727 213.75003147125244 M147.31250381469727 -213.75003147125244 C147.31250381469727 -77.57587263545167, 147.31250381469727 58.598286200349094, 147.31250381469727 213.75003147125244 M147.31250381469727 213.75003147125244 C66.78999043923562 213.75003147125244, -13.732522936226019 213.75003147125244, -147.31250381469727 213.75003147125244 M147.31250381469727 213.75003147125244 C75.33169083506624 213.75003147125244, 3.3508778554352148 213.75003147125244, -147.31250381469727 213.75003147125244 M-147.31250381469727 213.75003147125244 C-147.31250381469727 93.69559388273426, -147.31250381469727 -26.358843705783926, -147.31250381469727 -213.75003147125244 M-147.31250381469727 213.75003147125244 C-147.31250381469727 66.40822845322845, -147.31250381469727 -80.93357456479555, -147.31250381469727 -213.75003147125244"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 -85.50002574920654 L147.31250381469727 -85.50002574920654 L147.31250381469727 -42.75002384185791 L-147.31250381469727 -42.75002384185791"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -85.50002574920654 C-68.1907029367192 -85.50002574920654, 10.931097941258855 -85.50002574920654, 147.31250381469727 -85.50002574920654 M-147.31250381469727 -85.50002574920654 C-79.63740148424657 -85.50002574920654, -11.962299153795868 -85.50002574920654, 147.31250381469727 -85.50002574920654 M147.31250381469727 -85.50002574920654 C147.31250381469727 -74.4780047372865, 147.31250381469727 -63.45598372536644, 147.31250381469727 -42.75002384185791 M147.31250381469727 -85.50002574920654 C147.31250381469727 -73.51640390344397, 147.31250381469727 -61.53278205768139, 147.31250381469727 -42.75002384185791 M147.31250381469727 -42.75002384185791 C52.82218047170305 -42.75002384185791, -41.66814287129117 -42.75002384185791, -147.31250381469727 -42.75002384185791 M147.31250381469727 -42.75002384185791 C88.38685399732441 -42.75002384185791, 29.461204179951537 -42.75002384185791, -147.31250381469727 -42.75002384185791 M-147.31250381469727 -42.75002384185791 C-147.31250381469727 -55.6742496170241, -147.31250381469727 -68.5984753921903, -147.31250381469727 -85.50002574920654 M-147.31250381469727 -42.75002384185791 C-147.31250381469727 -52.94507269499343, -147.31250381469727 -63.14012154812894, -147.31250381469727 -85.50002574920654"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 -42.75002384185791 L147.31250381469727 -42.75002384185791 L147.31250381469727 -0.00002193450927734375 L-147.31250381469727 -0.00002193450927734375"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -42.75002384185791 C-68.00910978381937 -42.75002384185791, 11.294284247058528 -42.75002384185791, 147.31250381469727 -42.75002384185791 M-147.31250381469727 -42.75002384185791 C-83.4461052178259 -42.75002384185791, -19.57970662095454 -42.75002384185791, 147.31250381469727 -42.75002384185791 M147.31250381469727 -42.75002384185791 C147.31250381469727 -33.91433471070582, 147.31250381469727 -25.078645579553736, 147.31250381469727 -0.00002193450927734375 M147.31250381469727 -42.75002384185791 C147.31250381469727 -27.894904546502264, 147.31250381469727 -13.039785251146618, 147.31250381469727 -0.00002193450927734375 M147.31250381469727 -0.00002193450927734375 C74.94500546566353 -0.00002193450927734375, 2.577507116629789 -0.00002193450927734375, -147.31250381469727 -0.00002193450927734375 M147.31250381469727 -0.00002193450927734375 C42.01387266819465 -0.00002193450927734375, -63.284758478307964 -0.00002193450927734375, -147.31250381469727 -0.00002193450927734375 M-147.31250381469727 -0.00002193450927734375 C-147.31250381469727 -14.33834626998082, -147.31250381469727 -28.67667060545236, -147.31250381469727 -42.75002384185791 M-147.31250381469727 -0.00002193450927734375 C-147.31250381469727 -12.713828398311767, -147.31250381469727 -25.427634862114257, -147.31250381469727 -42.75002384185791"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 -0.00002193450927734375 L147.31250381469727 -0.00002193450927734375 L147.31250381469727 42.749979972839355 L-147.31250381469727 42.749979972839355"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -0.00002193450927734375 C-80.36292880789716 -0.00002193450927734375, -13.41335380109706 -0.00002193450927734375, 147.31250381469727 -0.00002193450927734375 M-147.31250381469727 -0.00002193450927734375 C-80.16071405031231 -0.00002193450927734375, -13.00892428592735 -0.00002193450927734375, 147.31250381469727 -0.00002193450927734375 M147.31250381469727 -0.00002193450927734375 C147.31250381469727 9.392282183971378, 147.31250381469727 18.784586302452034, 147.31250381469727 42.749979972839355 M147.31250381469727 -0.00002193450927734375 C147.31250381469727 8.964435560985875, 147.31250381469727 17.928893056481026, 147.31250381469727 42.749979972839355 M147.31250381469727 42.749979972839355 C85.42990481829469 42.749979972839355, 23.547305821892124 42.749979972839355, -147.31250381469727 42.749979972839355 M147.31250381469727 42.749979972839355 C62.15180126265045 42.749979972839355, -23.008901289396363 42.749979972839355, -147.31250381469727 42.749979972839355 M-147.31250381469727 42.749979972839355 C-147.31250381469727 26.450426643097863, -147.31250381469727 10.15087331335637, -147.31250381469727 -0.00002193450927734375 M-147.31250381469727 42.749979972839355 C-147.31250381469727 33.67475379878792, -147.31250381469727 24.599527624736478, -147.31250381469727 -0.00002193450927734375"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 42.749979972839355 L147.31250381469727 42.749979972839355 L147.31250381469727 85.49998188018799 L-147.31250381469727 85.49998188018799"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 42.749979972839355 C-84.35721305635948 42.749979972839355, -21.401922298021717 42.749979972839355, 147.31250381469727 42.749979972839355 M-147.31250381469727 42.749979972839355 C-63.61425946151982 42.749979972839355, 20.08398489165762 42.749979972839355, 147.31250381469727 42.749979972839355 M147.31250381469727 42.749979972839355 C147.31250381469727 52.11457126710867, 147.31250381469727 61.47916256137798, 147.31250381469727 85.49998188018799 M147.31250381469727 42.749979972839355 C147.31250381469727 57.86603437339088, 147.31250381469727 72.98208877394241, 147.31250381469727 85.49998188018799 M147.31250381469727 85.49998188018799 C70.45506515440536 85.49998188018799, -6.402373505886544 85.49998188018799, -147.31250381469727 85.49998188018799 M147.31250381469727 85.49998188018799 C44.076599461014624 85.49998188018799, -59.15930489266802 85.49998188018799, -147.31250381469727 85.49998188018799 M-147.31250381469727 85.49998188018799 C-147.31250381469727 76.93682405081776, -147.31250381469727 68.37366622144752, -147.31250381469727 42.749979972839355 M-147.31250381469727 85.49998188018799 C-147.31250381469727 68.66211718552462, -147.31250381469727 51.82425249086125, -147.31250381469727 42.749979972839355"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 85.49998188018799 L147.31250381469727 85.49998188018799 L147.31250381469727 128.24998378753662 L-147.31250381469727 128.24998378753662"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 85.49998188018799 C-70.32977058046713 85.49998188018799, 6.652962653763012 85.49998188018799, 147.31250381469727 85.49998188018799 M-147.31250381469727 85.49998188018799 C-65.90135637652499 85.49998188018799, 15.509791061647292 85.49998188018799, 147.31250381469727 85.49998188018799 M147.31250381469727 85.49998188018799 C147.31250381469727 96.5164849423748, 147.31250381469727 107.53298800456162, 147.31250381469727 128.24998378753662 M147.31250381469727 85.49998188018799 C147.31250381469727 94.45682490800834, 147.31250381469727 103.41366793582871, 147.31250381469727 128.24998378753662 M147.31250381469727 128.24998378753662 C37.35714483498215 128.24998378753662, -72.59821414473296 128.24998378753662, -147.31250381469727 128.24998378753662 M147.31250381469727 128.24998378753662 C42.90160635406619 128.24998378753662, -61.50929110656489 128.24998378753662, -147.31250381469727 128.24998378753662 M-147.31250381469727 128.24998378753662 C-147.31250381469727 113.31410080570366, -147.31250381469727 98.37821782387071, -147.31250381469727 85.49998188018799 M-147.31250381469727 128.24998378753662 C-147.31250381469727 118.68464439848753, -147.31250381469727 109.11930500943845, -147.31250381469727 85.49998188018799"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 128.24998378753662 L147.31250381469727 128.24998378753662 L147.31250381469727 170.99998569488525 L-147.31250381469727 170.99998569488525"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 128.24998378753662 C-60.88587548607582 128.24998378753662, 25.54075284254563 128.24998378753662, 147.31250381469727 128.24998378753662 M-147.31250381469727 128.24998378753662 C-36.4719127346325 128.24998378753662, 74.36867834543227 128.24998378753662, 147.31250381469727 128.24998378753662 M147.31250381469727 128.24998378753662 C147.31250381469727 141.2092954115937, 147.31250381469727 154.16860703565078, 147.31250381469727 170.99998569488525 M147.31250381469727 128.24998378753662 C147.31250381469727 139.4083510504121, 147.31250381469727 150.5667183132876, 147.31250381469727 170.99998569488525 M147.31250381469727 170.99998569488525 C79.64242980346297 170.99998569488525, 11.972355792228683 170.99998569488525, -147.31250381469727 170.99998569488525 M147.31250381469727 170.99998569488525 C59.01507927154957 170.99998569488525, -29.282345271598132 170.99998569488525, -147.31250381469727 170.99998569488525 M-147.31250381469727 170.99998569488525 C-147.31250381469727 158.9625940020241, -147.31250381469727 146.92520230916296, -147.31250381469727 128.24998378753662 M-147.31250381469727 170.99998569488525 C-147.31250381469727 156.43394188511465, -147.31250381469727 141.86789807534402, -147.31250381469727 128.24998378753662"></path></g><g class="row-rect-odd" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 170.99998569488525 L147.31250381469727 170.99998569488525 L147.31250381469727 213.7499876022339 L-147.31250381469727 213.7499876022339"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 170.99998569488525 C-53.37304370770681 170.99998569488525, 40.56641639928364 170.99998569488525, 147.31250381469727 170.99998569488525 M-147.31250381469727 170.99998569488525 C-56.36259158876409 170.99998569488525, 34.587320637169086 170.99998569488525, 147.31250381469727 170.99998569488525 M147.31250381469727 170.99998569488525 C147.31250381469727 187.2849712029343, 147.31250381469727 203.56995671098332, 147.31250381469727 213.7499876022339 M147.31250381469727 170.99998569488525 C147.31250381469727 182.92026869905246, 147.31250381469727 194.84055170321966, 147.31250381469727 213.7499876022339 M147.31250381469727 213.7499876022339 C85.65644160420243 213.7499876022339, 24.00037939370759 213.7499876022339, -147.31250381469727 213.7499876022339 M147.31250381469727 213.7499876022339 C61.90804076477555 213.7499876022339, -23.496422285146167 213.7499876022339, -147.31250381469727 213.7499876022339 M-147.31250381469727 213.7499876022339 C-147.31250381469727 199.00893030896304, -147.31250381469727 184.26787301569217, -147.31250381469727 170.99998569488525 M-147.31250381469727 213.7499876022339 C-147.31250381469727 200.63608358808142, -147.31250381469727 187.52217957392892, -147.31250381469727 170.99998569488525"></path></g><g class="row-rect-even" style=""><path fill="#ffffff" stroke-width="0" stroke="none" d="M-147.31250381469727 -171.0000295639038 L147.31250381469727 -171.0000295639038 L147.31250381469727 -128.25002765655518 L-147.31250381469727 -128.25002765655518"></path><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -171.0000295639038 C-41.42449641228821 -171.0000295639038, 64.46351099012085 -171.0000295639038, 147.31250381469727 -171.0000295639038 M-147.31250381469727 -171.0000295639038 C-82.37340186731417 -171.0000295639038, -17.434299919931078 -171.0000295639038, 147.31250381469727 -171.0000295639038 M147.31250381469727 -171.0000295639038 C147.31250381469727 -157.08602236087043, 147.31250381469727 -143.17201515783708, 147.31250381469727 -128.25002765655518 M147.31250381469727 -171.0000295639038 C147.31250381469727 -157.02932986480712, 147.31250381469727 -143.0586301657104, 147.31250381469727 -128.25002765655518 M147.31250381469727 -128.25002765655518 C47.806759598385185 -128.25002765655518, -51.6989846179269 -128.25002765655518, -147.31250381469727 -128.25002765655518 M147.31250381469727 -128.25002765655518 C60.266917276793066 -128.25002765655518, -26.778669261111133 -128.25002765655518, -147.31250381469727 -128.25002765655518 M-147.31250381469727 -128.25002765655518 C-147.31250381469727 -144.81096960148312, -147.31250381469727 -161.37191154641104, -147.31250381469727 -171.0000295639038 M-147.31250381469727 -128.25002765655518 C-147.31250381469727 -142.67921689134246, -147.31250381469727 -157.10840612612975, -147.31250381469727 -171.0000295639038"></path></g><g style="" transform="translate(-34.35416793823242, -204.37503147125244)" class="label name"><foreignobject height="24.000001907348633" width="68.70833587646484"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 172px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>payments</p></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, -161.6250295639038)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, -161.6250295639038)" class="label attribute-name"><foreignobject height="24.000001907348633" width="13.30000114440918"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 113px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>id</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, -161.6250295639038)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="18.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 121px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PK</p></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, -161.6250295639038)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, -118.87502765655518)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, -118.87502765655518)" class="label attribute-name"><foreignobject height="24.000001907348633" width="49.716670989990234"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 154px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>user_id</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, -118.87502765655518)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="17.100000381469727"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 120px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>FK</p></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, -118.87502765655518)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, -76.12502574920654)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, -76.12502574920654)" class="label attribute-name"><foreignobject height="24.000001907348633" width="61.1833381652832"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 167px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>wallet_id</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, -76.12502574920654)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="17.100000381469727"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 120px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>FK</p></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, -76.12502574920654)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, -33.37502384185791)" class="label attribute-type"><foreignobject height="24.000001907348633" width="61.0333366394043"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 162px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>binary16</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, -33.37502384185791)" class="label attribute-name"><foreignobject height="24.000001907348633" width="58.23333740234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 161px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>order_id</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, -33.37502384185791)" class="label attribute-keys"><foreignobject height="24.000001907348633" width="17.100000381469727"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 120px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>FK</p></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, -33.37502384185791)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, 9.374978065490723)" class="label attribute-type"><foreignobject height="24.000001907348633" width="68.76667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 176px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>varchar50</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, 9.374978065490723)" class="label attribute-name"><foreignobject height="24.000001907348633" width="59.241668701171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 160px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>provider</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, 9.374978065490723)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, 9.374978065490723)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, 52.124979972839355)" class="label attribute-type"><foreignobject height="24.000001907348633" width="68.76667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 175px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>varchar30</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, 52.124979972839355)" class="label attribute-name"><foreignobject height="24.000001907348633" width="123.98333740234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 229px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>payment_method</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, 52.124979972839355)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, 52.124979972839355)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, 94.87498188018799)" class="label attribute-type"><foreignobject height="24.000001907348633" width="41.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 141px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bigint</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, 94.87498188018799)" class="label attribute-name"><foreignobject height="24.000001907348633" width="54.833335876464844"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 156px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>amount</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, 94.87498188018799)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, 94.87498188018799)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, 137.62498378753662)" class="label attribute-type"><foreignobject height="24.000001907348633" width="68.76667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 175px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>varchar30</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, 137.62498378753662)" class="label attribute-name"><foreignobject height="24.000001907348633" width="41.625003814697266"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 146px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>status</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, 137.62498378753662)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, 137.62498378753662)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(-134.81250381469727, 180.37498569488525)" class="label attribute-type"><foreignobject height="24.000001907348633" width="77.39167022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 185px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>varchar255</p></span></div></foreignobject></g><g style="" transform="translate(-32.420833587646484, 180.37498569488525)" class="label attribute-name"><foreignobject height="24.000001907348633" width="47.400001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 153px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>txn_ref</p></span></div></foreignobject></g><g style="" transform="translate(116.56250381469727, 180.37498569488525)" class="label attribute-keys"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g style="" transform="translate(159.81250381469727, 180.37498569488525)" class="label attribute-comment"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: start;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignobject></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -171.0000295639038 C-30.059597397649924 -171.0000295639038, 87.19330901939742 -171.0000295639038, 147.31250381469727 -171.0000295639038 M-147.31250381469727 -171.0000295639038 C-66.01622603175248 -171.0000295639038, 15.280051751192303 -171.0000295639038, 147.31250381469727 -171.0000295639038"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-44.920833587646484 -171.0000295639038 C-44.920833587646484 -34.592402630724905, -44.920833587646484 101.815224302454, -44.920833587646484 213.75003147125244 M-44.920833587646484 -171.0000295639038 C-44.920833587646484 -30.525831548279825, -44.920833587646484 109.94836646734416, -44.920833587646484 213.75003147125244"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M104.06250381469727 -171.0000295639038 C104.06250381469727 -23.247752441816118, 104.06250381469727 124.50452468027157, 104.06250381469727 213.75003147125244 M104.06250381469727 -171.0000295639038 C104.06250381469727 -42.824861267862275, 104.06250381469727 85.35030702817926, 104.06250381469727 213.75003147125244"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -128.25002765655518 C-35.396885570341155 -128.25002765655518, 76.51873267401496 -128.25002765655518, 147.31250381469727 -128.25002765655518 M-147.31250381469727 -128.25002765655518 C-48.9239515873313 -128.25002765655518, 49.46460064003466 -128.25002765655518, 147.31250381469727 -128.25002765655518"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -85.50002574920654 C-79.45918365053298 -85.50002574920654, -11.60586348636869 -85.50002574920654, 147.31250381469727 -85.50002574920654 M-147.31250381469727 -85.50002574920654 C-84.60231213590029 -85.50002574920654, -21.892120457103303 -85.50002574920654, 147.31250381469727 -85.50002574920654"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -42.75002384185791 C-85.71887108860021 -42.75002384185791, -24.125238362503154 -42.75002384185791, 147.31250381469727 -42.75002384185791 M-147.31250381469727 -42.75002384185791 C-45.690222799951414 -42.75002384185791, 55.93205821479444 -42.75002384185791, 147.31250381469727 -42.75002384185791"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -0.00002193450927734375 C-75.92915243523176 -0.00002193450927734375, -4.545801055766248 -0.00002193450927734375, 147.31250381469727 -0.00002193450927734375 M-147.31250381469727 -0.00002193450927734375 C-60.04796222958768 -0.00002193450927734375, 27.2165793555219 -0.00002193450927734375, 147.31250381469727 -0.00002193450927734375"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 42.749979972839355 C-65.1577577718604 42.749979972839355, 16.99698827097646 42.749979972839355, 147.31250381469727 42.749979972839355 M-147.31250381469727 42.749979972839355 C-41.885924249354645 42.749979972839355, 63.540655315987976 42.749979972839355, 147.31250381469727 42.749979972839355"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 85.49998188018799 C-71.24826335739499 85.49998188018799, 4.815977099907286 85.49998188018799, 147.31250381469727 85.49998188018799 M-147.31250381469727 85.49998188018799 C-74.25324607063835 85.49998188018799, -1.1939883265794435 85.49998188018799, 147.31250381469727 85.49998188018799"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 128.24998378753662 C-61.29404179463461 128.24998378753662, 24.724420225428048 128.24998378753662, 147.31250381469727 128.24998378753662 M-147.31250381469727 128.24998378753662 C-43.136110225033406 128.24998378753662, 61.040283364630454 128.24998378753662, 147.31250381469727 128.24998378753662"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 170.99998569488525 C-53.686551458027566 170.99998569488525, 39.939400898642134 170.99998569488525, 147.31250381469727 170.99998569488525 M-147.31250381469727 170.99998569488525 C-73.28887436966171 170.99998569488525, 0.7347550753738403 170.99998569488525, 147.31250381469727 170.99998569488525"></path></g><g class="divider"><path fill="none" stroke-width="1.3" stroke="#dddddd" d="M-147.31250381469727 -171.0000295639038 C-36.150670689454856 -171.0000295639038, 75.01116243578755 -171.0000295639038, 147.31250381469727 -171.0000295639038 M-147.31250381469727 -171.0000295639038 C-60.94727374374773 -171.0000295639038, 25.417956327201807 -171.0000295639038, 147.31250381469727 -171.0000295639038"></path></g></g><g transform="translate(885.8125, 1206.5000667572021)" id="entity-payment_attempts-4" class="node default"><rect height="84.00000190734863" width="171.30833435058594" y="-42.000000953674316" x="-85.65416717529297" style="" class="basic label-container"></rect><g transform="translate(-65.65416717529297, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="131.30833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>payment_attempts</p></span></div></foreignobject></g></g><g transform="translate(1223.125, 849.7500343322754)" id="entity-users-5" class="node default"><rect height="84.00000190734863" width="100" y="-42.000000953674316" x="-50" style="" class="basic label-container"></rect><g transform="translate(-18.283334732055664, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="36.56666946411133"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 100px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>users</p></span></div></foreignobject></g></g><g transform="translate(1264.7979183197021, 364.00000190734863)" id="entity-bank_accounts-6" class="node default"><rect height="84.00000190734863" width="143.8166732788086" y="-42.000000953674316" x="-71.9083366394043" style="" class="basic label-container"></rect><g transform="translate(-51.9083366394043, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="103.8166732788086"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bank_accounts</p></span></div></foreignobject></g></g><g transform="translate(867.5979156494141, 50)" id="entity-withdrawal_requests-7" class="node default"><rect height="84.00000190734863" width="183.03334045410156" y="-42.000000953674316" x="-91.51667022705078" style="" class="basic label-container"></rect><g transform="translate(-71.51667022705078, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="143.03334045410156"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>withdrawal_requests</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/db.sql#L2-L114" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/db.sql</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">2-114</span></a></p>
<h3 id="service-layer-architecture" class="group" data-header="true">Service Layer Architecture<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1a" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0.00000762939453125 0 1487.133544921875 510.0000305175781" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-2p3hdb5uri2" preserveAspectRatio="xMidYMid meet"><style>#mermaid-2p3hdb5uri2{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-2p3hdb5uri2 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-2p3hdb5uri2 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-2p3hdb5uri2 .error-icon{fill:#dddddd;}#mermaid-2p3hdb5uri2 .error-text{fill:#222222;stroke:#222222;}#mermaid-2p3hdb5uri2 .edge-thickness-normal{stroke-width:1px;}#mermaid-2p3hdb5uri2 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-2p3hdb5uri2 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-2p3hdb5uri2 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-2p3hdb5uri2 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-2p3hdb5uri2 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-2p3hdb5uri2 .marker{fill:#999;stroke:#999;}#mermaid-2p3hdb5uri2 .marker.cross{stroke:#999;}#mermaid-2p3hdb5uri2 svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-2p3hdb5uri2 p{margin:0;}#mermaid-2p3hdb5uri2 .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-2p3hdb5uri2 .cluster-label text{fill:#444;}#mermaid-2p3hdb5uri2 .cluster-label span{color:#444;}#mermaid-2p3hdb5uri2 .cluster-label span p{background-color:transparent;}#mermaid-2p3hdb5uri2 .label text,#mermaid-2p3hdb5uri2 span{fill:#333;color:#333;}#mermaid-2p3hdb5uri2 .node rect,#mermaid-2p3hdb5uri2 .node circle,#mermaid-2p3hdb5uri2 .node ellipse,#mermaid-2p3hdb5uri2 .node polygon,#mermaid-2p3hdb5uri2 .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-2p3hdb5uri2 .rough-node .label text,#mermaid-2p3hdb5uri2 .node .label text,#mermaid-2p3hdb5uri2 .image-shape .label,#mermaid-2p3hdb5uri2 .icon-shape .label{text-anchor:middle;}#mermaid-2p3hdb5uri2 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-2p3hdb5uri2 .rough-node .label,#mermaid-2p3hdb5uri2 .node .label,#mermaid-2p3hdb5uri2 .image-shape .label,#mermaid-2p3hdb5uri2 .icon-shape .label{text-align:center;}#mermaid-2p3hdb5uri2 .node.clickable{cursor:pointer;}#mermaid-2p3hdb5uri2 .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-2p3hdb5uri2 .arrowheadPath{fill:#0b0b0b;}#mermaid-2p3hdb5uri2 .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-2p3hdb5uri2 .flowchart-link{stroke:#999;fill:none;}#mermaid-2p3hdb5uri2 .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-2p3hdb5uri2 .edgeLabel p{background-color:#ffffff;}#mermaid-2p3hdb5uri2 .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-2p3hdb5uri2 .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-2p3hdb5uri2 .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-2p3hdb5uri2 .cluster text{fill:#444;}#mermaid-2p3hdb5uri2 .cluster span{color:#444;}#mermaid-2p3hdb5uri2 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-2p3hdb5uri2 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-2p3hdb5uri2 rect.text{fill:none;stroke-width:0;}#mermaid-2p3hdb5uri2 .icon-shape,#mermaid-2p3hdb5uri2 .image-shape{background-color:#ffffff;text-align:center;}#mermaid-2p3hdb5uri2 .icon-shape p,#mermaid-2p3hdb5uri2 .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-2p3hdb5uri2 .icon-shape rect,#mermaid-2p3hdb5uri2 .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-2p3hdb5uri2 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-2p3hdb5uri2_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-2p3hdb5uri2_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-2p3hdb5uri2_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-2p3hdb5uri2_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-2p3hdb5uri2_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-2p3hdb5uri2_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentController_PaymentService_0" d="M652.95,62L652.95,66.167C652.95,70.333,652.95,78.667,652.95,86.333C652.95,94,652.95,101,652.95,104.5L652.95,108"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_WalletController_WalletService_0" d="M896.463,62L896.463,66.167C896.463,70.333,896.463,78.667,896.463,86.333C896.463,94,896.463,101,896.463,104.5L896.463,108"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BankAccountController_BankAccountService_0" d="M1155.675,62L1155.675,66.167C1155.675,70.333,1155.675,78.667,1155.675,86.333C1155.675,94,1155.675,101,1155.675,104.5L1155.675,108"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentService_PaymentServiceImpl_0" d="M652.95,166L652.95,170.167C652.95,174.333,652.95,182.667,652.95,190.333C652.95,198,652.95,205,652.95,208.5L652.95,212"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_WalletService_WalletServiceImpl_0" d="M896.463,166L896.463,170.167C896.463,174.333,896.463,182.667,896.463,190.333C896.463,198,896.463,205,896.463,208.5L896.463,212"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BankAccountService_BankAccountServiceImpl_0" d="M1155.675,166L1155.675,170.167C1155.675,174.333,1155.675,182.667,1155.675,190.333C1155.675,198,1155.675,205,1155.675,208.5L1155.675,212"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentServiceImpl_PaymentRepository_0" d="M551.963,252.601L477.631,259.667C403.299,266.734,254.635,280.867,180.303,293.433C105.971,306,105.971,317,105.971,322.5L105.971,328"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentServiceImpl_VnpayUltils_0" d="M551.963,258.925L513.833,264.937C475.704,270.95,399.446,282.975,361.317,294.487C323.188,306,323.188,317,323.188,322.5L323.188,328"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentServiceImpl_OutboxRepository_0" d="M592.369,270L583.02,274.167C573.671,278.333,554.973,286.667,545.624,296.333C536.275,306,536.275,317,536.275,322.5L536.275,328"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentServiceImpl_WalletRepository_0" d="M713.531,270L722.88,274.167C732.229,278.333,750.927,286.667,760.276,296.333C769.625,306,769.625,317,769.625,322.5L769.625,328"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentServiceImpl_WalletReservationRepository_0" d="M753.938,256.598L801.47,262.998C849.003,269.399,944.068,282.199,991.601,294.1C1039.133,306,1039.133,317,1039.133,322.5L1039.133,328"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_VnpayUltils_PayConfig_0" d="M323.188,386L323.188,392.167C323.188,398.333,323.188,410.667,323.188,420.333C323.188,430,323.188,437,323.188,440.5L323.188,444"></path><path marker-end="url(#mermaid-2p3hdb5uri2_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentServiceImpl_KafkaTopics_0" d="M753.938,250.543L853.137,257.953C952.336,265.362,1150.735,280.181,1249.934,291.091C1349.133,302,1349.133,309,1349.133,312.5L1349.133,316"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(652.9500274658203, 35)" id="flowchart-PaymentController-0" class="node default"><rect height="54.00000190734863" width="191.3000030517578" y="-27.000000953674316" x="-95.6500015258789" style="" class="basic label-container"></rect><g transform="translate(-65.6500015258789, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="131.3000030517578"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PaymentController</p></span></div></foreignobject></g></g><g transform="translate(652.9500274658203, 139)" id="flowchart-PaymentService-1" class="node default"><rect height="54.00000190734863" width="170.65000915527344" y="-27.000000953674316" x="-85.32500457763672" style="" class="basic label-container"></rect><g transform="translate(-55.32500457763672, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="110.65000915527344"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PaymentService</p></span></div></foreignobject></g></g><g transform="translate(896.462532043457, 35)" id="flowchart-WalletController-2" class="node default"><rect height="54.00000190734863" width="174.37500762939453" y="-27.000000953674316" x="-87.18750381469727" style="" class="basic label-container"></rect><g transform="translate(-57.187503814697266, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="114.37500762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>WalletController</p></span></div></foreignobject></g></g><g transform="translate(896.462532043457, 139)" id="flowchart-WalletService-3" class="node default"><rect height="54.00000190734863" width="153.73333740234375" y="-27.000000953674316" x="-76.86666870117188" style="" class="basic label-container"></rect><g transform="translate(-46.866668701171875, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="93.73333740234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>WalletService</p></span></div></foreignobject></g></g><g transform="translate(1155.6750411987305, 35)" id="flowchart-BankAccountController-4" class="node default"><rect height="54.00000190734863" width="222.70834350585938" y="-27.000000953674316" x="-111.35417175292969" style="" class="basic label-container"></rect><g transform="translate(-81.35417175292969, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="162.70834350585938"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>BankAccountController</p></span></div></foreignobject></g></g><g transform="translate(1155.6750411987305, 139)" id="flowchart-BankAccountService-5" class="node default"><rect height="54.00000190734863" width="202.05833435058594" y="-27.000000953674316" x="-101.02916717529297" style="" class="basic label-container"></rect><g transform="translate(-71.02916717529297, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="142.05833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>BankAccountService</p></span></div></foreignobject></g></g><g transform="translate(652.9500274658203, 243)" id="flowchart-PaymentServiceImpl-7" class="node default"><rect height="54.00000190734863" width="201.97500610351562" y="-27.000000953674316" x="-100.98750305175781" style="" class="basic label-container"></rect><g transform="translate(-70.98750305175781, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="141.97500610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PaymentServiceImpl</p></span></div></foreignobject></g></g><g transform="translate(896.462532043457, 243)" id="flowchart-WalletServiceImpl-9" class="node default"><rect height="54.00000190734863" width="185.0500030517578" y="-27.000000953674316" x="-92.5250015258789" style="" class="basic label-container"></rect><g transform="translate(-62.525001525878906, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="125.05000305175781"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>WalletServiceImpl</p></span></div></foreignobject></g></g><g transform="translate(1155.6750411987305, 243)" id="flowchart-BankAccountServiceImpl-11" class="node default"><rect height="54.00000190734863" width="233.37501525878906" y="-27.000000953674316" x="-116.68750762939453" style="" class="basic label-container"></rect><g transform="translate(-86.68750762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="173.37501525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>BankAccountServiceImpl</p></span></div></foreignobject></g></g><g transform="translate(105.97084045410156, 359)" id="flowchart-PaymentRepository-13" class="node default"><rect height="54.00000190734863" width="195.94168090820312" y="-27.000000953674316" x="-97.97084045410156" style="" class="basic label-container"></rect><g transform="translate(-67.97084045410156, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="135.94168090820312"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PaymentRepository</p></span></div></foreignobject></g></g><g transform="translate(323.18751525878906, 359)" id="flowchart-VnpayUltils-15" class="node default"><rect height="54.00000190734863" width="138.49166870117188" y="-27.000000953674316" x="-69.24583435058594" style="" class="basic label-container"></rect><g transform="translate(-39.24583435058594, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="78.49166870117188"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>VnpayUltils</p></span></div></foreignobject></g></g><g transform="translate(536.2750244140625, 359)" id="flowchart-OutboxRepository-17" class="node default"><rect height="54.00000190734863" width="187.68334197998047" y="-27.000000953674316" x="-93.84167098999023" style="" class="basic label-container"></rect><g transform="translate(-63.841670989990234, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="127.68334197998047"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>OutboxRepository</p></span></div></foreignobject></g></g><g transform="translate(769.6250305175781, 359)" id="flowchart-WalletRepository-19" class="node default"><rect height="54.00000190734863" width="179.01667022705078" y="-27.000000953674316" x="-89.50833511352539" style="" class="basic label-container"></rect><g transform="translate(-59.50833511352539, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="119.01667022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>WalletRepository</p></span></div></foreignobject></g></g><g transform="translate(1039.1333770751953, 359)" id="flowchart-WalletReservationRepository-21" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>WalletReservationRepository</p></span></div></foreignobject></g></g><g transform="translate(323.18751525878906, 475)" id="flowchart-PayConfig-23" class="node default"><rect height="54.00000190734863" width="130.9416732788086" y="-27.000000953674316" x="-65.4708366394043" style="" class="basic label-container"></rect><g transform="translate(-35.4708366394043, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="70.9416732788086"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PayConfig</p></span></div></foreignobject></g></g><g transform="translate(1349.1334075927734, 359)" id="flowchart-KafkaTopics-25" class="node default"><rect height="78.00000381469727" width="260.00001525878906" y="-39.00000190734863" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -24.000001907348633)" style="" class="label"><rect></rect><foreignobject height="48.000003814697266" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>KafkaTopic.PAYMENT_PROCECSSING<br>KafkaTopic.PAYMENT_SUCCESS</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java#L17-L80" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">17-80</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java#L11-L44" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">11-44</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java#L12-L69" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">12-69</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L44-L210" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">44-210</span></a></p>
<h2 id="payment-processing-flow" class="group" data-header="true">Payment Processing Flow<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>The payment processing system supports both wallet-based payments and external gateway payments through VNPAY.</p>
<h3 id="payment-state-machine" class="group" data-header="true">Payment State Machine<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1d" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="stateDiagram" role="graphics-document document" viewBox="0 9.5367431640625e-7 756.2021484375 646.0000610351562" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="statediagram" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-pzjkkezujqf" preserveAspectRatio="xMidYMid meet"><style>#mermaid-pzjkkezujqf{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-pzjkkezujqf .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-pzjkkezujqf .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-pzjkkezujqf .error-icon{fill:#dddddd;}#mermaid-pzjkkezujqf .error-text{fill:#222222;stroke:#222222;}#mermaid-pzjkkezujqf .edge-thickness-normal{stroke-width:1px;}#mermaid-pzjkkezujqf .edge-thickness-thick{stroke-width:3.5px;}#mermaid-pzjkkezujqf .edge-pattern-solid{stroke-dasharray:0;}#mermaid-pzjkkezujqf .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-pzjkkezujqf .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-pzjkkezujqf .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-pzjkkezujqf .marker{fill:#999;stroke:#999;}#mermaid-pzjkkezujqf .marker.cross{stroke:#999;}#mermaid-pzjkkezujqf svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-pzjkkezujqf p{margin:0;}#mermaid-pzjkkezujqf defs #statediagram-barbEnd{fill:#999;stroke:#999;}#mermaid-pzjkkezujqf g.stateGroup text{fill:#dddddd;stroke:none;font-size:10px;}#mermaid-pzjkkezujqf g.stateGroup text{fill:#333;stroke:none;font-size:10px;}#mermaid-pzjkkezujqf g.stateGroup .state-title{font-weight:bolder;fill:#333;}#mermaid-pzjkkezujqf g.stateGroup rect{fill:#ffffff;stroke:#dddddd;}#mermaid-pzjkkezujqf g.stateGroup line{stroke:#999;stroke-width:1;}#mermaid-pzjkkezujqf .transition{stroke:#999;stroke-width:1;fill:none;}#mermaid-pzjkkezujqf .stateGroup .composit{fill:#f4f4f4;border-bottom:1px;}#mermaid-pzjkkezujqf .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px;}#mermaid-pzjkkezujqf .state-note{stroke:#e6d280;fill:#fff5ad;}#mermaid-pzjkkezujqf .state-note text{fill:#333;stroke:none;font-size:10px;}#mermaid-pzjkkezujqf .stateLabel .box{stroke:none;stroke-width:0;fill:#ffffff;opacity:0.5;}#mermaid-pzjkkezujqf .edgeLabel .label rect{fill:#ffffff;opacity:0.5;}#mermaid-pzjkkezujqf .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-pzjkkezujqf .edgeLabel p{background-color:#ffffff;}#mermaid-pzjkkezujqf .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-pzjkkezujqf .edgeLabel .label text{fill:#333;}#mermaid-pzjkkezujqf .label div .edgeLabel{color:#333;}#mermaid-pzjkkezujqf .stateLabel text{fill:#333;font-size:10px;font-weight:bold;}#mermaid-pzjkkezujqf .node circle.state-start{fill:#999;stroke:#999;}#mermaid-pzjkkezujqf .node .fork-join{fill:#999;stroke:#999;}#mermaid-pzjkkezujqf .node circle.state-end{fill:#dddddd;stroke:#f4f4f4;stroke-width:1.5;}#mermaid-pzjkkezujqf .end-state-inner{fill:#f4f4f4;stroke-width:1.5;}#mermaid-pzjkkezujqf .node rect{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-pzjkkezujqf .node polygon{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-pzjkkezujqf #statediagram-barbEnd{fill:#999;}#mermaid-pzjkkezujqf .statediagram-cluster rect{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-pzjkkezujqf .cluster-label,#mermaid-pzjkkezujqf .nodeLabel{color:#333;}#mermaid-pzjkkezujqf .statediagram-cluster rect.outer{rx:5px;ry:5px;}#mermaid-pzjkkezujqf .statediagram-state .divider{stroke:#dddddd;}#mermaid-pzjkkezujqf .statediagram-state .title-state{rx:5px;ry:5px;}#mermaid-pzjkkezujqf .statediagram-cluster.statediagram-cluster .inner{fill:#f4f4f4;}#mermaid-pzjkkezujqf .statediagram-cluster.statediagram-cluster-alt .inner{fill:#f8f8f8;}#mermaid-pzjkkezujqf .statediagram-cluster .inner{rx:0;ry:0;}#mermaid-pzjkkezujqf .statediagram-state rect.basic{rx:5px;ry:5px;}#mermaid-pzjkkezujqf .statediagram-state rect.divider{stroke-dasharray:10,10;fill:#f8f8f8;}#mermaid-pzjkkezujqf .note-edge{stroke-dasharray:5;}#mermaid-pzjkkezujqf .statediagram-note rect{fill:#fff5ad;stroke:#e6d280;stroke-width:1px;rx:0;ry:0;}#mermaid-pzjkkezujqf .statediagram-note rect{fill:#fff5ad;stroke:#e6d280;stroke-width:1px;rx:0;ry:0;}#mermaid-pzjkkezujqf .statediagram-note text{fill:#333;}#mermaid-pzjkkezujqf .statediagram-note .nodeLabel{color:#333;}#mermaid-pzjkkezujqf .statediagram .edgeLabel{color:red;}#mermaid-pzjkkezujqf #dependencyStart,#mermaid-pzjkkezujqf #dependencyEnd{fill:#999;stroke:#999;stroke-width:1;}#mermaid-pzjkkezujqf .statediagramTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-pzjkkezujqf :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerUnits="userSpaceOnUse" markerHeight="14" markerWidth="20" refY="7" refX="19" id="mermaid-pzjkkezujqf_stateDiagram-barbEnd"><path d="M 19,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><g class="root"><g class="clusters"><g id="PROCESSING----parent" class="note-cluster"><rect fill="none" height="200" width="300.00001525878906" y="324.0000057220459" x="8"></rect></g></g><g class="edgePaths"><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge0" d="M453.769,22L453.769,28.167C453.769,34.333,453.769,46.667,453.769,59C453.769,71.333,453.769,83.667,453.769,89.833L453.769,96"></path><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge1" d="M413.548,126.877L385.123,134.564C356.699,142.252,299.849,157.626,271.425,171.48C243,185.333,243,197.667,243,203.833L243,210"></path><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge2" d="M297.321,237.526L356.834,245.772C416.348,254.017,535.375,270.509,594.889,284.921C654.402,299.333,654.402,311.667,654.402,331.167C654.402,350.667,654.402,377.333,654.402,390.667L654.402,404"></path><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge3" d="M281.097,250L292.843,256.167C304.589,262.333,328.082,274.667,339.829,287C351.575,299.333,351.575,311.667,370.497,331.167C389.419,350.667,427.263,377.333,446.185,390.667L465.107,404"></path><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge4" d="M654.402,444L654.402,457.333C654.402,470.667,654.402,497.333,654.402,516.833C654.402,536.333,654.402,548.667,654.402,561C654.402,573.333,654.402,585.667,654.402,591.833L654.402,598"></path><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge5" d="M500.997,404L506.002,390.667C511.007,377.333,521.017,350.667,526.022,331.167C531.027,311.667,531.027,299.333,531.027,283.667C531.027,268,531.027,249,531.027,230C531.027,211,531.027,192,522.669,176.333C514.31,160.667,497.594,148.333,489.235,142.167L480.877,136"></path><path marker-end="url(#mermaid-pzjkkezujqf_stateDiagram-barbEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition" id="edge6" d="M433.38,136L427.093,142.167C420.807,148.333,408.234,160.667,401.947,173C395.66,185.333,395.66,197.667,395.66,203.833L395.66,210"></path><path style="fill:none;" class="edge-thickness-normal edge-pattern-solid transition note-edge" id="PROCESSING-PROCESSING----note-7" d="M213.175,250L203.98,256.167C194.784,262.333,176.392,274.667,167.196,287C158,299.333,158,311.667,158,322C158,332.333,158,340.667,158,344.833L158,349"></path></g><g class="edgeLabels"><g transform="translate(453.76877212524414, 59.000000953674316)" class="edgeLabel"><g transform="translate(-67.65416717529297, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="135.30833435058594"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"Payment initiated"</p></span></div></foreignobject></g></g><g transform="translate(243.0000114440918, 173.00000286102295)" class="edgeLabel"><g transform="translate(-64.78750610351562, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="129.57501220703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"payment() called"</p></span></div></foreignobject></g></g><g transform="translate(654.4021129608154, 287.0000047683716)" class="edgeLabel"><g transform="translate(-93.80000305175781, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="187.60000610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"handleProviderCallback()"</p></span></div></foreignobject></g></g><g transform="translate(351.5750160217285, 287.0000047683716)" class="edgeLabel"><g transform="translate(-55.07500457763672, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="110.15000915527344"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"Provider error"</p></span></div></foreignobject></g></g><g transform="translate(654.4021129608154, 561.0000066757202)" class="edgeLabel"><g transform="translate(-64.80000305175781, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="129.60000610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"refundPayment()"</p></span></div></foreignobject></g></g><g transform="translate(531.0271091461182, 230.00000381469727)" class="edgeLabel"><g transform="translate(-57.89167022705078, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="115.78334045410156"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"retryPayment()"</p></span></div></foreignobject></g></g><g transform="translate(395.660436630249, 173.00000286102295)" class="edgeLabel"><g transform="translate(-63.67500305175781, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="127.35000610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>"cancelPayment()"</p></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(453.76877212524414, 15)" id="state-root_start-0" class="node default"><circle height="14" width="14" r="7" class="state-start"></circle></g><g transform="translate(453.76877212524414, 116.00000190734863)" id="state-CREATED-6" class="node  statediagram-state"><rect height="40.00000190734863" width="80.4416732788086" y="-20.000000953674316" x="-40.2208366394043" ry="5" rx="5" style="" class="basic label-container"></rect><g transform="translate(-32.2208366394043, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="64.4416732788086"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>CREATED</p></span></div></foreignobject></g></g><g transform="translate(243.0000114440918, 230.00000381469727)" id="state-PROCESSING-7" class="node  statediagram-state"><rect height="40.00000190734863" width="108.64167022705078" y="-20.000000953674316" x="-54.32083511352539" ry="5" rx="5" style="" class="basic label-container"></rect><g transform="translate(-46.32083511352539, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="92.64167022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PROCESSING</p></span></div></foreignobject></g></g><g transform="translate(654.4021129608154, 424.0000057220459)" id="state-SUCCEEDED-4" class="node  statediagram-state"><rect height="40.00000190734863" width="101.60000610351562" y="-20.000000953674316" x="-50.80000305175781" ry="5" rx="5" style="" class="basic label-container"></rect><g transform="translate(-42.80000305175781, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="85.60000610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>SUCCEEDED</p></span></div></foreignobject></g></g><g transform="translate(493.4896068572998, 424.0000057220459)" id="state-FAILED-5" class="node  statediagram-state"><rect height="40.00000190734863" width="64.30000305175781" y="-20.000000953674316" x="-32.150001525878906" ry="5" rx="5" style="" class="basic label-container"></rect><g transform="translate(-24.150001525878906, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="48.30000305175781"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>FAILED</p></span></div></foreignobject></g></g><g transform="translate(654.4021129608154, 618.0000076293945)" id="state-REFUNDED-4" class="node  statediagram-state"><rect height="40.00000190734863" width="94.97500610351562" y="-20.000000953674316" x="-47.48750305175781" ry="5" rx="5" style="" class="basic label-container"></rect><g transform="translate(-39.48750305175781, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="78.97500610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>REFUNDED</p></span></div></foreignobject></g></g><g transform="translate(395.660436630249, 230.00000381469727)" id="state-CANCLED-6" class="node  statediagram-state"><rect height="40.00000190734863" width="84.95000457763672" y="-20.000000953674316" x="-42.47500228881836" ry="5" rx="5" style="" class="basic label-container"></rect><g transform="translate(-34.47500228881836, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="68.95000457763672"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>CANCLED</p></span></div></foreignobject></g></g><g transform="translate(158.00000762939453, 424.0000057220459)" id="state-PROCESSING----note-7" class="node statediagram-note"><g class="basic label-container"><path style="" fill="#fff5ad" stroke-width="0" stroke="none" d="M-115.00000762939453 -75.00000381469727 L115.00000762939453 -75.00000381469727 L115.00000762939453 75.00000381469727 L-115.00000762939453 75.00000381469727"></path><path style="" fill="none" stroke-width="1.3" stroke="#e6d280" d="M-115.00000762939453 -75.00000381469727 C-65.24424014573879 -75.00000381469727, -15.488472662083026 -75.00000381469727, 115.00000762939453 -75.00000381469727 M-115.00000762939453 -75.00000381469727 C-47.08271357088209 -75.00000381469727, 20.834580487630348 -75.00000381469727, 115.00000762939453 -75.00000381469727 M115.00000762939453 -75.00000381469727 C115.00000762939453 -21.0680950318636, 115.00000762939453 32.86381375097007, 115.00000762939453 75.00000381469727 M115.00000762939453 -75.00000381469727 C115.00000762939453 -26.765467425755, 115.00000762939453 21.46906896318727, 115.00000762939453 75.00000381469727 M115.00000762939453 75.00000381469727 C52.641876200143265 75.00000381469727, -9.716255229108 75.00000381469727, -115.00000762939453 75.00000381469727 M115.00000762939453 75.00000381469727 C49.53665076642376 75.00000381469727, -15.926706096547008 75.00000381469727, -115.00000762939453 75.00000381469727 M-115.00000762939453 75.00000381469727 C-115.00000762939453 18.9068013003876, -115.00000762939453 -37.18640121392207, -115.00000762939453 -75.00000381469727 M-115.00000762939453 75.00000381469727 C-115.00000762939453 25.849718397108923, -115.00000762939453 -23.30056702047942, -115.00000762939453 -75.00000381469727"></path></g><g transform="translate(-100.00000762939453, -60.000003814697266)" style="" class="label"><rect></rect><foreignobject height="120.00000762939453" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>For wallet payments:<br>- Deduct balance<br>- Create reservation<br>For external payments:Unsupported markdown: br        - Generate VNPAY URL<br>- Wait for callback</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/common/Status.java#L20-L27" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/common/Status.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">20-27</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L105-L123" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">105-123</span></a></p>
<h3 id="wallet-payment-flow" class="group" data-header="true">Wallet Payment Flow<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1g" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="sequence" role="graphics-document document" viewBox="-50 -10 1749 741" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-94ueny4hdfj" preserveAspectRatio="xMidYMid meet"><g><rect class="actor actor-bottom" ry="3" rx="3" name="Kafka" height="65" width="150" stroke="#666" fill="#eaeaea" y="655" x="1499"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="687.5" x="1574"><tspan dy="0" x="1574">Kafka</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="OutboxRepository" height="65" width="152" stroke="#666" fill="#eaeaea" y="655" x="1181"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="687.5" x="1257"><tspan dy="0" x="1257">OutboxRepository</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="WalletReservationRepository" height="65" width="231" stroke="#666" fill="#eaeaea" y="655" x="900"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="687.5" x="1015.5"><tspan dy="0" x="1015.5">WalletReservationRepository</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="WalletRepository" height="65" width="150" stroke="#666" fill="#eaeaea" y="655" x="700"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="687.5" x="775"><tspan dy="0" x="775">WalletRepository</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="PaymentServiceImpl" height="65" width="171" stroke="#666" fill="#eaeaea" y="655" x="360.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="687.5" x="446"><tspan dy="0" x="446">PaymentServiceImpl</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="655" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="687.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="Kafka" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="655" x2="1574" y1="65" x1="1574" id="actor20"></line><g id="root-20"><rect class="actor actor-top" ry="3" rx="3" name="Kafka" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="1499"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1574"><tspan dy="0" x="1574">Kafka</tspan></text></g></g><g><line name="OutboxRepository" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="655" x2="1257" y1="65" x1="1257" id="actor19"></line><g id="root-19"><rect class="actor actor-top" ry="3" rx="3" name="OutboxRepository" height="65" width="152" stroke="#666" fill="#eaeaea" y="0" x="1181"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1257"><tspan dy="0" x="1257">OutboxRepository</tspan></text></g></g><g><line name="WalletReservationRepository" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="655" x2="1015.5" y1="65" x1="1015.5" id="actor18"></line><g id="root-18"><rect class="actor actor-top" ry="3" rx="3" name="WalletReservationRepository" height="65" width="231" stroke="#666" fill="#eaeaea" y="0" x="900"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1015.5"><tspan dy="0" x="1015.5">WalletReservationRepository</tspan></text></g></g><g><line name="WalletRepository" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="655" x2="775" y1="65" x1="775" id="actor17"></line><g id="root-17"><rect class="actor actor-top" ry="3" rx="3" name="WalletRepository" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="700"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="775"><tspan dy="0" x="775">WalletRepository</tspan></text></g></g><g><line name="PaymentServiceImpl" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="655" x2="446" y1="65" x1="446" id="actor16"></line><g id="root-16"><rect class="actor actor-top" ry="3" rx="3" name="PaymentServiceImpl" height="65" width="171" stroke="#666" fill="#eaeaea" y="0" x="360.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="446"><tspan dy="0" x="446">PaymentServiceImpl</tspan></text></g></g><g><line name="Client" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="655" x2="75" y1="65" x1="75" id="actor15"></line><g id="root-15"><rect class="actor actor-top" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g><style>#mermaid-94ueny4hdfj{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-94ueny4hdfj .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-94ueny4hdfj .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-94ueny4hdfj .error-icon{fill:#dddddd;}#mermaid-94ueny4hdfj .error-text{fill:#222222;stroke:#222222;}#mermaid-94ueny4hdfj .edge-thickness-normal{stroke-width:1px;}#mermaid-94ueny4hdfj .edge-thickness-thick{stroke-width:3.5px;}#mermaid-94ueny4hdfj .edge-pattern-solid{stroke-dasharray:0;}#mermaid-94ueny4hdfj .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-94ueny4hdfj .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-94ueny4hdfj .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-94ueny4hdfj .marker{fill:#999;stroke:#999;}#mermaid-94ueny4hdfj .marker.cross{stroke:#999;}#mermaid-94ueny4hdfj svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-94ueny4hdfj p{margin:0;}#mermaid-94ueny4hdfj .actor{stroke:#cccccc;fill:#ffffff;}#mermaid-94ueny4hdfj text.actor&gt;tspan{fill:#333;stroke:none;}#mermaid-94ueny4hdfj .actor-line{stroke:#cccccc;}#mermaid-94ueny4hdfj .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#999999;}#mermaid-94ueny4hdfj .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#999999;}#mermaid-94ueny4hdfj #arrowhead path{fill:#999999;stroke:#999999;}#mermaid-94ueny4hdfj .sequenceNumber{fill:#666666;}#mermaid-94ueny4hdfj #sequencenumber{fill:#999999;}#mermaid-94ueny4hdfj #crosshead path{fill:#999999;stroke:#999999;}#mermaid-94ueny4hdfj .messageText{fill:#333333;stroke:none;}#mermaid-94ueny4hdfj .labelBox{stroke:#dddddd;fill:#ffffff;}#mermaid-94ueny4hdfj .labelText,#mermaid-94ueny4hdfj .labelText&gt;tspan{fill:#333;stroke:none;}#mermaid-94ueny4hdfj .loopText,#mermaid-94ueny4hdfj .loopText&gt;tspan{fill:#333;stroke:none;}#mermaid-94ueny4hdfj .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:#dddddd;fill:#dddddd;}#mermaid-94ueny4hdfj .note{stroke:#e6d280;fill:#fff5ad;}#mermaid-94ueny4hdfj .noteText,#mermaid-94ueny4hdfj .noteText&gt;tspan{fill:#333;stroke:none;}#mermaid-94ueny4hdfj .activation0{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-94ueny4hdfj .activation1{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-94ueny4hdfj .activation2{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-94ueny4hdfj .actorPopupMenu{position:absolute;}#mermaid-94ueny4hdfj .actorPopupMenuPanel{position:absolute;fill:#ffffff;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-94ueny4hdfj .actor-man line{stroke:#cccccc;fill:#ffffff;}#mermaid-94ueny4hdfj .actor-man circle,#mermaid-94ueny4hdfj line{stroke:#cccccc;fill:#ffffff;stroke-width:2px;}#mermaid-94ueny4hdfj :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g></g><defs><symbol height="24" width="24" id="computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="7.9" id="arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refY="4.5" refX="4" orient="auto" markerHeight="8" markerWidth="15" id="crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="15.5" id="filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="40" markerWidth="60" refY="15" refX="15" id="sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><line class="loopLine" y2="231" x2="1268" y1="231" x1="64"></line><line class="loopLine" y2="583" x2="1268" y1="231" x1="1268"></line><line class="loopLine" y2="583" x2="1268" y1="583" x1="64"></line><line class="loopLine" y2="583" x2="64" y1="231" x1="64"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="490" x2="1268" y1="490" x1="64"></line><polygon class="labelBox" points="64,231 114,231 114,244 105.6,251 64,251"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="244" x="89">alt</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="249" x="691"><tspan x="691">["Sufficient balance"]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="508" x="666">["Insufficient balance"]</text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="259">"payment(paymentId, ip, userId, WALLET)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="117" x2="442" y1="117" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="132" x="609">"findById(userId)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="169" x2="771" y1="169" x1="447"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="184" x="612">"Wallet entity"</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="221" x2="450" y1="221" x1="774"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="282" x="609">"save(wallet with reduced balance)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="319" x2="771" y1="319" x1="447"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="334" x="729">"save(new reservation)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="371" x2="1011.5" y1="371" x1="447"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="386" x="850">"save(PaymentProcessEvent)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="423" x2="1253" y1="423" x1="447"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="438" x="262">"payment processing message"</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="475" x2="79" y1="475" x1="445"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="536" x="262">"INSUFFICIENT_BALANCE error"</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="573" x2="79" y1="573" x1="445"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="598" x="1414">"PAYMENT_PROCECSSING event"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="635" x2="1570" y1="635" x1="1258"></line></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L69-L101" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">69-101</span></a></p>
<h3 id="vnpay-external-payment-flow" class="group" data-header="true">VNPAY External Payment Flow<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1j" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="sequence" role="graphics-document document" viewBox="-50 -10 1609 639" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-7bov04l4mq2" preserveAspectRatio="xMidYMid meet"><g><rect class="actor actor-bottom" ry="3" rx="3" name="OutboxRepository" height="65" width="152" stroke="#666" fill="#eaeaea" y="553" x="1357"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="585.5" x="1433"><tspan dy="0" x="1433">OutboxRepository</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="PaymentAttemptRepository" height="65" width="221" stroke="#666" fill="#eaeaea" y="553" x="1086"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="585.5" x="1196.5"><tspan dy="0" x="1196.5">PaymentAttemptRepository</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="VNPAYGateway" height="65" width="150" stroke="#666" fill="#eaeaea" y="553" x="886"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="585.5" x="961"><tspan dy="0" x="961">VNPAYGateway</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="VnpayUltils" height="65" width="150" stroke="#666" fill="#eaeaea" y="553" x="686"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="585.5" x="761"><tspan dy="0" x="761">VnpayUltils</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="PaymentServiceImpl" height="65" width="171" stroke="#666" fill="#eaeaea" y="553" x="356.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="585.5" x="442"><tspan dy="0" x="442">PaymentServiceImpl</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="553" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="585.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="OutboxRepository" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="553" x2="1433" y1="65" x1="1433" id="actor26"></line><g id="root-26"><rect class="actor actor-top" ry="3" rx="3" name="OutboxRepository" height="65" width="152" stroke="#666" fill="#eaeaea" y="0" x="1357"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1433"><tspan dy="0" x="1433">OutboxRepository</tspan></text></g></g><g><line name="PaymentAttemptRepository" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="553" x2="1196.5" y1="65" x1="1196.5" id="actor25"></line><g id="root-25"><rect class="actor actor-top" ry="3" rx="3" name="PaymentAttemptRepository" height="65" width="221" stroke="#666" fill="#eaeaea" y="0" x="1086"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1196.5"><tspan dy="0" x="1196.5">PaymentAttemptRepository</tspan></text></g></g><g><line name="VNPAYGateway" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="553" x2="961" y1="65" x1="961" id="actor24"></line><g id="root-24"><rect class="actor actor-top" ry="3" rx="3" name="VNPAYGateway" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="886"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="961"><tspan dy="0" x="961">VNPAYGateway</tspan></text></g></g><g><line name="VnpayUltils" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="553" x2="761" y1="65" x1="761" id="actor23"></line><g id="root-23"><rect class="actor actor-top" ry="3" rx="3" name="VnpayUltils" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="686"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="761"><tspan dy="0" x="761">VnpayUltils</tspan></text></g></g><g><line name="PaymentServiceImpl" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="553" x2="442" y1="65" x1="442" id="actor22"></line><g id="root-22"><rect class="actor actor-top" ry="3" rx="3" name="PaymentServiceImpl" height="65" width="171" stroke="#666" fill="#eaeaea" y="0" x="356.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="442"><tspan dy="0" x="442">PaymentServiceImpl</tspan></text></g></g><g><line name="Client" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="553" x2="75" y1="65" x1="75" id="actor21"></line><g id="root-21"><rect class="actor actor-top" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g><style>#mermaid-7bov04l4mq2{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-7bov04l4mq2 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-7bov04l4mq2 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-7bov04l4mq2 .error-icon{fill:#dddddd;}#mermaid-7bov04l4mq2 .error-text{fill:#222222;stroke:#222222;}#mermaid-7bov04l4mq2 .edge-thickness-normal{stroke-width:1px;}#mermaid-7bov04l4mq2 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-7bov04l4mq2 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-7bov04l4mq2 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-7bov04l4mq2 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-7bov04l4mq2 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-7bov04l4mq2 .marker{fill:#999;stroke:#999;}#mermaid-7bov04l4mq2 .marker.cross{stroke:#999;}#mermaid-7bov04l4mq2 svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-7bov04l4mq2 p{margin:0;}#mermaid-7bov04l4mq2 .actor{stroke:#cccccc;fill:#ffffff;}#mermaid-7bov04l4mq2 text.actor&gt;tspan{fill:#333;stroke:none;}#mermaid-7bov04l4mq2 .actor-line{stroke:#cccccc;}#mermaid-7bov04l4mq2 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#999999;}#mermaid-7bov04l4mq2 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#999999;}#mermaid-7bov04l4mq2 #arrowhead path{fill:#999999;stroke:#999999;}#mermaid-7bov04l4mq2 .sequenceNumber{fill:#666666;}#mermaid-7bov04l4mq2 #sequencenumber{fill:#999999;}#mermaid-7bov04l4mq2 #crosshead path{fill:#999999;stroke:#999999;}#mermaid-7bov04l4mq2 .messageText{fill:#333333;stroke:none;}#mermaid-7bov04l4mq2 .labelBox{stroke:#dddddd;fill:#ffffff;}#mermaid-7bov04l4mq2 .labelText,#mermaid-7bov04l4mq2 .labelText&gt;tspan{fill:#333;stroke:none;}#mermaid-7bov04l4mq2 .loopText,#mermaid-7bov04l4mq2 .loopText&gt;tspan{fill:#333;stroke:none;}#mermaid-7bov04l4mq2 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:#dddddd;fill:#dddddd;}#mermaid-7bov04l4mq2 .note{stroke:#e6d280;fill:#fff5ad;}#mermaid-7bov04l4mq2 .noteText,#mermaid-7bov04l4mq2 .noteText&gt;tspan{fill:#333;stroke:none;}#mermaid-7bov04l4mq2 .activation0{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-7bov04l4mq2 .activation1{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-7bov04l4mq2 .activation2{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-7bov04l4mq2 .actorPopupMenu{position:absolute;}#mermaid-7bov04l4mq2 .actorPopupMenuPanel{position:absolute;fill:#ffffff;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-7bov04l4mq2 .actor-man line{stroke:#cccccc;fill:#ffffff;}#mermaid-7bov04l4mq2 .actor-man circle,#mermaid-7bov04l4mq2 line{stroke:#cccccc;fill:#ffffff;stroke-width:2px;}#mermaid-7bov04l4mq2 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g></g><defs><symbol height="24" width="24" id="computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="7.9" id="arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refY="4.5" refX="4" orient="auto" markerHeight="8" markerWidth="15" id="crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="15.5" id="filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="40" markerWidth="60" refY="15" refX="15" id="sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="257">"payment(paymentId, ip, userId, DIRECT)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="117" x2="438" y1="117" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="132" x="600">"payUrl(ip, amount, detail, txnRef)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="169" x2="757" y1="169" x1="443"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="184" x="603">"VNPAY payment URL"</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="221" x2="446" y1="221" x1="760"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="236" x="260">"Redirect to VNPAY URL"</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="273" x2="79" y1="273" x1="441"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="288" x="517">"Complete payment on VNPAY"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="325" x2="957" y1="325" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="340" x="703">"handleProviderCallback(VnpayReturnDto)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="377" x2="446" y1="377" x1="960"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="392" x="600">"checkCallBack(returnDto)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="429" x2="757" y1="429" x1="443"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="444" x="818">"save(payment attempt)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="481" x2="1192.5" y1="481" x1="443"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="496" x="936">"save(PaymentSuccessedEvent)"</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="533" x2="1429" y1="533" x1="443"></line></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L152-L188" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">152-188</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java#L36-L118" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">36-118</span></a></p>
<h2 id="database-design" class="group" data-header="true">Database Design<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>The wallet service uses a double-entry accounting pattern with immutable transaction logs and optimistic concurrency control.</p>
<h3 id="core-tables-structure" class="group" data-header="true">Core Tables Structure<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>



































<table><thead><tr><th>Table</th><th>Purpose</th><th>Key Fields</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">wallets</code></td><td>Current balance snapshot</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">balance</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">reserved</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">version</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">wallet_transactions</code></td><td>Immutable transaction ledger</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">amount</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">direction</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">balance_after</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">wallet_reservations</code></td><td>Fund holds for pending orders</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">amount</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">expires_at</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">status</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">payments</code></td><td>Payment processing records</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">provider</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">status</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">txn_ref</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">payment_attempts</code></td><td>Provider interaction logs</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">attempt_data</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">provider_response</code></td></tr></tbody></table>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/db.sql#L2-L84" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/db.sql</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">2-84</span></a></p>
<h3 id="transaction-logging-pattern" class="group" data-header="true">Transaction Logging Pattern<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1m" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1069.300048828125 446.1416931152344" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-9fxv57bmrbu" preserveAspectRatio="xMidYMid meet"><style>#mermaid-9fxv57bmrbu{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-9fxv57bmrbu .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-9fxv57bmrbu .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-9fxv57bmrbu .error-icon{fill:#dddddd;}#mermaid-9fxv57bmrbu .error-text{fill:#222222;stroke:#222222;}#mermaid-9fxv57bmrbu .edge-thickness-normal{stroke-width:1px;}#mermaid-9fxv57bmrbu .edge-thickness-thick{stroke-width:3.5px;}#mermaid-9fxv57bmrbu .edge-pattern-solid{stroke-dasharray:0;}#mermaid-9fxv57bmrbu .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-9fxv57bmrbu .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-9fxv57bmrbu .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-9fxv57bmrbu .marker{fill:#999;stroke:#999;}#mermaid-9fxv57bmrbu .marker.cross{stroke:#999;}#mermaid-9fxv57bmrbu svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-9fxv57bmrbu p{margin:0;}#mermaid-9fxv57bmrbu .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-9fxv57bmrbu .cluster-label text{fill:#444;}#mermaid-9fxv57bmrbu .cluster-label span{color:#444;}#mermaid-9fxv57bmrbu .cluster-label span p{background-color:transparent;}#mermaid-9fxv57bmrbu .label text,#mermaid-9fxv57bmrbu span{fill:#333;color:#333;}#mermaid-9fxv57bmrbu .node rect,#mermaid-9fxv57bmrbu .node circle,#mermaid-9fxv57bmrbu .node ellipse,#mermaid-9fxv57bmrbu .node polygon,#mermaid-9fxv57bmrbu .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-9fxv57bmrbu .rough-node .label text,#mermaid-9fxv57bmrbu .node .label text,#mermaid-9fxv57bmrbu .image-shape .label,#mermaid-9fxv57bmrbu .icon-shape .label{text-anchor:middle;}#mermaid-9fxv57bmrbu .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-9fxv57bmrbu .rough-node .label,#mermaid-9fxv57bmrbu .node .label,#mermaid-9fxv57bmrbu .image-shape .label,#mermaid-9fxv57bmrbu .icon-shape .label{text-align:center;}#mermaid-9fxv57bmrbu .node.clickable{cursor:pointer;}#mermaid-9fxv57bmrbu .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-9fxv57bmrbu .arrowheadPath{fill:#0b0b0b;}#mermaid-9fxv57bmrbu .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-9fxv57bmrbu .flowchart-link{stroke:#999;fill:none;}#mermaid-9fxv57bmrbu .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-9fxv57bmrbu .edgeLabel p{background-color:#ffffff;}#mermaid-9fxv57bmrbu .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-9fxv57bmrbu .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-9fxv57bmrbu .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-9fxv57bmrbu .cluster text{fill:#444;}#mermaid-9fxv57bmrbu .cluster span{color:#444;}#mermaid-9fxv57bmrbu div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-9fxv57bmrbu .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-9fxv57bmrbu rect.text{fill:none;stroke-width:0;}#mermaid-9fxv57bmrbu .icon-shape,#mermaid-9fxv57bmrbu .image-shape{background-color:#ffffff;text-align:center;}#mermaid-9fxv57bmrbu .icon-shape p,#mermaid-9fxv57bmrbu .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-9fxv57bmrbu .icon-shape rect,#mermaid-9fxv57bmrbu .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-9fxv57bmrbu :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-9fxv57bmrbu_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-9fxv57bmrbu_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-9fxv57bmrbu_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-9fxv57bmrbu_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-9fxv57bmrbu_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-9fxv57bmrbu_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_WalletUpdate_TransactionLog_0" d="M226.658,239.106L230.825,239.106C234.992,239.106,243.325,239.106,250.992,239.106C258.658,239.106,265.658,239.106,269.158,239.106L272.658,239.106"></path><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_TransactionLog_BalanceAfter_0" d="M412.122,212.106L432.617,182.589C453.112,153.071,494.102,94.035,518.097,64.518C542.092,35,549.092,35,552.592,35L556.092,35"></path><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_TransactionLog_Direction_0" d="M449.616,212.106L463.862,205.267C478.108,198.428,506.6,184.749,536.251,177.99C565.901,171.231,596.711,171.39,612.116,171.47L627.521,171.55"></path><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Direction_Credit_0" d="M735.343,157.251L754.887,150.888C774.43,144.525,813.517,131.798,837.813,125.434C862.108,119.071,871.613,119.071,876.365,119.071L881.117,119.071"></path><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Direction_Debit_0" d="M735.343,185.89L754.887,192.087C774.43,198.284,813.517,210.677,838.547,216.874C863.576,223.071,874.549,223.071,880.035,223.071L885.521,223.071"></path><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_TransactionLog_Type_0" d="M449.616,266.106L463.862,272.945C478.108,279.785,506.6,293.463,524.346,300.302C542.092,307.142,549.092,307.142,552.592,307.142L556.092,307.142"></path><path marker-end="url(#mermaid-9fxv57bmrbu_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_TransactionLog_RelatedEntity_0" d="M415.617,266.106L435.529,290.279C455.442,314.451,495.267,362.797,518.679,386.969C542.092,411.142,549.092,411.142,552.592,411.142L556.092,411.142"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g transform="translate(852.604220867157, 119.07083511352539)" class="edgeLabel"><g transform="translate(-4.3125, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="8.625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>1</p></span></div></foreignobject></g></g><g transform="translate(852.604220867157, 223.0708351135254)" class="edgeLabel"><g transform="translate(-7.512500286102295, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="15.02500057220459"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>-1</p></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(117.32917022705078, 239.1062526702881)" id="flowchart-WalletUpdate-0" class="node default"><rect height="54.00000190734863" width="218.65834045410156" y="-27.000000953674316" x="-109.32917022705078" style="" class="basic label-container"></rect><g transform="translate(-79.32917022705078, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="158.65834045410156"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Wallet Balance Update</p></span></div></foreignobject></g></g><g transform="translate(393.37501525878906, 239.1062526702881)" id="flowchart-TransactionLog-1" class="node default"><rect height="54.00000190734863" width="233.433349609375" y="-27.000000953674316" x="-116.7166748046875" style="" class="basic label-container"></rect><g transform="translate(-86.7166748046875, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="173.433349609375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>wallet_transactions entry</p></span></div></foreignobject></g></g><g transform="translate(690.0917053222656, 35)" id="flowchart-BalanceAfter-3" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>balance_after = new wallet.balance</p></span></div></foreignobject></g></g><g transform="translate(690.0917053222656, 171.0708351135254)" id="flowchart-Direction-5" class="node default"><polygon transform="translate(-59.07083606719971,59.07083606719971)" class="label-container" points="59.07083606719971,0 118.14167213439941,-59.07083606719971 59.07083606719971,-118.14167213439941 0,-59.07083606719971"></polygon><g transform="translate(-32.07083511352539, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="64.14167022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Direction</p></span></div></foreignobject></g></g><g transform="translate(973.2083959579468, 119.07083511352539)" id="flowchart-Credit-7" class="node default"><rect height="54.00000190734863" width="176.18334197998047" y="-27.000000953674316" x="-88.09167098999023" style="" class="basic label-container"></rect><g transform="translate(-58.091670989990234, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="116.18334197998047"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Credit: +amount</p></span></div></foreignobject></g></g><g transform="translate(973.2083959579468, 223.0708351135254)" id="flowchart-Debit-9" class="node default"><rect height="54.00000190734863" width="167.37500762939453" y="-27.000000953674316" x="-83.68750381469727" style="" class="basic label-container"></rect><g transform="translate(-53.687503814697266, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="107.37500762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Debit: -amount</p></span></div></foreignobject></g></g><g transform="translate(690.0917053222656, 307.1416702270508)" id="flowchart-Type-11" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>type: topup/payment/refund/withdrawal</p></span></div></foreignobject></g></g><g transform="translate(690.0917053222656, 411.1416702270508)" id="flowchart-RelatedEntity-13" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>related_entity_id: order_id/payment_id</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/db.sql#L18-L34" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/db.sql</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">18-34</span></a></p>
<h2 id="vnpay-integration" class="group" data-header="true">VNPAY Integration<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>The service integrates with Vietnam's VNPAY payment gateway for external payment processing.</p>
<h3 id="configuration-structure" class="group" data-header="true">Configuration Structure<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><pre style="display: block; overflow-x: auto; padding: 6px 8px; color: rgb(51, 51, 51); background: transparent; margin: 0px; width: 100%;"><code style="white-space: pre; font-size: 12px;"><span style="color: rgb(153, 153, 136); font-style: italic;"># payment.yaml configuration</span><span>
</span><span></span><span>vnpay:</span><span>
</span><span>  </span><span>vnpVersion:</span><span> </span><span style="color: rgb(221, 17, 68);">"2.1.0"</span><span>
</span><span>  </span><span>vnpCommand:</span><span> </span><span style="color: rgb(221, 17, 68);">"pay"</span><span> 
</span><span>  </span><span>vnpTmnCode:</span><span> </span><span style="color: rgb(221, 17, 68);">"XTNKANRH"</span><span>
</span><span>  </span><span>vnpHashSecret:</span><span> </span><span style="color: rgb(221, 17, 68);">"FNABMOP7AXKQFVWBIZE63HEIW7NAHO96"</span><span>
</span><span>  </span><span>vnpHashType:</span><span> </span><span style="color: rgb(221, 17, 68);">"HmacSHA512"</span><span>
</span><span>  </span><span>vnpReturnUrl:</span><span> </span><span style="color: rgb(221, 17, 68);">"http://localhost:8084/api/v1/wallet-service/payments/vnpay_return"</span><span>
</span><span>  </span><span>vnpPayUrl:</span><span> </span><span style="color: rgb(221, 17, 68);">"https://sandbox.vnpayment.vn/paymentv2/vpcpay.html"</span></code></pre></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/resources/payment.yaml#L1-L9" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/resources/payment.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-9</span></a></p>
<h3 id="vnpay-request-building" class="group" data-header="true">VNPAY Request Building<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1p" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0.0000152587890625 0 1187.620849609375 694.0000610351562" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-js9zcoq7oc" preserveAspectRatio="xMidYMid meet"><style>#mermaid-js9zcoq7oc{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-js9zcoq7oc .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-js9zcoq7oc .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-js9zcoq7oc .error-icon{fill:#dddddd;}#mermaid-js9zcoq7oc .error-text{fill:#222222;stroke:#222222;}#mermaid-js9zcoq7oc .edge-thickness-normal{stroke-width:1px;}#mermaid-js9zcoq7oc .edge-thickness-thick{stroke-width:3.5px;}#mermaid-js9zcoq7oc .edge-pattern-solid{stroke-dasharray:0;}#mermaid-js9zcoq7oc .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-js9zcoq7oc .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-js9zcoq7oc .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-js9zcoq7oc .marker{fill:#999;stroke:#999;}#mermaid-js9zcoq7oc .marker.cross{stroke:#999;}#mermaid-js9zcoq7oc svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-js9zcoq7oc p{margin:0;}#mermaid-js9zcoq7oc .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-js9zcoq7oc .cluster-label text{fill:#444;}#mermaid-js9zcoq7oc .cluster-label span{color:#444;}#mermaid-js9zcoq7oc .cluster-label span p{background-color:transparent;}#mermaid-js9zcoq7oc .label text,#mermaid-js9zcoq7oc span{fill:#333;color:#333;}#mermaid-js9zcoq7oc .node rect,#mermaid-js9zcoq7oc .node circle,#mermaid-js9zcoq7oc .node ellipse,#mermaid-js9zcoq7oc .node polygon,#mermaid-js9zcoq7oc .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-js9zcoq7oc .rough-node .label text,#mermaid-js9zcoq7oc .node .label text,#mermaid-js9zcoq7oc .image-shape .label,#mermaid-js9zcoq7oc .icon-shape .label{text-anchor:middle;}#mermaid-js9zcoq7oc .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-js9zcoq7oc .rough-node .label,#mermaid-js9zcoq7oc .node .label,#mermaid-js9zcoq7oc .image-shape .label,#mermaid-js9zcoq7oc .icon-shape .label{text-align:center;}#mermaid-js9zcoq7oc .node.clickable{cursor:pointer;}#mermaid-js9zcoq7oc .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-js9zcoq7oc .arrowheadPath{fill:#0b0b0b;}#mermaid-js9zcoq7oc .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-js9zcoq7oc .flowchart-link{stroke:#999;fill:none;}#mermaid-js9zcoq7oc .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-js9zcoq7oc .edgeLabel p{background-color:#ffffff;}#mermaid-js9zcoq7oc .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-js9zcoq7oc .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-js9zcoq7oc .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-js9zcoq7oc .cluster text{fill:#444;}#mermaid-js9zcoq7oc .cluster span{color:#444;}#mermaid-js9zcoq7oc div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-js9zcoq7oc .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-js9zcoq7oc rect.text{fill:none;stroke-width:0;}#mermaid-js9zcoq7oc .icon-shape,#mermaid-js9zcoq7oc .image-shape{background-color:#ffffff;text-align:center;}#mermaid-js9zcoq7oc .icon-shape p,#mermaid-js9zcoq7oc .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-js9zcoq7oc .icon-shape rect,#mermaid-js9zcoq7oc .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-js9zcoq7oc :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-js9zcoq7oc_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-js9zcoq7oc_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-js9zcoq7oc_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-js9zcoq7oc_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-js9zcoq7oc_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-js9zcoq7oc_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BuildParams_ParamMap_0" d="M588.863,62L588.863,66.167C588.863,70.333,588.863,78.667,588.863,86.333C588.863,94,588.863,101,588.863,104.5L588.863,108"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_ParamMap_Sort_0" d="M542.904,144.301L475.42,152.084C407.936,159.867,272.968,175.434,205.484,186.717C138,198,138,205,138,208.5L138,212"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Sort_StringBuilder_0" d="M138,270L138,274.167C138,278.333,138,286.667,138,294.333C138,302,138,309,138,312.5L138,316"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StringBuilder_HMAC_0" d="M138,374L138,378.167C138,382.333,138,390.667,138,398.333C138,406,138,413,138,416.5L138,420"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_HMAC_SecureHash_0" d="M138,478L138,482.167C138,486.333,138,494.667,138,502.333C138,510,138,517,138,520.5L138,524"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_SecureHash_PaymentURL_0" d="M138,582L138,586.167C138,590.333,138,598.667,138,606.333C138,614,138,621,138,624.5L138,628"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_ParamMap_Amount_0" d="M542.904,154.852L525.438,160.877C507.971,166.901,473.038,178.951,455.571,188.475C438.104,198,438.104,205,438.104,208.5L438.104,212"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_ParamMap_TxnRef_0" d="M634.821,154.852L652.288,160.877C669.754,166.901,704.688,178.951,722.154,188.475C739.621,198,739.621,205,739.621,208.5L739.621,212"></path><path marker-end="url(#mermaid-js9zcoq7oc_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_ParamMap_CreateDate_0" d="M634.821,144.187L703.954,151.989C773.088,159.791,911.354,175.396,980.488,186.698C1049.621,198,1049.621,205,1049.621,208.5L1049.621,212"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(588.8625221252441, 35)" id="flowchart-BuildParams-0" class="node default"><rect height="54.00000190734863" width="238.07501220703125" y="-27.000000953674316" x="-119.03750610351562" style="" class="basic label-container"></rect><g transform="translate(-89.03750610351562, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="178.07501220703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>VnpayUltils.buildParams()</p></span></div></foreignobject></g></g><g transform="translate(588.8625221252441, 139)" id="flowchart-ParamMap-1" class="node default"><rect height="54.00000190734863" width="91.91666793823242" y="-27.000000953674316" x="-45.95833396911621" style="" class="basic label-container"></rect><g transform="translate(-15.958333969116211, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="31.916667938232422"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Map</p></span></div></foreignobject></g></g><g transform="translate(138.00001525878906, 243)" id="flowchart-Sort-3" class="node default"><rect height="54.00000190734863" width="257.1750030517578" y="-27.000000953674316" x="-128.5875015258789" style="" class="basic label-container"></rect><g transform="translate(-98.5875015258789, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="197.1750030517578"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Collections.sort(fieldNames)</p></span></div></foreignobject></g></g><g transform="translate(138.00001525878906, 347)" id="flowchart-StringBuilder-5" class="node default"><rect height="54.00000190734863" width="184.4416732788086" y="-27.000000953674316" x="-92.2208366394043" style="" class="basic label-container"></rect><g transform="translate(-62.2208366394043, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="124.4416732788086"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Build query string</p></span></div></foreignobject></g></g><g transform="translate(138.00001525878906, 451)" id="flowchart-HMAC-7" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>hmacSHA512(hashSecret, queryString)</p></span></div></foreignobject></g></g><g transform="translate(138.00001525878906, 555)" id="flowchart-SecureHash-9" class="node default"><rect height="54.00000190734863" width="175.35833740234375" y="-27.000000953674316" x="-87.67916870117188" style="" class="basic label-container"></rect><g transform="translate(-57.679168701171875, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="115.35833740234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>vnp_SecureHash</p></span></div></foreignobject></g></g><g transform="translate(138.00001525878906, 659)" id="flowchart-PaymentURL-11" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Complete VNPAY payment URL</p></span></div></foreignobject></g></g><g transform="translate(438.1041793823242, 243)" id="flowchart-Amount-13" class="node default"><rect height="54.00000190734863" width="243.03334045410156" y="-27.000000953674316" x="-121.51667022705078" style="" class="basic label-container"></rect><g transform="translate(-91.51667022705078, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="183.03334045410156"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>vnp_Amount = total * 100</p></span></div></foreignobject></g></g><g transform="translate(739.6208648681641, 243)" id="flowchart-TxnRef-15" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>vnp_TxnRef = type-paymentId-timestamp</p></span></div></foreignobject></g></g><g transform="translate(1049.6208953857422, 243)" id="flowchart-CreateDate-17" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>vnp_CreateDate = yyyyMMddHHmmss</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java#L140-L171" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">140-171</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java#L32-L34" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">32-34</span></a></p>
<h2 id="event-driven-architecture" class="group" data-header="true">Event-Driven Architecture<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>The Wallet Service publishes events to notify other services of payment state changes.</p>
<h3 id="event-publishing-pattern" class="group" data-header="true">Event Publishing Pattern<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1s" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0.00000762939453125 0 1007.63134765625 510.0000305175781" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-ybfubof50gm" preserveAspectRatio="xMidYMid meet"><style>#mermaid-ybfubof50gm{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-ybfubof50gm .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-ybfubof50gm .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-ybfubof50gm .error-icon{fill:#dddddd;}#mermaid-ybfubof50gm .error-text{fill:#222222;stroke:#222222;}#mermaid-ybfubof50gm .edge-thickness-normal{stroke-width:1px;}#mermaid-ybfubof50gm .edge-thickness-thick{stroke-width:3.5px;}#mermaid-ybfubof50gm .edge-pattern-solid{stroke-dasharray:0;}#mermaid-ybfubof50gm .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-ybfubof50gm .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-ybfubof50gm .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-ybfubof50gm .marker{fill:#999;stroke:#999;}#mermaid-ybfubof50gm .marker.cross{stroke:#999;}#mermaid-ybfubof50gm svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-ybfubof50gm p{margin:0;}#mermaid-ybfubof50gm .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-ybfubof50gm .cluster-label text{fill:#444;}#mermaid-ybfubof50gm .cluster-label span{color:#444;}#mermaid-ybfubof50gm .cluster-label span p{background-color:transparent;}#mermaid-ybfubof50gm .label text,#mermaid-ybfubof50gm span{fill:#333;color:#333;}#mermaid-ybfubof50gm .node rect,#mermaid-ybfubof50gm .node circle,#mermaid-ybfubof50gm .node ellipse,#mermaid-ybfubof50gm .node polygon,#mermaid-ybfubof50gm .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-ybfubof50gm .rough-node .label text,#mermaid-ybfubof50gm .node .label text,#mermaid-ybfubof50gm .image-shape .label,#mermaid-ybfubof50gm .icon-shape .label{text-anchor:middle;}#mermaid-ybfubof50gm .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-ybfubof50gm .rough-node .label,#mermaid-ybfubof50gm .node .label,#mermaid-ybfubof50gm .image-shape .label,#mermaid-ybfubof50gm .icon-shape .label{text-align:center;}#mermaid-ybfubof50gm .node.clickable{cursor:pointer;}#mermaid-ybfubof50gm .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-ybfubof50gm .arrowheadPath{fill:#0b0b0b;}#mermaid-ybfubof50gm .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-ybfubof50gm .flowchart-link{stroke:#999;fill:none;}#mermaid-ybfubof50gm .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-ybfubof50gm .edgeLabel p{background-color:#ffffff;}#mermaid-ybfubof50gm .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-ybfubof50gm .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-ybfubof50gm .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-ybfubof50gm .cluster text{fill:#444;}#mermaid-ybfubof50gm .cluster span{color:#444;}#mermaid-ybfubof50gm div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-ybfubof50gm .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-ybfubof50gm rect.text{fill:none;stroke-width:0;}#mermaid-ybfubof50gm .icon-shape,#mermaid-ybfubof50gm .image-shape{background-color:#ffffff;text-align:center;}#mermaid-ybfubof50gm .icon-shape p,#mermaid-ybfubof50gm .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-ybfubof50gm .icon-shape rect,#mermaid-ybfubof50gm .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-ybfubof50gm :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-ybfubof50gm_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-ybfubof50gm_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-ybfubof50gm_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-ybfubof50gm_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-ybfubof50gm_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-ybfubof50gm_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentAction_EventCreation_0" d="M563.256,62L563.256,66.167C563.256,70.333,563.256,78.667,563.256,86.333C563.256,94,563.256,101,563.256,104.5L563.256,108"></path><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_EventCreation_OutboxSave_0" d="M463.427,156.191L429.739,161.993C396.051,167.794,328.674,179.397,294.986,190.699C261.298,202,261.298,213,261.298,218.5L261.298,224"></path><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_OutboxSave_KafkaPublish_0" d="M261.298,282L261.298,288.167C261.298,294.333,261.298,306.667,261.298,316.333C261.298,326,261.298,333,261.298,336.5L261.298,340"></path><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_EventCreation_PaymentProcessEvent_0" d="M563.256,166L563.256,170.167C563.256,174.333,563.256,182.667,563.256,190.333C563.256,198,563.256,205,563.256,208.5L563.256,212"></path><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_EventCreation_PaymentSuccessedEvent_0" d="M663.085,155.844L697.812,161.703C732.538,167.563,801.991,179.281,836.717,188.641C871.444,198,871.444,205,871.444,208.5L871.444,212"></path><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_KafkaPublish_Topic1_0" d="M191.551,398L180.788,402.167C170.024,406.333,148.498,414.667,137.734,422.333C126.971,430,126.971,437,126.971,440.5L126.971,444"></path><path marker-end="url(#mermaid-ybfubof50gm_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_KafkaPublish_Topic2_0" d="M331.045,398L341.808,402.167C352.571,406.333,374.098,414.667,384.862,422.333C395.625,430,395.625,437,395.625,440.5L395.625,444"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(563.2562789916992, 35)" id="flowchart-PaymentAction-0" class="node default"><rect height="54.00000190734863" width="226.45001220703125" y="-27.000000953674316" x="-113.22500610351562" style="" class="basic label-container"></rect><g transform="translate(-83.22500610351562, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="166.45001220703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Payment Status Change</p></span></div></foreignobject></g></g><g transform="translate(563.2562789916992, 139)" id="flowchart-EventCreation-1" class="node default"><rect height="54.00000190734863" width="199.65834045410156" y="-27.000000953674316" x="-99.82917022705078" style="" class="basic label-container"></rect><g transform="translate(-69.82917022705078, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="139.65834045410156"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Create Event Object</p></span></div></foreignobject></g></g><g transform="translate(261.2979278564453, 255)" id="flowchart-OutboxSave-3" class="node default"><rect height="54.00000190734863" width="243.9166717529297" y="-27.000000953674316" x="-121.95833587646484" style="" class="basic label-container"></rect><g transform="translate(-91.95833587646484, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="183.9166717529297"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Save to OutboxRepository</p></span></div></foreignobject></g></g><g transform="translate(261.2979278564453, 371)" id="flowchart-KafkaPublish-5" class="node default"><rect height="54.00000190734863" width="243.0916748046875" y="-27.000000953674316" x="-121.54583740234375" style="" class="basic label-container"></rect><g transform="translate(-91.54583740234375, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="183.0916748046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Outbox Publisher  Kafka</p></span></div></foreignobject></g></g><g transform="translate(563.2562789916992, 255)" id="flowchart-PaymentProcessEvent-7" class="node default"><rect height="78.00000381469727" width="260.00001525878906" y="-39.00000190734863" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -24.000001907348633)" style="" class="label"><rect></rect><foreignobject height="48.000003814697266" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PaymentProcessEvent<br>{orderId, paymentId, ip, paymentMethod}</p></span></div></foreignobject></g></g><g transform="translate(871.4438095092773, 255)" id="flowchart-PaymentSuccessedEvent-9" class="node default"><rect height="78.00000381469727" width="256.37501525878906" y="-39.00000190734863" x="-128.18750762939453" style="" class="basic label-container"></rect><g transform="translate(-98.18750762939453, -24.000001907348633)" style="" class="label"><rect></rect><foreignobject height="48.000003814697266" width="196.37501525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PaymentSuccessedEvent<br>{orderId, paymentId, userId}</p></span></div></foreignobject></g></g><g transform="translate(126.97084045410156, 475)" id="flowchart-Topic1-11" class="node default"><rect height="54.00000190734863" width="237.94168090820312" y="-27.000000953674316" x="-118.97084045410156" style="" class="basic label-container"></rect><g transform="translate(-88.97084045410156, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="177.94168090820312"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_PROCECSSING</p></span></div></foreignobject></g></g><g transform="translate(395.62501525878906, 475)" id="flowchart-Topic2-13" class="node default"><rect height="54.00000190734863" width="199.36666870117188" y="-27.000000953674316" x="-99.68333435058594" style="" class="basic label-container"></rect><g transform="translate(-69.68333435058594, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="139.36666870117188"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_SUCCESS</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L88-L96" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">88-96</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L167-L180" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">167-180</span></a></p>
<h3 id="payment-events-structure" class="group" data-header="true">Payment Events Structure<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>























<table><thead><tr><th>Event Type</th><th>Kafka Topic</th><th>Purpose</th><th>Key Fields</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">PaymentProcessEvent</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">PAYMENT_PROCECSSING</code></td><td>Notify order processing start</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">orderId</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">paymentId</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">paymentMethod</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">PaymentSuccessedEvent</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">PAYMENT_SUCCESS</code></td><td>Notify successful payment</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">orderId</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">paymentId</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">userId</code></td></tr></tbody></table>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/kafka/KafkaTopic.java" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/kafka/KafkaTopic.java</span></a> (referenced in imports), <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L92-L94" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">92-94</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L167-L171" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">167-171</span></a></p>
<h2 id="error-handling" class="group" data-header="true">Error Handling<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>The service implements comprehensive error handling with specific error codes for different failure scenarios.</p>
<h3 id="payment-specific-error-codes" class="group" data-header="true">Payment-Specific Error Codes<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>



































<table><thead><tr><th>Error Code</th><th>Message</th><th>HTTP Status</th><th>Scenario</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">E025</code></td><td>"Payment not found"</td><td>404</td><td>Invalid payment ID</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">E026</code></td><td>"Payment processing"</td><td>400</td><td>Duplicate processing attempt</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">E033</code></td><td>"Wallet not found"</td><td>404</td><td>User has no wallet</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">E034</code></td><td>"Insufficient balance"</td><td>400</td><td>Wallet balance too low</td></tr></tbody></table>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java#L35-L45" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">35-45</span></a></p>
<h3 id="status-validation-logic" class="group" data-header="true">Status Validation Logic<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-r1v" data-state="closed" data-slot="dialog-trigger"><div class="flex justify-center"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0.00000762939453125 0 1695.625244140625 409.00006103515625" style="max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="mermaid-kbqql9c9t5" preserveAspectRatio="xMidYMid meet"><style>#mermaid-kbqql9c9t5{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-kbqql9c9t5 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-kbqql9c9t5 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-kbqql9c9t5 .error-icon{fill:#dddddd;}#mermaid-kbqql9c9t5 .error-text{fill:#222222;stroke:#222222;}#mermaid-kbqql9c9t5 .edge-thickness-normal{stroke-width:1px;}#mermaid-kbqql9c9t5 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-kbqql9c9t5 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-kbqql9c9t5 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-kbqql9c9t5 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-kbqql9c9t5 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-kbqql9c9t5 .marker{fill:#999;stroke:#999;}#mermaid-kbqql9c9t5 .marker.cross{stroke:#999;}#mermaid-kbqql9c9t5 svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-kbqql9c9t5 p{margin:0;}#mermaid-kbqql9c9t5 .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-kbqql9c9t5 .cluster-label text{fill:#444;}#mermaid-kbqql9c9t5 .cluster-label span{color:#444;}#mermaid-kbqql9c9t5 .cluster-label span p{background-color:transparent;}#mermaid-kbqql9c9t5 .label text,#mermaid-kbqql9c9t5 span{fill:#333;color:#333;}#mermaid-kbqql9c9t5 .node rect,#mermaid-kbqql9c9t5 .node circle,#mermaid-kbqql9c9t5 .node ellipse,#mermaid-kbqql9c9t5 .node polygon,#mermaid-kbqql9c9t5 .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-kbqql9c9t5 .rough-node .label text,#mermaid-kbqql9c9t5 .node .label text,#mermaid-kbqql9c9t5 .image-shape .label,#mermaid-kbqql9c9t5 .icon-shape .label{text-anchor:middle;}#mermaid-kbqql9c9t5 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-kbqql9c9t5 .rough-node .label,#mermaid-kbqql9c9t5 .node .label,#mermaid-kbqql9c9t5 .image-shape .label,#mermaid-kbqql9c9t5 .icon-shape .label{text-align:center;}#mermaid-kbqql9c9t5 .node.clickable{cursor:pointer;}#mermaid-kbqql9c9t5 .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-kbqql9c9t5 .arrowheadPath{fill:#0b0b0b;}#mermaid-kbqql9c9t5 .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-kbqql9c9t5 .flowchart-link{stroke:#999;fill:none;}#mermaid-kbqql9c9t5 .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-kbqql9c9t5 .edgeLabel p{background-color:#ffffff;}#mermaid-kbqql9c9t5 .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-kbqql9c9t5 .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-kbqql9c9t5 .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-kbqql9c9t5 .cluster text{fill:#444;}#mermaid-kbqql9c9t5 .cluster span{color:#444;}#mermaid-kbqql9c9t5 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-kbqql9c9t5 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-kbqql9c9t5 rect.text{fill:none;stroke-width:0;}#mermaid-kbqql9c9t5 .icon-shape,#mermaid-kbqql9c9t5 .image-shape{background-color:#ffffff;text-align:center;}#mermaid-kbqql9c9t5 .icon-shape p,#mermaid-kbqql9c9t5 .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-kbqql9c9t5 .icon-shape rect,#mermaid-kbqql9c9t5 .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-kbqql9c9t5 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-kbqql9c9t5_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-kbqql9c9t5_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-kbqql9c9t5_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-kbqql9c9t5_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-kbqql9c9t5_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-kbqql9c9t5_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_PaymentRequest_StatusCheck_0" d="M831.781,62L831.781,66.167C831.781,70.333,831.781,78.667,831.852,86.417C831.922,94.167,832.062,101.334,832.133,104.917L832.203,108.501"></path><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StatusCheck_ProcessPayment_0" d="M763.055,204.274L654.256,221.895C545.457,239.516,327.86,274.758,219.061,297.879C110.263,321,110.263,332,110.263,337.5L110.263,343"></path><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StatusCheck_Error1_0" d="M768.77,209.989L706.063,226.658C643.355,243.326,517.94,276.663,455.233,298.832C392.525,321,392.525,332,392.525,337.5L392.525,343"></path><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StatusCheck_Error2_0" d="M788.49,229.709L772.344,243.091C756.198,256.473,723.905,283.236,707.759,302.118C691.613,321,691.613,332,691.613,337.5L691.613,343"></path><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StatusCheck_Error3_0" d="M876.072,229.709L892.052,243.091C908.032,256.473,939.991,283.236,955.97,302.118C971.95,321,971.95,332,971.95,337.5L971.95,343"></path><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StatusCheck_Error4_0" d="M895.411,210.37L955.98,226.975C1016.549,243.58,1137.687,276.79,1198.256,298.895C1258.825,321,1258.825,332,1258.825,337.5L1258.825,343"></path><path marker-end="url(#mermaid-kbqql9c9t5_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_StatusCheck_Error5_0" d="M901.611,204.171L1011.515,221.809C1121.42,239.447,1341.229,274.724,1451.133,297.862C1561.038,321,1561.038,332,1561.038,337.5L1561.038,343"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g transform="translate(110.26250457763672, 310.0000162124634)" class="edgeLabel"><g transform="translate(-32.2208366394043, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="64.4416732788086"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>CREATED</p></span></div></foreignobject></g></g><g transform="translate(392.5250244140625, 310.0000162124634)" class="edgeLabel"><g transform="translate(-46.32083511352539, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="92.64167022705078"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>PROCESSING</p></span></div></foreignobject></g></g><g transform="translate(691.6125411987305, 310.0000162124634)" class="edgeLabel"><g transform="translate(-31.98750114440918, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="63.97500228881836"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>SUCCESS</p></span></div></foreignobject></g></g><g transform="translate(971.9500503540039, 310.0000162124634)" class="edgeLabel"><g transform="translate(-24.150001525878906, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="48.30000305175781"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>FAILED</p></span></div></foreignobject></g></g><g transform="translate(1258.825065612793, 310.0000162124634)" class="edgeLabel"><g transform="translate(-34.47500228881836, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="68.95000457763672"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>CANCLED</p></span></div></foreignobject></g></g><g transform="translate(1561.0375747680664, 310.0000162124634)" class="edgeLabel"><g transform="translate(-39.48750305175781, -12.000000953674316)" class="label"><foreignobject height="24.000001907348633" width="78.97500610351562"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>REFUNDED</p></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(831.7812957763672, 35)" id="flowchart-PaymentRequest-0" class="node default"><rect height="54.00000190734863" width="177.02500915527344" y="-27.000000953674316" x="-88.51250457763672" style="" class="basic label-container"></rect><g transform="translate(-58.51250457763672, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="117.02500915527344"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>payment() called</p></span></div></foreignobject></g></g><g transform="translate(831.7812957763672, 192.50000762939453)" id="flowchart-StatusCheck-1" class="node default"><polygon transform="translate(-80.50000476837158,80.50000476837158)" class="label-container" points="80.50000476837158,0 161.00000953674316,-80.50000476837158 80.50000476837158,-161.00000953674316 0,-80.50000476837158"></polygon><g transform="translate(-53.500003814697266, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="107.00000762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>payment.status</p></span></div></foreignobject></g></g><g transform="translate(110.26250457763672, 374.0000171661377)" id="flowchart-ProcessPayment-3" class="node default"><rect height="54.00000190734863" width="204.52500915527344" y="-27.000000953674316" x="-102.26250457763672" style="" class="basic label-container"></rect><g transform="translate(-72.26250457763672, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="144.52500915527344"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Continue processing</p></span></div></foreignobject></g></g><g transform="translate(392.5250244140625, 374.0000171661377)" id="flowchart-Error1-5" class="node default"><rect height="54.00000190734863" width="260.00001525878906" y="-27.000000953674316" x="-130.00000762939453" style="" class="basic label-container"></rect><g transform="translate(-100.00000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="200.00001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_PROCESSING error</p></span></div></foreignobject></g></g><g transform="translate(691.6125411987305, 374.0000171661377)" id="flowchart-Error2-7" class="node default"><rect height="54.00000190734863" width="238.1750030517578" y="-27.000000953674316" x="-119.0875015258789" style="" class="basic label-container"></rect><g transform="translate(-89.0875015258789, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="178.1750030517578"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_SUCCESS error</p></span></div></foreignobject></g></g><g transform="translate(971.9500503540039, 374.0000171661377)" id="flowchart-Error3-9" class="node default"><rect height="54.00000190734863" width="222.50001525878906" y="-27.000000953674316" x="-111.25000762939453" style="" class="basic label-container"></rect><g transform="translate(-81.25000762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="162.50001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_FAILED error</p></span></div></foreignobject></g></g><g transform="translate(1258.825065612793, 374.0000171661377)" id="flowchart-Error4-11" class="node default"><rect height="54.00000190734863" width="251.25001525878906" y="-27.000000953674316" x="-125.62500762939453" style="" class="basic label-container"></rect><g transform="translate(-95.62500762939453, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="191.25001525878906"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_CANCELED error</p></span></div></foreignobject></g></g><g transform="translate(1561.0375747680664, 374.0000171661377)" id="flowchart-Error5-13" class="node default"><rect height="54.00000190734863" width="253.1750030517578" y="-27.000000953674316" x="-126.5875015258789" style="" class="basic label-container"></rect><g transform="translate(-96.5875015258789, -12.000000953674316)" style="" class="label"><rect></rect><foreignobject height="24.000001907348633" width="193.1750030517578"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>PAYMENT_REFUNDED error</p></span></div></foreignobject></g></g></g></g></g></svg></div><div class="bg-input-dark absolute right-2 top-2 rounded-sm p-1 opacity-0 transition-opacity group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z"></path></svg></div></div></pre>
<p>Sources: <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L66-L68" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">66-68</span></a> <a href="https://github.com/letrogthien/e-com-chuadatten/blob/35018ebc/wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java#L105-L124" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">105-124</span></a></p></div></div></div></div></div></div><div class="hidden overflow-hidden transition-[border-radius] xl:sticky xl:right-0 xl:top-20 xl:block xl:h-[calc(100vh-82px)] xl:w-64 xl:flex-shrink-0 2xl:w-72" style="scrollbar-width: none;"><div class="flex max-h-full w-full flex-shrink-0 flex-col py-6 pt-0 text-sm lg:pb-4 lg:pt-8 xl:w-64 2xl:w-72" style="scrollbar-color: var(--color-night) transparent;"><div><div class="relative mx-4 my-4 rounded-md border border-neutral-200 bg-neutral-100 p-3 text-sm text-neutral-600 dark:border-neutral-800 dark:bg-neutral-900 dark:text-neutral-400"><button class="absolute right-2 top-2 rounded-sm p-1 opacity-70 transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-neutral-400 focus:ring-offset-2"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg><span class="sr-only">Dismiss</span></button><p class="text-sm font-medium">Refresh this wiki</p><p class="mt-2 text-sm font-light text-neutral-500 dark:text-neutral-400">This wiki was recently refreshed. Please wait 7 days to refresh again.</p></div></div><h3 class="px-4 pb-5 text-lg font-medium leading-none">On this page</h3><ul class="min-h-0 flex-1 space-y-3 overflow-y-auto p-4 pt-0" style="scrollbar-width: none;"><li class=""><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#wallet-service" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Wallet Service</a></li><li class="ml-3"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#core-components" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Core Components</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#entity-architecture" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Entity Architecture</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#service-layer-architecture" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Service Layer Architecture</a></li><li class="ml-3"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#payment-processing-flow" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Payment Processing Flow</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#payment-state-machine" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Payment State Machine</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#wallet-payment-flow" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Wallet Payment Flow</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#vnpay-external-payment-flow" class="hover:text-primary pr-1 font-normal transition-all text-secondary">VNPAY External Payment Flow</a></li><li class="ml-3"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#database-design" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Database Design</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#core-tables-structure" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Core Tables Structure</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#transaction-logging-pattern" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Transaction Logging Pattern</a></li><li class="ml-3"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#vnpay-integration" class="hover:text-primary pr-1 font-normal transition-all text-secondary">VNPAY Integration</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#configuration-structure" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Configuration Structure</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#vnpay-request-building" class="hover:text-primary pr-1 font-normal transition-all text-secondary">VNPAY Request Building</a></li><li class="ml-3"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#event-driven-architecture" class="hover:text-primary pr-1 transition-all text-primary font-medium">Event-Driven Architecture</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#event-publishing-pattern" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Event Publishing Pattern</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#payment-events-structure" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Payment Events Structure</a></li><li class="ml-3"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#error-handling" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Error Handling</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#payment-specific-error-codes" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Payment-Specific Error Codes</a></li><li class="ml-6"><a href="https://deepwiki.com/letrogthien/e-com-chuadatten/3.3-wallet-service#status-validation-logic" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Status Validation Logic</a></li></ul></div></div><div class="pointer-events-none fixed bottom-2 left-2 right-2 mt-2 md:bottom-4 md:left-0 md:right-0"><div class="z-10 mx-auto max-w-3xl"><form class="z-20 w-full rounded-md ring-[0.5px] ring-[#353535] backdrop-blur-md transition-shadow [pointer-events:all] focus-within:ring-neutral-700 bg-component/70 border border-indigo-300/20 shadow-lg shadow-indigo-500/20 [backdrop-filter:blur(8px)]"><div class=""><div class="relative text-base font-normal"><div class="relative px-3 pt-3"><div class="pointer-events-none absolute left-3 right-3 top-3 ml-px flex w-full overflow-hidden text-base" aria-hidden="true"><div class="flex items-center gap-1 overflow-hidden text-wrap opacity-60">Ask Devin about letrogthien/e-com-chuadatten</div></div><textarea placeholder="" rows="2" class="w-full resize-none rounded-none bg-transparent text-white focus:outline-none text-base"></textarea></div></div></div><div class="border-border flex h-12 items-center justify-between border-t-[0.5px] p-3"><div class="flex items-center text-sm gap-4"><div class="flex items-center gap-1 sm:gap-2"><div class="flex gap-2 sm:items-center"><label for="useDeep" class="text-foreground flex cursor-text items-center gap-1 text-sm">Deep Research</label><div id="useDeep" class="relative inline-flex h-6 w-11 items-center rounded-full cursor-pointer border-[1px] border-[#b0b0b0] p-[1px] shadow-none dark:border-[#535353] dark:data-[state=checked]:bg-[#ef9541]/30 dark:data-[state=unchecked]:bg-[#181818]"><div class="absolute bottom-0 top-0 my-auto h-5 w-5 rounded-full bg-white shadow-md data-[state=unchecked]:bg-[#535353] data-[state=checked]:bg-[#ef9541]/80 cursor-pointer" style="transform: none;"></div><div class="h-full w-full rounded-full transition-colors duration-200 ease-in-out bg-[#d5d5d5] dark:bg-[#535353]"></div></div></div></div></div><div class="flex items-center gap-2"><button class="rounded-full bg-[#e0e0e0] p-1 text-neutral-400 transition-colors dark:bg-neutral-700" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M221.66,133.66l-72,72a8,8,0,0,1-11.32-11.32L196.69,136H40a8,8,0,0,1,0-16H196.69L138.34,61.66a8,8,0,0,1,11.32-11.32l72,72A8,8,0,0,1,221.66,133.66Z"></path></svg></button></div></div></form></div></div></div></div></div></div><!--/$--><script src="./Wallet Service _ letrogthien_e-com-chuadatten _ DeepWiki_files/webpack-acbbbb548492d4a6.js.download" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[51709,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"5009\",\"static/chunks/5009-cf1c1739f4eccbfa.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3377\",\"static/chunks/3377-d302682beb4206f6.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"6671\",\"static/chunks/6671-9def8ce641ff6e98.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"6967\",\"static/chunks/6967-c4b815e71e97ed18.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"7177\",\"static/chunks/app/layout-f37487c3576e7273.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\"],\"RootProvider\"]\n3:I[87555,[],\"\"]\n4:I[31295,[],\"\"]\n6:I[90894,[],\"ClientPageRoot\"]\n7:I[87667,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"4129\",\"static/chunks/7bf36345-06f80506190927ed.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2545\",\"static/chunks/c16f53c3-1a60b9b77b3e1d4b.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"537\",\"static/chunks/537-bef73e6675141c6f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"5009\",\"static/chunks/5009-cf1c1739f4eccbfa.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3377\",\"static/chunks/3377-d302682beb4206f6.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"6671\",\"static/chunks/6671-9def8ce641ff6e98.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8039\",\"static/chunks/8039-e53433e94d896525.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2136\",\"static/chunks/2136-947db7298d61ada7.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"6967\",\"static/chunks/6967-c4b815e71e97ed18.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"9769\",\"static/chunks/9769-220603704fe7fef4.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8674\",\"static/chunks/8674-a5b7b13d963b8a5d.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3283\",\"static/ch"])</script><script>self.__next_f.push([1,"unks/3283-f8ea31617a625982.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"5104\",\"static/chunks/5104-0cbc314c5d1c9712.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"5024\",\"static/chunks/5024-2b5018986dd9efb0.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2853\",\"static/chunks/2853-15b68c763707a31b.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3285\",\"static/chunks/app/%5Borg%5D/%5Brepo%5D/%5B%5B...wikiRoutes%5D%5D/page-c7bc5fad25f2d95a.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\"],\"default\"]\na:I[59665,[],\"OutletBoundary\"]\nd:I[59665,[],\"ViewportBoundary\"]\nf:I[59665,[],\"MetadataBoundary\"]\n11:I[26614,[],\"\"]\n:HL[\"/_next/static/media/4cf2300e9c8272f7-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/de70bee13400563f.css?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"style\"]\n:HL[\"/_next/static/css/fc1993f38795cea2.css?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"MLHC7bL1mRIjFnurNsI-v\",\"p\":\"\",\"c\":[\"\",\"letrogthien\",\"e-com-chuadatten\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[[\"org\",\"letrogthien\",\"d\"],{\"children\":[[\"repo\",\"e-com-chuadatten\",\"d\"],{\"children\":[[\"wikiRoutes\",\"\",\"oc\"],{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/de70bee13400563f.css?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/fc1993f38795cea2.css?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[[\"$\",\"head\",null,{}],[\"$\",\"body\",null,{\"className\":\"__variable_188709 font-geist-sans relative min-h-screen __variable_9a8899 bg-background antialiased\",\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}]]}],{\"children\":[[\"org\",\"letrogthien\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"repo\",\"e-com-chuadatten\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,\"$L5\"]}],{\"children\":[[\"wikiRoutes\",\"\",\"oc\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[\"$\",\"$L6\",null,{\"Component\":\"$7\",\"searchParams\":{},\"params\":{\"org\":\"letrogthien\",\"repo\":\"e-com-chuadatten\"},\"promises\":[\"$@8\",\"$@9\"]}],\"$undefined\",null,[\"$\",\"$La\",null,{\"children\":[\"$Lb\",\"$Lc\",null]}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"dqYK71dEEJCzt2tRTRBNd\",{\"children\":[[\"$\",\"$Ld\",null,{\"children\":\"$Le\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],[\"$\",\"$Lf\",null,{\"children\":\"$L10\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$11\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"8:{}\n9:{\"org\":\"letrogthien\",\"repo\":\"e-com-chuadatten\"}\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\nb:null\n"])</script><script>self.__next_f.push([1,"12:I[87437,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"537\",\"static/chunks/537-bef73e6675141c6f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"5009\",\"static/chunks/5009-cf1c1739f4eccbfa.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3377\",\"static/chunks/3377-d302682beb4206f6.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8039\",\"static/chunks/8039-e53433e94d896525.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2136\",\"static/chunks/2136-947db7298d61ada7.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"9769\",\"static/chunks/9769-220603704fe7fef4.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3449\",\"static/chunks/3449-13cf6a3413a1d31f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3283\",\"static/chunks/3283-f8ea31617a625982.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2015\",\"static/chunks/2015-d2f0d3f0cd483d40.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"736\",\"static/chunks/736-7ec209f4c8a08bb5.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2933\",\"static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-98e72fee56d7939f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\"],\"HeaderWrapperWithSuspense\"]\n13:I[93403,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"537\",\"static/chunks/537-bef73e6675141c6f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"5009\",\"static/chunks/5009-cf1c1739f4eccbfa.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3377\",\"static/chunks/3377-d302682beb4206f6.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"8039\",\"static/chunks/8039-e53433e94d896525.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2136\",\"static/chunks/2136-947db7298d61ada7.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"9769\",\"static/chunks/9769-220603704fe7fef4.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1Mt"])</script><script>self.__next_f.push([1,"EoRV\",\"3449\",\"static/chunks/3449-13cf6a3413a1d31f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"3283\",\"static/chunks/3283-f8ea31617a625982.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2015\",\"static/chunks/2015-d2f0d3f0cd483d40.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"736\",\"static/chunks/736-7ec209f4c8a08bb5.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\",\"2933\",\"static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-98e72fee56d7939f.js?dpl=dpl_Am21FVzNpGcuGYq2eJAGn1MtEoRV\"],\"WikiContextProvider\"]\n14:T2c38,"])</script><script>self.__next_f.push([1,"# Overview\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java](notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java](notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java)\n- [transaction/db.sql](transaction/db.sql)\n- [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java](transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java)\n- [transaction/src/main/java/com/chuadatten/transaction/common/Status.java](transaction/src/main/java/com/chuadatten/transaction/common/Status.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java)\n- [transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java](transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java)\n\n\u003c/details\u003e\n\n\n\nThis document provides a comprehensive introduction to the e-commerce microservices platform, explaining its architecture, core services, and key design patterns. The platform is built using event-driven microservices architecture with distributed transaction management and comprehensive payment processing capabilities.\n\nFor detailed information about individual services, see [Core Services](#3). For specific business workflows, see [Core Business Processes](#4). For API specifications, see [API Reference](#6).\n\n## Purpose and Scope\n\nThis e-commerce platform is designed as a distributed microservices system that handles the complete lifecycle of online transactions, from user registration through product management to payment processing and order fulfillment. The system emphasizes data consistency through event-driven architecture, financial transaction safety through wallet management, and scalability through service isolation.\n\nThe platform supports multiple user roles (buyers, sellers, administrators) with comprehensive authentication and authorization, dispute resolution mechanisms, and real-time notification capabilities.\n\n## System Architecture Overview\n\nThe platform consists of five core microservices, each responsible for distinct business domains, communicating through Apache Kafka for event-driven coordination.\n\n```mermaid\ngraph TB\n    subgraph \"Client Layer\"\n        WebApp[\"Web Application\"]\n        MobileApp[\"Mobile Application\"]\n    end\n    \n    subgraph \"Core Microservices\"\n        TransactionService[\"transaction\u003cbr/\u003eOrder Management\u003cbr/\u003eDisputes \u0026 Refunds\u003cbr/\u003eOrder Lifecycle\"]\n        ProductService[\"product\u003cbr/\u003eProduct Catalog\u003cbr/\u003eInventory Management\u003cbr/\u003eCategories \u0026 Variants\"]\n        WalletService[\"wallet\u003cbr/\u003eDigital Wallets\u003cbr/\u003ePayment Processing\u003cbr/\u003eVNPAY Integration\"]\n        UserService[\"user\u003cbr/\u003eAuthentication\u003cbr/\u003eUser Profiles\u003cbr/\u003eRole Management\"]\n        NotifyService[\"notify\u003cbr/\u003eEmail Notifications\u003cbr/\u003eWebSocket Messages\u003cbr/\u003eEventListener\"]\n    end\n    \n    subgraph \"Message Broker\"\n        Kafka[\"Apache Kafka\u003cbr/\u003eTopics:\u003cbr/\u003euser-register\u003cbr/\u003epayment.url.success\u003cbr/\u003euser-forgot-password\"]\n    end\n    \n    subgraph \"Data Layer\"\n        TransactionDB[\"transaction_db\u003cbr/\u003eMySQL\u003cbr/\u003eorders, order_items\u003cbr/\u003eorder_proofs, order_refunds\"]\n        ProductDB[\"product_db\u003cbr/\u003eMongoDB\u003cbr/\u003eproducts, categories\u003cbr/\u003einventory\"]\n        WalletDB[\"wallet_db\u003cbr/\u003eMySQL\u003cbr/\u003ewallets, transactions\u003cbr/\u003epayments\"]\n        UserDB[\"user_db\u003cbr/\u003eMySQL\u003cbr/\u003eusers, roles\u003cbr/\u003eauthentication\"]\n        NotifyDB[\"notify_db\u003cbr/\u003eMongoDB\u003cbr/\u003enotifications\u003cbr/\u003eOutboxEvent\"]\n    end\n    \n    WebApp --\u003e TransactionService\n    WebApp --\u003e ProductService\n    WebApp --\u003e WalletService\n    WebApp --\u003e UserService\n    MobileApp --\u003e TransactionService\n    MobileApp --\u003e ProductService\n    MobileApp --\u003e WalletService\n    MobileApp --\u003e UserService\n    \n    TransactionService --\u003e TransactionDB\n    ProductService --\u003e ProductDB\n    WalletService --\u003e WalletDB\n    UserService --\u003e UserDB\n    NotifyService --\u003e NotifyDB\n    \n    TransactionService -.-\u003e Kafka\n    ProductService -.-\u003e Kafka\n    WalletService -.-\u003e Kafka\n    UserService -.-\u003e Kafka\n    Kafka -.-\u003e NotifyService\n```\n\n**Sources:** [transaction/db.sql:1-128](), [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:1-19](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:1-61]()\n\n## Core Services Summary\n\n| Service | Primary Responsibility | Database | Key Entities |\n|---------|----------------------|----------|--------------|\n| **transaction** | Order lifecycle management, disputes, refunds | MySQL (`transaction_db`) | `Order`, `OrderItem`, `OrderProof`, `OrderRefund`, `OrderDispute` |\n| **product** | Product catalog, inventory, categories | MongoDB (`product_db`) | `Product`, `ProductVariant`, `Category`, `Inventory` |\n| **wallet** | Payment processing, digital wallets, VNPAY | MySQL (`wallet_db`) | `Wallet`, `WalletTransaction`, `Payment`, `PaymentAttempt` |\n| **user** | Authentication, user profiles, role management | MySQL (`user_db`) | `UserAuth`, `UserInf`, `Role`, `UserRole` |\n| **notify** | Email notifications, WebSocket messaging | MongoDB (`notify_db`) | `Notification`, `OutboxEvent` |\n\n**Sources:** [transaction/db.sql:8-127](), [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java:12-52]()\n\n## Technology Stack\n\n### Core Technologies\n- **Java Spring Boot** - Microservice framework\n- **Apache Kafka** - Event streaming and inter-service communication  \n- **MySQL** - Relational data storage for transactional data\n- **MongoDB** - Document storage for product catalogs and notifications\n- **Redis** - Caching and session management\n- **JWT** - Authentication and authorization\n- **VNPAY** - External payment gateway integration\n\n### Key Libraries and Frameworks\n- Spring Security for authentication/authorization\n- Spring Data JPA for MySQL operations\n- Spring Data MongoDB for document operations\n- Spring Kafka for message processing\n- WebSocket support for real-time notifications\n\n## Key Design Patterns\n\n### Event-Driven Architecture with Outbox Pattern\n\nThe platform implements the outbox pattern to ensure reliable event publishing across service boundaries. Each service maintains an `OutboxEvent` collection to guarantee event delivery even in failure scenarios.\n\n```mermaid\nsequenceDiagram\n    participant Client as \"Client Application\"\n    participant Transaction as \"TransactionService\"\n    participant OutboxRepo as \"OutboxRepository\"\n    participant Kafka as \"Kafka Broker\"\n    participant Product as \"ProductService\"\n    participant Notify as \"NotifyService\"\n    \n    Client-\u003e\u003eTransaction: \"POST /orders (OrderCreateRq)\"\n    Transaction-\u003e\u003eTransaction: \"Create Order entity\"\n    Transaction-\u003e\u003eOutboxRepo: \"Save OutboxEvent\u003cbr/\u003eeventType: ORDER_CREATED\u003cbr/\u003estatus: PENDING\"\n    Transaction-\u003e\u003eClient: \"Order created response\"\n    \n    Note over Transaction: \"Background OutboxPublisher\"\n    Transaction-\u003e\u003eOutboxRepo: \"Find PENDING events\"\n    OutboxRepo--\u003e\u003eTransaction: \"List\u003cOutboxEvent\u003e\"\n    Transaction-\u003e\u003eKafka: \"Publish to order.created topic\"\n    Transaction-\u003e\u003eOutboxRepo: \"Update status to PUBLISHED\u003cbr/\u003epublishedAt: now()\"\n    \n    Kafka--\u003e\u003eProduct: \"ConsumeEvent(OrderCreatedEvent)\"\n    Product-\u003e\u003eProduct: \"Reserve inventory\"\n    Product-\u003e\u003eKafka: \"Publish ProductReservationSuccess\"\n    \n    Kafka--\u003e\u003eNotify: \"ConsumeEvent via EventListener\"\n    Notify-\u003e\u003eNotify: \"Send order confirmation email\"\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java:18-52](), [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java:7-9](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:23-60]()\n\n### Order Status Management\n\nThe transaction service implements a comprehensive status tracking system with multiple status dimensions for orders and payments.\n\n| Order Status | Payment Status | Description |\n|--------------|----------------|-------------|\n| `PENDING` | `PENDING` | Order created, awaiting inventory confirmation |\n| `READY_PAY` | `PENDING` | Inventory reserved, ready for payment |\n| `PAID` | `SUCCESS` | Payment completed successfully |\n| `DELIVERED` | `SUCCESS` | Order fulfilled by seller |\n| `COMPLETED` | `SUCCESS` | Order lifecycle completed |\n| `CANCELLED` | `CANCELLED` | Order cancelled before payment |\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/common/Status.java:3-22](), [transaction/db.sql:18-19]()\n\n## Business Domain Overview\n\n### Core Business Entities\n\nThe platform manages several key business entities across services:\n\n1. **Orders** - Central transaction records linking buyers and sellers\n2. **Products** - Catalog items with variants and inventory tracking\n3. **Wallets** - Digital payment accounts with transaction history\n4. **Users** - Authentication and profile management with role-based access\n5. **Notifications** - Multi-channel communication system\n\n### Key Business Processes\n\n1. **User Registration \u0026 Authentication** - Handled by `user` service with email verification\n2. **Product Management** - Sellers manage inventory through `product` service\n3. **Order Processing** - Complete lifecycle from creation to fulfillment via `transaction` service\n4. **Payment Processing** - Wallet operations and external gateway integration via `wallet` service\n5. **Dispute Resolution** - Built-in dispute and refund mechanisms\n6. **Delivery Proof** - Sellers can upload delivery confirmations with multiple proof types\n\n### Proof System\n\nThe platform supports comprehensive delivery proof mechanisms through the `OrderProof` entity:\n\n| ProofType | Usage | Storage |\n|-----------|-------|---------|\n| `SCREENSHOT` | Visual delivery confirmation | File URL + metadata |\n| `VIDEO` | Video delivery proof | File URL + metadata |\n| `TEXT_NOTE` | Written delivery notes | Text content |\n| `DELIVERY` | Delivery receipt/tracking | Document URL |\n| `PURCHASE` | Purchase receipt/invoice | Document URL |\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java:3-8](), [transaction/db.sql:54-71]()\n\n### Event-Driven Communication\n\nServices communicate through well-defined Kafka topics:\n\n| Topic | Purpose | Producer | Consumer |\n|-------|---------|----------|----------|\n| `user-register` | User registration events | `user` service | `notify` service |\n| `user-forgot-password` | Password reset events | `user` service | `notify` service |\n| `payment.url.success` | Payment URL generation | `wallet` service | `notify` service |\n| `user-strange-device` | Security alerts | `user` service | `notify` service |\n\n**Sources:** [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:5-18](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-58]()\n\nThis overview establishes the foundation for understanding the platform's architecture and business capabilities. For detailed service specifications, refer to the individual service documentation in [Core Services](#3)."])</script><script>self.__next_f.push([1,"15:T2ea7,"])</script><script>self.__next_f.push([1,"# System Architecture\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java](notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java](notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java](transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java](transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the core architectural patterns and communication mechanisms used across the e-commerce microservices platform. It covers the event-driven architecture, outbox pattern implementation, and inter-service communication protocols that enable reliable data consistency across distributed services.\n\nFor specific service implementations, see [Core Services](#3). For end-to-end business processes that utilize this architecture, see [Core Business Processes](#4).\n\n## Microservices Architecture Overview\n\nThe platform implements a distributed microservices architecture with five core services communicating through Apache Kafka. Each service maintains its own data store and publishes domain events through a standardized outbox pattern.\n\n### Service Communication Pattern\n\n```mermaid\ngraph TB\n    subgraph \"Service Layer\"\n        TransactionService[\"Transaction Service\u003cbr/\u003e- Order Management\u003cbr/\u003e- OrderRepository\u003cbr/\u003e- OutboxRepository\"]\n        ProductService[\"Product Service\u003cbr/\u003e- Inventory Management\u003cbr/\u003e- Product Catalog\"]\n        WalletService[\"Wallet Service\u003cbr/\u003e- Payment Processing\u003cbr/\u003e- Financial Operations\"]\n        UserService[\"User Service\u003cbr/\u003e- Authentication\u003cbr/\u003e- User Profiles\"]\n        NotificationService[\"Notification Service\u003cbr/\u003e- EmailSender\u003cbr/\u003e- NotifyService\"]\n    end\n    \n    subgraph \"Event Infrastructure\"\n        KafkaCluster[\"Apache Kafka\u003cbr/\u003e- Event Streaming\u003cbr/\u003e- Topic Management\"]\n        OutboxEvents[\"Outbox Pattern\u003cbr/\u003e- OutboxEvent\u003cbr/\u003e- OutboxRepository\"]\n    end\n    \n    TransactionService --\u003e OutboxEvents\n    OutboxEvents --\u003e KafkaCluster\n    KafkaCluster --\u003e ProductService\n    KafkaCluster --\u003e WalletService\n    KafkaCluster --\u003e NotificationService\n    KafkaCluster --\u003e UserService\n    \n    TransactionService -.-\u003e KafkaCluster\n    ProductService -.-\u003e KafkaCluster\n    WalletService -.-\u003e KafkaCluster\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java:1-10](), [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:1-140](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:1-61]()\n\n## Event-Driven Communication Architecture\n\nThe system implements asynchronous communication through Kafka topics with dedicated event listeners in each service. This ensures loose coupling while maintaining data consistency across service boundaries.\n\n### Kafka Topic Structure\n\n```mermaid\ngraph LR\n    subgraph \"User Events\"\n        UserRegister[\"user-register\"]\n        UserForgotPassword[\"user-forgot-password\"]\n        UserSendOtp[\"user-send-otp\"]\n        UserStrangeDevice[\"user-strange-device\"]\n    end\n    \n    subgraph \"Transaction Events\"\n        OrderCreated[\"transaction.order.created\"]\n        OrderConfirmData[\"transaction.order.confirm.data\"]\n        OrderSuccess[\"transaction.order.success\"]\n        CheckingOrderReturn[\"order.checking.status\"]\n    end\n    \n    subgraph \"Product Events\"\n        ProductReservationSuccess[\"product.reservation.succeeded\"]\n        ProductReservationFailed[\"product.reservation.failed\"]\n    end\n    \n    subgraph \"Payment Events\"\n        PaymentProcessing[\"payment.payment.processing\"]\n        PaymentSuccess[\"payment.success\"]\n        PaymentUrlSuccess[\"payment.url.success\"]\n    end\n    \n    subgraph \"Event Listeners\"\n        TransactionEventListener[\"Transaction\u003cbr/\u003eEventListener\"]\n        NotifyEventListener[\"Notification\u003cbr/\u003eEventListener\"]\n    end\n    \n    UserRegister --\u003e NotifyEventListener\n    UserForgotPassword --\u003e NotifyEventListener\n    PaymentUrlSuccess --\u003e NotifyEventListener\n    ProductReservationSuccess --\u003e TransactionEventListener\n    ProductReservationFailed --\u003e TransactionEventListener\n    PaymentSuccess --\u003e TransactionEventListener\n    PaymentProcessing --\u003e TransactionEventListener\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java:1-24](), [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:1-20]()\n\n### Event Processing Flow\n\nThe platform uses Kafka consumer groups to ensure exactly-once processing of events across service instances:\n\n| Service | Consumer Group | Concurrency | Event Types |\n|---------|---------------|-------------|-------------|\n| Transaction | `transaction-group` | Default | Product reservations, Payment events |\n| Notification | `group1` | 3 | User events, Payment URLs |\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:32-139](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-59]()\n\n## Outbox Pattern Implementation\n\nThe Transaction service implements the outbox pattern to guarantee eventual consistency when publishing domain events. This ensures that database changes and event publishing occur atomically.\n\n### Outbox Event Structure\n\n```mermaid\nclassDiagram\n    class OutboxEvent {\n        +String id\n        +String aggregateType\n        +String aggregateId\n        +String eventType\n        +String payload\n        +String headers\n        +String status\n        +int attempts\n        +Instant createdAt\n        +Instant publishedAt\n    }\n    \n    class OutboxRepository {\n        \u003c\u003cinterface\u003e\u003e\n        +extends MongoRepository~OutboxEvent, String~\n    }\n    \n    class EventListener {\n        -OrderRepository orderRepository\n        -OutboxRepository outboxRepository\n        -JsonParserUtil jsonParserUtil\n        +listenProductReservationSucceeded()\n        +listenPaymentSuccess()\n        +listenPaymentProcessing()\n    }\n    \n    OutboxRepository --\u003e OutboxEvent : manages\n    EventListener --\u003e OutboxRepository : saves events\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java:1-53](), [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java:1-10]()\n\n### Event Publication Lifecycle\n\nWhen the Transaction service processes domain events, it follows this pattern:\n\n1. **Event Reception**: `EventListener` receives Kafka messages via `@KafkaListener` annotations\n2. **Business Logic**: Updates order status in `OrderRepository`\n3. **Event Creation**: Creates `OutboxEvent` with serialized payload using `JsonParserUtil`\n4. **Persistence**: Saves `OutboxEvent` to `OutboxRepository` with `status = \"PENDING\"`\n5. **Publication**: Background process publishes pending events to Kafka topics\n\n```mermaid\nsequenceDiagram\n    participant KL as \"KafkaListener\"\n    participant EL as \"EventListener\"\n    participant OR as \"OrderRepository\"\n    participant OBR as \"OutboxRepository\"\n    participant JPU as \"JsonParserUtil\"\n    participant K as \"Kafka\"\n    \n    K-\u003e\u003eKL: \"ProductReservationSuccessEvent\"\n    KL-\u003e\u003eEL: \"listenProductReservationSucceeded()\"\n    EL-\u003e\u003eOR: \"findById() \u0026 save()\"\n    EL-\u003e\u003eJPU: \"toJson(OrderComfirmData)\"\n    JPU--\u003e\u003eEL: \"JSON payload\"\n    EL-\u003e\u003eOBR: \"save(OutboxEvent)\"\n    Note over OBR: \"status='PENDING'\"\n    \n    loop Background Process\n        OBR-\u003e\u003eK: \"Publish pending events\"\n        OBR-\u003e\u003eOBR: \"Update status='PUBLISHED'\"\n    end\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:42-65]()\n\n## Inter-Service Communication Patterns\n\nServices communicate exclusively through domain events, maintaining loose coupling while ensuring data consistency across service boundaries.\n\n### Critical Communication Flows\n\n#### Order Processing Flow\n```mermaid\nsequenceDiagram\n    participant TS as \"Transaction Service\"\n    participant PS as \"Product Service\" \n    participant WS as \"Wallet Service\"\n    participant NS as \"Notification Service\"\n    \n    Note over TS,NS: Order Creation \u0026 Payment Flow\n    \n    TS-\u003e\u003ePS: \"transaction.order.created\"\n    PS-\u003e\u003eTS: \"product.reservation.succeeded\"\n    TS-\u003e\u003eTS: \"Update status to READY_PAY\"\n    TS-\u003e\u003eWS: \"transaction.order.confirm.data\"\n    \n    WS-\u003e\u003eTS: \"payment.payment.processing\"\n    TS-\u003e\u003eTS: \"Update status to PAYING\"\n    TS-\u003e\u003eWS: \"order.checking.status\"\n    \n    WS-\u003e\u003eTS: \"payment.success\"\n    TS-\u003e\u003eTS: \"Update status to PAID\"\n    TS-\u003e\u003ePS: \"transaction.order.success\"\n    TS-\u003e\u003eNS: \"payment.url.success\"\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:42-103]()\n\n#### Event Error Handling\n\nThe system implements comprehensive error handling for event processing:\n\n- **Failed Events**: `SendMessageError` entities stored via `MessageErrorRepository`\n- **Retry Logic**: `OutboxEvent.attempts` field tracks retry attempts\n- **Dead Letter Handling**: Failed product reservations trigger order cancellation\n\n```mermaid\ngraph TD\n    SendEvent[\"SendEvent Service\"] --\u003e KafkaTemplate[\"KafkaTemplate\"]\n    KafkaTemplate --\u003e Success{\"Send Success?\"}\n    Success --\u003e|Yes| Complete[\"Event Published\"]\n    Success --\u003e|No| ErrorRepo[\"MessageErrorRepository\"]\n    ErrorRepo --\u003e SendMessageError[\"SendMessageError Entity\"]\n    \n    subgraph \"Failure Recovery\"\n        ProductReservationFailed[\"ProductReservationFailedEvent\"]\n        ProductReservationFailed --\u003e CancelOrder[\"Set Order Status = CANCELLED\"]\n    end\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java:1-32](), [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:32-40]()\n\n## Event Publishing Infrastructure\n\n### Event Producer Architecture\n\nThe Transaction service uses a centralized `EventProducer` that delegates to `SendEvent` for asynchronous message delivery:\n\n| Component | Responsibility |\n|-----------|---------------|\n| `EventProducer` | High-level event publishing interface |\n| `SendEvent` | Kafka template management and error handling |\n| `KafkaTemplate` | Spring Kafka integration |\n| `MessageErrorRepository` | Failed message persistence |\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java:1-21](), [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java:1-32]()\n\n### Notification Service Integration\n\nThe Notification service consumes events from multiple domains and triggers user communications:\n\n- **Email Notifications**: Handled by `EmailSender` for user lifecycle events\n- **Real-time Notifications**: `NotifyService` pushes payment URLs via WebSocket\n- **Event Processing**: Dedicated `@KafkaListener` methods for each event type\n\n**Sources:** [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:24-60]()\n\nThis architecture ensures reliable, scalable communication between services while maintaining clear separation of concerns and enabling independent service deployment and scaling."])</script><script>self.__next_f.push([1,"16:T2ae7,"])</script><script>self.__next_f.push([1,"# Microservices Overview\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java](product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventListener.java](product/src/main/java/com/chuadatten/product/kafka/EventListener.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventProducer.java](product/src/main/java/com/chuadatten/product/kafka/EventProducer.java)\n- [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java](product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java](product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java)\n- [user/db.sql](user/db.sql)\n- [user/src/main/java/com/chuadatten/user/controller/AuthController.java](user/src/main/java/com/chuadatten/user/controller/AuthController.java)\n- [user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java](user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java](wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java)\n- [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java](wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document provides a comprehensive overview of the five core microservices that comprise the e-commerce platform architecture. It covers each service's primary responsibilities, technology stack, key components, and inter-service communication patterns. For detailed information about event-driven communication patterns and the outbox implementation, see [Event-Driven Architecture](#2.2). For authentication and security mechanisms across services, see [Authentication \u0026 Security](#2.3).\n\n## Service Architecture Overview\n\nThe platform is built around five domain-specific microservices, each with dedicated databases and clear boundaries:\n\n```mermaid\ngraph TB\n    subgraph \"Client Layer\"\n        Client[\"Client Applications\"]\n    end\n    \n    subgraph \"Microservices Layer\"\n        UserService[UserService\u003cbr/\u003e- AuthController\u003cbr/\u003e- UserInfRepository\u003cbr/\u003e- Role-based access control]\n        ProductService[ProductService\u003cbr/\u003e- ProductVariantRepository\u003cbr/\u003e- EventListener\u003cbr/\u003e- Inventory management]\n        TransactionService[TransactionService\u003cbr/\u003e- Order lifecycle\u003cbr/\u003e- Disputes \u0026 refunds\u003cbr/\u003e- Order management]\n        WalletService[WalletService\u003cbr/\u003e- PaymentServiceImpl\u003cbr/\u003e- VnpayUltils\u003cbr/\u003e- Wallet reservations]\n        NotifyService[NotificationService\u003cbr/\u003e- Event-driven alerts\u003cbr/\u003e- Email notifications\u003cbr/\u003e- WebSocket messaging]\n    end\n    \n    subgraph \"Data Layer\"\n        MySQL[(MySQL\u003cbr/\u003euser_db\u003cbr/\u003ewallet_db\u003cbr/\u003etransaction_db)]\n        MongoDB[(MongoDB\u003cbr/\u003eproduct collections\u003cbr/\u003enotification logs)]\n        Redis[(Redis\u003cbr/\u003eSessions \u0026 caching)]\n    end\n    \n    subgraph \"Message Bus\"\n        Kafka[Apache Kafka\u003cbr/\u003e- transaction.order.created\u003cbr/\u003e- product.reservation.success\u003cbr/\u003e- payment.success]\n    end\n    \n    Client --\u003e UserService\n    Client --\u003e ProductService\n    Client --\u003e TransactionService\n    Client --\u003e WalletService\n    \n    UserService --\u003e MySQL\n    TransactionService --\u003e MySQL\n    WalletService --\u003e MySQL\n    ProductService --\u003e MongoDB\n    NotifyService --\u003e MongoDB\n    \n    UserService --\u003e Redis\n    \n    UserService -.-\u003e Kafka\n    ProductService -.-\u003e Kafka\n    TransactionService -.-\u003e Kafka\n    WalletService -.-\u003e Kafka\n    Kafka -.-\u003e NotifyService\n```\n\nSources: [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:1-16](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:1-50](), [user/src/main/java/com/chuadatten/user/controller/AuthController.java:1-40](), [user/db.sql:1-50](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:1-17]()\n\n## Individual Service Details\n\n### User Service\n\n| Component | Technology | Purpose |\n|-----------|------------|---------|\n| Database | MySQL (`user_db`) | User authentication, profiles, roles |\n| Cache | Redis | Session management, token validation |\n| Key Classes | `AuthController`, `UserInfRepository` | Authentication endpoints, user data access |\n\nThe User Service handles all user-related operations through the `AuthController` class, which provides endpoints for registration, login, 2FA, and role management. The service maintains complex user data structures including authentication (`user_auth`), user information (`user_inf`), and role-based access control (`user_roles`, `roles`).\n\n**Key Features:**\n- JWT-based authentication with refresh tokens\n- Two-factor authentication with TOTP\n- Role-based authorization (`ROLE_USER`, `ROLE_ADMIN`, `ROLE_SELLER`)\n- KYC verification workflow\n- Device management and trusted devices\n\nSources: [user/src/main/java/com/chuadatten/user/controller/AuthController.java:34-111](), [user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java:14-21](), [user/db.sql:112-124]()\n\n### Product Service\n\n| Component | Technology | Purpose |\n|-----------|------------|---------|\n| Database | MongoDB | Product catalog, variants, categories |\n| Key Classes | `ProductVariantRepository`, `EventListener` | Data access, event processing |\n| Error Handling | `ErrorCode` enum | Standardized error responses |\n\nThe Product Service manages the entire product catalog using MongoDB for flexible schema design. The `ProductVariantRepository` handles product variant operations, while the `EventListener` class processes order-related events for inventory management.\n\n**Inventory Management:**\n- Real-time stock tracking with `availableQty`, `reservedQty`, and `soldQty`\n- Automatic reservation on order creation\n- Stock validation with `INSUFFICIENT_STOCK` error handling\n- Event-driven inventory updates through Kafka\n\nSources: [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:10-16](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-70](), [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java:23-24]()\n\n### Wallet Service\n\n| Component | Technology | Purpose |\n|-----------|------------|---------|\n| Database | MySQL | Wallet balances, transactions, payments |\n| Payment Gateway | VNPAY | External payment processing |\n| Key Classes | `PaymentServiceImpl`, `VnpayUltils` | Payment logic, gateway integration |\n\nThe Wallet Service handles all financial operations through the `PaymentServiceImpl` class, which supports both internal wallet payments and external gateway transactions via `VnpayUltils`. The service implements wallet reservations to ensure payment atomicity.\n\n**Payment Processing:**\n- Dual payment methods: internal wallet and VNPAY gateway\n- Wallet reservation system with `WalletReservation` entities\n- Payment attempt tracking with provider response logging\n- Outbox pattern for reliable event publishing\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:58-103](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:29-41]()\n\n### Transaction Service\n\nThe Transaction Service orchestrates the complete order lifecycle, from creation through fulfillment, disputes, and refunds. It maintains order state and coordinates with other services through event-driven communication.\n\n**Order Lifecycle Management:**\n- Order creation and validation\n- Status transitions (CREATED  READY_PAY  PAID  COMPLETED)\n- Dispute and refund handling\n- Delivery proof management\n\n### Notification Service\n\nThe Notification Service provides event-driven communication to users through multiple channels including email and WebSocket connections. It consumes events from all other services to provide real-time updates.\n\n## Inter-Service Communication Patterns\n\nThe services communicate primarily through Apache Kafka using domain-specific topics and the outbox pattern for reliable event publishing:\n\n```mermaid\nsequenceDiagram\n    participant TS as TransactionService\n    participant PS as ProductService\u003cbr/\u003eEventListener\n    participant WS as WalletService\u003cbr/\u003ePaymentServiceImpl\n    participant K as Kafka Topics\n    participant NS as NotificationService\n    \n    Note over TS,NS: Order Creation Flow\n    \n    TS-\u003e\u003eK: PublishEvent(\"transaction.order.created\")\n    K-\u003e\u003ePS: ConsumeEvent(OrderCreatedEvent)\n    \n    alt Stock Available\n        PS-\u003e\u003ePS: productVariantRepository.save()\n        PS-\u003e\u003eK: PublishEvent(\"product.reservation.success\")\n        K-\u003e\u003eTS: ConsumeEvent(ProductReservationSuccessEvent)\n        TS-\u003e\u003eTS: Update order status to READY_PAY\n    else Insufficient Stock  \n        PS-\u003e\u003eK: PublishEvent(\"product.reservation.failed\")\n        K-\u003e\u003eTS: ConsumeEvent(ProductReservationFailedEvent)\n        TS-\u003e\u003eTS: Cancel order\n    end\n    \n    Note over WS: Payment Processing\n    WS-\u003e\u003eWS: PaymentServiceImpl.payment()\n    WS-\u003e\u003eK: PublishEvent(\"payment.success\")\n    \n    K-\u003e\u003ePS: ConsumeEvent(PaymentSuccessedEvent)\n    K-\u003e\u003eTS: ConsumeEvent(PaymentSuccessedEvent)  \n    K-\u003e\u003eNS: ConsumeEvent(PaymentSuccessedEvent)\n    \n    PS-\u003e\u003ePS: Finalize inventory (reservedsold)\n    TS-\u003e\u003eTS: Mark order as PAID\n    NS-\u003e\u003eNS: Send payment confirmation\n```\n\n**Key Kafka Topics:**\n- `transaction.order.created` - Order creation events\n- `product.reservation.success` / `product.reservation.failed` - Inventory events  \n- `payment.success` - Payment completion events\n\nSources: [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-70](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:6-16](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:167-180]()\n\n## Technology Stack Summary\n\n| Service | Database | Key Technologies | Primary Responsibilities |\n|---------|----------|------------------|-------------------------|\n| User | MySQL + Redis | JWT, 2FA, Spring Security | Authentication, authorization, user management |\n| Product | MongoDB | Event sourcing, inventory tracking | Catalog management, stock control |\n| Transaction | MySQL | State machines, saga pattern | Order lifecycle, disputes |  \n| Wallet | MySQL | VNPAY integration, reservations | Payment processing, wallet operations |\n| Notification | MongoDB | WebSocket, email services | Multi-channel messaging |\n\nEach service implements the outbox pattern through `transactional_outbox` tables for reliable event publishing, ensuring eventual consistency across the distributed system.\n\nSources: [user/db.sql:274-288](), [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:5-6](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:28-29]()"])</script><script>self.__next_f.push([1,"17:T2db1,"])</script><script>self.__next_f.push([1,"# Event-Driven Architecture\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java](notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java](notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java](product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventListener.java](product/src/main/java/com/chuadatten/product/kafka/EventListener.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventProducer.java](product/src/main/java/com/chuadatten/product/kafka/EventProducer.java)\n- [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java](product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java](product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java](transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java](transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java)\n\n\u003c/details\u003e\n\n\n\nThis document describes the event-driven architecture implementation used for inter-service communication in the e-commerce platform. It covers the Kafka-based messaging system, outbox pattern implementation, and event flow patterns that enable loose coupling between microservices.\n\nFor complete order processing workflows, see [Order Lifecycle](#4.2). For payment-specific event handling, see [Payment Processing](#4.1). For detailed event schemas and topics, see [Event System](#4.3).\n\n## Architecture Overview\n\nThe platform implements event-driven architecture using Apache Kafka as the message broker, with services communicating through asynchronous events rather than direct API calls. This approach provides loose coupling, improved resilience, and eventual consistency across the distributed system.\n\n### Service Communication Pattern\n\n```mermaid\ngraph TD\n    subgraph \"Transaction Service\"\n        TS_API[\"TransactionController\"] --\u003e TS_Outbox[\"OutboxRepository\"]\n        TS_Outbox --\u003e TS_Kafka[\"EventProducer\"] \n        TS_Listener[\"EventListener\"] --\u003e TS_OrderRepo[\"OrderRepository\"]\n    end\n    \n    subgraph \"Product Service\"\n        PS_Listener[\"EventListener\"] --\u003e PS_Variant[\"ProductVariantRepository\"]\n        PS_Variant --\u003e PS_Outbox[\"OutboxRepository\"]\n        PS_Outbox --\u003e PS_Kafka[\"SendEvent\"]\n    end\n    \n    subgraph \"Wallet Service\"\n        WS_Listener[\"EventListener\"] --\u003e WS_Payment[\"PaymentRepository\"]\n        WS_Payment --\u003e WS_Kafka[\"EventProducer\"]\n    end\n    \n    subgraph \"Notification Service\"\n        NS_Listener[\"EventListener\"] --\u003e NS_Email[\"EmailSender\"]\n        NS_Listener --\u003e NS_Socket[\"NotifyService\"]\n    end\n    \n    subgraph \"Kafka Cluster\"\n        Topic1[\"transaction.order.created\"]\n        Topic2[\"product.reservation.success\"]\n        Topic3[\"payment.success\"]\n        Topic4[\"user-register\"]\n    end\n    \n    TS_Kafka --\u003e Topic1\n    Topic1 --\u003e PS_Listener\n    PS_Kafka --\u003e Topic2\n    Topic2 --\u003e TS_Listener\n    WS_Kafka --\u003e Topic3\n    Topic3 --\u003e PS_Listener\n    Topic3 --\u003e TS_Listener\n    TS_Kafka --\u003e Topic4\n    Topic4 --\u003e NS_Listener\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:1-139](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:1-91](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:1-61]()\n\n## Outbox Pattern Implementation\n\nThe platform implements the outbox pattern to ensure reliable event publishing in distributed transactions. Events are first stored in a local outbox table, then published to Kafka asynchronously.\n\n### Outbox Event Structure\n\n```mermaid\nerDiagram\n    OutboxEvent {\n        String id PK\n        String aggregateType\n        String aggregateId\n        String eventType\n        String payload\n        String headers\n        String status\n        int attempts\n        Instant createdAt\n        Instant publishedAt\n    }\n    \n    Order ||--o{ OutboxEvent : \"generates events\"\n    ProductVariant ||--o{ OutboxEvent : \"generates events\"\n```\n\nThe `OutboxEvent` entity stores event metadata and payload with the following key fields:\n\n| Field | Purpose | Index |\n|-------|---------|--------|\n| `aggregateId` | Links event to source entity |  |\n| `eventType` | Kafka topic for routing |  |\n| `status` | Tracks publishing state (PENDING/PUBLISHED) |  |\n| `attempts` | Retry counter for failed publishes | |\n| `publishedAt` | Timestamp when sent to Kafka |  |\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java:1-53](), [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java:1-10]()\n\n## Core Event Flow Patterns\n\n### Order Processing Event Chain\n\n```mermaid\nsequenceDiagram\n    participant TC as TransactionController\n    participant TO as OutboxRepository\n    participant K as Kafka\n    participant PL as Product EventListener\n    participant PV as ProductVariantRepository\n    participant TL as Transaction EventListener\n    participant OR as OrderRepository\n\n    TC-\u003e\u003eTO: \"Save OutboxEvent(ORDER_CREATED)\"\n    TO-\u003e\u003eK: \"Publish to transaction.order.created\"\n    K-\u003e\u003ePL: \"Consume OrderCreatedEvent\"\n    \n    alt Sufficient Stock\n        PL-\u003e\u003ePV: \"Reserve inventory\"\n        PL-\u003e\u003eTO: \"Save OutboxEvent(PRODUCT_RESERVATION_SUCCESS)\"\n        TO-\u003e\u003eK: \"Publish to product.reservation.success\"\n        K-\u003e\u003eTL: \"Consume ProductReservationSuccessEvent\"\n        TL-\u003e\u003eOR: \"Update order status to READY_PAY\"\n        TL-\u003e\u003eTO: \"Save OutboxEvent(ORDER_COMFIRM_DATA)\"\n    else Insufficient Stock\n        PL-\u003e\u003eTO: \"Save OutboxEvent(PRODUCT_RESERVATION_FAILED)\"\n        TO-\u003e\u003eK: \"Publish to product.reservation.failed\"\n        K-\u003e\u003eTL: \"Consume ProductReservationFailedEvent\"\n        TL-\u003e\u003eOR: \"Update order status to CANCELLED\"\n    end\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:42-65](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-70]()\n\n### Payment Success Event Handling\n\nWhen payment completes successfully, multiple services coordinate to finalize the transaction:\n\n```mermaid\ngraph LR\n    PS[\"PaymentSuccessedEvent\"] --\u003e TL[\"Transaction EventListener\"]\n    PS --\u003e PL[\"Product EventListener\"]\n    PS --\u003e NL[\"Notification EventListener\"]\n    \n    TL --\u003e OR[\"Order.status = PAID\"]\n    TL --\u003e TO[\"OutboxEvent(ORDER_SUCCESS)\"]\n    \n    PL --\u003e PV[\"ProductVariant.reservedQty--\u003cbr/\u003eProductVariant.soldQty++\"]\n    \n    NL --\u003e EM[\"Send confirmation email\"]\n    NL --\u003e WS[\"WebSocket notification\"]\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:67-103](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:72-86]()\n\n## Technical Implementation Details\n\n### Kafka Topic Configuration\n\nEach service defines its own `KafkaTopic` enum for type-safe topic management:\n\n**Transaction Service Topics:**\n- `ORDER_CREATED`  \"transaction.order.created\"\n- `ORDER_COMFIRM_DATA`  \"transaction.order.confirm.data\" \n- `ORDER_SUCCESS`  \"transaction.order.success\"\n- `CHECKING_ORDER_RETURN`  \"order.checking.status\"\n\n**Product Service Topics:**\n- `PRODUCT_RESERVATION_SUCCESS`  \"product.reservation.success\"\n- `PRODUCT_RESERVATION_FAILED`  \"product.reservation.failed\"\n\n**Notification Service Topics:**\n- `REGISTER`  \"user-register\"\n- `PAYMENT_URL_SUCCESS`  \"payment.url.success\"\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java:1-24](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:1-17](), [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:1-20]()\n\n### Event Publishing Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Event Publishing Layer\"\n        EP[\"EventProducer\"] --\u003e SE[\"SendEvent\"]\n        SE --\u003e KT[\"KafkaTemplate\u003cString, Object\u003e\"]\n        SE --\u003e MER[\"MessageErrorRepository\"]\n    end\n    \n    subgraph \"Kafka Infrastructure\"\n        KT --\u003e KC[\"Kafka Cluster\"]\n        KC --\u003e CG1[\"Consumer Group: transaction-group\"]\n        KC --\u003e CG2[\"Consumer Group: product-group\"]\n        KC --\u003e CG3[\"Consumer Group: group1\"]\n    end\n    \n    subgraph \"Error Handling\"\n        KT --\u003e SME[\"SendMessageError\"]\n        SME --\u003e MER\n    end\n```\n\nThe `SendEvent` class provides async publishing with error handling:\n- Uses `@Async` annotation for non-blocking sends\n- Captures failed messages in `MessageErrorRepository`\n- Returns `CompletableFuture\u003cSendResult\u003e` for monitoring\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java:1-31](), [transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java:1-21]()\n\n### Consumer Configuration\n\nEvent listeners use `@KafkaListener` annotations with specific configurations:\n\n```java\n@KafkaListener(topics = \"transaction.order.created\", groupId = \"product-group\")\n@KafkaListener(topics = \"user-register\", concurrency = \"3\", groupId = \"group1\")\n```\n\nKey configuration patterns:\n- **Consumer Groups**: Ensure single processing per service type\n- **Concurrency**: Multiple concurrent consumers for high-throughput topics  \n- **Topic Specificity**: Each listener handles one specific event type\n\n**Sources:** [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-31](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-27]()\n\n## Error Handling and Reliability\n\n### Message Failure Recovery\n\nThe system implements several reliability mechanisms:\n\n1. **Outbox Pattern**: Local storage before Kafka publishing prevents data loss\n2. **Async Error Capture**: Failed Kafka sends stored in `SendMessageError` \n3. **Retry Tracking**: `OutboxEvent.attempts` counter for republishing\n4. **Status Monitoring**: Event status tracking (`PENDING`/`PUBLISHED`)\n\n### Event Ordering and Consistency\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e PENDING : \"Event created in outbox\"\n    PENDING --\u003e PUBLISHING : \"Kafka send initiated\"\n    PUBLISHING --\u003e PUBLISHED : \"Kafka ACK received\"\n    PUBLISHING --\u003e FAILED : \"Kafka send failed\"\n    FAILED --\u003e PENDING : \"Retry after backoff\"\n    PUBLISHED --\u003e [*]\n```\n\nThe platform ensures eventual consistency through:\n- **Ordered Processing**: Events processed in creation order per aggregate\n- **Idempotency Keys**: Prevent duplicate event processing\n- **State Validation**: Services validate current state before processing events\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java:38-51](), [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java:18-31]()"])</script><script>self.__next_f.push([1,"18:T2e02,"])</script><script>self.__next_f.push([1,"# Authentication \u0026 Security\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java](product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java)\n- [product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java](product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java)\n- [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java](product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java)\n- [product/src/main/java/com/chuadatten/product/service/ProductVariantService.java](product/src/main/java/com/chuadatten/product/service/ProductVariantService.java)\n- [product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java](product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java)\n- [product/src/main/resources/application.properties](product/src/main/resources/application.properties)\n- [user/src/main/java/com/chuadatten/user/controller/UserInforController.java](user/src/main/java/com/chuadatten/user/controller/UserInforController.java)\n- [user/src/main/java/com/chuadatten/user/securities/Security.java](user/src/main/java/com/chuadatten/user/securities/Security.java)\n- [user/src/main/java/com/chuadatten/user/services/UserInforService.java](user/src/main/java/com/chuadatten/user/services/UserInforService.java)\n- [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java](user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java)\n- [user/src/main/java/com/chuadatten/user/services/impl/UserInforServiceImpl.java](user/src/main/java/com/chuadatten/user/services/impl/UserInforServiceImpl.java)\n\n\u003c/details\u003e\n\n\n\nThis document covers the JWT-based authentication and authorization system used across all microservices in the e-commerce platform. The system implements a comprehensive security model with role-based access control, two-factor authentication, device management, and cross-service token validation.\n\nFor information about user profile management and KYC verification, see [User Service](#3.4). For details about event-driven inter-service communication patterns, see [Event-Driven Architecture](#2.2).\n\n## JWT Authentication Architecture\n\nThe platform uses a centralized JWT authentication system where the User Service acts as the primary identity provider for all microservices. Each service validates JWT tokens independently while sharing the same public key infrastructure.\n\n### JWT Token Flow Architecture\n\n```mermaid\ngraph TB\n    subgraph \"User Service (Auth Provider)\"\n        A[AuthServiceImpl] --\u003e B[JwtUtils]\n        B --\u003e C[Token Generation]\n        C --\u003e D[ACCESS_TOKEN]\n        C --\u003e E[REFRESH_TOKEN]\n        C --\u003e F[TMP_TOKEN]\n        C --\u003e G[ACTIVATION_TOKEN]\n        C --\u003e H[PASSWORD_RESET_TOKEN]\n    end\n    \n    subgraph \"Cross-Service Validation\"\n        I[CustomJwtDecoder] --\u003e J{Token Issuer?}\n        J --\u003e|Internal| K[Internal JWKS]\n        J --\u003e|Google OAuth| L[Google JWKS]\n        K --\u003e M[http://localhost:8081/api/v1/oauth2/jwks]\n        L --\u003e N[https://www.googleapis.com/oauth2/v3/certs]\n    end\n    \n    subgraph \"Token Processing Pipeline\"\n        O[GetTokenResolver] --\u003e P[CustomAuthenticationConverter]\n        P --\u003e Q[CustomAuthenticationEntryPoint]\n        I --\u003e P\n    end\n    \n    A --\u003e I\n    O --\u003e I\n```\n\nThe system supports both internally-generated JWT tokens and Google OAuth tokens, automatically routing to the appropriate validation mechanism based on the token issuer.\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:218-242](), [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java:22-46]()\n\n### Token Types and Usage\n\n| Token Type | Purpose | Lifetime | Usage |\n|------------|---------|----------|-------|\n| `ACCESS_TOKEN` | API authorization | 1 hour | Standard API access |\n| `REFRESH_TOKEN` | Token refresh | 7 days | Renewing access tokens |\n| `TMP_TOKEN` | 2FA workflow | Short-lived | Temporary during 2FA |\n| `ACTIVATION_TOKEN` | Account activation | Variable | Email verification |\n| `PASSWORD_RESET_TOKEN` | Password reset | Variable | Forgot password flow |\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:218-242](), [user/src/main/java/com/chuadatten/user/common/TokenType.java]()\n\n## Role-Based Access Control\n\nThe system implements a hierarchical role-based access control (RBAC) model with three primary roles, each inheriting permissions from lower levels.\n\n### Security Configuration and Role Mapping\n\n```mermaid\ngraph TD\n    subgraph \"Security Configuration\"\n        A[Security.java] --\u003e B[configureAuthorizationRules]\n        B --\u003e C[ROLE_ADMIN]\n        B --\u003e D[ROLE_SELLER]\n        B --\u003e E[ROLE_USER]\n    end\n    \n    subgraph \"Role Hierarchy\"\n        C --\u003e F[\"admin/** endpoints\"]\n        C --\u003e G[\"assign-role endpoint\"]\n        D --\u003e H[\"seller/** endpoints\"]\n        D --\u003e I[\"Product management\"]\n        E --\u003e J[\"users/me/** endpoints\"]\n        E --\u003e K[\"Basic user operations\"]\n    end\n    \n    subgraph \"Permission Inheritance\"\n        C -.-\u003e D\n        C -.-\u003e E\n        D -.-\u003e E\n    end\n```\n\nSources: [user/src/main/java/com/chuadatten/user/securities/Security.java:35-78]()\n\n### Role Assignment Requirements\n\nThe system enforces specific requirements for role elevation:\n\n- **ROLE_USER**: Default role assigned during registration\n- **ROLE_SELLER**: Requires completed KYC verification (`user.getIsKyc().equals(true)`)\n- **ROLE_ADMIN**: Manually assigned by existing administrators\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:535-544]()\n\n### Authorization Matrix\n\n| Endpoint Pattern | ADMIN | SELLER | USER | Public |\n|------------------|-------|--------|------|--------|\n| `/admin/**` |  |  |  |  |\n| `/seller/**` |  |  |  |  |\n| `/users/me/**` |  |  |  |  |\n| `/auth/login` |  |  |  |  |\n| `/auth/register` |  |  |  |  |\n| GET `/users/**` |  |  |  |  |\n\nSources: [user/src/main/java/com/chuadatten/user/securities/Security.java:36-77]()\n\n## Authentication Flow\n\nThe authentication system supports multiple flows including standard login, two-factor authentication, and device management.\n\n### Complete Authentication Sequence\n\n```mermaid\nsequenceDiagram\n    participant C as \"Client\"\n    participant A as \"AuthServiceImpl\"\n    participant D as \"DeviceManager\"\n    participant O as \"OtpModelCacheService\"\n    participant W as \"WhiteListCacheService\"\n    participant E as \"EventProducer\"\n\n    C-\u003e\u003eA: \"login(LoginRequest)\"\n    A-\u003e\u003eA: \"validateCredentials()\"\n    \n    alt Invalid Credentials\n        A--\u003e\u003eC: \"Invalid username or password\"\n    end\n    \n    A-\u003e\u003eD: \"handlerDeviceInformation()\"\n    \n    alt New Device\n        D-\u003e\u003eD: \"saveNewDevice()\"\n        D-\u003e\u003eE: \"strangeDevice(StrangeDevice)\"\n    end\n    \n    alt 2FA Enabled\n        A-\u003e\u003eO: \"saveAndSendOtp()\"\n        A-\u003e\u003eE: \"sendOtp(OtpEvent)\"\n        A--\u003e\u003eC: \"TMP_TOKEN + 2FA Required\"\n        \n        C-\u003e\u003eA: \"verifyTwoFAuth(Verify2FaRequest)\"\n        A-\u003e\u003eO: \"validateOtp()\"\n        \n        alt Invalid OTP\n            A--\u003e\u003eC: \"UNAUTHORIZED\"\n        end\n    end\n    \n    A-\u003e\u003eA: \"generateLoginResponse()\"\n    A-\u003e\u003eW: \"saveToCache(WhiteList)\"\n    A--\u003e\u003eC: \"ACCESS_TOKEN + REFRESH_TOKEN (cookies)\"\n```\n\nThe flow includes device fingerprinting, optional 2FA verification, and token caching for session management.\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:167-189](), [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:244-253]()\n\n## Security Features\n\n### Two-Factor Authentication (2FA)\n\nThe 2FA system uses OTP (One-Time Password) codes sent via email:\n\n```mermaid\ngraph LR\n    A[User Login] --\u003e B{2FA Enabled?}\n    B --\u003e|Yes| C[Generate OTP]\n    B --\u003e|No| D[Standard Login]\n    C --\u003e E[Cache OTP]\n    C --\u003e F[Send Email]\n    E --\u003e G[Return TMP_TOKEN]\n    G --\u003e H[User Submits OTP]\n    H --\u003e I[Validate Cached OTP]\n    I --\u003e J{Valid?}\n    J --\u003e|Yes| K[Full Authentication]\n    J --\u003e|No| L[Reject]\n```\n\nUsers can enable/disable 2FA through dedicated endpoints with OTP verification required for disabling.\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:398-436]()\n\n### Device Management and Trust\n\nThe system tracks user devices to detect suspicious login attempts:\n\n- **Device Fingerprinting**: Tracks `deviceName` and `deviceType`\n- **Trust Management**: Users can explicitly trust devices to skip 2FA\n- **Suspicious Activity**: Sends email alerts for new device logins\n- **Device History**: Maintains `lastLoginAt` timestamps per device\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:192-216](), [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:439-448]()\n\n### Password Security\n\nThe platform implements comprehensive password security measures:\n\n- **BCrypt Encoding**: All passwords are hashed using `CustomPasswordEncoder`\n- **Password History**: Prevents reuse of last 3 passwords\n- **Password Reset Flow**: Secure token-based reset with email verification\n- **Change Password**: Requires old password verification\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:344-371](), [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:486-516]()\n\n## JWT Claims and Cross-Service Security\n\n### JWT Claims Extraction\n\nThe system uses a custom `@JwtClaims` annotation to automatically extract user information from JWT tokens:\n\n```java\n// Example usage in controllers\npublic ApiResponse\u003cUserInfDto\u003e updateUserInfo(\n    @JwtClaims(\"id\") UUID userId,\n    @RequestBody UpdateUserRequest request\n)\n```\n\nThis annotation extracts specific claims from the JWT token, commonly used for:\n- User ID extraction (`@JwtClaims(\"id\")`)\n- Role verification\n- Session validation\n\nSources: [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:56](), [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:86]()\n\n### Cross-Service Security Implementation\n\n```mermaid\ngraph TB\n    subgraph \"Service A (e.g., Product Service)\"\n        A1[CustomJwtDecoder] --\u003e A2[Token Validation]\n        A2 --\u003e A3[Claims Extraction]\n        A3 --\u003e A4[Authorization Check]\n    end\n    \n    subgraph \"User Service (Identity Provider)\"\n        B1[JWKS Endpoint] --\u003e B2[\"/api/v1/oauth2/jwks\"]\n        B3[JWT Generation] --\u003e B4[Token Signing]\n    end\n    \n    subgraph \"External OAuth\"\n        C1[Google OAuth] --\u003e C2[\"https://www.googleapis.com/oauth2/v3/certs\"]\n    end\n    \n    A1 --\u003e B2\n    A1 --\u003e C2\n    B4 --\u003e A1\n```\n\nEach microservice independently validates JWT tokens by fetching public keys from the User Service's JWKS endpoint, ensuring no single point of failure in the authentication chain.\n\nSources: [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java:38-45]()\n\n### Session Management\n\nThe system uses Redis-based caching for session management:\n\n- **WhiteList Caching**: Tracks valid refresh tokens with JTI (JWT ID)\n- **OTP Caching**: Temporarily stores 2FA codes with expiration\n- **Session Invalidation**: Supports logout and logout-all operations\n- **Token Refresh**: Validates cached refresh tokens before issuing new access tokens\n\nThe `WhiteListCacheService` and `OtpModelCacheService` handle distributed session state across the microservices architecture.\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:285-296](), [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:308-327]()"])</script><script>self.__next_f.push([1,"19:T2fc9,"])</script><script>self.__next_f.push([1,"# Core Services\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java](product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventListener.java](product/src/main/java/com/chuadatten/product/kafka/EventListener.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventProducer.java](product/src/main/java/com/chuadatten/product/kafka/EventProducer.java)\n- [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java](product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java](product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java)\n- [transaction/db.sql](transaction/db.sql)\n- [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java](transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java)\n- [transaction/src/main/java/com/chuadatten/transaction/common/Status.java](transaction/src/main/java/com/chuadatten/transaction/common/Status.java)\n- [transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java](transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java](wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java)\n- [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java](wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java)\n\n\u003c/details\u003e\n\n\n\nThis document provides an overview of the five core microservices that comprise the e-commerce platform: Transaction Service, Product Service, Wallet Service, User Service, and Notification Service. Each service owns its domain-specific functionality and data models, communicating through event-driven patterns via Apache Kafka.\n\nFor detailed implementation specifics of each service, see the individual service documentation: [Transaction Service](#3.1), [Product Service](#3.2), [Wallet Service](#3.3), [User Service](#3.4), and [Notification Service](#3.5). For cross-service business processes and workflows, see [Core Business Processes](#4).\n\n## Service Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph \"Core Microservices\"\n        TransactionService[\"Transaction Service\u003cbr/\u003etransaction:8082\u003cbr/\u003eMySQL Database\"]\n        ProductService[\"Product Service\u003cbr/\u003eproduct:8081\u003cbr/\u003eMongoDB Database\"]\n        WalletService[\"Wallet Service\u003cbr/\u003ewallet:8083\u003cbr/\u003eMySQL Database\"]\n        UserService[\"User Service\u003cbr/\u003euser:8080\u003cbr/\u003eMySQL Database\"]\n        NotificationService[\"Notification Service\u003cbr/\u003enotification:8084\u003cbr/\u003eMongoDB Database\"]\n    end\n    \n    subgraph \"Infrastructure\"\n        KafkaCluster[\"Apache Kafka\u003cbr/\u003eEvent Streaming\"]\n        MySQLCluster[\"MySQL\u003cbr/\u003eRelational Storage\"]\n        MongoDBCluster[\"MongoDB\u003cbr/\u003eDocument Storage\"]\n        RedisCluster[\"Redis\u003cbr/\u003eCaching \u0026 Sessions\"]\n    end\n    \n    TransactionService --\u003e MySQLCluster\n    WalletService --\u003e MySQLCluster\n    UserService --\u003e MySQLCluster\n    \n    ProductService --\u003e MongoDBCluster\n    NotificationService --\u003e MongoDBCluster\n    \n    UserService --\u003e RedisCluster\n    \n    TransactionService -.-\u003e KafkaCluster\n    ProductService -.-\u003e KafkaCluster\n    WalletService -.-\u003e KafkaCluster\n    UserService -.-\u003e KafkaCluster\n    NotificationService -.-\u003e KafkaCluster\n```\n\n**Sources:** [transaction/db.sql:1-128](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:1-17](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:1-210]()\n\n## Service Responsibilities\n\n| Service | Primary Domain | Database | Key Entities | Port |\n|---------|---------------|----------|--------------|------|\n| Transaction | Order lifecycle, disputes, refunds | MySQL | `orders`, `order_items`, `order_proofs` | 8082 |\n| Product | Catalog, inventory, variants | MongoDB | `Product`, `ProductVariant`, `Category` | 8081 |\n| Wallet | Payments, digital wallets, VNPAY | MySQL | `Payment`, `Wallet`, `WalletTransaction` | 8083 |\n| User | Authentication, profiles, KYC | MySQL | `UserAuth`, `UserInf`, `UserRole` | 8080 |\n| Notification | Email, WebSocket, event alerts | MongoDB | `NotificationEvent`, `EmailTemplate` | 8084 |\n\n**Sources:** [transaction/db.sql:3-6](), [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:1-16](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:46-56]()\n\n## Core Data Models\n\n```mermaid\nerDiagram\n    %% Transaction Service Entities\n    orders {\n        BINARY_16 id PK\n        BINARY_16 buyer_id FK\n        BINARY_16 seller_id FK\n        DECIMAL total_amount\n        VARCHAR status\n        VARCHAR payment_status\n        DATETIME created_at\n    }\n    \n    order_items {\n        BINARY_16 id PK\n        BINARY_16 order_id FK\n        VARCHAR product_id\n        VARCHAR product_variant_id\n        DECIMAL unit_price\n        INT quantity\n        DECIMAL subtotal\n    }\n    \n    order_proofs {\n        BINARY_16 id PK\n        BINARY_16 order_id FK\n        BINARY_16 seller_id FK\n        VARCHAR type\n        VARCHAR url\n        VARCHAR note\n    }\n    \n    %% Product Service Entities\n    ProductVariant {\n        String id PK\n        String productId FK\n        String sku\n        BigDecimal price\n        Integer availableQty\n        Integer reservedQty\n        Integer soldQty\n    }\n    \n    %% Wallet Service Entities\n    Payment {\n        UUID id PK\n        UUID userId FK\n        UUID orderId FK\n        BigDecimal amount\n        String currency\n        Status status\n        String txnRef\n    }\n    \n    WalletReservation {\n        UUID id PK\n        UUID walletId FK\n        UUID orderId FK\n        BigDecimal amount\n        Status status\n    }\n    \n    %% Relationships\n    orders ||--o{ order_items : contains\n    orders ||--o{ order_proofs : has_proof\n    orders ||--|| Payment : paid_by\n    Payment ||--|| WalletReservation : reserves\n    order_items }o--|| ProductVariant : references\n```\n\n**Sources:** [transaction/db.sql:9-127](), [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:11-15](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:77-84]()\n\n## Event-Driven Communication\n\n```mermaid\nsequenceDiagram\n    participant TS as \"TransactionService\"\n    participant PS as \"ProductService\u003cbr/\u003eEventListener\"\n    participant WS as \"WalletService\u003cbr/\u003ePaymentServiceImpl\"\n    participant K as \"Kafka Topics\"\n\n    Note over TS,WS: Order Processing Flow\n    \n    TS-\u003e\u003eK: \"transaction.order.created\"\u003cbr/\u003eOrderCreatedEvent\n    K-\u003e\u003ePS: listenOrderCreatedEvent()\n    \n    alt Stock Available\n        PS-\u003e\u003ePS: productVariantRepository.save()\n        PS-\u003e\u003eK: \"product.reservation.success\"\u003cbr/\u003eProductReservationSuccessEvent\n        K-\u003e\u003eTS: Update order status to READY_PAY\n        \n        TS-\u003e\u003eK: \"order.confirm.data\"\u003cbr/\u003eOrderConfirmData\n        K-\u003e\u003eWS: Create Payment entity\n        \n        WS-\u003e\u003eWS: payment() method\n        WS-\u003e\u003eK: \"payment.processing\"\u003cbr/\u003ePaymentProcessEvent\n        \n        WS-\u003e\u003eWS: handleProviderCallback()\n        WS-\u003e\u003eK: \"payment.success\"\u003cbr/\u003ePaymentSuccessedEvent\n        \n        K-\u003e\u003ePS: listenOrderSuccess()\n        PS-\u003e\u003ePS: Finalize inventory (reservedsold)\n        \n    else Insufficient Stock\n        PS-\u003e\u003eK: \"product.reservation.failed\"\u003cbr/\u003eProductReservationFailedEvent\n        K-\u003e\u003eTS: Cancel order\n    end\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-86](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:6-16](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:88-103](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:153-188]()\n\n## Transaction Service\n\nThe Transaction Service manages the complete order lifecycle using MySQL for persistent storage. Core entities include `orders`, `order_items`, `order_proofs`, `order_refunds`, and `order_disputes` tables.\n\n**Key Classes:**\n- `OrderCreateRq` - Request object for order creation with validation constraints\n- `Status` enum - Comprehensive status tracking including `PENDING`, `READY_PAY`, `PAID`, `COMPLETED`\n- `ProofType` enum - Delivery proof types: `SCREENSHOT`, `VIDEO`, `TEXT_NOTE`, `DELIVERY`, `PURCHASE`\n\n**Database Schema:**\n- Orders table with buyer/seller IDs, amounts, payment status tracking\n- Foreign key relationships ensuring referential integrity\n- Audit logging via `order_logs` table for status transitions\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java:18-38](), [transaction/src/main/java/com/chuadatten/transaction/common/Status.java:3-21](), [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java:3-8](), [transaction/db.sql:8-127]()\n\n## Product Service\n\nThe Product Service manages product catalog and real-time inventory using MongoDB for flexible document storage. Handles product reservation and stock finalization through Kafka events.\n\n**Key Classes:**\n- `ProductVariantRepository` - MongoDB repository with `findById()`, `findByProductId()` operations\n- `EventListener` - Kafka consumer with `listenOrderCreatedEvent()` and `listenOrderSuccess()` methods\n- `KafkaTopic` enum - Event topics including `PRODUCT_RESERVATION_SUCCESS`, `PRODUCT_RESERVATION_FAILED`\n\n**Inventory Management:**\n- `availableQty`, `reservedQty`, `soldQty` fields for real-time stock tracking\n- Two-phase inventory updates: reserve on order creation, finalize on payment success\n- Error handling with `INSUFFICIENT_STOCK` and `PRODUCT_VARIANT_NOT_FOUND` exceptions\n\n**Sources:** [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:11-15](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-86](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:6-16](), [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java:22-25]()\n\n## Wallet Service\n\nThe Wallet Service handles payment processing with VNPAY gateway integration and digital wallet management using MySQL for transactional consistency.\n\n**Key Classes:**\n- `PaymentServiceImpl` - Core payment logic with `payment()`, `handleProviderCallback()` methods\n- `VnpayUltils` - VNPAY integration utilities with `payUrl()`, `checkCallBack()` methods  \n- `WalletReservation` entity - Fund reservation mechanism for order payments\n\n**Payment Flow:**\n- Wallet balance validation and fund reservation\n- VNPAY external gateway integration with HMAC-SHA512 signature validation\n- Event publishing via `OutboxEvent` for `PAYMENT_PROCESSING` and `PAYMENT_SUCCESS` topics\n- Transaction atomicity with `@Transactional` annotations\n\n**Sources:** [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:57-103](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:153-188](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:110-118](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:77-84]()\n\n## User Service\n\nThe User Service manages authentication, user profiles, and role-based authorization. Uses MySQL for relational user data and Redis for session management.\n\n**Key Responsibilities:**\n- JWT-based authentication with custom decoders for internal and OAuth tokens\n- Role-based access control with `ROLE_ADMIN`, `ROLE_SELLER`, `ROLE_USER` permissions\n- KYC verification workflows for seller onboarding\n- User profile management and seller registration\n\n## Notification Service\n\nThe Notification Service handles all user communications through email notifications and WebSocket messaging. Uses MongoDB for flexible notification event storage.\n\n**Key Responsibilities:**  \n- Event-driven notifications responding to order status changes, payment confirmations\n- Email template management and delivery\n- Real-time WebSocket messaging for order updates\n- Notification preference management per user"])</script><script>self.__next_f.push([1,"1a:T32d3,"])</script><script>self.__next_f.push([1,"# Transaction Service\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [transaction/db.sql](transaction/db.sql)\n- [transaction/pom.xml](transaction/pom.xml)\n- [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java](transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java)\n- [transaction/src/main/java/com/chuadatten/transaction/common/Status.java](transaction/src/main/java/com/chuadatten/transaction/common/Status.java)\n- [transaction/src/main/java/com/chuadatten/transaction/entity/Order.java](transaction/src/main/java/com/chuadatten/transaction/entity/Order.java)\n- [transaction/src/main/java/com/chuadatten/transaction/entity/OrderDispute.java](transaction/src/main/java/com/chuadatten/transaction/entity/OrderDispute.java)\n- [transaction/src/main/java/com/chuadatten/transaction/entity/OrderItem.java](transaction/src/main/java/com/chuadatten/transaction/entity/OrderItem.java)\n- [transaction/src/main/java/com/chuadatten/transaction/entity/OrderRefund.java](transaction/src/main/java/com/chuadatten/transaction/entity/OrderRefund.java)\n- [transaction/src/main/java/com/chuadatten/transaction/exceptions/ErrorCode.java](transaction/src/main/java/com/chuadatten/transaction/exceptions/ErrorCode.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java](transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java](transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/mapper/TransactionMapper.java](transaction/src/main/java/com/chuadatten/transaction/mapper/TransactionMapper.java)\n- [transaction/src/main/java/com/chuadatten/transaction/repository/OrderDisputeRepository.java](transaction/src/main/java/com/chuadatten/transaction/repository/OrderDisputeRepository.java)\n- [transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java](transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java)\n- [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java](transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThe Transaction Service is responsible for managing the complete order lifecycle within the e-commerce platform, from initial order creation through payment processing, fulfillment, and resolution of disputes or refunds. This service acts as the central coordinator for order-related business logic and maintains order state consistency through event-driven communication with other microservices.\n\nFor payment processing workflows, see [Payment Processing](#4.1). For complete end-to-end order flows, see [Order Lifecycle](#4.2). For event system details, see [Event System](#4.3).\n\n## Core Functionality\n\nThe Transaction Service provides the following key capabilities:\n\n| Functionality | Description | Key Classes |\n|---------------|-------------|-------------|\n| Order Management | Create, retrieve, update, and cancel orders | `OrderServiceImpl`, `Order` |\n| Order Item Tracking | Manage individual items within orders | `OrderItem` |\n| Delivery Proof Handling | Upload and store delivery confirmation | `OrderProof`, `ProofType` |\n| Dispute Management | Handle order disputes between buyers and sellers | `OrderDispute` |\n| Refund Processing | Manage refund requests and processing | `OrderRefund` |\n| Event Communication | Publish and consume events for inter-service coordination | `EventListener`, `OutboxEvent` |\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:38-172](), [transaction/src/main/java/com/chuadatten/transaction/entity/Order.java:24-94]()\n\n## Order State Machine\n\nThe following diagram illustrates the order status transitions managed by the Transaction Service:\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e PENDING: \"createOrder()\"\n    PENDING --\u003e READY_PAY: \"Product reservation success\"\n    PENDING --\u003e CANCELLED: \"Product reservation failed\"\n    PENDING --\u003e CANCELLED: \"cancelOrder()\"\n    \n    READY_PAY --\u003e PAYING: \"Payment processing starts\"\n    PAYING --\u003e PAID: \"Payment success\"\n    PAYING --\u003e CANCELLED: \"Payment failed\"\n    \n    PAID --\u003e APPROVED: \"Order approved for fulfillment\"\n    APPROVED --\u003e DELIVERED: \"uploadDeliveryProof()\"\n    DELIVERED --\u003e COMPLETED: \"Order completion\"\n    \n    state \"Dispute/Refund States\" as dispute {\n        DELIVERED --\u003e DISPUTED: \"Dispute opened\"\n        PAID --\u003e REFUND_REQUESTED: \"Refund requested\"\n        DISPUTED --\u003e RESOLVED: \"Dispute resolved\"\n        REFUND_REQUESTED --\u003e REFUNDED: \"Refund processed\"\n    }\n```\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/common/Status.java:3-22](), [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:32-139]()\n\n## Event-Driven Integration\n\nThe Transaction Service integrates with other microservices through Kafka events:\n\n```mermaid\nsequenceDiagram\n    participant TS as \"TransactionService\u003cbr/\u003e(OrderServiceImpl)\"\n    participant KB as \"KafkaTopics\"\n    participant PS as \"ProductService\"\n    participant WS as \"WalletService\"\n    participant OB as \"OutboxRepository\"\n    \n    Note over TS,OB: Order Creation Flow\n    TS-\u003e\u003eTS: \"createOrder(OrderCreateRq)\"\n    TS-\u003e\u003eOB: \"save(OutboxEvent\u003cbr/\u003eORDER_CREATED)\"\n    KB-\u003e\u003ePS: \"ORDER_CREATED event\"\n    \n    Note over PS,TS: Product Reservation\n    PS-\u003e\u003eKB: \"PRODUCT_RESERVATION_SUCCESS\u003cbr/\u003eor PRODUCT_RESERVATION_FAILED\"\n    KB-\u003e\u003eTS: \"listenProductReservation...()\"\n    TS-\u003e\u003eTS: \"Update order status\u003cbr/\u003eREADY_PAY or CANCELLED\"\n    TS-\u003e\u003eOB: \"save(ORDER_COMFIRM_DATA)\"\n    \n    Note over WS,TS: Payment Processing\n    KB-\u003e\u003eWS: \"ORDER_COMFIRM_DATA event\"\n    WS-\u003e\u003eKB: \"PAYMENT_PROCESSING event\"\n    KB-\u003e\u003eTS: \"listenPaymentProcessing()\"\n    TS-\u003e\u003eTS: \"Update status to PAYING\"\n    \n    WS-\u003e\u003eKB: \"PAYMENT_SUCCESS event\"\n    KB-\u003e\u003eTS: \"listenPaymentSuccess()\"\n    TS-\u003e\u003eTS: \"Update status to PAID\"\n    TS-\u003e\u003eOB: \"save(ORDER_SUCCESS)\"\n```\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:27-139](), [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java:6-23]()\n\n## Database Schema\n\nThe Transaction Service uses MySQL with the following core tables:\n\n```mermaid\nerDiagram\n    orders ||--o{ order_items : \"contains\"\n    orders ||--o{ order_proofs : \"has\"\n    orders ||--o{ order_refunds : \"may have\"\n    orders ||--o{ order_disputes : \"may have\"\n    orders ||--o{ order_logs : \"tracks changes\"\n    \n    orders {\n        BINARY_16 id PK\n        BINARY_16 buyer_id\n        BINARY_16 seller_id\n        DECIMAL_18_2 total_amount\n        CHAR_3 currency\n        VARCHAR_50 status\n        VARCHAR_50 payment_status\n        TINYINT audit_flag\n        DATETIME created_at\n        DATETIME updated_at\n        DATETIME expired_at\n    }\n    \n    order_items {\n        BINARY_16 id PK\n        BINARY_16 order_id FK\n        VARCHAR_255 product_id\n        VARCHAR_255 product_variant_id\n        DECIMAL_18_2 unit_price\n        INT quantity\n        DECIMAL_18_2 subtotal\n    }\n    \n    order_proofs {\n        BINARY_16 id PK\n        BINARY_16 order_id FK\n        BINARY_16 seller_id\n        VARCHAR_50 type\n        VARCHAR_1024 url\n        VARCHAR_500 note\n        DATETIME uploaded_at\n    }\n    \n    order_disputes {\n        BINARY_16 id PK\n        BINARY_16 order_id FK\n        BINARY_16 opened_by\n        VARCHAR_50 issue_type\n        TEXT description\n        VARCHAR_50 status\n        DATETIME created_at\n        DATETIME resolved_at\n    }\n    \n    order_refunds {\n        BINARY_16 id PK\n        BINARY_16 order_id FK\n        BINARY_16 request_by\n        VARCHAR_50 status\n        TEXT reason\n        DATETIME created_at\n        DATETIME completed_at\n    }\n```\n\nSources: [transaction/db.sql:8-128]()\n\n## Key Components\n\n### OrderServiceImpl\n\nThe main service class implementing order business logic:\n\n| Method | Purpose | Event Published |\n|--------|---------|-----------------|\n| `createOrder()` | Creates new order with items | `ORDER_CREATED` |\n| `getOrderById()` | Retrieves order by ID with permission check | None |\n| `getOrdersByBuyer()` | Paginated buyer order history | None |\n| `getOrdersBySeller()` | Paginated seller order history | None |\n| `cancelOrder()` | Cancels pending orders | None |\n| `uploadDeliveryProof()` | Uploads delivery proof, updates status to `DELIVERED` | None |\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:47-172]()\n\n### EventListener\n\nHandles incoming Kafka events and coordinates order state changes:\n\n| Kafka Topic | Handler Method | Order Status Update |\n|-------------|----------------|-------------------|\n| `product.reservation.failed` | `listenProductReservationFailed()` | `PENDING`  `CANCELLED` |\n| `product.reservation.succeeded` | `listenProductReservationSucceeded()` | `PENDING`  `READY_PAY` |\n| `payment.success` | `listenPaymentSuccess()` | `READY_PAY`  `PAID` |\n| `payment.payment.processing` | `listenPaymentProcessing()` | `READY_PAY`  `PAYING` |\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:32-139]()\n\n### Entity Relationships\n\nCore JPA entities and their relationships:\n\n```mermaid\nclassDiagram\n    class Order {\n        +UUID id\n        +UUID buyerId\n        +UUID sellerId\n        +BigDecimal totalAmount\n        +String currency\n        +Status status\n        +Status paymentStatus\n        +List~OrderItem~ items\n        +List~OrderProof~ proofs\n        +List~OrderDispute~ disputes\n        +List~OrderRefund~ refunds\n    }\n    \n    class OrderItem {\n        +UUID id\n        +String productId\n        +String productVariantId\n        +BigDecimal unitPrice\n        +int quantity\n        +BigDecimal subtotal\n    }\n    \n    class OrderProof {\n        +UUID id\n        +UUID sellerId\n        +ProofType type\n        +String url\n        +String note\n        +LocalDateTime uploadedAt\n    }\n    \n    class OrderDispute {\n        +UUID id\n        +UUID openedBy\n        +DisputeIssueType issueType\n        +String description\n        +Status status\n    }\n    \n    Order ||--o{ OrderItem : \"contains\"\n    Order ||--o{ OrderProof : \"has\"\n    Order ||--o{ OrderDispute : \"may have\"\n```\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/entity/Order.java:28-94](), [transaction/src/main/java/com/chuadatten/transaction/entity/OrderItem.java:24-56](), [transaction/src/main/java/com/chuadatten/transaction/entity/OrderProof.java](), [transaction/src/main/java/com/chuadatten/transaction/entity/OrderDispute.java:24-63]()\n\n## Outbox Pattern Implementation\n\nThe service implements the outbox pattern for reliable event publishing:\n\n```mermaid\nflowchart TD\n    A[\"Business Operation\u003cbr/\u003e(e.g., createOrder)\"] --\u003e B[\"Save Order to Database\"]\n    B --\u003e C[\"Save OutboxEvent\u003cbr/\u003ewith event payload\"]\n    C --\u003e D[\"Outbox Publisher\u003cbr/\u003e(separate process)\"]\n    D --\u003e E[\"Publish to Kafka Topic\"]\n    E --\u003e F[\"Mark OutboxEvent\u003cbr/\u003eas PUBLISHED\"]\n    \n    G[\"Event Failure\"] --\u003e H[\"OutboxEvent remains\u003cbr/\u003estatus: PENDING\"]\n    H --\u003e I[\"Retry mechanism\u003cbr/\u003eprocesses pending events\"]\n```\n\nThe `OutboxEvent` entity stores pending events with fields:\n- `eventType`: Kafka topic name from `KafkaTopic` enum\n- `aggregateId`: Order ID for correlation\n- `payload`: JSON serialized event data\n- `status`: `PENDING`, `PUBLISHED`, or `FAILED`\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java](), [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:84-92]()\n\n## Status and Type Enumerations\n\n### Order Status Values\n\nThe `Status` enum defines all possible order states:\n\n| Status Category | Values | Usage |\n|----------------|--------|-------|\n| Order States | `PENDING`, `READY_PAY`, `PAYING`, `PAID`, `DELIVERED`, `COMPLETED` | Main order lifecycle |\n| Cancellation | `CANCELLED`, `REJECTED`, `EXPIRED` | Order termination |\n| Dispute/Refund | `DISPUTED`, `REFUND_REQUESTED`, `REFUNDED` | Post-fulfillment issues |\n\n### Proof Types\n\nThe `ProofType` enum defines delivery proof categories:\n\n| Type | Description |\n|------|-------------|\n| `DELIVERY` | Delivery confirmation proof |\n| `SCREENSHOT` | Screenshot evidence |\n| `VIDEO` | Video proof |\n| `TEXT_NOTE` | Text description |\n| `PURCHASE` | Purchase confirmation |\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/common/Status.java:3-22](), [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java:3-8]()"])</script><script>self.__next_f.push([1,"1b:T47d6,"])</script><script>self.__next_f.push([1,"# Product Service\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/event/OrderCreatedEvent.java](product/src/main/java/com/chuadatten/event/OrderCreatedEvent.java)\n- [product/src/main/java/com/chuadatten/event/OrderSuccess.java](product/src/main/java/com/chuadatten/event/OrderSuccess.java)\n- [product/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java](product/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java)\n- [product/src/main/java/com/chuadatten/event/ProductReservationSuccessEvent.java](product/src/main/java/com/chuadatten/event/ProductReservationSuccessEvent.java)\n- [product/src/main/java/com/chuadatten/product/common/JsonParserUtil.java](product/src/main/java/com/chuadatten/product/common/JsonParserUtil.java)\n- [product/src/main/java/com/chuadatten/product/controller/AdminController.java](product/src/main/java/com/chuadatten/product/controller/AdminController.java)\n- [product/src/main/java/com/chuadatten/product/controller/CategoryController.java](product/src/main/java/com/chuadatten/product/controller/CategoryController.java)\n- [product/src/main/java/com/chuadatten/product/controller/ProductController.java](product/src/main/java/com/chuadatten/product/controller/ProductController.java)\n- [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java](product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java)\n- [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java](product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventListener.java](product/src/main/java/com/chuadatten/product/kafka/EventListener.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventProducer.java](product/src/main/java/com/chuadatten/product/kafka/EventProducer.java)\n- [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java](product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java](product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java)\n- [product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java](product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java)\n- [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java](product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java)\n- [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java](product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java)\n- [product/src/main/java/com/chuadatten/product/securities/Security.java](product/src/main/java/com/chuadatten/product/securities/Security.java)\n- [product/src/main/java/com/chuadatten/product/service/ProductService.java](product/src/main/java/com/chuadatten/product/service/ProductService.java)\n- [product/src/main/java/com/chuadatten/product/service/ProductVariantService.java](product/src/main/java/com/chuadatten/product/service/ProductVariantService.java)\n- [product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java](product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java)\n- [product/src/main/resources/application.properties](product/src/main/resources/application.properties)\n- [transaction/src/main/java/com/chuadatten/transaction/controller/AdminController.java](transaction/src/main/java/com/chuadatten/transaction/controller/AdminController.java)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThe Product Service manages the product catalog, inventory tracking, and product variants in the e-commerce microservices platform. It provides comprehensive product management capabilities including CRUD operations, real-time stock management, and event-driven integration with other services for order processing.\n\nThis document covers product catalog operations, inventory management, and inter-service communication patterns. For transaction processing workflows, see [Order Lifecycle](#4.2). For payment integration details, see [Payment Processing](#4.1). For complete event system documentation, see [Event System](#4.3).\n\n## Architecture Overview\n\nThe Product Service follows Domain-Driven Design principles with clear separation between product catalog management and inventory operations. It uses MongoDB for flexible document storage and implements event-driven patterns for reliable inter-service communication.\n\n```mermaid\ngraph TB\n    subgraph \"Product Service Core Components\"\n        ProductController[ProductController\u003cbr/\u003e\"/api/v1/product-service/products\"]\n        ProductVariantController[ProductVariantController\u003cbr/\u003e\"/api/v1/product-service/product-variants\"]\n        CategoryController[CategoryController\u003cbr/\u003e\"/api/v1/product-service/categories\"]\n        AdminController[AdminController\u003cbr/\u003e\"/api/v1/product-service/admin\"]\n    end\n    \n    subgraph \"Business Logic Layer\"\n        ProductService[ProductServiceImpl]\n        ProductVariantService[ProductVariantServiceImpl]\n        CategoryService[CategoryServiceImpl]\n        AdminService[AdminServiceImpl]\n    end\n    \n    subgraph \"Data Layer\"\n        ProductRepository[ProductRepository\u003cbr/\u003eMongoRepository]\n        ProductVariantRepository[ProductVariantRepository\u003cbr/\u003eMongoRepository]\n        CategoryRepository[CategoryRepository\u003cbr/\u003eMongoRepository]\n        OutboxRepository[OutboxRepository\u003cbr/\u003eOutbox Pattern]\n    end\n    \n    subgraph \"Event Processing\"\n        EventListener[EventListener\u003cbr/\u003eKafka Consumer]\n        EventProducer[EventProducer\u003cbr/\u003eKafka Producer]\n        OutboxEvent[OutboxEvent\u003cbr/\u003eEvent Staging]\n    end\n    \n    subgraph \"External Systems\"\n        MongoDB[(MongoDB\u003cbr/\u003eDocument Store)]\n        Kafka[Apache Kafka\u003cbr/\u003eEvent Streaming]\n        FileStorage[FileStorageService\u003cbr/\u003eImage Upload]\n    end\n    \n    ProductController --\u003e ProductService\n    ProductVariantController --\u003e ProductVariantService\n    CategoryController --\u003e CategoryService\n    AdminController --\u003e AdminService\n    \n    ProductService --\u003e ProductRepository\n    ProductVariantService --\u003e ProductVariantRepository\n    CategoryService --\u003e CategoryRepository\n    \n    ProductRepository --\u003e MongoDB\n    ProductVariantRepository --\u003e MongoDB\n    CategoryRepository --\u003e MongoDB\n    OutboxRepository --\u003e MongoDB\n    \n    EventListener --\u003e ProductVariantRepository\n    EventListener --\u003e OutboxRepository\n    EventProducer --\u003e Kafka\n    OutboxRepository --\u003e Kafka\n    \n    ProductService --\u003e FileStorage\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/ProductController.java:1-94](), [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java:1-67](), [product/src/main/java/com/chuadatten/product/service/ProductService.java:1-98](), [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java:1-17]()\n\n## Core Entities and Data Model\n\nThe Product Service manages four primary entities with specific relationships and responsibilities:\n\n### Entity Relationships\n\n```mermaid\nerDiagram\n    Product ||--o{ ProductVariant : \"has variants\"\n    Product ||--o{ ProductImage : \"has images\"\n    Product }o--|| Category : \"belongs to category\"\n    Product {\n        string id PK\n        string name\n        string description\n        string slug UK\n        list categoryIds\n        map attributes\n        decimal basePrice\n        list tags\n        Status active\n        string currency\n        string userId FK\n        datetime createdAt\n        datetime updatedAt\n        list images\n    }\n    \n    ProductVariant {\n        string id PK\n        string productId FK\n        map attributes\n        string attributesHash UK\n        decimal price\n        int availableQty\n        int reservedQty\n        int soldQty\n        string sku UK\n        Status status\n        datetime createdAt\n        datetime updatedAt\n    }\n    \n    ProductImage {\n        string productId FK\n        string url\n        string alt\n        boolean main\n        int position\n    }\n    \n    Category {\n        string id PK\n        string name\n        string description\n        string slug UK\n        string parentId FK\n        Status active\n        datetime createdAt\n        datetime updatedAt\n    }\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java:1-78](), [product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java:1-42]()\n\n### Key Entity Characteristics\n\n| Entity | Storage Pattern | Key Features |\n|--------|----------------|--------------|\n| `Product` | Document with embedded `ProductImage` list | Flexible attributes, slug-based URLs, multi-category support |\n| `ProductVariant` | Separate documents | Real-time stock tracking, attribute-based variants, SKU management |\n| `Category` | Hierarchical documents | Parent-child relationships, slug-based navigation |\n| `ProductImage` | Embedded in Product | Position ordering, main image flag, alt text |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java:48-88]()\n\n## Stock Management System\n\nThe Product Service implements a sophisticated three-tier inventory management system through the `ProductVariant` entity:\n\n### Stock State Machine\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e Available: \"Initial Stock\"\n    Available --\u003e Reserved: \"reserve(qty)\"\n    Reserved --\u003e Available: \"release(qty)\"\n    Reserved --\u003e Sold: \"commit(qty) via OrderSuccess\"\n    Available --\u003e Sold: \"Direct Sale (bypass reservation)\"\n    Sold --\u003e [*]: \"Final State\"\n    \n    note right of Available\n        availableQty: Current available stock\n        Can be purchased immediately\n    end note\n    \n    note right of Reserved\n        reservedQty: Stock held for orders\n        Temporarily unavailable for new orders\n    end note\n    \n    note right of Sold\n        soldQty: Permanently sold stock\n        Historical tracking only\n    end note\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/service/ProductVariantService.java:60-91](), [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java:52-67]()\n\n### Stock Operation APIs\n\n| Operation | Endpoint | Purpose | Stock Changes |\n|-----------|----------|---------|---------------|\n| `reserve()` | `POST /product-variants/{id}/reserve` | Hold stock for pending orders | `availableQty -= qty`, `reservedQty += qty` |\n| `commit()` | `POST /product-variants/{id}/commit` | Finalize sale from reservation | `reservedQty -= qty`, `soldQty += qty` |\n| `release()` | `POST /product-variants/{id}/release` | Cancel reservation | `reservedQty -= qty`, `availableQty += qty` |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java:53-66]()\n\n### Event-Driven Stock Management\n\nThe service automatically manages stock through Kafka event processing:\n\n```mermaid\nsequenceDiagram\n    participant TS as \"Transaction Service\"\n    participant PS as \"Product Service\"\n    participant KF as \"Kafka\"\n    participant PVR as \"ProductVariantRepository\"\n    \n    TS-\u003e\u003eKF: \"OrderCreatedEvent\"\n    Note over TS,KF: Contains productVariantId, quantity\n    \n    KF-\u003e\u003ePS: \"EventListener.listenOrderCreatedEvent()\"\n    PS-\u003e\u003ePVR: \"findById(productVariantId)\"\n    \n    alt Sufficient Stock\n        PS-\u003e\u003ePVR: \"availableQty -= quantity\"\n        PS-\u003e\u003ePVR: \"reservedQty += quantity\"\n        PS-\u003e\u003eKF: \"ProductReservationSuccessEvent\"\n        Note over PS,KF: Includes orderId, subtotal\n    else Insufficient Stock\n        PS-\u003e\u003eKF: \"ProductReservationFailedEvent\"\n        Note over PS,KF: Order will be cancelled\n    end\n    \n    Note over TS,PVR: Later, when payment succeeds...\n    \n    TS-\u003e\u003eKF: \"OrderSuccess (payment.success)\"\n    KF-\u003e\u003ePS: \"EventListener.listenOrderSuccess()\"\n    PS-\u003e\u003ePVR: \"reservedQty -= quantity\"\n    PS-\u003e\u003ePVR: \"soldQty += quantity\"\n    PS-\u003e\u003ePVR: \"availableQty -= quantity\"\n    Note over PS,PVR: Final inventory commitment\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-86](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:1-18]()\n\n## Event-Driven Integration\n\nThe Product Service participates in the platform's event-driven architecture through Kafka topics and the outbox pattern:\n\n### Kafka Topic Integration\n\n| Topic | Direction | Event Type | Purpose |\n|-------|-----------|------------|---------|\n| `transaction.order.created` | Consume | `OrderCreatedEvent` | Reserve inventory for new orders |\n| `payment.success` | Consume | `OrderSuccess` | Finalize inventory after payment |\n| `product.reservation.success` | Produce | `ProductReservationSuccessEvent` | Notify successful inventory reservation |\n| `product.reservation.failed` | Produce | `ProductReservationFailedEvent` | Notify inventory shortage |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java:6-17]()\n\n### Outbox Pattern Implementation\n\nThe service uses the outbox pattern for reliable event publishing:\n\n```mermaid\nflowchart TD\n    A[Business Operation] --\u003e B[Update ProductVariant]\n    B --\u003e C[Create OutboxEvent]\n    C --\u003e D[Save Both in Transaction]\n    D --\u003e E[Outbox Publisher Job]\n    E --\u003e F[Publish to Kafka]\n    F --\u003e G[Mark Event as Sent]\n    \n    subgraph \"Database Transaction Boundary\"\n        B\n        C\n        D\n    end\n    \n    subgraph \"Outbox Event Structure\"\n        H[eventType: PRODUCT_RESERVATION_SUCCESS]\n        I[aggregateId: productVariantId]\n        J[aggregateType: ProductVariant.class.name]\n        K[payload: JSON serialized event]\n        L[status: PENDING/SENT]\n    end\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:42-67](), [product/src/main/java/com/chuadatten/product/common/JsonParserUtil.java:27-33]()\n\n### Event Processing Error Handling\n\nThe service implements robust error handling for event processing:\n\n```mermaid\nflowchart TD\n    A[Receive OrderCreatedEvent] --\u003e B{Multiple Items?}\n    B --\u003e|Yes| C[Throw INVALID_REQUEST]\n    B --\u003e|No| D[Check Stock Availability]\n    \n    D --\u003e E{Stock Available?}\n    E --\u003e|No| F[Create ProductReservationFailedEvent]\n    E --\u003e|Yes| G[Reserve Stock]\n    \n    F --\u003e H[Save to OutboxEvent]\n    G --\u003e I[Create ProductReservationSuccessEvent]\n    I --\u003e J[Save to OutboxEvent]\n    \n    H --\u003e K[Throw INSUFFICIENT_STOCK]\n    J --\u003e L[Continue Processing]\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:32-50](), [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java:23-25]()\n\n## Security and Access Control\n\nThe Product Service implements JWT-based authentication with role-based authorization:\n\n### Role-Based Access Matrix\n\n| Operation | Public | USER | SELLER | ADMIN |\n|-----------|--------|------|--------|-------|\n| View products/categories |  |  |  |  |\n| Create products | | |  |  |\n| Update/Delete own products | | |  |  |\n| Stock operations (reserve/release/commit) | |  |  |  |\n| Create/manage categories | | | |  |\n| Upload product images | | |  |  |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/securities/Security.java:27-52]()\n\n### JWT Processing Pipeline\n\n```mermaid\nflowchart LR\n    A[HTTP Request] --\u003e B[GetTokenResolver]\n    B --\u003e C[Extract Bearer Token]\n    C --\u003e D[CustomJwtDecoder]\n    \n    D --\u003e E{Token Issuer?}\n    E --\u003e|Google| F[Google JWT Validation]\n    E --\u003e|Internal| G[Internal JWT Validation]\n    \n    F --\u003e H[CustomAuthenticationConverter]\n    G --\u003e H\n    H --\u003e I[Extract User Claims]\n    I --\u003e J[Role-Based Authorization]\n    \n    J --\u003e K{Authorized?}\n    K --\u003e|Yes| L[Allow Access]\n    K --\u003e|No| M[403 Forbidden]\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java:22-46](), [product/src/main/java/com/chuadatten/product/securities/Security.java:18-69]()\n\n## API Endpoints and Operations\n\n### Product Management Endpoints\n\n| Method | Endpoint | Role Required | Description |\n|--------|----------|---------------|-------------|\n| `POST` | `/api/v1/product-service/products` | SELLER | Create new product with initial variant |\n| `PUT` | `/api/v1/product-service/products/{id}` | SELLER | Update product (owner only) |\n| `DELETE` | `/api/v1/product-service/products/{id}` | SELLER | Soft delete product (owner only) |\n| `GET` | `/api/v1/product-service/products/{id}` | Public | Get product by ID |\n| `GET` | `/api/v1/product-service/products/slug/{slug}` | Public | Get product by slug |\n| `POST` | `/api/v1/product-service/products/{id}/images` | SELLER | Upload product images |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/ProductController.java:36-87]()\n\n### Product Variant Management\n\n| Method | Endpoint | Role Required | Description |\n|--------|----------|---------------|-------------|\n| `POST` | `/api/v1/product-service/product-variants` | SELLER | Create product variant |\n| `PUT` | `/api/v1/product-service/product-variants/{id}` | SELLER | Update variant |\n| `DELETE` | `/api/v1/product-service/product-variants/{id}` | SELLER | Delete variant |\n| `GET` | `/api/v1/product-service/product-variants/product/{productId}` | Public | List variants for product |\n| `POST` | `/api/v1/product-service/product-variants/{id}/reserve` | USER | Reserve stock |\n| `POST` | `/api/v1/product-service/product-variants/{id}/commit` | USER | Commit reserved stock |\n| `POST` | `/api/v1/product-service/product-variants/{id}/release` | USER | Release reserved stock |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java:23-66]()\n\n### Error Handling and Validation\n\nThe service implements comprehensive error handling with specific error codes:\n\n| Error Code | HTTP Status | Description | Scenario |\n|------------|-------------|-------------|----------|\n| `E028` | 404 | Product not found | Invalid product ID |\n| `E030` | 404 | Product variant not found | Invalid variant ID |\n| `E032` | 400 | Insufficient stock | Not enough inventory |\n| `E027` | 400 | Slug exists | Duplicate product slug |\n| `E029` | 403 | No permission | User not product owner |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java:18-26]()"])</script><script>self.__next_f.push([1,"1c:T3379,"])</script><script>self.__next_f.push([1,"# Wallet Service\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [wallet/db.sql](wallet/db.sql)\n- [wallet/src/main/java/com/chuadatten/wallet/common/Status.java](wallet/src/main/java/com/chuadatten/wallet/common/Status.java)\n- [wallet/src/main/java/com/chuadatten/wallet/entity/Payment.java](wallet/src/main/java/com/chuadatten/wallet/entity/Payment.java)\n- [wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java](wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java](wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java](wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java](wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java](wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java)\n- [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java](wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java)\n- [wallet/src/main/resources/payment.yaml](wallet/src/main/resources/payment.yaml)\n\n\u003c/details\u003e\n\n\n\nThe Wallet Service manages digital wallets, payment processing, and bank account operations within the e-commerce platform. It handles wallet balance management, payment transactions through external gateways (primarily VNPAY), wallet reservations for orders, and withdrawal requests to bank accounts. The service publishes payment events to other services via Kafka and maintains comprehensive transaction logs for financial auditing.\n\nFor order processing workflows that interact with wallets, see [Order Lifecycle](#4.2). For complete payment flow documentation, see [Payment Processing](#4.1).\n\n## Core Components\n\nThe Wallet Service is built around five main entity types that handle different aspects of financial operations:\n\n### Entity Architecture\n\n```mermaid\nerDiagram\n    wallets ||--o{ wallet_transactions : \"logs all changes\"\n    wallets ||--o{ wallet_reservations : \"holds funds\"  \n    wallets ||--o{ payments : \"processes via\"\n    payments ||--o{ payment_attempts : \"tracks attempts\"\n    wallets }o--|| users : \"owned by\"\n    bank_accounts }o--|| users : \"belongs to\"\n    withdrawal_requests }o--|| wallets : \"withdraws from\"\n    withdrawal_requests }o--|| bank_accounts : \"withdraws to\"\n    \n    wallets {\n        binary16 id PK\n        binary16 user_id FK\n        char3 currency\n        bigint balance\n        bigint reserved\n        bigint version\n        tinyint status\n    }\n    \n    wallet_transactions {\n        binary16 id PK\n        binary16 wallet_id FK\n        binary16 related_entity_id\n        varchar40 type\n        bigint amount\n        tinyint direction\n        bigint balance_after\n        varchar30 status\n    }\n    \n    payments {\n        binary16 id PK\n        binary16 user_id FK\n        binary16 wallet_id FK\n        binary16 order_id FK\n        varchar50 provider\n        varchar30 payment_method\n        bigint amount\n        varchar30 status\n        varchar255 txn_ref\n    }\n```\n\nSources: [wallet/db.sql:2-114]()\n\n### Service Layer Architecture\n\n```mermaid\ngraph TD\n    PaymentController[\"PaymentController\"] --\u003e PaymentService[\"PaymentService\"]\n    WalletController[\"WalletController\"] --\u003e WalletService[\"WalletService\"]\n    BankAccountController[\"BankAccountController\"] --\u003e BankAccountService[\"BankAccountService\"]\n    \n    PaymentService --\u003e PaymentServiceImpl[\"PaymentServiceImpl\"]\n    WalletService --\u003e WalletServiceImpl[\"WalletServiceImpl\"]\n    BankAccountService --\u003e BankAccountServiceImpl[\"BankAccountServiceImpl\"]\n    \n    PaymentServiceImpl --\u003e PaymentRepository[\"PaymentRepository\"]\n    PaymentServiceImpl --\u003e VnpayUltils[\"VnpayUltils\"] \n    PaymentServiceImpl --\u003e OutboxRepository[\"OutboxRepository\"]\n    PaymentServiceImpl --\u003e WalletRepository[\"WalletRepository\"]\n    PaymentServiceImpl --\u003e WalletReservationRepository[\"WalletReservationRepository\"]\n    \n    VnpayUltils --\u003e PayConfig[\"PayConfig\"]\n    \n    PaymentServiceImpl --\u003e KafkaTopics[\"KafkaTopic.PAYMENT_PROCECSSING\u003cbr/\u003eKafkaTopic.PAYMENT_SUCCESS\"]\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/PaymentService.java:17-80](), [wallet/src/main/java/com/chuadatten/wallet/service/WalletService.java:11-44](), [wallet/src/main/java/com/chuadatten/wallet/service/BankAccountService.java:12-69](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:44-210]()\n\n## Payment Processing Flow\n\nThe payment processing system supports both wallet-based payments and external gateway payments through VNPAY.\n\n### Payment State Machine\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e CREATED : \"Payment initiated\"\n    CREATED --\u003e PROCESSING : \"payment() called\"\n    PROCESSING --\u003e SUCCEEDED : \"handleProviderCallback()\"\n    PROCESSING --\u003e FAILED : \"Provider error\"\n    SUCCEEDED --\u003e REFUNDED : \"refundPayment()\"\n    FAILED --\u003e CREATED : \"retryPayment()\"\n    CREATED --\u003e CANCLED : \"cancelPayment()\"\n    \n    note right of PROCESSING\n        For wallet payments:\n        - Deduct balance\n        - Create reservation\n        For external payments:  \n        - Generate VNPAY URL\n        - Wait for callback\n    end note\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/common/Status.java:20-27](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:105-123]()\n\n### Wallet Payment Flow\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant PaymentServiceImpl\n    participant WalletRepository  \n    participant WalletReservationRepository\n    participant OutboxRepository\n    participant Kafka\n    \n    Client-\u003e\u003ePaymentServiceImpl: \"payment(paymentId, ip, userId, WALLET)\"\n    PaymentServiceImpl-\u003e\u003eWalletRepository: \"findById(userId)\"\n    WalletRepository--\u003e\u003ePaymentServiceImpl: \"Wallet entity\"\n    \n    alt \"Sufficient balance\"\n        PaymentServiceImpl-\u003e\u003eWalletRepository: \"save(wallet with reduced balance)\" \n        PaymentServiceImpl-\u003e\u003eWalletReservationRepository: \"save(new reservation)\"\n        PaymentServiceImpl-\u003e\u003eOutboxRepository: \"save(PaymentProcessEvent)\"\n        PaymentServiceImpl--\u003e\u003eClient: \"payment processing message\"\n    else \"Insufficient balance\"  \n        PaymentServiceImpl--\u003e\u003eClient: \"INSUFFICIENT_BALANCE error\"\n    end\n    \n    OutboxRepository-\u003e\u003eKafka: \"PAYMENT_PROCECSSING event\"\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:69-101]()\n\n### VNPAY External Payment Flow\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant PaymentServiceImpl\n    participant VnpayUltils\n    participant VNPAYGateway\n    participant PaymentAttemptRepository\n    \n    Client-\u003e\u003ePaymentServiceImpl: \"payment(paymentId, ip, userId, DIRECT)\"\n    PaymentServiceImpl-\u003e\u003eVnpayUltils: \"payUrl(ip, amount, detail, txnRef)\"\n    VnpayUltils--\u003e\u003ePaymentServiceImpl: \"VNPAY payment URL\"\n    PaymentServiceImpl--\u003e\u003eClient: \"Redirect to VNPAY URL\"\n    \n    Client-\u003e\u003eVNPAYGateway: \"Complete payment on VNPAY\"\n    VNPAYGateway-\u003e\u003ePaymentServiceImpl: \"handleProviderCallback(VnpayReturnDto)\"\n    PaymentServiceImpl-\u003e\u003eVnpayUltils: \"checkCallBack(returnDto)\"\n    PaymentServiceImpl-\u003e\u003ePaymentAttemptRepository: \"save(payment attempt)\"\n    PaymentServiceImpl-\u003e\u003eOutboxRepository: \"save(PaymentSuccessedEvent)\"\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:152-188](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:36-118]()\n\n## Database Design\n\nThe wallet service uses a double-entry accounting pattern with immutable transaction logs and optimistic concurrency control.\n\n### Core Tables Structure\n\n| Table | Purpose | Key Fields |\n|-------|---------|------------|\n| `wallets` | Current balance snapshot | `balance`, `reserved`, `version` |\n| `wallet_transactions` | Immutable transaction ledger | `amount`, `direction`, `balance_after` |\n| `wallet_reservations` | Fund holds for pending orders | `amount`, `expires_at`, `status` |\n| `payments` | Payment processing records | `provider`, `status`, `txn_ref` |\n| `payment_attempts` | Provider interaction logs | `attempt_data`, `provider_response` |\n\nSources: [wallet/db.sql:2-84]()\n\n### Transaction Logging Pattern\n\n```mermaid\ngraph LR\n    WalletUpdate[\"Wallet Balance Update\"] --\u003e TransactionLog[\"wallet_transactions entry\"]\n    TransactionLog --\u003e BalanceAfter[\"balance_after = new wallet.balance\"]\n    \n    TransactionLog --\u003e Direction{Direction}\n    Direction --\u003e|1| Credit[\"Credit: +amount\"]\n    Direction --\u003e|-1| Debit[\"Debit: -amount\"]\n    \n    TransactionLog --\u003e Type[\"type: topup/payment/refund/withdrawal\"]\n    TransactionLog --\u003e RelatedEntity[\"related_entity_id: order_id/payment_id\"]\n```\n\nSources: [wallet/db.sql:18-34]()\n\n## VNPAY Integration\n\nThe service integrates with Vietnam's VNPAY payment gateway for external payment processing.\n\n### Configuration Structure\n\n```yaml\n# payment.yaml configuration\nvnpay:\n  vnpVersion: \"2.1.0\"\n  vnpCommand: \"pay\" \n  vnpTmnCode: \"XTNKANRH\"\n  vnpHashSecret: \"FNABMOP7AXKQFVWBIZE63HEIW7NAHO96\"\n  vnpHashType: \"HmacSHA512\"\n  vnpReturnUrl: \"http://localhost:8084/api/v1/wallet-service/payments/vnpay_return\"\n  vnpPayUrl: \"https://sandbox.vnpayment.vn/paymentv2/vpcpay.html\"\n```\n\nSources: [wallet/src/main/resources/payment.yaml:1-9]()\n\n### VNPAY Request Building\n\n```mermaid\ngraph TD\n    BuildParams[\"VnpayUltils.buildParams()\"] --\u003e ParamMap[\"Map\u003cString, String\u003e\"]\n    ParamMap --\u003e Sort[\"Collections.sort(fieldNames)\"]\n    Sort --\u003e StringBuilder[\"Build query string\"]\n    StringBuilder --\u003e HMAC[\"hmacSHA512(hashSecret, queryString)\"]\n    HMAC --\u003e SecureHash[\"vnp_SecureHash\"]\n    SecureHash --\u003e PaymentURL[\"Complete VNPAY payment URL\"]\n    \n    ParamMap --\u003e Amount[\"vnp_Amount = total * 100\"]\n    ParamMap --\u003e TxnRef[\"vnp_TxnRef = type-paymentId-timestamp\"]\n    ParamMap --\u003e CreateDate[\"vnp_CreateDate = yyyyMMddHHmmss\"]\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:140-171](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:32-34]()\n\n## Event-Driven Architecture\n\nThe Wallet Service publishes events to notify other services of payment state changes.\n\n### Event Publishing Pattern\n\n```mermaid\ngraph TD\n    PaymentAction[\"Payment Status Change\"] --\u003e EventCreation[\"Create Event Object\"]\n    EventCreation --\u003e OutboxSave[\"Save to OutboxRepository\"]\n    OutboxSave --\u003e KafkaPublish[\"Outbox Publisher  Kafka\"]\n    \n    EventCreation --\u003e PaymentProcessEvent[\"PaymentProcessEvent\u003cbr/\u003e{orderId, paymentId, ip, paymentMethod}\"]\n    EventCreation --\u003e PaymentSuccessedEvent[\"PaymentSuccessedEvent\u003cbr/\u003e{orderId, paymentId, userId}\"]\n    \n    KafkaPublish --\u003e Topic1[\"PAYMENT_PROCECSSING\"]\n    KafkaPublish --\u003e Topic2[\"PAYMENT_SUCCESS\"]\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:88-96](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:167-180]()\n\n### Payment Events Structure\n\n| Event Type | Kafka Topic | Purpose | Key Fields |\n|------------|-------------|---------|------------|\n| `PaymentProcessEvent` | `PAYMENT_PROCECSSING` | Notify order processing start | `orderId`, `paymentId`, `paymentMethod` |\n| `PaymentSuccessedEvent` | `PAYMENT_SUCCESS` | Notify successful payment | `orderId`, `paymentId`, `userId` |\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/kafka/KafkaTopic.java]() (referenced in imports), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:92-94](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:167-171]()\n\n## Error Handling\n\nThe service implements comprehensive error handling with specific error codes for different failure scenarios.\n\n### Payment-Specific Error Codes\n\n| Error Code | Message | HTTP Status | Scenario |\n|------------|---------|-------------|-----------|\n| `E025` | \"Payment not found\" | 404 | Invalid payment ID |\n| `E026` | \"Payment processing\" | 400 | Duplicate processing attempt |  \n| `E033` | \"Wallet not found\" | 404 | User has no wallet |\n| `E034` | \"Insufficient balance\" | 400 | Wallet balance too low |\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/exceptions/ErrorCode.java:35-45]()\n\n### Status Validation Logic\n\n```mermaid\ngraph TD\n    PaymentRequest[\"payment() called\"] --\u003e StatusCheck{\"payment.status\"}\n    StatusCheck --\u003e|CREATED| ProcessPayment[\"Continue processing\"]\n    StatusCheck --\u003e|PROCESSING| Error1[\"PAYMENT_PROCESSING error\"]\n    StatusCheck --\u003e|SUCCESS| Error2[\"PAYMENT_SUCCESS error\"] \n    StatusCheck --\u003e|FAILED| Error3[\"PAYMENT_FAILED error\"]\n    StatusCheck --\u003e|CANCLED| Error4[\"PAYMENT_CANCELED error\"]\n    StatusCheck --\u003e|REFUNDED| Error5[\"PAYMENT_REFUNDED error\"]\n```\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:66-68](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:105-124]()"])</script><script>self.__next_f.push([1,"1d:T3ae6,"])</script><script>self.__next_f.push([1,"# User Service\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [user/db.sql](user/db.sql)\n- [user/src/main/java/com/chuadatten/user/controller/AdminController.java](user/src/main/java/com/chuadatten/user/controller/AdminController.java)\n- [user/src/main/java/com/chuadatten/user/controller/AuthController.java](user/src/main/java/com/chuadatten/user/controller/AuthController.java)\n- [user/src/main/java/com/chuadatten/user/controller/FileUploadController.java](user/src/main/java/com/chuadatten/user/controller/FileUploadController.java)\n- [user/src/main/java/com/chuadatten/user/controller/KycController.java](user/src/main/java/com/chuadatten/user/controller/KycController.java)\n- [user/src/main/java/com/chuadatten/user/controller/SellerController.java](user/src/main/java/com/chuadatten/user/controller/SellerController.java)\n- [user/src/main/java/com/chuadatten/user/controller/UserInforController.java](user/src/main/java/com/chuadatten/user/controller/UserInforController.java)\n- [user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java](user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java)\n- [user/src/main/java/com/chuadatten/user/securities/Security.java](user/src/main/java/com/chuadatten/user/securities/Security.java)\n- [user/src/main/java/com/chuadatten/user/services/UserInforService.java](user/src/main/java/com/chuadatten/user/services/UserInforService.java)\n- [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java](user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java)\n- [user/src/main/java/com/chuadatten/user/services/impl/UserInforServiceImpl.java](user/src/main/java/com/chuadatten/user/services/impl/UserInforServiceImpl.java)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThe User Service is responsible for user authentication, authorization, profile management, and identity verification within the e-commerce platform. It handles user registration and login, JWT token management, role-based access control, KYC (Know Your Customer) verification, seller applications, and user preferences.\n\nFor information about payment processing and wallet management, see [Wallet Service](#3.3). For order management functionality, see [Transaction Service](#3.1). For authentication patterns across all services, see [Authentication \u0026 Security](#2.3).\n\n## Core Architecture\n\nThe User Service follows a layered architecture with clear separation between web controllers, business services, and data access layers. It uses JWT-based stateless authentication with role-based authorization and integrates with Redis for caching and Kafka for event publishing.\n\n```mermaid\ngraph TB\n    subgraph \"Web Layer\"\n        AuthController[\"AuthController\u003cbr/\u003eLogin, Registration, 2FA\"]\n        UserInforController[\"UserInforController\u003cbr/\u003eProfile Management\"]\n        AdminController[\"AdminController\u003cbr/\u003eUser Administration\"]\n        KycController[\"KycController\u003cbr/\u003eIdentity Verification\"]\n        SellerController[\"SellerController\u003cbr/\u003eSeller Management\"]\n    end\n    \n    subgraph \"Security Layer\"\n        Security[\"Security\u003cbr/\u003eJWT Configuration\"]\n        CustomJwtDecoder[\"CustomJwtDecoder\u003cbr/\u003eToken Processing\"]\n        CustomAuthenticatinConverter[\"CustomAuthenticatinConverter\u003cbr/\u003eAuthentication Context\"]\n    end\n    \n    subgraph \"Service Layer\"\n        AuthServiceImpl[\"AuthServiceImpl\u003cbr/\u003eAuthentication Logic\"]\n        UserInforServiceImpl[\"UserInforServiceImpl\u003cbr/\u003eProfile Management\"]\n        AdminService[\"AdminService\u003cbr/\u003eUser Administration\"]\n        KycService[\"KycService\u003cbr/\u003eKYC Processing\"]\n        SellerService[\"SellerService\u003cbr/\u003eSeller Operations\"]\n    end\n    \n    subgraph \"Data Layer\"\n        UserAuthRepository[\"UserAuthRepository\u003cbr/\u003eAuthentication Data\"]\n        UserInfRepository[\"UserInfRepository\u003cbr/\u003eProfile Data\"]\n        RoleRepository[\"RoleRepository\u003cbr/\u003eRole Management\"]\n        OutboxRepository[\"OutboxRepository\u003cbr/\u003eEvent Publishing\"]\n    end\n    \n    subgraph \"External Systems\"\n        MySQL[\"MySQL Database\u003cbr/\u003ePersistent Storage\"]\n        Redis[\"Redis Cache\u003cbr/\u003eSessions \u0026 OTP\"]\n        Kafka[\"Apache Kafka\u003cbr/\u003eEvent Streaming\"]\n    end\n    \n    AuthController --\u003e AuthServiceImpl\n    UserInforController --\u003e UserInforServiceImpl\n    AdminController --\u003e AdminService\n    KycController --\u003e KycService\n    SellerController --\u003e SellerService\n    \n    Security --\u003e CustomJwtDecoder\n    Security --\u003e CustomAuthenticatinConverter\n    \n    AuthServiceImpl --\u003e UserAuthRepository\n    UserInforServiceImpl --\u003e UserInfRepository\n    AuthServiceImpl --\u003e RoleRepository\n    AuthServiceImpl --\u003e OutboxRepository\n    \n    UserAuthRepository --\u003e MySQL\n    UserInfRepository --\u003e MySQL\n    RoleRepository --\u003e MySQL\n    OutboxRepository --\u003e MySQL\n    \n    AuthServiceImpl -.-\u003e Redis\n    AuthServiceImpl -.-\u003e Kafka\n```\n\nSources: [user/src/main/java/com/chuadatten/user/securities/Security.java:18-95](), [user/src/main/java/com/chuadatten/user/controller/AuthController.java:34-111](), [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:64-554]()\n\n## Authentication System\n\nThe User Service implements a comprehensive JWT-based authentication system with support for two-factor authentication, device tracking, and session management.\n\n### JWT Token Flow\n\n```mermaid\nsequenceDiagram\n    participant Client as \"Client Application\"\n    participant AuthController as \"AuthController\"\n    participant AuthServiceImpl as \"AuthServiceImpl\"\n    participant JwtUtils as \"JwtUtils\"\n    participant Redis as \"Redis Cache\"\n    participant MySQL as \"MySQL Database\"\n\n    Client-\u003e\u003eAuthController: \"POST /auth/login\"\n    AuthController-\u003e\u003eAuthServiceImpl: \"login(LoginRequest)\"\n    AuthServiceImpl-\u003e\u003eMySQL: \"findByUsername()\"\n    MySQL--\u003e\u003eAuthServiceImpl: \"UserAuth entity\"\n    AuthServiceImpl-\u003e\u003eAuthServiceImpl: \"validatePassword()\"\n    \n    alt Two-Factor Enabled\n        AuthServiceImpl-\u003e\u003eJwtUtils: \"generateTmpToken()\"\n        JwtUtils--\u003e\u003eAuthServiceImpl: \"temporary token\"\n        AuthServiceImpl-\u003e\u003eRedis: \"saveOtpModel()\"\n        AuthServiceImpl--\u003e\u003eClient: \"2FA required + tmp token\"\n        \n        Client-\u003e\u003eAuthController: \"POST /auth/verify-2fa\"\n        AuthController-\u003e\u003eAuthServiceImpl: \"verifyTwoFAuth()\"\n        AuthServiceImpl-\u003e\u003eRedis: \"validateOtp()\"\n        Redis--\u003e\u003eAuthServiceImpl: \"OTP valid\"\n    end\n    \n    AuthServiceImpl-\u003e\u003eJwtUtils: \"generateToken() + generateRefreshToken()\"\n    JwtUtils--\u003e\u003eAuthServiceImpl: \"access + refresh tokens\"\n    AuthServiceImpl-\u003e\u003eRedis: \"saveToCache(WhiteList)\"\n    AuthServiceImpl--\u003e\u003eClient: \"Login successful + tokens\"\n```\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:166-242](), [user/src/main/java/com/chuadatten/user/controller/AuthController.java:45-88]()\n\n### Security Configuration\n\nThe security layer implements role-based access control with different authorization levels:\n\n| Role | Permissions | Endpoints |\n|------|-------------|-----------|\n| `ROLE_ADMIN` | Full system access | `/admin/**`, `/auth/assign-role` |\n| `ROLE_SELLER` | Product and order management | `/seller/**` |  \n| `ROLE_USER` | Basic user operations | `/users/me/**`, `/kyc/**`, `/auth/logout` |\n| Anonymous | Public operations | `/auth/login`, `/auth/register`, `/users/**` (GET) |\n\nSources: [user/src/main/java/com/chuadatten/user/securities/Security.java:35-78]()\n\n## User Management\n\nThe User Service manages user profiles through the `UserInf` entity, which stores display information separately from authentication credentials in `UserAuth`.\n\n### User Profile Operations\n\n```mermaid\ngraph LR\n    subgraph \"Profile Management APIs\"\n        A[\"/users/me\"] --\u003e B[\"updateUserInfo()\"]\n        C[\"/users/me/avatar\"] --\u003e D[\"updateAvatar()\"]\n        E[\"/users/me/preferences\"] --\u003e F[\"updatePreference()\"]\n        G[\"/users/me/billing-address\"] --\u003e H[\"updateBillingAddress()\"]\n    end\n    \n    subgraph \"UserInforServiceImpl\"\n        B --\u003e I[\"UserInfRepository.save()\"]\n        D --\u003e J[\"FileStorageService.storeFile()\"]\n        F --\u003e K[\"PreferenceRepository.save()\"]\n        H --\u003e L[\"BillingAddressRepository.save()\"]\n    end\n    \n    subgraph \"Data Entities\"\n        I --\u003e M[\"user_inf table\"]\n        J --\u003e N[\"File System\"]\n        K --\u003e O[\"preferences table\"]\n        L --\u003e P[\"billing_address table\"]\n    end\n```\n\nSources: [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:32-123](), [user/src/main/java/com/chuadatten/user/services/impl/UserInforServiceImpl.java:31-130]()\n\n## Role-Based Access Control\n\nThe system implements a flexible role hierarchy with the ability to assign multiple roles to users. Role assignment requires specific conditions, such as KYC verification for seller roles.\n\n### Role Assignment Process\n\n```mermaid\nflowchart TD\n    A[\"assignRoleToUser()\"] --\u003e B{\"User exists?\"}\n    B --\u003e|No| C[\"Throw USER_NOT_FOUND\"]\n    B --\u003e|Yes| D{\"Role exists?\"}\n    D --\u003e|No| E[\"Throw NOT_FOUND\"]\n    D --\u003e|Yes| F{\"User already has role?\"}\n    F --\u003e|Yes| G[\"Throw INVALID_INPUT\"]\n    F --\u003e|No| H{\"Role = ROLE_SELLER?\"}\n    H --\u003e|Yes| I{\"User KYC verified?\"}\n    I --\u003e|No| J[\"Throw NOT_KYC\"]\n    I --\u003e|Yes| K[\"Create UserRole\"]\n    H --\u003e|No| K\n    K --\u003e L[\"Save to user_roles table\"]\n    L --\u003e M[\"Return success\"]\n```\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:518-553](), [user/db.sql:112-137]()\n\n## KYC and Seller Management\n\nThe User Service handles identity verification through KYC processes and manages seller applications with approval workflows.\n\n### KYC Verification Flow\n\nThe KYC process involves document upload, verification status tracking, and integration with the seller application system:\n\n- **Document Collection**: Face ID, document front/back images\n- **Verification States**: `PENDING`, `APPROVED`, `REJECTED`, `NEEDS_MORE_INFO`\n- **Version Control**: Multiple KYC document versions supported\n- **Seller Eligibility**: KYC approval required for `ROLE_SELLER` assignment\n\nSources: [user/src/main/java/com/chuadatten/user/controller/KycController.java:22-46](), [user/db.sql:214-239]()\n\n## Data Model\n\nThe User Service maintains a comprehensive data model supporting authentication, profiles, preferences, and seller operations.\n\n### Core Entity Relationships\n\n```mermaid\nerDiagram\n    UserAuth ||--|| UserInf : \"same user_id\"\n    UserAuth ||--o{ UserRole : \"has roles\"\n    Role ||--o{ UserRole : \"assigned to users\"\n    UserInf ||--o| Preference : \"has preferences\"\n    UserInf ||--o| BillingAddress : \"has billing\"\n    UserInf ||--o{ UserVerification : \"has KYC records\"\n    UserInf ||--o| SellerApplication : \"applies as seller\"\n    UserInf ||--o{ SellerRating : \"receives ratings\"\n    UserAuth ||--o{ PasswordHistory : \"password tracking\"\n    UserAuth ||--o{ DeviceManager : \"trusted devices\"\n    UserAuth ||--o{ LoginHistory : \"login tracking\"\n    \n    UserAuth {\n        binary id \"Primary Key\"\n        varchar username \"Unique\"\n        varchar email \"Unique\" \n        varchar password_hash \"Hashed\"\n        varchar status \"ACTIVE/INACTIVE\"\n        boolean two_factor_enabled \"2FA Flag\"\n        boolean is_kyc \"KYC Status\"\n        varchar two_factor_secret \"2FA Secret\"\n        timestamp last_login_at \"Last Login\"\n    }\n    \n    UserInf {\n        binary id \"Same as UserAuth.id\"\n        varchar display_name \"Display Name\"\n        varchar email \"Same as UserAuth.email\"\n        varchar country \"User Location\"\n        varchar status \"Profile Status\"\n        varchar avatar_url \"Profile Picture\"\n        boolean is_seller \"Seller Flag\"\n        text seller_bio \"Seller Description\"\n    }\n    \n    Role {\n        binary id \"Primary Key\"\n        varchar name \"ROLE_USER/ROLE_SELLER/ROLE_ADMIN\"\n        varchar description \"Role Description\"\n    }\n```\n\nSources: [user/db.sql:6-288]()\n\n## API Endpoints\n\nThe User Service exposes REST APIs organized by functional area:\n\n### Authentication Endpoints\n\n| Method | Endpoint | Description | Auth Required |\n|--------|----------|-------------|---------------|\n| POST | `/auth/register` | User registration | No |\n| POST | `/auth/login` | User login | No |\n| POST | `/auth/logout` | Single session logout | Yes |\n| POST | `/auth/logout-all` | All sessions logout | Yes |\n| POST | `/auth/verify-2fa` | Two-factor verification | Temp token |\n| POST | `/auth/enable-2fa` | Enable 2FA | Yes |\n| POST | `/auth/disable-2fa` | Disable 2FA | Yes |\n| POST | `/auth/change-password` | Password change | Yes |\n| POST | `/auth/forgot-password` | Password reset request | No |\n| POST | `/auth/reset-password` | Password reset | Reset token |\n| POST | `/auth/access-token` | Token refresh | Refresh token |\n\n### User Profile Endpoints\n\n| Method | Endpoint | Description | Auth Required |\n|--------|----------|-------------|---------------|\n| GET | `/users/id/{userId}` | Get user by ID | No |\n| GET | `/users/name/{displayName}` | Get user by name | No |\n| PUT | `/users/me` | Update profile | Yes |\n| POST | `/users/me/avatar` | Update avatar | Yes |\n| GET | `/users/me/preferences` | Get preferences | Yes |\n| PUT | `/users/me/preferences` | Update preferences | Yes |\n| GET | `/users/me/billing-address` | Get billing address | Yes |\n| POST | `/users/me/billing-address` | Create billing address | Yes |\n| PUT | `/users/me/billing-address` | Update billing address | Yes |\n\n### Administrative Endpoints  \n\n| Method | Endpoint | Description | Auth Required |\n|--------|----------|-------------|---------------|\n| GET | `/admin/users` | List users with pagination | ROLE_ADMIN |\n| GET | `/admin/users/{userId}` | Get user details | ROLE_ADMIN |\n| POST | `/admin/users/{userId}/approve` | Approve user | ROLE_ADMIN |\n| POST | `/admin/users/{userId}/reject` | Reject user | ROLE_ADMIN |\n| POST | `/admin/users/{userId}/suspend` | Suspend user | ROLE_ADMIN |\n| DELETE | `/admin/users/{userId}` | Delete user | ROLE_ADMIN |\n| POST | `/admin/users/{userId}/roles` | Assign role | ROLE_ADMIN |\n\nSources: [user/src/main/java/com/chuadatten/user/controller/AuthController.java:35-111](), [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:32-123](), [user/src/main/java/com/chuadatten/user/controller/AdminController.java:14-94]()\n\n## Event Integration\n\nThe User Service publishes events to Kafka for cross-service communication using the transactional outbox pattern:\n\n### Published Events\n\n| Event Type | Trigger | Payload | Target Services |\n|------------|---------|---------|-----------------|\n| `REGISTER` | User registration | `RegistrationEvent` | Notification Service |\n| `StrangeDevice` | New device login | `StrangeDevice` | Notification Service |\n| `OtpEvent` | 2FA OTP generation | `OtpEvent` | Notification Service |\n| `PasswordResetEvent` | Forgot password | `PasswordResetEvent` | Notification Service |\n\nThe outbox pattern ensures reliable event delivery by storing events in the `transactional_outbox` table before publishing to Kafka.\n\nSources: [user/src/main/java/com/chuadatten/user/services/impl/AuthServiceImpl.java:146-164](), [user/db.sql:274-288]()"])</script><script>self.__next_f.push([1,"1e:T252c,"])</script><script>self.__next_f.push([1,"# Notification Service\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [notify/src/main/java/com/chuadatten/event/PayUrlEvent.java](notify/src/main/java/com/chuadatten/event/PayUrlEvent.java)\n- [notify/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java](notify/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java](notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java](notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java)\n- [notify/src/main/java/com/chuadatten/notify/socket/NotificationMessage.java](notify/src/main/java/com/chuadatten/notify/socket/NotificationMessage.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java)\n\n\u003c/details\u003e\n\n\n\nThe Notification Service is responsible for delivering real-time notifications and email communications to users across the e-commerce platform. It operates as an event-driven microservice that consumes Kafka messages from other services and delivers notifications via email and WebSocket connections.\n\nThis service handles user communication workflows including account registration confirmations, password resets, OTP delivery, security alerts, and payment notifications. For information about the broader event-driven architecture patterns, see [Event-Driven Architecture](#2.2). For details on payment processing workflows that trigger notifications, see [Payment Processing](#4.1).\n\n## Service Overview\n\nThe Notification Service implements a reactive messaging pattern where it consumes events from Kafka topics published by other microservices and translates them into user-facing notifications. It supports two primary delivery channels:\n\n| Delivery Channel | Purpose | Implementation |\n|-----------------|---------|----------------|\n| Email | Account lifecycle, security alerts, OTP delivery | SMTP with branded templates |\n| WebSocket | Real-time payment URLs, instant notifications | Server-sent events to connected users |\n\n## Event Consumption Architecture\n\nThe service consumes events from multiple Kafka topics using Spring Kafka listeners with configurable concurrency:\n\n```mermaid\ngraph TD\n    subgraph \"Kafka Topics\"\n        RegTopic[\"user-register\"]\n        ForgotTopic[\"user-forgot-password\"] \n        OtpTopic[\"user-send-otp\"]\n        StrangeTopic[\"user-strange-device\"]\n        PayTopic[\"payment.url.success\"]\n    end\n    \n    subgraph \"EventListener\"\n        RegListener[\"listenRegister()\"]\n        ForgotListener[\"listenForgotPassword()\"]\n        OtpListener[\"listenSendOtp()\"]\n        StrangeListener[\"listenStrangeDevice()\"]\n        PayListener[\"listenPaymentUrlSuccess()\"]\n    end\n    \n    subgraph \"Notification Channels\"\n        EmailSender[\"EmailSender.sendBrandedEmail()\"]\n        NotifyService[\"NotifyService.pushToUser()\"]\n    end\n    \n    RegTopic --\u003e RegListener\n    ForgotTopic --\u003e ForgotListener\n    OtpTopic --\u003e OtpListener\n    StrangeTopic --\u003e StrangeListener\n    PayTopic --\u003e PayListener\n    \n    RegListener --\u003e EmailSender\n    ForgotListener --\u003e EmailSender\n    OtpListener --\u003e EmailSender\n    StrangeListener --\u003e EmailSender\n    PayListener --\u003e NotifyService\n```\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:1-60](), [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:1-19]()\n\n## Kafka Topic Configuration\n\nThe service defines topic names through the `KafkaTopic` enum for type safety and centralized management:\n\n| Topic Name | Event Type | Purpose |\n|------------|------------|---------|\n| `user-register` | `RegistrationEvent` | Welcome emails for new users |\n| `user-forgot-password` | `PasswordResetEvent` | Password reset links |\n| `user-send-otp` | `OtpEvent` | One-time password delivery |\n| `user-strange-device` | `StrangeDevice` | Security alerts for unknown devices |\n| `payment.url.success` | `PayUrlEvent` | Real-time payment URL delivery |\n\nAll email-based listeners use concurrency level 3 and consumer group \"group1\" for load balancing and parallel processing.\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:5-18](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-58]()\n\n## Event Processing Flow\n\nThe notification processing follows a consistent pattern for each event type:\n\n```mermaid\nsequenceDiagram\n    participant OtherService as \"Other Service\"\n    participant Kafka as \"Kafka Topic\"\n    participant EventListener as \"EventListener\"\n    participant EmailSender as \"EmailSender\"\n    participant NotifyService as \"NotifyService\"\n    participant User as \"User\"\n    \n    Note over OtherService,User: Email Notification Flow\n    OtherService-\u003e\u003eKafka: Publish event\n    Kafka-\u003e\u003eEventListener: Consumer receives event\n    EventListener-\u003e\u003eEventListener: Extract event payload\n    EventListener-\u003e\u003eEmailSender: sendBrandedEmail()\n    EmailSender-\u003e\u003eUser: Send SMTP email\n    \n    Note over OtherService,User: WebSocket Notification Flow  \n    OtherService-\u003e\u003eKafka: Publish PayUrlEvent\n    Kafka-\u003e\u003eEventListener: listenPaymentUrlSuccess()\n    EventListener-\u003e\u003eNotifyService: pushToUser()\n    NotifyService-\u003e\u003eUser: WebSocket message\n```\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-58]()\n\n## Event Types and Data Models\n\nThe service processes strongly-typed event objects that encapsulate notification data:\n\n### User Lifecycle Events\n\n- **`RegistrationEvent`**: Contains user email and activation URL for welcome emails\n- **`PasswordResetEvent`**: Contains user email and password reset URL\n- **`OtpEvent`**: Contains user email and generated OTP code\n\n### Security Events\n\n- **`StrangeDevice`**: Contains user email, device type, and device name for security alerts\n\n### Payment Events\n\n- **`PayUrlEvent`**: Contains order ID, payment ID, payment URL, and user ID for real-time payment notifications\n\nSources: [notify/src/main/java/com/chuadatten/event/PayUrlEvent.java:1-13](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:27-57]()\n\n## Email Notification System\n\nEmail notifications use the `EmailSender.sendBrandedEmail()` method with consistent branding across all message types:\n\n| Event Type | Subject | Content |\n|------------|---------|---------|\n| Registration | \"registration success\" | Account activation URL |\n| Password Reset | \"reset password\" | Password reset URL |\n| OTP Delivery | \"otp\" | One-time password code |\n| Strange Device | \"strange device\" | Device type and name information |\n\nAll email notifications are processed asynchronously through Kafka consumer threads with configurable concurrency for scalability.\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:29,36,43,50]()\n\n## WebSocket Notification System\n\nReal-time notifications are delivered through the `NotifyService.pushToUser()` method, which sends targeted messages to specific users via WebSocket connections. This is currently used for:\n\n- **Payment URL Delivery**: Sends payment URLs to users immediately when generated by the Wallet Service\n\nThe WebSocket system supports user-targeted messaging, allowing the service to push notifications only to the intended recipient identified by `userId`.\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:55-58]()\n\n## Integration with Other Services\n\nThe Notification Service integrates with the broader microservices ecosystem through event consumption:\n\n```mermaid\ngraph LR\n    subgraph \"Event Publishers\"\n        UserService[\"User Service\"]\n        WalletService[\"Wallet Service\"]\n    end\n    \n    subgraph \"Kafka Infrastructure\"\n        UserTopics[\"User Topics\u003cbr/\u003e- user-register\u003cbr/\u003e- user-forgot-password\u003cbr/\u003e- user-send-otp\u003cbr/\u003e- user-strange-device\"]\n        PaymentTopics[\"Payment Topics\u003cbr/\u003e- payment.url.success\"]\n    end\n    \n    subgraph \"Notification Service\"\n        EventListener[\"EventListener\"]\n        EmailSender[\"EmailSender\"]\n        NotifyService[\"NotifyService\"]\n    end\n    \n    UserService --\u003e UserTopics\n    WalletService --\u003e PaymentTopics\n    UserTopics --\u003e EventListener\n    PaymentTopics --\u003e EventListener\n    EventListener --\u003e EmailSender\n    EventListener --\u003e NotifyService\n```\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:6-11](), [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-58]()\n\n## Error Handling and Reliability\n\nThe service implements several reliability patterns:\n\n- **Consumer Groups**: All Kafka listeners use consumer group \"group1\" for balanced message distribution\n- **Concurrency Control**: Email processing uses concurrency level 3 for parallel processing while maintaining order\n- **Event Deserialization**: Strongly-typed event objects ensure data integrity during message processing\n- **Asynchronous Processing**: Email sending operations don't block event consumption\n\nThe service relies on Kafka's built-in durability guarantees and Spring Kafka's error handling mechanisms for message reliability.\n\nSources: [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26,33,40,47,54]()"])</script><script>self.__next_f.push([1,"1f:T287d,"])</script><script>self.__next_f.push([1,"# Core Business Processes\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java](product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventListener.java](product/src/main/java/com/chuadatten/product/kafka/EventListener.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventProducer.java](product/src/main/java/com/chuadatten/product/kafka/EventProducer.java)\n- [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java](product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java](product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java)\n- [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java](transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java](wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java)\n- [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java](wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java)\n\n\u003c/details\u003e\n\n\n\nThis document covers the end-to-end business workflows that span multiple microservices in the e-commerce platform. These processes orchestrate complex interactions between the Transaction, Product, Wallet, User, and Notification services through event-driven patterns.\n\nFor detailed API specifications, see [API Reference](#6). For individual service documentation, see [Core Services](#3). For event system architecture, see [Event-Driven Architecture](#2.2).\n\n## Order Processing Workflow\n\nThe complete order lifecycle involves coordination between Transaction, Product, and Wallet services through asynchronous event messaging.\n\n### Order Creation Flow\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant TransactionService as \"OrderServiceImpl\"\n    participant ProductService as \"EventListener\"\n    participant Outbox as \"OutboxRepository\"\n    participant Kafka\n\n    Client-\u003e\u003eTransactionService: \"POST /orders (OrderCreateRq)\"\n    TransactionService-\u003e\u003eTransactionService: \"createOrder()\"\n    TransactionService-\u003e\u003eTransactionService: \"Order.builder().status(PENDING)\"\n    TransactionService-\u003e\u003eOutbox: \"save(OutboxEvent)\"\n    Note over Outbox: \"ORDER_CREATED event\"\n    TransactionService-\u003e\u003eClient: \"OrderDto\"\n    \n    Outbox-\u003e\u003eKafka: \"transaction.order.created\"\n    Kafka-\u003e\u003eProductService: \"listenOrderCreatedEvent()\"\n    \n    alt \"Stock Available\"\n        ProductService-\u003e\u003eProductService: \"variant.setReservedQty()\"\n        ProductService-\u003e\u003eOutbox: \"PRODUCT_RESERVATION_SUCCESS\"\n    else \"Insufficient Stock\"\n        ProductService-\u003e\u003eOutbox: \"PRODUCT_RESERVATION_FAILED\"\n    end\n```\n\nThe order creation process begins in [`transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:48-97`](). The `createOrder()` method:\n\n1. Creates an `Order` entity with `Status.PENDING`\n2. Saves `OrderItem` entities for each product\n3. Publishes an `OrderCreatedEvent` through the outbox pattern\n4. Returns an `OrderDto` response\n\n**Sources:** `transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java`\n\n### Product Reservation Process\n\n```mermaid\nflowchart TD\n    A[\"OrderCreatedEvent\"] --\u003e B[\"EventListener.listenOrderCreatedEvent()\"]\n    B --\u003e C{\"variant.getAvailableQty() \u003e= item.getQuantity()\"}\n    \n    C --\u003e|\"Yes\"| D[\"variant.setAvailableQty(available - quantity)\"]\n    D --\u003e E[\"variant.setReservedQty(reserved + quantity)\"]\n    E --\u003e F[\"ProductReservationSuccessEvent\"]\n    \n    C --\u003e|\"No\"| G[\"ProductReservationFailedEvent\"]\n    \n    F --\u003e H[\"OutboxEvent.PRODUCT_RESERVATION_SUCCESS\"]\n    G --\u003e I[\"OutboxEvent.PRODUCT_RESERVATION_FAILED\"]\n```\n\nProduct reservation is handled in [`product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-70`](). The system:\n\n1. Listens to `transaction.order.created` topic\n2. Validates stock availability using `ProductVariant.availableQty`\n3. Updates inventory counters atomically\n4. Publishes success/failure events through outbox pattern\n\n**Sources:** `product/src/main/java/com/chuadatten/product/kafka/EventListener.java`, `product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java`\n\n## Payment Processing Flow\n\nThe payment system supports both wallet payments and external gateway integration through VNPAY.\n\n### Payment Initiation\n\n```mermaid\nflowchart TD\n    A[\"Client Payment Request\"] --\u003e B{\"PaymentMethod\"}\n    \n    B --\u003e|\"WALLET\"| C[\"PaymentServiceImpl.payment()\"]\n    B --\u003e|\"EXTERNAL\"| D[\"VnpayUltils.payUrl()\"]\n    \n    C --\u003e E[\"wallet.setBalance(balance - amount)\"]\n    E --\u003e F[\"WalletReservation.builder()\"]\n    F --\u003e G[\"PaymentProcessEvent\"]\n    \n    D --\u003e H[\"buildParams()\"]\n    H --\u003e I[\"buildUrl() with hmacSHA512\"]\n    I --\u003e J[\"VNPAY Payment URL\"]\n    \n    G --\u003e K[\"OutboxEvent.PAYMENT_PROCECSSING\"]\n    J --\u003e L[\"External Payment Gateway\"]\n```\n\nPayment processing is implemented in [`wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:58-103`](). The `payment()` method handles:\n\n1. **Wallet Payments**: Direct debit from user wallet with `WalletReservation`\n2. **External Payments**: URL generation through `VnpayUltils.payUrl()`\n3. Event publishing via `PaymentProcessEvent`\n\n**Sources:** `wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java`\n\n### VNPAY Integration\n\n```mermaid\nflowchart LR\n    A[\"VnpayUltils.buildParams()\"] --\u003e B[\"Parameter Map\"]\n    B --\u003e C[\"Collections.sort(fieldNames)\"]\n    C --\u003e D[\"URL Encoding\"]\n    D --\u003e E[\"hmacSHA512(vnpHashSecret, queryString)\"]\n    E --\u003e F[\"vnpPayUrl + queryString + secureHash\"]\n    \n    G[\"VNPAY Callback\"] --\u003e H[\"VnpayReturnDto\"]\n    H --\u003e I[\"VnpayUltils.checkCallBack()\"]\n    I --\u003e J[\"validateIPN()\"]\n    J --\u003e K[\"PaymentSuccessedEvent\"]\n```\n\nVNPAY integration is handled by [`wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java`](). Key methods:\n\n- `payUrl()`: Generates secure payment URLs with HMAC-SHA512 signatures\n- `checkCallBack()`: Validates payment callbacks using IPN verification\n- `validateIPN()`: Ensures callback authenticity through hash validation\n\n**Sources:** `wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java`\n\n### Payment Completion\n\nPayment completion occurs in [`wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:153-188`]() via `handleProviderCallback()`:\n\n1. Validates VNPAY callback using `vnpayUltils.checkCallBack()`\n2. Updates `Payment.status` to `Status.SUCCEEDED`\n3. Updates `PaymentAttempt` with provider response\n4. Publishes `PaymentSuccessedEvent` through outbox\n\n**Sources:** `wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java`\n\n## Order Fulfillment Process\n\n### Delivery Proof Upload\n\n```mermaid\nsequenceDiagram\n    participant Seller\n    participant OrderServiceImpl as \"OrderServiceImpl\"\n    participant FileStorageService as \"FileStorageService\"\n    participant OrderProofRepository as \"OrderProofRepository\"\n\n    Seller-\u003e\u003eOrderServiceImpl: \"uploadDeliveryProof(orderId, proofRq, file)\"\n    OrderServiceImpl-\u003e\u003eOrderServiceImpl: \"validateOrderStatus(APPROVED)\"\n    OrderServiceImpl-\u003e\u003eFileStorageService: \"storeFile(file, 'proof', sellerId)\"\n    FileStorageService-\u003e\u003eOrderServiceImpl: \"urlString\"\n    OrderServiceImpl-\u003e\u003eOrderProofRepository: \"save(OrderProof)\"\n    OrderServiceImpl-\u003e\u003eOrderServiceImpl: \"order.setStatus(DELIVERED)\"\n    OrderServiceImpl-\u003e\u003eSeller: \"OrderDto\"\n```\n\nDelivery proof upload is implemented in [`transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:148-170`](). The process:\n\n1. Validates order status is `Status.APPROVED`\n2. Stores proof file using `FileStorageService`\n3. Creates `OrderProof` entity with `ProofType.DELIVERY`\n4. Updates order status to `Status.DELIVERED`\n\n**Sources:** `transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java`\n\n## Event Flow Integration\n\n### Kafka Topic Configuration\n\n| Topic Name | Producer Service | Consumer Service | Event Type |\n|------------|------------------|------------------|------------|\n| `transaction.order.created` | Transaction | Product | `OrderCreatedEvent` |\n| `product.reservation.success` | Product | Transaction | `ProductReservationSuccessEvent` |\n| `product.reservation.failed` | Product | Transaction | `ProductReservationFailedEvent` |\n| `payment.success` | Wallet | Product, Notification | `PaymentSuccessedEvent` |\n\n**Sources:** `product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java`\n\n### Inventory Finalization\n\n```mermaid\nflowchart TD\n    A[\"PaymentSuccessedEvent\"] --\u003e B[\"EventListener.listenOrderSuccess()\"]\n    B --\u003e C[\"ProductVariantRepository.findById()\"]\n    C --\u003e D[\"variant.setReservedQty(reserved - quantity)\"]\n    D --\u003e E[\"variant.setSoldQty(sold + quantity)\"]\n    E --\u003e F[\"variant.setAvailableQty(available - quantity)\"]\n    F --\u003e G[\"productVariantRepository.save()\"]\n```\n\nWhen payment succeeds, the Product service finalizes inventory in [`product/src/main/java/com/chuadatten/product/kafka/EventListener.java:72-86`]():\n\n1. Listens to `payment.success` topic\n2. Updates `ProductVariant` counters:\n   - Decreases `reservedQty`\n   - Increases `soldQty` \n   - Adjusts `availableQty`\n\n**Sources:** `product/src/main/java/com/chuadatten/product/kafka/EventListener.java`\n\n### Error Handling Patterns\n\nThe system implements comprehensive error handling through:\n\n1. **Stock Validation**: `ErrorCode.INSUFFICIENT_STOCK` in [`product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java:24`]()\n2. **Payment Status Checks**: Multiple payment status validations in `PaymentServiceImpl.handlePaymentStatus()`\n3. **Order State Validation**: Status-based operation restrictions throughout `OrderServiceImpl`\n\n**Sources:** `product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java`, `wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java`, `transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java`"])</script><script>self.__next_f.push([1,"20:T3446,"])</script><script>self.__next_f.push([1,"# Payment Processing\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [wallet/src/main/java/com/chuadatten/wallet/common/Status.java](wallet/src/main/java/com/chuadatten/wallet/common/Status.java)\n- [wallet/src/main/java/com/chuadatten/wallet/entity/Payment.java](wallet/src/main/java/com/chuadatten/wallet/entity/Payment.java)\n- [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java](wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java)\n- [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java](wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java)\n- [wallet/src/main/resources/payment.yaml](wallet/src/main/resources/payment.yaml)\n\n\u003c/details\u003e\n\n\n\nThis document covers the complete payment processing flow in the e-commerce platform, from payment initiation through external payment gateways to completion. It includes both internal wallet operations and external gateway integrations (VNPAY), event-driven communication patterns, and payment state management across services.\n\nFor information about the Wallet Service's internal architecture and data models, see [Wallet Service](#3.3). For the complete order lifecycle that payment processing supports, see [Order Lifecycle](#4.2).\n\n## Payment Flow Overview\n\nThe payment processing system supports two primary payment methods: internal wallet payments and external gateway payments through VNPAY. The process involves coordination between the Wallet Service, Transaction Service, and Product Service through event-driven communication.\n\n### Payment Processing Sequence\n\n```mermaid\nsequenceDiagram\n    participant Client as \"Client\"\n    participant WalletAPI as \"PaymentController\"\n    participant PaymentService as \"PaymentServiceImpl\"\n    participant WalletRepo as \"WalletRepository\" \n    participant OutboxRepo as \"OutboxRepository\"\n    participant Kafka as \"Kafka Topics\"\n    participant VNPAY as \"VNPAY Gateway\"\n    participant TransactionService as \"Transaction Service\"\n\n    Client-\u003e\u003eWalletAPI: \"POST /payments/{paymentId}/process\"\n    WalletAPI-\u003e\u003ePaymentService: \"payment(paymentId, ip, userId, paymentMethod)\"\n    \n    alt \"PaymentMethod.WALLET\"\n        PaymentService-\u003e\u003eWalletRepo: \"findById(userId)\"\n        PaymentService-\u003e\u003ePaymentService: \"Check wallet balance\"\n        PaymentService-\u003e\u003eWalletRepo: \"Update wallet balance\"\n        PaymentService-\u003e\u003ePaymentService: \"Create WalletReservation\"\n    else \"PaymentMethod.VNPAY\"\n        PaymentService-\u003e\u003ePaymentService: \"Skip wallet operations\"\n    end\n    \n    PaymentService-\u003e\u003eOutboxRepo: \"Save PaymentProcessEvent\"\n    PaymentService-\u003e\u003ePaymentService: \"Update payment status to PROCESSING\"\n    Kafka--\u003e\u003eTransactionService: \"PaymentProcessEvent consumed\"\n    \n    opt \"VNPAY Payment\"\n        TransactionService-\u003e\u003eVNPAY: \"Redirect user to payment URL\"\n        VNPAY-\u003e\u003eWalletAPI: \"Callback to /vnpay_return\"\n        WalletAPI-\u003e\u003ePaymentService: \"handleProviderCallback(VnpayReturnDto)\"\n        PaymentService-\u003e\u003ePaymentService: \"Validate callback signature\"\n        PaymentService-\u003e\u003ePaymentService: \"Update payment status to SUCCEEDED\"\n        PaymentService-\u003e\u003eOutboxRepo: \"Save PaymentSuccessedEvent\"\n    end\n    \n    Kafka--\u003e\u003eTransactionService: \"PaymentSuccessedEvent consumed\"\n    Kafka--\u003e\u003eProductService: \"PaymentSuccessedEvent consumed\"\n```\n\n**Payment Initiation Flow**\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:58-103]()\n\n## Payment Methods\n\n### Wallet Payment Processing\n\nInternal wallet payments process funds directly from the user's digital wallet balance. The system performs balance validation and creates reservations to ensure payment atomicity.\n\n```mermaid\nflowchart TD\n    Start[\"payment() called\"] --\u003e CheckPayment[\"Load Payment entity\"]\n    CheckPayment --\u003e ValidateUser[\"Validate userId matches\"]\n    ValidateUser --\u003e CheckStatus[\"Check payment.status == CREATED\"]\n    CheckStatus --\u003e CheckMethod{\"paymentMethod == WALLET?\"}\n    \n    CheckMethod --\u003e|Yes| LoadWallet[\"Load Wallet by userId\"]\n    LoadWallet --\u003e ValidateBalance[\"wallet.balance \u003e= payment.amount?\"]\n    ValidateBalance --\u003e|No| ThrowError[\"Throw INSUFFICIENT_BALANCE\"]\n    ValidateBalance --\u003e|Yes| DeductBalance[\"wallet.balance -= payment.amount\"]\n    DeductBalance --\u003e SaveWallet[\"walletRepository.save(wallet)\"]\n    SaveWallet --\u003e CreateReservation[\"Create WalletReservation\"]\n    CreateReservation --\u003e SaveReservation[\"walletReservationRepository.save()\"]\n    \n    CheckMethod --\u003e|No| SkipWallet[\"Skip wallet operations\"]\n    SaveReservation --\u003e CreateOutbox[\"Create PaymentProcessEvent\"]\n    SkipWallet --\u003e CreateOutbox\n    CreateOutbox --\u003e SaveOutbox[\"outboxRepository.save(outboxEvent)\"]\n    SaveOutbox --\u003e UpdateStatus[\"payment.status = PROCESSING\"]\n    UpdateStatus --\u003e Return[\"Return 'payment processing'\"]\n```\n\n**Wallet Payment Method Processing**\n\nThe `PaymentServiceImpl.payment()` method handles wallet payments by:\n\n1. **Balance Validation**: Checks if `wallet.getBalance().compareTo(pay.getAmount()) \u003c 0`\n2. **Balance Deduction**: Updates wallet with `wallet.setBalance(wallet.getBalance().subtract(pay.getAmount()))`\n3. **Reservation Creation**: Creates `WalletReservation` with `Status.ACTIVE`\n4. **Event Publishing**: Publishes `PaymentProcessEvent` through outbox pattern\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:69-86]()\n\n### External Gateway Payment (VNPAY)\n\nExternal payments route through VNPAY payment gateway, requiring URL generation, user redirection, and callback validation.\n\n| VNPAY Parameter | Source | Purpose |\n|-----------------|--------|---------|\n| `vnp_TmnCode` | `payConfig.getVnpTmnCode()` | Merchant identifier |\n| `vnp_Amount` | `total.multiply(BigInteger.valueOf(100))` | Payment amount in VND cents |\n| `vnp_TxnRef` | `genTxnRef(PaymentType, paymentId)` | Unique transaction reference |\n| `vnp_ReturnUrl` | `payConfig.getVnpReturnUrl()` | Callback URL after payment |\n| `vnp_SecureHash` | `hmacSHA512(vnpHashSecret, params)` | Request signature validation |\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:140-171]()\n\n## VNPAY Integration\n\n### Payment URL Generation\n\nThe `VnpayUltils` class handles VNPAY integration through URL generation and callback validation:\n\n```mermaid\nflowchart TD\n    Start[\"payUrl() called\"] --\u003e BuildParams[\"buildParams(ip, total, detail, ref)\"]\n    BuildParams --\u003e CreateMap[\"Create vnpParams Map\"]\n    CreateMap --\u003e AddVersion[\"vnpParams.put('vnp_Version', vnpVersion)\"]\n    AddVersion --\u003e AddCommand[\"vnpParams.put('vnp_Command', vnpCommand)\"]\n    AddCommand --\u003e AddAmount[\"vnpParams.put('vnp_Amount', total * 100)\"]\n    AddAmount --\u003e AddTxnRef[\"vnpParams.put('vnp_TxnRef', txnRef)\"]\n    AddTxnRef --\u003e AddReturnUrl[\"vnpParams.put('vnp_ReturnUrl', vnpReturnUrl)\"]\n    AddReturnUrl --\u003e SortParams[\"Collections.sort(fieldNames)\"]\n    SortParams --\u003e BuildQuery[\"Build URL query string\"]\n    BuildQuery --\u003e GenerateHash[\"hmacSHA512(vnpHashSecret, queryString)\"]\n    GenerateHash --\u003e BuildFinalUrl[\"vnpPayUrl + '?' + query + '\u0026vnp_SecureHash=' + hash\"]\n    BuildFinalUrl --\u003e Return[\"Return payment URL\"]\n```\n\n**VNPAY URL Generation Process**\n\nThe transaction reference uses the pattern: `PaymentType.name() + \"-\" + paymentId + \"-\" + System.currentTimeMillis()`\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:32-41](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:61-82]()\n\n### Callback Validation\n\nVNPAY callbacks are validated through the `handleProviderCallback()` method:\n\n```mermaid\nflowchart TD\n    Callback[\"handleProviderCallback(VnpayReturnDto)\"] --\u003e ValidateCallback[\"vnpayUltils.checkCallBack(returnDto)\"]\n    ValidateCallback --\u003e CheckResponse[\"responseCode == '00'?\"]\n    CheckResponse --\u003e|No| ThrowError[\"Throw PaymentException\"]\n    CheckResponse --\u003e|Yes| ValidateSignature[\"validateIPN(returnDto.toMap())\"]\n    ValidateSignature --\u003e|Invalid| ThrowError2[\"Throw PaymentException.UNKNOWN\"]\n    ValidateSignature --\u003e|Valid| LoadPayment[\"paymentRepository.findByTxnRef()\"]\n    LoadPayment --\u003e UpdatePayment[\"payment.status = SUCCEEDED\"]\n    UpdatePayment --\u003e UpdateAttempt[\"paymentAttempt.status = SUCCEEDED\"]\n    UpdateAttempt --\u003e CreateSuccessEvent[\"Create PaymentSuccessedEvent\"]\n    CreateSuccessEvent --\u003e SaveOutbox[\"Save to OutboxEvent\"]\n    SaveOutbox --\u003e SaveEntities[\"Save payment and paymentAttempt\"]\n    SaveEntities --\u003e ReturnResponse[\"Return PaymentDto\"]\n```\n\n**VNPAY Callback Processing**\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:153-187](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:110-118]()\n\n## Payment Status Management\n\n### Status Transitions\n\nThe payment system uses a comprehensive status enum to track payment lifecycle:\n\n| Status | Description | Allowed Transitions |\n|--------|-------------|-------------------|\n| `CREATED` | Initial payment state |  `PROCESSING` |\n| `PROCESSING` | Payment being processed |  `SUCCEEDED`, `FAILED` |\n| `SUCCEEDED` | Payment completed successfully |  `REFUNDED` |\n| `FAILED` | Payment failed |  `CREATED` (retry) |\n| `CANCLED` | Payment cancelled | Final state |\n| `REFUNDED` | Payment refunded | Final state |\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e CREATED: \"Payment created\"\n    CREATED --\u003e PROCESSING: \"payment() called\"\n    PROCESSING --\u003e SUCCEEDED: \"VNPAY callback / Wallet success\"\n    PROCESSING --\u003e FAILED: \"Validation failure / Insufficient funds\"\n    SUCCEEDED --\u003e REFUNDED: \"refundPayment()\"\n    FAILED --\u003e CREATED: \"retryPayment()\"\n    CANCLED --\u003e [*]: \"Final state\"\n    REFUNDED --\u003e [*]: \"Final state\"\n```\n\n**Payment Status State Machine**\n\nThe `handlePaymentStatus()` method enforces status validation by throwing appropriate exceptions for invalid state transitions.\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/common/Status.java:20-26](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:105-124]()\n\n## Event-Driven Processing\n\n### Outbox Pattern Implementation\n\nPayment processing uses the outbox pattern to ensure reliable event publishing:\n\n```mermaid\nflowchart TD\n    Payment[\"Payment Operation\"] --\u003e CreateEvent[\"Create Event Object\"]\n    CreateEvent --\u003e BuildOutbox[\"Build OutboxEvent\"]\n    BuildOutbox --\u003e SetAggregateId[\"aggregateId = paymentId\"]\n    SetAggregateId --\u003e SetEventType[\"eventType = KafkaTopic enum\"]\n    SetEventType --\u003e SerializePayload[\"payload = jsonParserUtil.toJson(event)\"]\n    SerializePayload --\u003e SaveOutbox[\"outboxRepository.save(outboxEvent)\"]\n    SaveOutbox --\u003e KafkaPublisher[\"Outbox Publisher reads events\"]\n    KafkaPublisher --\u003e PublishKafka[\"Publish to Kafka topics\"]\n    PublishKafka --\u003e ConsumeServices[\"Services consume events\"]\n```\n\n**Event Publishing Architecture**\n\n### Payment Events\n\n| Event Type | Kafka Topic | Trigger | Consumers |\n|------------|-------------|---------|-----------|\n| `PaymentProcessEvent` | `PAYMENT_PROCECSSING` | Payment initiated | Transaction Service |\n| `PaymentSuccessedEvent` | `PAYMENT_SUCCESS` | Payment completed | Transaction, Product, Notification Services |\n\n**Payment Processing Events**\n\nThe `PaymentProcessEvent` contains:\n- `orderId`: Links payment to order\n- `paymentId`: Payment identifier  \n- `ip`: User IP address\n- `paymentMethod`: Payment method used\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:88-96](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:167-180]()\n\n## Configuration and Security\n\n### VNPAY Configuration\n\nPayment gateway configuration is externalized in `payment.yaml`:\n\n```yaml\nvnpay:\n  vnpTmnCode: XTNKANRH           # Merchant code\n  vnpHashSecret: FNABMOP7...     # HMAC secret key\n  vnpReturnUrl: http://localhost:8084/api/v1/wallet-service/payments/vnpay_return\n  vnpPayUrl: https://sandbox.vnpayment.vn/paymentv2/vpcpay.html\n```\n\n### Security Validation\n\nAll VNPAY callbacks undergo cryptographic validation:\n\n1. **Response Code Validation**: Ensures `responseCode == \"00\"`\n2. **HMAC Signature Validation**: Validates `vnp_SecureHash` using `HmacSHA512`\n3. **Parameter Sorting**: Creates deterministic signature from sorted parameters\n4. **Secure Comparison**: Uses `equalsIgnoreCase()` for hash comparison\n\nSources: [wallet/src/main/resources/payment.yaml:1-14](), [wallet/src/main/java/com/chuadatten/wallet/vnpay/VnpayUltils.java:84-108]()\n\n## Error Handling\n\nThe payment system implements comprehensive error handling with specific exception types:\n\n| Error Code | Condition | Response |\n|------------|-----------|----------|\n| `PAYMENT_NOT_FOUND` | Invalid payment ID | 404 Not Found |\n| `UNAUTHORIZED` | User ID mismatch | 401 Unauthorized |\n| `INSUFFICIENT_BALANCE` | Wallet balance \u003c payment amount | 400 Bad Request |\n| `PAYMENT_PROCESSING` | Payment already in progress | 409 Conflict |\n| `PaymentException` | VNPAY validation failure | 400 Bad Request |\n\nPayment status validation prevents invalid state transitions and ensures data consistency across the payment lifecycle.\n\nSources: [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:61-68](), [wallet/src/main/java/com/chuadatten/wallet/service/impl/PaymentServiceImpl.java:105-124]()"])</script><script>self.__next_f.push([1,"21:T30d8,"])</script><script>self.__next_f.push([1,"# Order Lifecycle\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java](product/src/main/java/com/chuadatten/product/exceptions/ErrorCode.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventListener.java](product/src/main/java/com/chuadatten/product/kafka/EventListener.java)\n- [product/src/main/java/com/chuadatten/product/kafka/EventProducer.java](product/src/main/java/com/chuadatten/product/kafka/EventProducer.java)\n- [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java](product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java](product/src/main/java/com/chuadatten/product/repository/ProductVariantRepository.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java](transaction/src/main/java/com/chuadatten/transaction/kafka/EventProducer.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java](transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java)\n- [transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java](transaction/src/main/java/com/chuadatten/transaction/kafka/SendEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java](transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the complete order processing lifecycle in the e-commerce platform, covering order creation, product reservation, payment processing, and fulfillment. The order lifecycle spans multiple microservices including Transaction, Product, and Wallet services, coordinated through event-driven architecture.\n\nFor payment processing details, see [Payment Processing](#4.1). For event system architecture, see [Event System](#4.3).\n\n## Order Status Model\n\nThe order lifecycle is managed through a series of status transitions defined in the `Status` enumeration. Each status represents a distinct state in the order processing pipeline.\n\n| Status | Description | Next Possible States |\n|--------|-------------|---------------------|\n| `PENDING` | Order created, awaiting product reservation | `READY_PAY`, `CANCELLED` |\n| `READY_PAY` | Products reserved, order ready for payment | `PAYING`, `CANCELLED` |\n| `PAYING` | Payment processing in progress | `PAID`, `CANCELLED` |\n| `PAID` | Payment completed successfully | `APPROVED`, `DELIVERED` |\n| `APPROVED` | Order approved for fulfillment | `DELIVERED` |\n| `DELIVERED` | Order delivered with proof uploaded | - |\n| `CANCELLED` | Order cancelled at any stage | - |\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/common/Status.java](), [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:48-97]()\n\n## Complete Order Lifecycle Flow\n\n```mermaid\nsequenceDiagram\n    participant C as \"Client\"\n    participant T as \"TransactionService\"\n    participant P as \"ProductService\"\n    participant W as \"WalletService\"\n    participant K as \"Kafka\"\n    \n    Note over C,W: \"Order Creation Phase\"\n    C-\u003e\u003eT: \"createOrder(OrderCreateRq)\"\n    T-\u003e\u003eT: \"Save Order (PENDING)\"\n    T-\u003e\u003eK: \"Publish OrderCreatedEvent\"\n    K-\u003e\u003eP: \"Consume OrderCreatedEvent\"\n    \n    Note over P,T: \"Product Reservation Phase\"\n    alt \"Stock Available\"\n        P-\u003e\u003eP: \"Reserve inventory\"\n        P-\u003e\u003eP: \"Update availableQty/reservedQty\"\n        P-\u003e\u003eK: \"Publish ProductReservationSuccessEvent\"\n        K-\u003e\u003eT: \"Consume ProductReservationSuccessEvent\"\n        T-\u003e\u003eT: \"Update status to READY_PAY\"\n        T-\u003e\u003eK: \"Publish OrderConfirmData\"\n    else \"Insufficient Stock\"\n        P-\u003e\u003eK: \"Publish ProductReservationFailedEvent\"\n        K-\u003e\u003eT: \"Consume ProductReservationFailedEvent\"\n        T-\u003e\u003eT: \"Update status to CANCELLED\"\n    end\n    \n    Note over T,W: \"Payment Phase\"\n    K-\u003e\u003eW: \"Consume OrderConfirmData\"\n    W-\u003e\u003eK: \"Publish PaymentProcessEvent\"\n    K-\u003e\u003eT: \"Consume PaymentProcessEvent\"\n    T-\u003e\u003eT: \"Update status to PAYING\"\n    T-\u003e\u003eK: \"Publish OrderCheckingStatusEvent\"\n    \n    Note over W,T: \"Payment Success Phase\"\n    W-\u003e\u003eK: \"Publish PaymentSuccessEvent\"\n    K-\u003e\u003eT: \"Consume PaymentSuccessEvent\"\n    T-\u003e\u003eT: \"Update status to PAID\"\n    T-\u003e\u003eK: \"Publish OrderSuccess\"\n    K-\u003e\u003eP: \"Consume OrderSuccess\"\n    P-\u003e\u003eP: \"Finalize inventory (reservedsold)\"\n    \n    Note over C,T: \"Fulfillment Phase\"\n    C-\u003e\u003eT: \"uploadDeliveryProof()\"\n    T-\u003e\u003eT: \"Update status to DELIVERED\"\n```\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:48-97](), [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:32-103](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-86]()\n\n## Order Creation Process\n\n### Initial Order Creation\n\nThe order creation process begins when a client submits an `OrderCreateRq` to the `OrderServiceImpl.createOrder()` method. The system creates a new `Order` entity with initial `PENDING` status.\n\n```mermaid\ngraph LR\n    A[\"OrderCreateRq\"] --\u003e B[\"OrderServiceImpl.createOrder()\"]\n    B --\u003e C[\"Create Order (PENDING)\"]\n    B --\u003e D[\"Create OrderItem entities\"]\n    B --\u003e E[\"Publish OrderCreatedEvent\"]\n    E --\u003e F[\"OutboxEvent (PENDING)\"]\n```\n\n**Key Implementation Details:**\n- Orders are created with `Status.PENDING` initially\n- Each order item is saved as a separate `OrderItem` entity\n- An `OrderCreatedEvent` is published via the outbox pattern\n- The outbox event ensures reliable event delivery to downstream services\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:48-97]()\n\n### Order Data Model\n\nThe `Order` entity contains essential order information that tracks the complete lifecycle:\n\n- `buyerId` and `sellerId` - Participant identifiers\n- `totalAmount` and `currency` - Financial details\n- `status` - Current order lifecycle status\n- `paymentStatus` - Payment processing status\n- `items` - Collection of `OrderItem` entities\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/entity/Order.java](), [transaction/src/main/java/com/chuadatten/transaction/entity/OrderItem.java]()\n\n## Product Reservation Phase\n\n### Stock Validation and Reservation\n\nWhen the Product Service receives an `OrderCreatedEvent`, it validates product availability and reserves inventory through the `EventListener.listenOrderCreatedEvent()` method.\n\n```mermaid\ngraph TD\n    A[\"OrderCreatedEvent\"] --\u003e B[\"ProductService.EventListener\"]\n    B --\u003e C{\"availableQty \u003e= quantity?\"}\n    C --\u003e|\"Yes\"| D[\"Reserve Stock\"]\n    C --\u003e|\"No\"| E[\"Publish ProductReservationFailedEvent\"]\n    D --\u003e F[\"Update availableQty -= quantity\"]\n    D --\u003e G[\"Update reservedQty += quantity\"]\n    F --\u003e H[\"Save ProductVariant\"]\n    G --\u003e H\n    H --\u003e I[\"Publish ProductReservationSuccessEvent\"]\n    E --\u003e J[\"Transaction cancels order\"]\n    I --\u003e K[\"Transaction updates to READY_PAY\"]\n```\n\n**Critical Business Logic:**\n- Only single-item orders are currently supported (`event.getItems().size() \u003e 1` throws exception)\n- Stock is moved from `availableQty` to `reservedQty` during reservation\n- Failed reservations immediately trigger order cancellation\n- Successful reservations calculate the final `subtotal` based on actual product prices\n\nSources: [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:30-70]()\n\n### Transaction Service Response Handling\n\nThe Transaction Service handles both success and failure scenarios from product reservation:\n\n**Reservation Success:**\n- Updates order status to `READY_PAY`\n- Updates `totalAmount` with calculated subtotal from Product Service\n- Publishes `OrderConfirmData` event to trigger payment processing\n\n**Reservation Failure:**\n- Updates order status to `CANCELLED`\n- No further processing occurs for the order\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:32-65]()\n\n## Payment Processing Integration\n\n### Payment Initiation Flow\n\nWhen an order reaches `READY_PAY` status, the payment flow is initiated through event-driven coordination between Transaction and Wallet services.\n\n```mermaid\ngraph LR\n    A[\"READY_PAY Order\"] --\u003e B[\"OrderConfirmData Event\"]\n    B --\u003e C[\"WalletService\"]\n    C --\u003e D[\"PaymentProcessEvent\"]\n    D --\u003e E[\"Transaction validates status\"]\n    E --\u003e F{\"status == READY_PAY?\"}\n    F --\u003e|\"Yes\"| G[\"Update to PAYING\"]\n    F --\u003e|\"No\"| H[\"Return FAILED status\"]\n    G --\u003e I[\"OrderCheckingStatusEvent (OK)\"]\n    H --\u003e J[\"OrderCheckingStatusEvent (FAILED)\"]\n```\n\n**Status Validation Logic:**\nThe Transaction Service validates order status before allowing payment processing. Only orders in `READY_PAY` status can proceed to payment.\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:105-137]()\n\n### Payment Success Handling\n\nUpon successful payment, multiple coordinated actions occur:\n\n1. **Transaction Service Updates:**\n   - Order status changes to `PAID`\n   - Payment status changes to `SUCCESS`\n   - Publishes `OrderSuccess` event with complete order details\n\n2. **Product Service Finalization:**\n   - Moves inventory from `reservedQty` to `soldQty`\n   - Reduces `availableQty` by the purchased quantity\n   - Completes the inventory transaction\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/kafka/EventListener.java:67-103](), [product/src/main/java/com/chuadatten/product/kafka/EventListener.java:72-86]()\n\n## Order Fulfillment Process\n\n### Delivery Proof Upload\n\nSellers can upload delivery proof for orders in `APPROVED` status using the `uploadDeliveryProof()` method:\n\n```mermaid\ngraph TD\n    A[\"APPROVED Order\"] --\u003e B[\"Seller uploads proof\"]\n    B --\u003e C[\"OrderProofCreateRq + MultipartFile\"]\n    C --\u003e D[\"FileStorageService.storeFile()\"]\n    D --\u003e E[\"Create OrderProof entity\"]\n    E --\u003e F[\"Update Order status to DELIVERED\"]\n    F --\u003e G[\"Return updated OrderDto\"]\n```\n\n**Implementation Details:**\n- Only sellers can upload delivery proof for their orders\n- Orders must be in `APPROVED` status to accept delivery proof\n- Files are stored using `FileStorageService` with seller-specific paths\n- `OrderProof` entities are created with `ProofType.DELIVERY`\n- Order status automatically updates to `DELIVERED`\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:147-170]()\n\n## Order Cancellation Flows\n\n### User-Initiated Cancellation\n\nUsers can cancel their own orders through the `cancelOrder()` method, subject to status restrictions:\n\n- Only orders in `PENDING` status can be cancelled by users\n- Cancellation immediately updates order status to `CANCELLED`\n- No event propagation occurs for user cancellations\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/service/impl/OrderServiceImpl.java:133-145]()\n\n### System-Initiated Cancellation\n\nThe system automatically cancels orders in several scenarios:\n\n1. **Product Reservation Failure:** When insufficient stock is detected\n2. **Payment Processing Failure:** When payment validation fails\n3. **Service Integration Failures:** When downstream services are unavailable\n\nAll system cancellations are handled through event-driven mechanisms to ensure consistency across services.\n\n## Event Flow Summary\n\nThe order lifecycle involves the following key Kafka topics and events:\n\n| Event Topic | Purpose | Publishing Service | Consuming Services |\n|-------------|---------|-------------------|-------------------|\n| `transaction.order.created` | Initial order creation | Transaction | Product |\n| `product.reservation.success` | Stock successfully reserved | Product | Transaction |\n| `product.reservation.failed` | Insufficient stock detected | Product | Transaction |\n| `transaction.order.confirm.data` | Order ready for payment | Transaction | Wallet |\n| `payment.payment.processing` | Payment processing started | Wallet | Transaction |\n| `payment.success` | Payment completed | Wallet | Transaction, Product |\n| `transaction.order.success` | Order fully processed | Transaction | Product |\n\nSources: [transaction/src/main/java/com/chuadatten/transaction/kafka/KafkaTopic.java](), [product/src/main/java/com/chuadatten/product/kafka/KafkaTopic.java]()"])</script><script>self.__next_f.push([1,"22:T27b0,"])</script><script>self.__next_f.push([1,"# Event System\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [notify/src/main/java/com/chuadatten/event/PayUrlEvent.java](notify/src/main/java/com/chuadatten/event/PayUrlEvent.java)\n- [notify/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java](notify/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java](notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java)\n- [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java](notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java)\n- [product/src/main/java/com/chuadatten/event/OrderCreatedEvent.java](product/src/main/java/com/chuadatten/event/OrderCreatedEvent.java)\n- [product/src/main/java/com/chuadatten/event/OrderSuccess.java](product/src/main/java/com/chuadatten/event/OrderSuccess.java)\n- [product/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java](product/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java)\n- [product/src/main/java/com/chuadatten/event/ProductReservationSuccessEvent.java](product/src/main/java/com/chuadatten/event/ProductReservationSuccessEvent.java)\n- [product/src/main/java/com/chuadatten/product/common/JsonParserUtil.java](product/src/main/java/com/chuadatten/product/common/JsonParserUtil.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java)\n- [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java](transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java)\n\n\u003c/details\u003e\n\n\n\nThis document covers the Kafka-based event system that enables asynchronous communication between microservices in the e-commerce platform. It focuses on the technical implementation of event publishing, consumption, and the outbox pattern used for reliable event delivery.\n\nFor broader architectural patterns and event-driven design principles, see [Event-Driven Architecture](#2.2). For complete business process flows that use these events, see [Order Lifecycle](#4.2) and [Payment Processing](#4.1).\n\n## Outbox Pattern Implementation\n\nThe platform implements the outbox pattern to ensure reliable event publishing. The Transaction service uses MongoDB to store outbox events before publishing them to Kafka topics.\n\n### OutboxEvent Structure\n\nThe `OutboxEvent` entity represents events awaiting publication with the following key fields:\n\n| Field | Purpose | Index |\n|-------|---------|-------|\n| `aggregateType` | Source service/entity type | No |\n| `aggregateId` | Source entity identifier | Yes |\n| `eventType` | Specific event classification | Yes |\n| `payload` | JSON serialized event data | No |\n| `status` | Publication status (PENDING/PUBLISHED) | Yes |\n| `attempts` | Retry counter for failed publications | No |\n| `publishedAt` | Timestamp of successful publication | Yes |\n\n```mermaid\ngraph TD\n    A[\"Transaction Service\"] --\u003e B[\"OutboxEvent Creation\"]\n    B --\u003e C[\"MongoDB Outbox Collection\"]\n    C --\u003e D[\"Outbox Publisher Process\"]\n    D --\u003e E[\"Kafka Topic\"]\n    D --\u003e F[\"Update OutboxEvent.status = PUBLISHED\"]\n    \n    B --\u003e G[\"OutboxEvent Fields\"]\n    G --\u003e H[\"aggregateType: 'ORDER'\"]\n    G --\u003e I[\"eventType: 'ORDER_CREATED'\"]\n    G --\u003e J[\"payload: JSON event data\"]\n    G --\u003e K[\"status: 'PENDING'\"]\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxEvent.java:1-52](), [transaction/src/main/java/com/chuadatten/transaction/outbox/OutboxRepository.java:1-10]()\n\n## Kafka Topic Structure\n\nThe notification service defines standardized Kafka topics through the `KafkaTopic` enum. Each topic serves specific business events across the microservices ecosystem.\n\n### Topic Definitions\n\n| Topic Name | Purpose | Publishing Service | Consuming Service |\n|------------|---------|-------------------|-------------------|\n| `user-register` | User registration completion | User Service | Notification Service |\n| `user-forgot-password` | Password reset requests | User Service | Notification Service |\n| `user-change-password` | Password change notifications | User Service | Notification Service |\n| `user-otp` | OTP code delivery | User Service | Notification Service |\n| `user-strange-device` | Security alerts for new devices | User Service | Notification Service |\n| `payment.url.success` | Payment URL generation success | Wallet Service | Notification Service |\n\n```mermaid\ngraph LR\n    subgraph \"Kafka Topics\"\n        T1[\"user-register\"]\n        T2[\"user-forgot-password\"] \n        T3[\"user-change-password\"]\n        T4[\"user-otp\"]\n        T5[\"user-strange-device\"]\n        T6[\"payment.url.success\"]\n    end\n    \n    subgraph \"Services\"\n        US[\"User Service\"]\n        WS[\"Wallet Service\"]\n        NS[\"Notification Service\"]\n    end\n    \n    US --\u003e T1\n    US --\u003e T2\n    US --\u003e T3\n    US --\u003e T4\n    US --\u003e T5\n    WS --\u003e T6\n    \n    T1 --\u003e NS\n    T2 --\u003e NS\n    T3 --\u003e NS\n    T4 --\u003e NS\n    T5 --\u003e NS\n    T6 --\u003e NS\n```\n\n**Sources:** [notify/src/main/java/com/chuadatten/notify/kafka/KafkaTopic.java:1-19]()\n\n## Event Schemas\n\nThe system defines strongly-typed event classes for reliable data exchange between services. Each event contains specific business data required for processing.\n\n### Product Service Events\n\nThe Product service publishes events related to inventory management and order processing:\n\n```mermaid\nclassDiagram\n    class OrderCreatedEvent {\n        +String orderId\n        +String buyerId\n        +String sellerId\n        +BigDecimal totalAmount\n        +String currency\n        +List~OrderItemEvent~ items\n    }\n    \n    class OrderItemEvent {\n        +String productId\n        +String productVariantId\n        +int quantity\n        +BigDecimal unitPrice\n    }\n    \n    class ProductReservationSuccessEvent {\n        +String orderId\n        +BigDecimal subtotal\n    }\n    \n    class ProductReservationFailedEvent {\n        +String orderId\n    }\n    \n    class OrderSuccess {\n        +String orderId\n        +String sellerId\n        +List~ProductQuantityUpdate~ products\n        +BigDecimal finalAmount\n        +String currency\n    }\n    \n    OrderCreatedEvent --\u003e OrderItemEvent\n    OrderSuccess --\u003e ProductQuantityUpdate\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/event/OrderCreatedEvent.java:1-33](), [product/src/main/java/com/chuadatten/event/ProductReservationSuccessEvent.java:1-17](), [product/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java:1-15](), [product/src/main/java/com/chuadatten/event/OrderSuccess.java:1-33]()\n\n### Notification Service Events\n\nThe Notification service consumes various user-centric events:\n\n```mermaid\nclassDiagram\n    class RegistrationEvent {\n        +String email\n        +String urlActive\n    }\n    \n    class PasswordResetEvent {\n        +String email\n        +String url\n    }\n    \n    class OtpEvent {\n        +String email\n        +String otp\n    }\n    \n    class StrangeDevice {\n        +String email\n        +String deviceType\n        +String deviceName\n    }\n    \n    class PayUrlEvent {\n        +String orderId\n        +String paymentId\n        +String payUrl\n        +String userId\n    }\n```\n\n**Sources:** [notify/src/main/java/com/chuadatten/event/PayUrlEvent.java:1-13](), [notify/src/main/java/com/chuadatten/event/ProductReservationFailedEvent.java:1-15]()\n\n## Event Processing Implementation\n\n### Kafka Event Listeners\n\nThe `EventListener` class in the Notification service implements concurrent event processing using Spring Kafka annotations:\n\n```mermaid\nsequenceDiagram\n    participant KT as \"Kafka Topic\"\n    participant EL as \"EventListener\"\n    participant ES as \"EmailSender\"\n    participant NS as \"NotifyService\"\n    \n    Note over EL: \"@KafkaListener with concurrency=3\"\n    \n    KT-\u003e\u003eEL: \"ConsumerRecord\u003cString, RegistrationEvent\u003e\"\n    EL-\u003e\u003eES: \"sendBrandedEmail(email, subject, content)\"\n    \n    KT-\u003e\u003eEL: \"ConsumerRecord\u003cString, PayUrlEvent\u003e\"\n    EL-\u003e\u003eNS: \"pushToUser(userId, payUrl)\"\n```\n\n### Listener Configuration\n\nEach Kafka listener is configured with specific concurrency and group settings:\n\n| Method | Topic | Concurrency | Group ID | Action |\n|--------|-------|-------------|----------|---------|\n| `listenRegister` | `user-register` | 3 | `group1` | Send welcome email |\n| `listenForgotPassword` | `user-forgot-password` | 3 | `group1` | Send reset email |\n| `listenSendOtp` | `user-otp` | 3 | `group1` | Send OTP email |\n| `listenStrangeDevice` | `user-strange-device` | 3 | `group1` | Send security alert |\n| `listenPaymentUrlSuccess` | `payment.url.success` | 3 | `group1` | Push WebSocket notification |\n\n**Sources:** [notify/src/main/java/com/chuadatten/notify/kafka/EventListener.java:26-58]()\n\n## JSON Serialization\n\nThe system uses Jackson `ObjectMapper` for consistent JSON serialization across services through the `JsonParserUtil` utility class:\n\n```mermaid\ngraph TD\n    A[\"Event Object\"] --\u003e B[\"JsonParserUtil.toJson()\"]\n    B --\u003e C[\"ObjectMapper.writeValueAsString()\"]\n    C --\u003e D[\"JSON String for Kafka Payload\"]\n    \n    E[\"Kafka JSON Payload\"] --\u003e F[\"JsonParserUtil.fromJson()\"]\n    F --\u003e G[\"ObjectMapper.readValue()\"]\n    G --\u003e H[\"Typed Event Object\"]\n```\n\nThe utility provides type-safe conversion methods:\n- `toJson(T object)`: Converts objects to JSON strings for event payloads\n- `fromJson(String json, Class\u003cT\u003e clazz)`: Deserializes JSON to strongly-typed events\n\n**Sources:** [product/src/main/java/com/chuadatten/product/common/JsonParserUtil.java:19-33]()\n\n## Event Flow Patterns\n\nThe event system follows consistent patterns for inter-service communication:\n\n1. **Command Events**: Trigger actions in consuming services (e.g., `OrderCreatedEvent`)\n2. **Status Events**: Notify of state changes (e.g., `ProductReservationSuccessEvent`)\n3. **Notification Events**: Trigger user communications (e.g., `RegistrationEvent`)\n\nEach event type follows the outbox pattern for reliable delivery and maintains strong schema contracts for data consistency across service boundaries."])</script><script>self.__next_f.push([1,"23:T3ebb,"])</script><script>self.__next_f.push([1,"# Database Design\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [transaction/db.sql](transaction/db.sql)\n- [transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java](transaction/src/main/java/com/chuadatten/transaction/common/ProofType.java)\n- [transaction/src/main/java/com/chuadatten/transaction/common/Status.java](transaction/src/main/java/com/chuadatten/transaction/common/Status.java)\n- [transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java](transaction/src/main/java/com/chuadatten/transaction/request/OrderCreateRq.java)\n- [user/db.sql](user/db.sql)\n- [user/src/main/java/com/chuadatten/user/controller/AuthController.java](user/src/main/java/com/chuadatten/user/controller/AuthController.java)\n- [user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java](user/src/main/java/com/chuadatten/user/repository/UserInfRepository.java)\n- [wallet/db.sql](wallet/db.sql)\n\n\u003c/details\u003e\n\n\n\nThis document provides a comprehensive overview of the database schemas, entity relationships, and data models across all services in the e-commerce microservices platform. It covers the physical database design, cross-service data relationships, and event-driven data consistency patterns.\n\nFor information about the API contracts and data transfer between services, see [API Reference](#6). For details about the event-driven communication patterns, see [Event System](#4.3).\n\n## Database Architecture Overview\n\nThe platform uses a polyglot persistence approach with different database technologies optimized for each service's specific requirements. Each microservice maintains its own dedicated database following the database-per-service pattern.\n\n### Database Technology Distribution\n\n```mermaid\ngraph TB\n    subgraph \"MySQL Databases\"\n        UserDB[\"user_db\u003cbr/\u003e- Authentication\u003cbr/\u003e- User Profiles\u003cbr/\u003e- KYC Data\u003cbr/\u003e- Roles \u0026 Permissions\"]\n        TransactionDB[\"transaction_db\u003cbr/\u003e- Orders\u003cbr/\u003e- Order Items\u003cbr/\u003e- Disputes \u0026 Refunds\u003cbr/\u003e- Order Lifecycle\"]\n        WalletDB[\"wallet_service_db\u003cbr/\u003e- Digital Wallets\u003cbr/\u003e- Payment Records\u003cbr/\u003e- Reservations\u003cbr/\u003e- Bank Accounts\"]\n    end\n    \n    subgraph \"MongoDB Databases\"\n        ProductDB[\"product_db\u003cbr/\u003e- Product Catalog\u003cbr/\u003e- Inventory\u003cbr/\u003e- Categories\"]\n        NotifyDB[\"notification_db\u003cbr/\u003e- Message Queue\u003cbr/\u003e- Email Templates\u003cbr/\u003e- Delivery Status\"]\n    end\n    \n    subgraph \"Services\"\n        UserService[\"`UserService`\"]\n        TransactionService[\"`TransactionService`\"]\n        WalletService[\"`WalletService`\"]\n        ProductService[\"`ProductService`\"]\n        NotifyService[\"`NotificationService`\"]\n    end\n    \n    UserService --\u003e UserDB\n    TransactionService --\u003e TransactionDB\n    WalletService --\u003e WalletDB\n    ProductService --\u003e ProductDB\n    NotifyService --\u003e NotifyDB\n```\n\n**Sources:** [wallet/db.sql:1-131](), [transaction/db.sql:1-128](), [user/db.sql:1-289]()\n\n## User Service Database Schema\n\nThe User Service maintains authentication, profile, and authorization data in MySQL with comprehensive audit trails and KYC support.\n\n### Core Authentication Tables\n\n```mermaid\nerDiagram\n    user_auth {\n        binary_16 id PK\n        varchar_50 username UK\n        varchar_255 email UK\n        varchar_255 password_hash\n        varchar_50 status\n        tinyint_1 two_factor_enabled\n        tinyint_1 is_kyc\n        varchar_100 two_factor_secret\n        timestamp created_at\n        timestamp updated_at\n        timestamp last_login_at\n    }\n    \n    user_inf {\n        binary_16 id PK\n        varchar_50 display_name\n        varchar_100 email UK\n        varchar_50 country\n        varchar_20 status\n        varchar_255 avatar_url\n        boolean is_seller\n        text seller_bio\n        timestamp created_at\n        timestamp updated_at\n        timestamp deleted_at\n    }\n    \n    roles {\n        binary_16 id PK\n        varchar_50 name UK\n        varchar_255 description\n    }\n    \n    user_roles {\n        binary_16 id PK\n        binary_16 user_id FK\n        binary_16 role_id FK\n    }\n    \n    user_auth ||--|| user_inf : \"same user\"\n    user_inf ||--o{ user_roles : \"has roles\"\n    roles ||--o{ user_roles : \"assigned to\"\n```\n\nThe system supports three primary roles defined in the `roles` table: `ROLE_USER`, `ROLE_SELLER`, and `ROLE_ADMIN` as referenced in [user/src/main/java/com/chuadatten/user/controller/AuthController.java:106]().\n\n### KYC and Verification System\n\n| Table | Purpose | Key Features |\n|-------|---------|--------------|\n| `user_verifications` | KYC document storage | Face ID, document front/back URLs, versioning |\n| `delete_kyc_requests` | GDPR compliance | User-initiated KYC deletion with selfie verification |\n| `seller_applications` | Seller onboarding | Multi-stage approval process with reviewer tracking |\n\n**Sources:** [user/db.sql:7-25](), [user/db.sql:151-165](), [user/db.sql:215-229](), [user/db.sql:257-272]()\n\n## Transaction Service Database Schema\n\nThe Transaction Service manages the complete order lifecycle with comprehensive audit trails and dispute resolution capabilities.\n\n### Order Management Tables\n\n```mermaid\nerDiagram\n    orders {\n        binary_16 id PK\n        binary_16 buyer_id FK\n        binary_16 seller_id FK\n        decimal_18_2 total_amount\n        char_3 currency\n        varchar_50 status\n        varchar_50 payment_status\n        tinyint_1 audit_flag\n        datetime created_at\n        datetime updated_at\n        datetime expired_at\n    }\n    \n    order_items {\n        binary_16 id PK\n        binary_16 order_id FK\n        varchar_255 product_id\n        varchar_255 product_variant_id\n        decimal_18_2 unit_price\n        int quantity\n        decimal_18_2 subtotal\n        datetime created_at\n    }\n    \n    order_proofs {\n        binary_16 id PK\n        binary_16 order_id FK\n        binary_16 seller_id FK\n        varchar_50 type\n        varchar_1024 url\n        varchar_500 note\n        datetime uploaded_at\n    }\n    \n    order_refunds {\n        binary_16 id PK\n        binary_16 order_id FK\n        binary_16 request_by FK\n        varchar_50 status\n        text reason\n        datetime created_at\n        datetime completed_at\n    }\n    \n    order_disputes {\n        binary_16 id PK\n        binary_16 order_id FK\n        binary_16 opened_by FK\n        varchar_50 issue_type\n        text description\n        varchar_50 status\n        datetime created_at\n        datetime resolved_at\n    }\n    \n    order_logs {\n        bigint id PK\n        binary_16 order_id FK\n        varchar_50 from_status\n        varchar_50 to_status\n        binary_16 changed_by FK\n        varchar_500 note\n        datetime created_at\n    }\n    \n    orders ||--o{ order_items : \"contains\"\n    orders ||--o{ order_proofs : \"has proof\"\n    orders ||--o{ order_refunds : \"may have\"\n    orders ||--o{ order_disputes : \"may have\"\n    orders ||--o{ order_logs : \"tracks changes\"\n```\n\n### Order Status Transitions\n\nThe order lifecycle follows defined status transitions managed by the `Status` enum in [transaction/src/main/java/com/chuadatten/transaction/common/Status.java:1-22]():\n\n| Status | Description | Next Valid States |\n|--------|-------------|-------------------|\n| `PENDING` | Initial order state | `READY_PAY`, `CANCELLED` |\n| `READY_PAY` | Inventory reserved | `PAYING`, `CANCELLED` |\n| `PAYING` | Payment processing | `PAID`, `CANCELLED` |\n| `PAID` | Payment successful | `PROCESSING`, `COMPLETED` |\n| `PROCESSING` | Order fulfillment | `DELIVERED`, `COMPLETED` |\n| `DELIVERED` | Proof uploaded | `COMPLETED` |\n| `COMPLETED` | Order finalized | N/A |\n\n**Sources:** [transaction/db.sql:8-31](), [transaction/db.sql:34-52](), [transaction/src/main/java/com/chuadatten/transaction/common/Status.java:1-22]()\n\n## Wallet Service Database Schema\n\nThe Wallet Service implements a comprehensive financial ledger system with double-entry bookkeeping principles, reservation management, and external payment gateway integration.\n\n### Financial Core Tables\n\n```mermaid\nerDiagram\n    wallets {\n        binary_16 id PK\n        binary_16 user_id FK\n        char_3 currency\n        bigint balance\n        bigint reserved\n        bigint version\n        tinyint status\n        timestamp_6 created_at\n        timestamp_6 updated_at\n    }\n    \n    wallet_transactions {\n        binary_16 id PK\n        binary_16 wallet_id FK\n        binary_16 related_entity_id FK\n        varchar_40 type\n        bigint amount\n        tinyint direction\n        bigint balance_after\n        char_3 currency\n        varchar_30 status\n        varchar_255 idempotency_key UK\n        json metadata\n        timestamp_6 created_at\n    }\n    \n    wallet_reservations {\n        binary_16 id PK\n        binary_16 wallet_id FK\n        binary_16 order_id FK\n        bigint amount\n        char_3 currency\n        timestamp_6 expires_at\n        varchar_30 status\n        timestamp_6 created_at\n    }\n    \n    payments {\n        binary_16 id PK\n        binary_16 user_id FK\n        binary_16 wallet_id FK\n        binary_16 order_id FK\n        varchar_50 provider\n        varchar_255 provider_payment_id\n        varchar_30 type\n        varchar_30 payment_method\n        bigint amount\n        char_3 currency\n        varchar_30 status\n        varchar_255 idempotency_key UK\n        json metadata\n        varchar_255 txn_ref UK\n        timestamp_6 created_at\n        timestamp_6 updated_at\n    }\n    \n    payment_attempts {\n        binary_16 id PK\n        binary_16 payment_id FK\n        json attempt_data\n        json provider_response\n        varchar_30 status\n        timestamp_6 created_at\n    }\n    \n    bank_accounts {\n        binary_16 id PK\n        binary_16 user_id FK\n        varchar_50 bank_code\n        varbinary_512 account_number_encrypted\n        varchar_50 account_number_masked\n        varchar_255 account_name\n        timestamp_6 created_at\n    }\n    \n    wallets ||--o{ wallet_transactions : \"ledger entries\"\n    wallets ||--o{ wallet_reservations : \"holds funds\"\n    payments ||--o{ payment_attempts : \"retry tracking\"\n    payments }o--|| wallets : \"credits/debits\"\n```\n\n### Financial Transaction Types\n\nThe wallet system supports various transaction types with strict audit trails:\n\n| Transaction Type | Direction | Purpose |\n|------------------|-----------|---------|\n| `topup` | Credit (+1) | Adding funds to wallet |\n| `payment` | Debit (-1) | Order payment |\n| `refund` | Credit (+1) | Order cancellation refund |\n| `withdrawal` | Debit (-1) | Cash out to bank |\n| `transfer` | Both | P2P transfers |\n| `fee` | Debit (-1) | Service fees |\n| `adjustment` | Both | Administrative corrections |\n\n### Reservation System\n\nThe wallet implements a two-phase commit pattern for payments:\n1. **Reserve Phase**: Funds are held in `wallet_reservations` with `status='active'`\n2. **Capture Phase**: Reservation is `status='captured'` and converted to a `wallet_transaction`\n3. **Release Phase**: On failure, reservation becomes `status='cancelled'`\n\n**Sources:** [wallet/db.sql:2-15](), [wallet/db.sql:18-34](), [wallet/db.sql:37-48](), [wallet/db.sql:51-73]()\n\n## Cross-Service Data Relationships\n\nWhile each service maintains its own database, logical relationships exist across service boundaries through shared entity identifiers.\n\n### Inter-Service Entity Relationships\n\n```mermaid\ngraph TB\n    subgraph \"User Service\"\n        UserAuth[\"user_auth.id\"]\n        UserInf[\"user_inf.id\"]\n    end\n    \n    subgraph \"Transaction Service\"\n        Orders[\"orders\u003cbr/\u003ebuyer_id, seller_id\"]\n        OrderItems[\"order_items\u003cbr/\u003eproduct_id, product_variant_id\"]\n    end\n    \n    subgraph \"Wallet Service\"\n        Wallets[\"wallets\u003cbr/\u003euser_id\"]\n        Payments[\"payments\u003cbr/\u003euser_id, order_id\"]\n        WalletTxn[\"wallet_transactions\u003cbr/\u003erelated_entity_id\"]\n    end\n    \n    subgraph \"Product Service\"\n        Products[\"products\u003cbr/\u003eMongoDB\"]\n        Variants[\"product_variants\u003cbr/\u003eMongoDB\"]\n    end\n    \n    UserAuth -.-\u003e|\"user_id reference\"| Wallets\n    UserInf -.-\u003e|\"buyer_id/seller_id\"| Orders\n    Orders -.-\u003e|\"order_id reference\"| Payments\n    Products -.-\u003e|\"product_id reference\"| OrderItems\n    Variants -.-\u003e|\"variant_id reference\"| OrderItems\n    Orders -.-\u003e|\"order_id reference\"| WalletTxn\n```\n\n### Foreign Key Constraints and Referential Integrity\n\nSince microservices use separate databases, traditional foreign key constraints cannot enforce cross-service relationships. The system maintains referential integrity through:\n\n1. **Event-driven updates**: Services publish events when entities are created/modified\n2. **Eventual consistency**: Services update their references asynchronously\n3. **Compensation patterns**: Failed operations trigger compensating transactions\n\n**Sources:** [transaction/db.sql:11-13](), [wallet/db.sql:4](), [user/db.sql:153]()\n\n## Event-Driven Data Consistency\n\nThe platform uses the Transactional Outbox pattern to ensure reliable event publishing and eventual consistency across services.\n\n### Outbox Pattern Implementation\n\n```mermaid\nsequenceDiagram\n    participant App as \"Application Code\"\n    participant DB as \"Local Database\"\n    participant Outbox as \"transactional_outbox\"\n    participant Pub as \"Event Publisher\"\n    participant Kafka as \"Kafka Topics\"\n    \n    App-\u003e\u003eDB: Begin Transaction\n    App-\u003e\u003eDB: Update Business Entity\n    App-\u003e\u003eOutbox: Insert Event Record\n    DB-\u003e\u003eDB: Commit Transaction\n    \n    loop Event Publishing\n        Pub-\u003e\u003eOutbox: Poll PENDING events\n        Pub-\u003e\u003eKafka: Publish Event\n        Pub-\u003e\u003eOutbox: Mark PUBLISHED\n    end\n```\n\n### Outbox Table Schema\n\nThe `transactional_outbox` table in User Service demonstrates the pattern:\n\n| Column | Type | Purpose |\n|--------|------|---------|\n| `id` | `BINARY(16)` | Unique event identifier |\n| `aggregate_type` | `VARCHAR(50)` | Entity type: 'Order', 'Wallet', 'Payment' |\n| `aggregate_id` | `BINARY(16)` | Related entity ID |\n| `event_type` | `VARCHAR(100)` | Event name: 'order.created', 'wallet.reservation_created' |\n| `payload` | `JSON` | Event data payload |\n| `status` | `VARCHAR(20)` | 'PENDING', 'PUBLISHED', 'FAILED' |\n| `attempts` | `INT` | Retry counter |\n\n**Sources:** [user/db.sql:274-288]()\n\n## Data Security and Compliance\n\n### Encryption and PII Protection\n\nThe database design implements several security measures for sensitive data:\n\n1. **Encrypted Bank Accounts**: Account numbers stored in `account_number_encrypted` using KMS\n2. **Masked Display Data**: `account_number_masked` shows partial information (e.g., \"****1234\")\n3. **JWT Secret Storage**: Two-factor authentication secrets in `user_auth.two_factor_secret`\n4. **Soft Deletes**: `user_inf.deleted_at` for GDPR compliance\n\n### Audit Trails\n\nComprehensive audit logging across all services:\n\n| Service | Audit Mechanism | Tables |\n|---------|----------------|---------|\n| User | Login history, audit logs | `login_history`, `audit_logs`, `password_history` |\n| Transaction | Order state changes | `order_logs` |\n| Wallet | Immutable transaction ledger | `wallet_transactions` |\n\n**Sources:** [wallet/db.sql:105-114](), [user/db.sql:29-40](), [user/db.sql:69-81](), [transaction/db.sql:113-127]()\n\n## Performance Optimizations\n\n### Indexing Strategy\n\nThe database design includes strategic indexes for high-frequency queries:\n\n```sql\n-- User Service\nKEY idx_user_auth_email (email)\nKEY idx_user_auth_username (username)\n\n-- Transaction Service  \nKEY idx_orders_buyer_status (buyer_id, status)\nKEY idx_orders_seller_status (seller_id, status)\nKEY idx_orders_payment_status (payment_status)\n\n-- Wallet Service\nKEY idx_wallet_created (wallet_id, created_at)\nKEY idx_user_status (user_id, status)\nUNIQUE KEY ux_user_currency (user_id, currency)\n```\n\n### Optimistic Concurrency Control\n\nThe wallet system uses versioning to prevent race conditions:\n- `wallets.version` field incremented on each update\n- Application code must check version before modifying balance\n- Concurrent modifications result in optimistic locking exceptions\n\n**Sources:** [user/db.sql:23-24](), [transaction/db.sql:27-30](), [wallet/db.sql:8](), [wallet/db.sql:13]()"])</script><script>self.__next_f.push([1,"24:T4b78,"])</script><script>self.__next_f.push([1,"# API Reference\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [product/src/main/java/com/chuadatten/product/controller/AdminController.java](product/src/main/java/com/chuadatten/product/controller/AdminController.java)\n- [product/src/main/java/com/chuadatten/product/controller/CategoryController.java](product/src/main/java/com/chuadatten/product/controller/CategoryController.java)\n- [product/src/main/java/com/chuadatten/product/controller/ProductController.java](product/src/main/java/com/chuadatten/product/controller/ProductController.java)\n- [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java](product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java)\n- [transaction/src/main/java/com/chuadatten/transaction/controller/AdminController.java](transaction/src/main/java/com/chuadatten/transaction/controller/AdminController.java)\n- [user/src/main/java/com/chuadatten/user/controller/AdminController.java](user/src/main/java/com/chuadatten/user/controller/AdminController.java)\n- [user/src/main/java/com/chuadatten/user/controller/FileUploadController.java](user/src/main/java/com/chuadatten/user/controller/FileUploadController.java)\n- [user/src/main/java/com/chuadatten/user/controller/KycController.java](user/src/main/java/com/chuadatten/user/controller/KycController.java)\n- [user/src/main/java/com/chuadatten/user/controller/SellerController.java](user/src/main/java/com/chuadatten/user/controller/SellerController.java)\n- [user/src/main/java/com/chuadatten/user/controller/UserInforController.java](user/src/main/java/com/chuadatten/user/controller/UserInforController.java)\n- [user/src/main/java/com/chuadatten/user/securities/Security.java](user/src/main/java/com/chuadatten/user/securities/Security.java)\n\n\u003c/details\u003e\n\n\n\nThis document provides comprehensive REST API documentation for all microservices in the e-commerce platform. It covers endpoint specifications, authentication requirements, request/response formats, and authorization patterns across the Transaction Service, Product Service, Wallet Service, User Service, and Notification Service.\n\nFor information about the underlying event-driven architecture and inter-service communication patterns, see [Event System](#4.3). For details about authentication mechanisms and security implementation, see [Authentication \u0026 Security](#2.3).\n\n## Authentication Overview\n\nAll API endpoints use JWT-based authentication with role-based authorization. The platform supports three primary roles with hierarchical permissions:\n\n- **ROLE_ADMIN**: Full system access, user management, administrative functions\n- **ROLE_SELLER**: Product management, order fulfillment, seller-specific operations  \n- **ROLE_USER**: Basic user operations, order placement, profile management\n\n### Authentication Flow\n\n```mermaid\nsequenceDiagram\n    participant Client as \"Client Application\"\n    participant Auth as \"Auth Endpoint\"\n    participant JWT as \"JWT Decoder\" \n    participant API as \"Protected API\"\n    \n    Client-\u003e\u003eAuth: \"POST /api/v1/user-service/auth/login\"\n    Auth-\u003e\u003eClient: \"JWT Token\"\n    Client-\u003e\u003eAPI: \"Request with Bearer Token\"\n    API-\u003e\u003eJWT: \"Validate Token\"\n    JWT-\u003e\u003eAPI: \"Extract User Claims\"\n    API-\u003e\u003eAPI: \"Check Role Permissions\"\n    API-\u003e\u003eClient: \"Response or 401/403\"\n```\n\n**Sources:** [user/src/main/java/com/chuadatten/user/securities/Security.java:27-93]()\n\n### Authorization Patterns\n\nThe security configuration defines endpoint access patterns using Spring Security:\n\n| Access Level | Pattern | Required Roles |\n|-------------|---------|---------------|\n| Admin Only | `/api/v1/*/admin/**` | `ROLE_ADMIN` |\n| Seller/Admin | `/api/v1/*/seller/**` | `ROLE_SELLER`, `ROLE_ADMIN` |\n| Authenticated | `/api/v1/*/users/me/**` | `ROLE_USER`, `ROLE_SELLER`, `ROLE_ADMIN` |\n| Public | `/api/v1/*/auth/**` | None (permitAll) |\n\n**Sources:** [user/src/main/java/com/chuadatten/user/securities/Security.java:35-78]()\n\n## User Service API\n\nBase URL: `/api/v1/user-service`\n\n### Authentication Endpoints\n\n| Method | Endpoint | Description | Access |\n|--------|----------|-------------|---------|\n| POST | `/auth/login` | User login | Public |\n| POST | `/auth/register` | User registration | Public |\n| POST | `/auth/logout` | Logout current session | Authenticated |\n| POST | `/auth/logout-all` | Logout all sessions | Authenticated |\n| POST | `/auth/verify-2fa` | Verify 2FA code | Public |\n| POST | `/auth/enable-2fa` | Enable 2FA | Authenticated |\n| POST | `/auth/disable-2fa` | Disable 2FA | Authenticated |\n| POST | `/auth/change-password` | Change password | Authenticated |\n| POST | `/auth/forgot-password` | Forgot password | Public |\n| POST | `/auth/reset-password` | Reset password | Public |\n| POST | `/auth/activate-account` | Activate account | Public |\n| GET | `/auth/access-token` | Get access token | Public |\n\n### User Information Management\n\n#### UserInforController Endpoints\n\n```mermaid\ngraph TD\n    A[\"UserInforController\"] --\u003e B[\"GET /users/id/{userId}\"]\n    A --\u003e C[\"GET /users/name/{displayName}\"]\n    A --\u003e D[\"PUT /users/me\"]\n    A --\u003e E[\"POST /users/me/avatar\"]\n    A --\u003e F[\"GET /users/preferences/{userId}\"]\n    A --\u003e G[\"PUT /users/me/preferences\"]\n    A --\u003e H[\"GET /users/me/billing-address\"]\n    A --\u003e I[\"POST /users/me/billing-address\"]\n    A --\u003e J[\"PUT /users/me/billing-address\"]\n    \n    B --\u003e K[\"@JwtClaims('id')\"]\n    D --\u003e K\n    E --\u003e K\n    G --\u003e K\n    H --\u003e K\n    I --\u003e K\n    J --\u003e K\n```\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:39-120]()\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| GET | `/users/id/{userId}` | Get user by ID | `userId`: UUID | Public |\n| GET | `/users/name/{displayName}` | Get user by display name | `displayName`: String | Public |\n| PUT | `/users/me` | Update current user | `UpdateUserRequest` body | Authenticated |\n| POST | `/users/me/avatar` | Update user avatar | `MultipartFile` avatar | Authenticated |\n| GET | `/users/preferences/{userId}` | Get user preferences | `userId`: UUID | Public |\n| PUT | `/users/me/preferences` | Update preferences | `UpdatePreferenceRequest` body | Authenticated |\n| GET | `/users/me/billing-address` | Get billing address | None | Authenticated |\n| POST | `/users/me/billing-address` | Create billing address | `BillingAddressRequest` body | Authenticated |\n| PUT | `/users/me/billing-address` | Update billing address | `BillingAddressRequest` body | Authenticated |\n\n### KYC Verification\n\n| Method | Endpoint | Description | Content Type | Access |\n|--------|----------|-------------|-------------|---------|\n| POST | `/kyc/submit` | Submit verification request | `multipart/form-data` | Authenticated |\n| GET | `/kyc/me` | Get current user's verification | `application/json` | Authenticated |\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/KycController.java:31-45]()\n\n### File Management\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| POST | `/files/upload` | Upload file | `file`, `folder`, `id` | Authenticated |\n| GET | `/files/{folder}/{id}/{fileName:.+}` | Download file | Path variables | Authenticated |\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/FileUploadController.java:23-48]()\n\n### Seller Operations\n\n| Method | Endpoint | Description | Access |\n|--------|----------|-------------|---------|\n| GET | `/seller/ratings` | Get seller ratings with pagination | Seller/Admin |\n| POST | `/seller/ratings` | Rate a seller | Seller/Admin |\n| POST | `/seller/applications` | Submit seller application | Seller/Admin |\n| GET | `/seller/applications/me` | Get current user's application | Seller/Admin |\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/SellerController.java:28-66]()\n\n### Admin User Management\n\n```mermaid\ngraph TB\n    Admin[\"AdminController\"] --\u003e ListUsers[\"GET /admin/users\"]\n    Admin --\u003e GetUser[\"GET /admin/users/{userId}\"]\n    Admin --\u003e ApproveUser[\"POST /admin/users/{userId}/approve\"]\n    Admin --\u003e RejectUser[\"POST /admin/users/{userId}/reject\"]\n    Admin --\u003e SuspendUser[\"POST /admin/users/{userId}/suspend\"]\n    Admin --\u003e DeleteUser[\"DELETE /admin/users/{userId}\"]\n    Admin --\u003e SetRole[\"POST /admin/users/{userId}/roles\"]\n    Admin --\u003e ChangeSellerStatus[\"POST /admin/users/{userId}/seller-status\"]\n    \n    ListUsers --\u003e QueryParams[\"page, size, status\"]\n    SetRole --\u003e RoleParam[\"roleName: RoleName\"]\n    ChangeSellerStatus --\u003e StatusParam[\"status: Status\"]\n```\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/AdminController.java:24-93]()\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| GET | `/admin/users` | Get user list | `page`, `size`, `status` | Admin |\n| GET | `/admin/users/{userId}` | Get user by ID | `userId`: UUID | Admin |\n| POST | `/admin/users/{userId}/approve` | Approve user | `userId`: UUID | Admin |\n| POST | `/admin/users/{userId}/reject` | Reject user | `userId`: UUID | Admin |\n| POST | `/admin/users/{userId}/suspend` | Suspend user | `userId`: UUID | Admin |\n| DELETE | `/admin/users/{userId}` | Delete user | `userId`: UUID | Admin |\n| POST | `/admin/users/{userId}/roles` | Set user role | `userId`: UUID, `roleName`: RoleName | Admin |\n| POST | `/admin/users/{userId}/seller-status` | Change seller status | `userId`: UUID, `status`: Status | Admin |\n\n## Product Service API\n\nBase URL: `/api/v1/product-service`\n\n### Product Management\n\n#### ProductController Endpoints\n\n```mermaid\ngraph LR\n    PC[\"ProductController\"] --\u003e Create[\"POST /products\"]\n    PC --\u003e Update[\"PUT /products/{id}\"]\n    PC --\u003e Delete[\"DELETE /products/{id}\"]\n    PC --\u003e GetById[\"GET /products/{id}\"]\n    PC --\u003e GetBySlug[\"GET /products/slug/{slug}\"]\n    PC --\u003e ListByCategory[\"GET /products/category/{categoryId}\"]\n    PC --\u003e Search[\"GET /products/search\"]\n    PC --\u003e AddImages[\"POST /products/{productId}/images\"]\n    PC --\u003e GetAll[\"GET /products/all\"]\n    \n    Create --\u003e AuthRequired[\"@JwtClaims('id')\"]\n    Update --\u003e AuthRequired\n    Delete --\u003e AuthRequired\n    AddImages --\u003e AuthRequired\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/ProductController.java:36-92]()\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| POST | `/products` | Create product | `ProductCreateRq` body | Authenticated |\n| PUT | `/products/{id}` | Update product | `id`: String, `ProductUpdateRq` body | Authenticated |\n| DELETE | `/products/{id}` | Delete product | `id`: String | Authenticated |\n| GET | `/products/{id}` | Get product by ID | `id`: String | Public |\n| GET | `/products/slug/{slug}` | Get product by slug | `slug`: String | Public |\n| GET | `/products/category/{categoryId}` | List products by category | `categoryId`, `page`, `size` | Public |\n| GET | `/products/search` | Search products | `keyword`, `page`, `size` | Public |\n| POST | `/products/{productId}/images` | Add product images | `productId`, `MultipartFile`, `alt`, `main`, `position` | Authenticated |\n| GET | `/products/all` | Get all products | None | Public |\n\n### Product Variant Management\n\n#### Stock Operations Flow\n\n```mermaid\nsequenceDiagram\n    participant Client as \"Client\"\n    participant PVC as \"ProductVariantController\"\n    participant PVS as \"ProductVariantService\"\n    participant Stock as \"Stock Management\"\n    \n    Client-\u003e\u003ePVC: \"POST /product-variants/{variantId}/reserve?qty=5\"\n    PVC-\u003e\u003ePVS: \"reserve(variantId, qty)\"\n    PVS-\u003e\u003eStock: \"Check available stock\"\n    Stock-\u003e\u003ePVS: \"Stock available\"\n    PVS-\u003e\u003eStock: \"Reserve stock\"\n    Stock-\u003e\u003ePVS: \"Stock reserved\"\n    PVS-\u003e\u003ePVC: \"ProductVariantDto\"\n    PVC-\u003e\u003eClient: \"ApiResponse\u003cProductVariantDto\u003e\"\n    \n    Note over Client,Stock: Later, after payment success\n    Client-\u003e\u003ePVC: \"POST /product-variants/{variantId}/commit?qty=5\"\n    PVC-\u003e\u003ePVS: \"commit(variantId, qty)\"\n    PVS-\u003e\u003eStock: \"Commit reserved stock\"\n    Stock-\u003e\u003ePVS: \"Stock committed (sold)\"\n    PVS-\u003e\u003ePVC: \"ProductVariantDto\"\n    PVC-\u003e\u003eClient: \"ApiResponse\u003cProductVariantDto\u003e\"\n```\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java:53-66]()\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| POST | `/product-variants` | Create variant | `VariantCreateRq` body | Authenticated |\n| PUT | `/product-variants/{id}` | Update variant | `id`: String, `VariantUpdateRq` body | Authenticated |\n| DELETE | `/product-variants/{id}` | Delete variant | `id`: String | Authenticated |\n| GET | `/product-variants/{id}` | Get variant by ID | `id`: String | Public |\n| GET | `/product-variants/product/{productId}` | List variants by product | `productId`: String | Public |\n| POST | `/product-variants/{variantId}/reserve` | Reserve stock | `variantId`: String, `qty`: int | Public |\n| POST | `/product-variants/{variantId}/commit` | Commit reserved stock | `variantId`: String, `qty`: int | Public |\n| POST | `/product-variants/{variantId}/release` | Release reserved stock | `variantId`: String, `qty`: int | Public |\n\n### Category Management\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| GET | `/categories/{id}` | Get category by ID | `id`: String | Public |\n| GET | `/categories/slug/{slug}` | Get category by slug | `slug`: String | Public |\n| GET | `/categories/{parentId}/children` | Get child categories | `parentId`: String | Public |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/CategoryController.java:18-31]()\n\n### Admin Category Management\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| POST | `/admin/categories` | Create category | `CategoryDto` body | Admin |\n| PUT | `/admin/categories/{id}` | Update category | `id`: String, `CategoryDto` body | Admin |\n| DELETE | `/admin/categories/{id}` | Delete category | `id`: String | Admin |\n\n**Sources:** [product/src/main/java/com/chuadatten/product/controller/AdminController.java:20-37]()\n\n## Transaction Service API\n\nBase URL: `/api/v1/transaction-service`\n\n### Admin Transaction Management\n\n#### Order Management\n\n```mermaid\ngraph TD\n    TAC[\"Transaction AdminController\"] --\u003e GetAllOrders[\"GET /admin/orders\"]\n    TAC --\u003e GetOrderDetails[\"GET /admin/orders/{orderId}\"]\n    TAC --\u003e AuditOrder[\"PUT /admin/orders/{orderId}/audit\"]\n    \n    GetAllOrders --\u003e OrderFilters[\"sellerId, buyerId, status, paymentStatus, page, limit\"]\n    AuditOrder --\u003e AuditParams[\"orderId: UUID, auditFlag: boolean\"]\n    \n    TAC --\u003e GetAllDisputes[\"GET /admin/disputes\"]\n    TAC --\u003e ResolveDispute[\"POST /admin/disputes/{disputeId}/resolve\"]\n    TAC --\u003e GetAllRefunds[\"GET /admin/refunds\"]\n    \n    GetAllDisputes --\u003e DisputeFilters[\"status, issueType, page, limit\"]\n    ResolveDispute --\u003e DisputeParams[\"disputeId: UUID, status: Status, autoRefund: boolean\"]\n    GetAllRefunds --\u003e RefundFilters[\"status, orderId, buyerId, page, limit\"]\n```\n\n**Sources:** [transaction/src/main/java/com/chuadatten/transaction/controller/AdminController.java:34-108]()\n\n| Method | Endpoint | Description | Parameters | Access |\n|--------|----------|-------------|------------|---------|\n| GET | `/admin/orders` | Get all orders | `sellerId`, `buyerId`, `status`, `paymentStatus`, `page`, `limit` | Admin |\n| GET | `/admin/orders/{orderId}` | Get order details | `orderId`: UUID | Admin |\n| PUT | `/admin/orders/{orderId}/audit` | Audit order | `orderId`: UUID, `auditFlag`: boolean | Admin |\n| GET | `/admin/disputes` | Get all disputes | `status`, `issueType`, `page`, `limit` | Admin |\n| POST | `/admin/disputes/{disputeId}/resolve` | Resolve dispute | `disputeId`: UUID, `status`: Status, `autoRefund`: boolean | Admin |\n| GET | `/admin/refunds` | Get all refunds | `status`, `orderId`, `buyerId`, `page`, `limit` | Admin |\n\n## Common API Patterns\n\n### Request/Response Format\n\nAll APIs return responses in a standardized `ApiResponse\u003cT\u003e` format:\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Operation completed successfully\",\n  \"data\": { /* Response payload */ },\n  \"timestamp\": \"2024-01-01T00:00:00Z\"\n}\n```\n\n### Pagination Parameters\n\nFor paginated endpoints, the following query parameters are supported:\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| `page` | int | 0 | Page number (0-indexed) |\n| `size`/`limit` | int | 10 | Items per page |\n\n### JWT Claims Extraction\n\nControllers use the `@JwtClaims(\"id\")` annotation to extract user ID from JWT tokens:\n\n```java\n@GetMapping(\"/users/me\")\npublic ApiResponse\u003cUserInfDto\u003e getCurrentUser(\n    @Parameter(hidden = true) @JwtClaims(\"id\") UUID userId\n) {\n    // userId automatically extracted from JWT token\n}\n```\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:56]()\n\n### Error Handling\n\nThe platform uses standard HTTP status codes:\n\n- **200**: Success\n- **400**: Bad Request - Invalid request parameters\n- **401**: Unauthorized - Invalid or missing JWT token\n- **403**: Forbidden - Insufficient permissions for requested operation\n- **404**: Not Found - Requested resource does not exist\n- **500**: Internal Server Error - Server-side error\n\nAuthentication failures are handled by `CustomAuthenticationEntryPoint` which returns structured error responses.\n\n**Sources:** [user/src/main/java/com/chuadatten/user/securities/Security.java:91]()\n\n### File Upload Handling\n\nFile uploads use `multipart/form-data` encoding and support the following operations:\n\n- Profile avatar updates: `POST /api/v1/user-service/users/me/avatar`\n- KYC document uploads: `POST /api/v1/user-service/kyc/submit`\n- Product image uploads: `POST /api/v1/product-service/products/{productId}/images`\n- General file storage: `POST /api/v1/user-service/files/upload`\n\n**Sources:** [user/src/main/java/com/chuadatten/user/controller/FileUploadController.java:23-31](), [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:65-71](), [product/src/main/java/com/chuadatten/product/controller/ProductController.java:79-87]()\n\n## Service Integration Points\n\n### Cross-Service Communication\n\nWhile this document focuses on REST API endpoints, many operations trigger events that are processed by other services:\n\n- **Order Creation**: Transaction Service  Product Service (stock reservation)\n- **Payment Processing**: Wallet Service  Transaction Service (order completion)\n- **User Registration**: User Service  Notification Service (welcome emails)\n\nFor detailed information about event-driven integration patterns, see [Event System](#4.3).\n\n**Sources:** [user/src/main/java/com/chuadatten/user/securities/Security.java:1-95](), [user/src/main/java/com/chuadatten/user/controller/UserInforController.java:1-124](), [product/src/main/java/com/chuadatten/product/controller/ProductController.java:1-94](), [product/src/main/java/com/chuadatten/product/controller/ProductVariantController.java:1-67](), [transaction/src/main/java/com/chuadatten/transaction/controller/AdminController.java:1-109]()"])</script><script>self.__next_f.push([1,"25:T36cc,"])</script><script>self.__next_f.push([1,"# Development Setup\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [.vscode/settings.json](.vscode/settings.json)\n- [notify/.gitattributes](notify/.gitattributes)\n- [product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java](product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java)\n- [product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java](product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java)\n- [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java](product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java)\n- [product/src/main/java/com/chuadatten/product/service/ProductVariantService.java](product/src/main/java/com/chuadatten/product/service/ProductVariantService.java)\n- [product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java](product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java)\n- [product/src/main/resources/application.properties](product/src/main/resources/application.properties)\n- [wallet/src/main/resources/payment.yaml](wallet/src/main/resources/payment.yaml)\n\n\u003c/details\u003e\n\n\n\nThis document provides configuration requirements, environment setup instructions, and development guidelines for the e-commerce microservices platform. It covers service configuration, database setup, external integrations, and development tooling required to run the system locally.\n\nFor detailed information about the overall system architecture, see [System Architecture](#2). For specific service configurations and APIs, see [Core Services](#3).\n\n## Prerequisites\n\nThe following tools and services are required for local development:\n\n### Required Software\n\n| Component | Version | Purpose |\n|-----------|---------|---------|\n| Java | 17+ | Runtime for all microservices |\n| Maven | 3.8+ | Build and dependency management |\n| Docker | 20.10+ | Container orchestration |\n| MongoDB | 5.0+ | Document database for Product and Notification services |\n| MySQL | 8.0+ | Relational database for Transaction, User, and Wallet services |\n| Apache Kafka | 2.8+ | Event streaming platform |\n| Redis | 6.2+ | Caching and session storage |\n\n### Development Tools\n\n- **IDE**: VS Code with Java extensions (configuration available)\n- **API Testing**: Postman or similar tool\n- **Database Client**: MongoDB Compass, MySQL Workbench\n- **Message Queue**: Kafka UI for monitoring\n\n**Development Environment Configuration**\n```mermaid\ngraph TB\n    subgraph \"Development Machine\"\n        IDE[\"VS Code\u003cbr/\u003eJava Extensions\u003cbr/\u003eMapStruct Support\"]\n        Maven[\"Maven 3.8+\u003cbr/\u003eBuild Tool\"]\n        JDK[\"JDK 17+\u003cbr/\u003eRuntime\"]\n    end\n    \n    subgraph \"Local Infrastructure\"\n        MongoDB[\"MongoDB 5.0+\u003cbr/\u003e:27017\"]\n        MySQL[\"MySQL 8.0+\u003cbr/\u003e:3306\"]\n        Kafka[\"Apache Kafka\u003cbr/\u003e:9092\"]\n        Redis[\"Redis\u003cbr/\u003e:6379\"]\n    end\n    \n    subgraph \"Microservices\"\n        UserService[\"user-service\u003cbr/\u003e:8081\"]\n        ProductService[\"product-service\u003cbr/\u003e:8082\"]\n        TransactionService[\"transaction-service\u003cbr/\u003e:8083\"]\n        WalletService[\"wallet-service\u003cbr/\u003e:8084\"]\n        NotifyService[\"notify-service\u003cbr/\u003e:8085\"]\n    end\n    \n    IDE --\u003e Maven\n    Maven --\u003e JDK\n    JDK --\u003e UserService\n    JDK --\u003e ProductService\n    JDK --\u003e TransactionService\n    JDK --\u003e WalletService\n    JDK --\u003e NotifyService\n    \n    ProductService --\u003e MongoDB\n    NotifyService --\u003e MongoDB\n    UserService --\u003e MySQL\n    TransactionService --\u003e MySQL\n    WalletService --\u003e MySQL\n    UserService --\u003e Redis\n    \n    UserService -.-\u003e Kafka\n    ProductService -.-\u003e Kafka\n    TransactionService -.-\u003e Kafka\n    WalletService -.-\u003e Kafka\n    Kafka -.-\u003e NotifyService\n```\n\nSources: [.vscode/settings.json:1-3](), [product/src/main/resources/application.properties:1-4]()\n\n## Service Configuration\n\n### Port Allocation\n\nEach microservice runs on a dedicated port to avoid conflicts:\n\n| Service | Port | Configuration File |\n|---------|------|-------------------|\n| User Service | 8081 | `user/src/main/resources/application.properties` |\n| Product Service | 8082 | `product/src/main/resources/application.properties` |\n| Transaction Service | 8083 | `transaction/src/main/resources/application.properties` |\n| Wallet Service | 8084 | `wallet/src/main/resources/application.properties` |\n| Notification Service | 8085 | `notify/src/main/resources/application.properties` |\n\n### Configuration File Structure\n\nThe application uses a modular configuration approach with separate YAML files:\n\n**Configuration Import Pattern**\n```mermaid\ngraph LR\n    AppProps[\"application.properties\"]\n    \n    subgraph \"Imported Configurations\"\n        Kafka[\"kafka.yaml\u003cbr/\u003eEvent Streaming\"]\n        DB[\"db.yaml\u003cbr/\u003eDatabase Connections\"]\n        JWT[\"jwt.yaml\u003cbr/\u003eSecurity Tokens\"]\n        Auth2[\"auth2.yaml\u003cbr/\u003eOAuth2 Settings\"]\n    end\n    \n    AppProps --\u003e Kafka\n    AppProps --\u003e DB\n    AppProps --\u003e JWT\n    AppProps --\u003e Auth2\n```\n\nThe main application properties file imports specialized configurations using `spring.config.import`:\n\n```properties\nspring.config.import=classpath:kafka.yaml,classpath:db.yaml,classpath:jwt.yaml,classpath:auth2.yaml\n```\n\nSources: [product/src/main/resources/application.properties:3]()\n\n### Payment Configuration\n\nThe wallet service requires specific payment gateway configuration for VNPAY integration:\n\n**VNPAY Configuration Structure**\n- **Version**: 2.1.0 (API version)\n- **Terminal Code**: `XTNKANRH` (merchant identifier)\n- **Hash Secret**: Environment-specific secret key\n- **Return URL**: `http://localhost:8084/api/v1/wallet-service/payments/vnpay_return`\n- **Payment URL**: `https://sandbox.vnpayment.vn/paymentv2/vpcpay.html`\n\nThe payment configuration also includes JWT settings for payment tokens:\n- **Secret**: Base64-encoded signing key\n- **Expiration**: 600000ms (10 minutes)\n\nSources: [wallet/src/main/resources/payment.yaml:1-14]()\n\n## Security Configuration\n\n### JWT Authentication System\n\nThe platform uses a custom JWT decoder that handles both internal tokens and external OAuth2 tokens:\n\n**JWT Processing Flow**\n```mermaid\nsequenceDiagram\n    participant Client\n    participant CustomJwtDecoder\n    participant InternalJWKS[\"Internal JWKS\u003cbr/\u003elocalhost:8081/api/v1/oauth2/jwks\"]\n    participant GoogleJWKS[\"Google JWKS\u003cbr/\u003egoogleapis.com/oauth2/v3/certs\"]\n    \n    Client-\u003e\u003eCustomJwtDecoder: \"JWT Token\"\n    CustomJwtDecoder-\u003e\u003eCustomJwtDecoder: \"Parse Token\"\n    \n    alt \"Internal Token\"\n        CustomJwtDecoder-\u003e\u003eInternalJWKS: \"Validate with Internal Keys\"\n        InternalJWKS--\u003e\u003eCustomJwtDecoder: \"Validation Result\"\n    else \"Google OAuth Token\"\n        CustomJwtDecoder-\u003e\u003eGoogleJWKS: \"Validate with Google Keys\"\n        GoogleJWKS--\u003e\u003eCustomJwtDecoder: \"Validation Result\"\n    end\n    \n    CustomJwtDecoder--\u003e\u003eClient: \"Decoded JWT or Error\"\n```\n\nThe `CustomJwtDecoder` class implements token validation logic:\n- Parses incoming JWT tokens using `JWTParser.parse()`\n- Checks issuer to determine token source (internal vs Google OAuth)\n- Routes to appropriate JWKS endpoint for validation\n- Handles `ParseException` and converts to `CustomException`\n\nSources: [product/src/main/java/com/chuadatten/product/securities/CustomJwtDecoder.java:22-46]()\n\n## Database Setup\n\n### Database Architecture\n\nThe system uses a polyglot persistence approach with different databases for different services:\n\n**Database Allocation by Service**\n```mermaid\nerDiagram\n    ProductService ||--|| MongoDB : \"uses\"\n    NotificationService ||--|| MongoDB : \"uses\"\n    UserService ||--|| MySQL : \"uses\"\n    TransactionService ||--|| MySQL : \"uses\" \n    WalletService ||--|| MySQL : \"uses\"\n    UserService ||--|| Redis : \"caches\"\n    \n    MongoDB {\n        string _id \"ObjectId\"\n        object documents \"BSON format\"\n        array embedded_arrays \"Product images, etc\"\n    }\n    \n    MySQL {\n        varchar id \"UUID primary keys\"\n        timestamp created_at \"Auto-generated\"\n        timestamp updated_at \"Auto-generated\"\n    }\n    \n    Redis {\n        string key \"Session keys\"\n        string value \"Cached data\"\n        int ttl \"Time to live\"\n    }\n```\n\n### Required Databases\n\n1. **MongoDB** (Document Store)\n   - Product catalog with embedded images\n   - Notification templates and logs\n   - Flexible schema for product attributes\n\n2. **MySQL** (Relational Store)  \n   - User accounts and authentication\n   - Financial transactions and wallets\n   - Order management and disputes\n   - Referential integrity for business rules\n\n3. **Redis** (Cache Store)\n   - User session management\n   - Temporary data caching\n   - Rate limiting counters\n\n## Development Workflow\n\n### Object Mapping with MapStruct\n\nThe system uses MapStruct for compile-time object mapping between entities and DTOs:\n\n**MapStruct Configuration Pattern**\n```mermaid\nclassDiagram\n    class ProductMapper {\n        +toDto(Product) ProductDto\n        +toEntity(ProductDto) Product\n        +update(ProductUpdateRq, Product) void\n        +toDtoList(List~Product~) List~ProductDto~\n    }\n    \n    class ProductVariantMapper {\n        +toDto(ProductVariant) ProductVariantDto\n        +update(VariantUpdateRq, ProductVariant) void\n    }\n    \n    class MapStructConfig {\n        \u003c\u003cannotation\u003e\u003e\n        componentModel: \"spring\"\n        nullValuePropertyMappingStrategy: IGNORE\n    }\n    \n    ProductMapper ..|\u003e MapStructConfig\n    ProductVariantMapper ..|\u003e MapStructConfig\n```\n\nKey mapping configurations:\n- **Component Model**: `\"spring\"` for Spring dependency injection\n- **Null Value Strategy**: `IGNORE` to prevent overwriting with null values\n- **Target Ignoring**: Automatic fields like `id`, `createdAt`, `updatedAt` are ignored during updates\n\nThe mappers handle complex scenarios like embedded objects (`ProductImage` within `Product`) and provide update methods that merge only non-null values.\n\nSources: [product/src/main/java/com/chuadatten/product/mapper/ProductMapper.java:21-77](), [product/src/main/java/com/chuadatten/product/mapper/ProductVariantMapper.java:16-41]()\n\n### Service Layer Architecture\n\nServices follow a consistent pattern with interface definitions and implementation classes:\n\n**Service Implementation Pattern**\n```mermaid\nclassDiagram\n    class ProductService {\n        \u003c\u003cinterface\u003e\u003e\n        +create(ProductCreateRq, String) ApiResponse~ProductDto~\n        +update(String, ProductUpdateRq, String) ApiResponse~ProductDto~\n        +delete(String, String) ApiResponse~Void~\n        +getById(String) ApiResponse~ProductDto~\n        +addImages(String, MultipartFile, String, boolean, int) ApiResponse~ProductDto~\n    }\n    \n    class ProductServiceImpl {\n        -ProductRepository productRepository\n        -ProductMapper productMapper  \n        -FileStorageService fileStorageService\n        +create(ProductCreateRq, String) ApiResponse~ProductDto~\n        +update(String, ProductUpdateRq, String) ApiResponse~ProductDto~\n        -createNewProduct(ProductCreateRq, String) Map~String,Object~\n    }\n    \n    class ProductVariantService {\n        \u003c\u003cinterface\u003e\u003e\n        +reserve(String, int) ApiResponse~ProductVariantDto~\n        +commit(String, int) ApiResponse~ProductVariantDto~\n        +release(String, int) ApiResponse~ProductVariantDto~\n    }\n    \n    ProductServiceImpl ..|\u003e ProductService\n    ProductServiceImpl --\u003e ProductMapper : uses\n    ProductServiceImpl --\u003e ProductRepository : uses\n```\n\nThe service layer provides:\n- **Consistent Response Format**: All methods return `ApiResponse\u003cT\u003e` wrapper\n- **User Authorization**: User ID validation for ownership-based operations  \n- **Business Logic**: Complex operations like product creation with variants\n- **Stock Management**: Reserve/commit/release operations for inventory\n\nSources: [product/src/main/java/com/chuadatten/product/service/impl/ProductServiceImpl.java:33-183](), [product/src/main/java/com/chuadatten/product/service/ProductVariantService.java:14-91]()\n\n## Local Development Setup\n\n### Service Startup Order\n\n1. **Infrastructure Services** (Start first)\n   - MongoDB\n   - MySQL  \n   - Redis\n   - Apache Kafka\n\n2. **Core Services** (Start in order)\n   - User Service (8081) - Provides authentication\n   - Product Service (8082)\n   - Transaction Service (8083)\n   - Wallet Service (8084)  \n   - Notification Service (8085)\n\n### Environment Variables\n\nCreate a `.env` file in the root directory with:\n\n```bash\n# Database URLs\nMONGODB_URL=mongodb://localhost:27017/ecommerce\nMYSQL_URL=jdbc:mysql://localhost:3306/ecommerce\nREDIS_URL=redis://localhost:6379\n\n# Kafka Configuration\nKAFKA_BOOTSTRAP_SERVERS=localhost:9092\n\n# JWT Configuration  \nJWT_SECRET=your-secret-key-here\nJWT_EXPIRATION=86400000\n\n# Payment Gateway\nVNPAY_TMN_CODE=your-terminal-code\nVNPAY_HASH_SECRET=your-hash-secret\nVNPAY_RETURN_URL=http://localhost:8084/api/v1/wallet-service/payments/vnpay_return\n```\n\n### VS Code Configuration\n\nThe project includes VS Code settings for optimal development experience:\n\n```json\n{\n    \"Codegeex.RepoIndex\": true\n}\n```\n\nRecommended VS Code extensions:\n- Extension Pack for Java\n- Spring Boot Extension Pack\n- MongoDB for VS Code\n- Thunder Client (API testing)\n\nSources: [.vscode/settings.json:1-3]()\n\n### Maven Build Commands\n\n```bash\n# Clean and compile all services\nmvn clean compile\n\n# Run tests for specific service\ncd product \u0026\u0026 mvn test\n\n# Package service as JAR\nmvn package -DskipTests\n\n# Run service locally\nmvn spring-boot:run\n```\n\n### Docker Development Setup\n\nFor containerized development, create a `docker-compose.yml` for infrastructure:\n\n```yaml\nversion: '3.8'\nservices:\n  mongodb:\n    image: mongo:5.0\n    ports:\n      - \"27017:27017\"\n  \n  mysql:\n    image: mysql:8.0\n    ports:\n      - \"3306:3306\"\n    environment:\n      MYSQL_ROOT_PASSWORD: password\n  \n  redis:\n    image: redis:6.2\n    ports:\n      - \"6379:6379\"\n      \n  kafka:\n    image: confluentinc/cp-kafka:latest\n    ports:\n      - \"9092:9092\"\n```\n\nThis setup enables rapid development with consistent infrastructure across different development environments."])</script><script>self.__next_f.push([1,"5:[\"$\",\"$L12\",null,{\"repoName\":\"letrogthien/e-com-chuadatten\",\"hasConfig\":false,\"canSteer\":false,\"children\":[\"$\",\"$L13\",null,{\"wiki\":{\"metadata\":{\"repo_name\":\"letrogthien/e-com-chuadatten\",\"commit_hash\":\"35018ebc\",\"generated_at\":\"2025-09-18T13:14:24.996347\",\"config\":null,\"config_source\":\"none\"},\"pages\":[{\"page_plan\":{\"id\":\"1\",\"title\":\"Overview\"},\"content\":\"$14\"},{\"page_plan\":{\"id\":\"2\",\"title\":\"System Architecture\"},\"content\":\"$15\"},{\"page_plan\":{\"id\":\"2.1\",\"title\":\"Microservices Overview\"},\"content\":\"$16\"},{\"page_plan\":{\"id\":\"2.2\",\"title\":\"Event-Driven Architecture\"},\"content\":\"$17\"},{\"page_plan\":{\"id\":\"2.3\",\"title\":\"Authentication \u0026 Security\"},\"content\":\"$18\"},{\"page_plan\":{\"id\":\"3\",\"title\":\"Core Services\"},\"content\":\"$19\"},{\"page_plan\":{\"id\":\"3.1\",\"title\":\"Transaction Service\"},\"content\":\"$1a\"},{\"page_plan\":{\"id\":\"3.2\",\"title\":\"Product Service\"},\"content\":\"$1b\"},{\"page_plan\":{\"id\":\"3.3\",\"title\":\"Wallet Service\"},\"content\":\"$1c\"},{\"page_plan\":{\"id\":\"3.4\",\"title\":\"User Service\"},\"content\":\"$1d\"},{\"page_plan\":{\"id\":\"3.5\",\"title\":\"Notification Service\"},\"content\":\"$1e\"},{\"page_plan\":{\"id\":\"4\",\"title\":\"Core Business Processes\"},\"content\":\"$1f\"},{\"page_plan\":{\"id\":\"4.1\",\"title\":\"Payment Processing\"},\"content\":\"$20\"},{\"page_plan\":{\"id\":\"4.2\",\"title\":\"Order Lifecycle\"},\"content\":\"$21\"},{\"page_plan\":{\"id\":\"4.3\",\"title\":\"Event System\"},\"content\":\"$22\"},{\"page_plan\":{\"id\":\"5\",\"title\":\"Database Design\"},\"content\":\"$23\"},{\"page_plan\":{\"id\":\"6\",\"title\":\"API Reference\"},\"content\":\"$24\"},{\"page_plan\":{\"id\":\"7\",\"title\":\"Development Setup\"},\"content\":\"$25\"}]},\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]\nc:null\n10:[[\"$\",\"title\",\"0\",{\"children\":\"letrogthien/e-com-chuadatten | DeepWiki\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"This document provides a comprehens"])</script><script>self.__next_f.push([1,"ive introduction to the e-commerce microservices platform, explaining its architecture, core services, and key design patterns. The platform is built using event-dri\"}],[\"$\",\"meta\",\"2\",{\"property\":\"og:title\",\"content\":\"letrogthien/e-com-chuadatten | DeepWiki\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:description\",\"content\":\"This document provides a comprehensive introduction to the e-commerce microservices platform, explaining its architecture, core services, and key design patterns. The platform is built using event-dri\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:url\",\"content\":\"https://deepwiki.com/letrogthien/e-com-chuadatten\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:site_name\",\"content\":\"DeepWiki\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:title\",\"content\":\"letrogthien/e-com-chuadatten | DeepWiki\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:description\",\"content\":\"This document provides a comprehensive introduction to the e-commerce microservices platform, explaining its architecture, core services, and key design patterns. The platform is built using event-dri\"}],[\"$\",\"link\",\"10\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"48x48\"}],[\"$\",\"link\",\"11\",{\"rel\":\"icon\",\"href\":\"/icon.png?66aaf51e0e68c818\",\"type\":\"image/png\",\"sizes\":\"16x16\"}],[\"$\",\"link\",\"12\",{\"rel\":\"apple-touch-icon\",\"href\":\"/apple-icon.png?a4f658907db0ab87\",\"type\":\"image/png\",\"sizes\":\"180x180\"}]]\n"])</script><next-route-announcer style="position: absolute;"><template shadowrootmode="open"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;">Wallet Service | letrogthien/e-com-chuadatten | DeepWiki</div></template></next-route-announcer><div style="position: absolute; left: -9999px;"><div id="dmermaid-vz96nohtobd" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif;"><svg id="mermaid-vz96nohtobd" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 2412 512" style="max-width: 512px;" role="graphics-document document" aria-roledescription="error"><style>#mermaid-vz96nohtobd{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-vz96nohtobd .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-vz96nohtobd .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-vz96nohtobd .error-icon{fill:#dddddd;}#mermaid-vz96nohtobd .error-text{fill:#222222;stroke:#222222;}#mermaid-vz96nohtobd .edge-thickness-normal{stroke-width:1px;}#mermaid-vz96nohtobd .edge-thickness-thick{stroke-width:3.5px;}#mermaid-vz96nohtobd .edge-pattern-solid{stroke-dasharray:0;}#mermaid-vz96nohtobd .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-vz96nohtobd .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-vz96nohtobd .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-vz96nohtobd .marker{fill:#999;stroke:#999;}#mermaid-vz96nohtobd .marker.cross{stroke:#999;}#mermaid-vz96nohtobd svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-vz96nohtobd p{margin:0;}#mermaid-vz96nohtobd :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g></g><g><path class="error-icon" d="m411.313,123.313c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32-9.375,9.375-20.688-20.688c-12.484-12.5-32.766-12.5-45.25,0l-16,16c-1.261,1.261-2.304,2.648-3.31,4.051-21.739-8.561-45.324-13.426-70.065-13.426-105.867,0-192,86.133-192,192s86.133,192 192,192 192-86.133 192-192c0-24.741-4.864-48.327-13.426-70.065 1.402-1.007 2.79-2.049 4.051-3.31l16-16c12.5-12.492 12.5-32.758 0-45.25l-20.688-20.688 9.375-9.375 32.001-31.999zm-219.313,100.687c-52.938,0-96,43.063-96,96 0,8.836-7.164,16-16,16s-16-7.164-16-16c0-70.578 57.422-128 128-128 8.836,0 16,7.164 16,16s-7.164,16-16,16z"></path><path class="error-icon" d="m459.02,148.98c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l16,16c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16.001-16z"></path><path class="error-icon" d="m340.395,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16-16c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l15.999,16z"></path><path class="error-icon" d="m400,64c8.844,0 16-7.164 16-16v-32c0-8.836-7.156-16-16-16-8.844,0-16,7.164-16,16v32c0,8.836 7.156,16 16,16z"></path><path class="error-icon" d="m496,96.586h-32c-8.844,0-16,7.164-16,16 0,8.836 7.156,16 16,16h32c8.844,0 16-7.164 16-16 0-8.836-7.156-16-16-16z"></path><path class="error-icon" d="m436.98,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688l32-32c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32c-6.251,6.25-6.251,16.375-0.001,22.625z"></path><text class="error-text" x="1440" y="250" font-size="150px" style="text-anchor: middle;">Syntax error in text</text><text class="error-text" x="1250" y="400" font-size="100px" style="text-anchor: middle;">mermaid version 11.6.0</text></g></svg></div></div><div style="position: absolute; left: -9999px;"><div id="dmermaid-x7s3x7oenyr" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif;"><svg id="mermaid-x7s3x7oenyr" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 2412 512" style="max-width: 512px;" role="graphics-document document" aria-roledescription="error"><style>#mermaid-x7s3x7oenyr{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-x7s3x7oenyr .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-x7s3x7oenyr .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-x7s3x7oenyr .error-icon{fill:#dddddd;}#mermaid-x7s3x7oenyr .error-text{fill:#222222;stroke:#222222;}#mermaid-x7s3x7oenyr .edge-thickness-normal{stroke-width:1px;}#mermaid-x7s3x7oenyr .edge-thickness-thick{stroke-width:3.5px;}#mermaid-x7s3x7oenyr .edge-pattern-solid{stroke-dasharray:0;}#mermaid-x7s3x7oenyr .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-x7s3x7oenyr .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-x7s3x7oenyr .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-x7s3x7oenyr .marker{fill:#999;stroke:#999;}#mermaid-x7s3x7oenyr .marker.cross{stroke:#999;}#mermaid-x7s3x7oenyr svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-x7s3x7oenyr p{margin:0;}#mermaid-x7s3x7oenyr :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g></g><g><path class="error-icon" d="m411.313,123.313c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32-9.375,9.375-20.688-20.688c-12.484-12.5-32.766-12.5-45.25,0l-16,16c-1.261,1.261-2.304,2.648-3.31,4.051-21.739-8.561-45.324-13.426-70.065-13.426-105.867,0-192,86.133-192,192s86.133,192 192,192 192-86.133 192-192c0-24.741-4.864-48.327-13.426-70.065 1.402-1.007 2.79-2.049 4.051-3.31l16-16c12.5-12.492 12.5-32.758 0-45.25l-20.688-20.688 9.375-9.375 32.001-31.999zm-219.313,100.687c-52.938,0-96,43.063-96,96 0,8.836-7.164,16-16,16s-16-7.164-16-16c0-70.578 57.422-128 128-128 8.836,0 16,7.164 16,16s-7.164,16-16,16z"></path><path class="error-icon" d="m459.02,148.98c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l16,16c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16.001-16z"></path><path class="error-icon" d="m340.395,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16-16c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l15.999,16z"></path><path class="error-icon" d="m400,64c8.844,0 16-7.164 16-16v-32c0-8.836-7.156-16-16-16-8.844,0-16,7.164-16,16v32c0,8.836 7.156,16 16,16z"></path><path class="error-icon" d="m496,96.586h-32c-8.844,0-16,7.164-16,16 0,8.836 7.156,16 16,16h32c8.844,0 16-7.164 16-16 0-8.836-7.156-16-16-16z"></path><path class="error-icon" d="m436.98,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688l32-32c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32c-6.251,6.25-6.251,16.375-0.001,22.625z"></path><text class="error-text" x="1440" y="250" font-size="150px" style="text-anchor: middle;">Syntax error in text</text><text class="error-text" x="1250" y="400" font-size="100px" style="text-anchor: middle;">mermaid version 11.6.0</text></g></svg></div></div></body></html>