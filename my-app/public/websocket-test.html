<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .loading { background-color: #fff3cd; color: #856404; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #logs {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Auto-Connection Test</h1>
    
    <div class="status">
        <strong>Instructions:</strong>
        <ol>
            <li>Click "Set Test Cookie" to create a demo access_token</li>
            <li>Open the React app in another tab (http://localhost:5173)</li>
            <li>Check if WebSocket connects automatically</li>
            <li>Watch the logs below for connection details</li>
        </ol>
    </div>

    <div>
        <button onclick="setTestCookie()">Set Test Cookie</button>
        <button onclick="clearCookie()">Clear Cookie</button>
        <button onclick="checkCookie()">Check Cookie</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="status">
        <strong>Current Cookie:</strong> <span id="currentCookie">Not set</span>
    </div>

    <div class="status">
        <strong>WebSocket Status:</strong> <span id="wsStatus">Not tested</span>
    </div>

    <h3>Console Logs:</h3>
    <div id="logs"></div>

    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function setTestCookie() {
            // Create a demo JWT-like token
            const demoToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ0ZXN0LXVzZXItMTIzIiwiaWF0IjoxNjMzMDI0ODAwLCJleHAiOjE2MzMxMTEyMDB9.demo-signature';
            
            // Set cookie with path and expiration
            document.cookie = `access_token=${demoToken}; path=/; max-age=3600; SameSite=Lax`;
            
            log('‚úÖ Test cookie set successfully');
            checkCookie();
        }

        function clearCookie() {
            document.cookie = 'access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            log('üóëÔ∏è Cookie cleared');
            checkCookie();
        }

        function checkCookie() {
            const cookies = document.cookie;
            const accessToken = getCookie('access_token');
            
            document.getElementById('currentCookie').textContent = accessToken ? 
                accessToken.substring(0, 30) + '...' : 'Not set';
            
            log(`üç™ Cookie check: ${accessToken ? 'Found' : 'Not found'}`);
            log(`üç™ All cookies: ${cookies || 'None'}`);
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
            return null;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Test WebSocket connection directly
        function testWebSocket() {
            log('üîó Testing direct WebSocket connection...');
            
            const ws = new WebSocket('ws://localhost:8080/ws');
            
            ws.onopen = function(event) {
                log('‚úÖ Direct WebSocket connected');
                document.getElementById('wsStatus').textContent = 'Connected';
                ws.close();
            };
            
            ws.onerror = function(error) {
                log('‚ùå Direct WebSocket error: ' + error);
                document.getElementById('wsStatus').textContent = 'Error';
            };
            
            ws.onclose = function(event) {
                log(`üîå Direct WebSocket closed: ${event.code} - ${event.reason}`);
            };
        }

        // Initialize
        log('üì± WebSocket Test Page Loaded');
        checkCookie();
        
        // Auto-test WebSocket if backend is running
        setTimeout(testWebSocket, 2000);
    </script>
</body>
</html>